<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Mio Calendario - AST Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    <script src="data-migration.js"></script>
    <!-- No external calendar library needed! -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- MOBILE OPTIMIZATIONS -->
    <link rel="stylesheet" href="mobile-optimizations.css">
    
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .user-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        
        /* FullCalendar custom styling */
        .fc {
            font-family: inherit;
        }
        .fc .fc-button-primary {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .fc .fc-button-primary:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .fc .fc-button-primary:disabled {
            background-color: #93c5fd;
            border-color: #93c5fd;
        }
        .fc-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .fc-daygrid-event {
            white-space: normal;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg z-50">
        <div class="flex items-center justify-center h-16 user-gradient">
            <h1 class="text-white text-xl font-bold">Pannello Utente</h1>
        </div>
        <nav class="mt-8">
            <a href="pannello-utente.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="pannello-utente.html#my-tasks" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                Le Mie Lavorazioni
            </a>
            <a href="calendario-dipendente.html" class="flex items-center px-6 py-3 bg-blue-50 text-blue-600 border-r-4 border-blue-600">
                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                Il Mio Calendario
            </a>
            <a href="pannello-utente.html#requests" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                Le Mie Richieste
            </a>
            <a href="pannello-utente.html#communications" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Comunicazioni
            </a>
            <div class="mt-8 border-t pt-4">
                <a href="admin-functional.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors">
                    <i data-lucide="shield" class="w-5 h-5 mr-3"></i>
                    Admin Panel
                </a>
                <a href="#" onclick="logout()" class="flex items-center px-6 py-3 text-red-700 hover:bg-red-50 hover:text-red-600 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="toggleMobileSidebar()"></div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">
                    <i data-lucide="calendar" class="w-8 h-8 inline mr-2"></i>
                    Il Mio Calendario
                </h2>
                <p class="text-gray-600">Le tue lavorazioni programmate</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Modalit√† Sola Lettura</strong>
                </p>
                <p class="text-xs text-blue-600 mt-1">
                    Le lavorazioni vengono assegnate dall'amministratore
                </p>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Totale Lavorazioni</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalMyTasks">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Priorit√† Alta</p>
                        <p class="text-2xl font-bold text-red-600" id="highPriorityCount">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">In Scadenza</p>
                        <p class="text-2xl font-bold text-orange-600" id="upcomingCount">0</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Completate</p>
                        <p class="text-2xl font-bold text-green-600" id="completedCount">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-4 flex justify-end">
                <a href="calendario-semplice.html" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition-colors flex items-center gap-2">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span>Apri Calendario Completo</span>
                </a>
            </div>
            <div id="calendar"></div>
        </div>

        <!-- Legend -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Legenda Priorit√†</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded bg-red-500"></div>
                    <span class="ml-2 text-sm text-gray-700">Priorit√† Alta</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded bg-orange-500"></div>
                    <span class="ml-2 text-sm text-gray-700">Priorit√† Media</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded bg-green-500"></div>
                    <span class="ml-2 text-sm text-gray-700">Priorit√† Bassa</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded bg-blue-500"></div>
                    <span class="ml-2 text-sm text-gray-700">Default</span>
                </div>
            </div>
        </div>
    </div>


    <!-- Task Details Modal - OTTIMIZZATA PER MOBILE -->
    <div id="taskDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md md:max-w-2xl max-h-[90vh] overflow-hidden flex flex-col my-4">
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 p-4 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <h3 id="modalTitle" class="text-lg font-bold text-white flex-1">Dettagli Lavorazione</h3>
                        <button onclick="closeTaskModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors ml-2" title="Chiudi">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Content scrollabile -->
                <div class="p-3 overflow-y-auto flex-1" id="taskDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out;
        }
        .animate-slideUp {
            animation: slideUp 0.3s ease-out;
        }
    </style>

    <script>
        // Current user (should be loaded from session)
        const currentUser = {
            id: 'mario',
            nome: 'Mario Rossi'
        };

        let calendar;
        let currentTaskId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            await initCalendar();
            await updateStats();
        });

        async function initCalendar() {
            try {
                const calendarEl = document.getElementById('calendar');
                const user = window.AuthHelper.getCurrentUser();
                
                // Get all events and filter for current user
                const allEvents = await window.dataManager.syncCalendarFromTasks();
                const myEvents = allEvents.filter(event => 
                    event.extendedProps && event.extendedProps.userId === user.id
                );
                
                // Render simple HTML list
                renderSimpleList(calendarEl, myEvents);
            } catch (error) {
                console.error('Errore inizializzazione calendario:', error);
            }
        }
        
        async function renderSimpleList(container, events) {
            if (events.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-500"><i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2"></i><p>Nessuna lavorazione programmata</p></div>';
                lucide.createIcons();
                return;
            }
            
            // Load all tasks once to get client names
            const allTasks = await window.dataManager.getLavorazioni();
            
            // Group events by date
            const grouped = {};
            events.forEach(event => {
                const date = new Date(event.start).toLocaleDateString('it-IT');
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(event);
            });
            
            // Sort dates
            const sortedDates = Object.keys(grouped).sort((a, b) => {
                return new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'));
            });
            
            let html = '<div class="space-y-4">';
            sortedDates.forEach(date => {
                const dateEvents = grouped[date];
                const dayName = new Date(dateEvents[0].start).toLocaleDateString('it-IT', { weekday: 'long' });
                
                html += `
                    <div class="border-l-4 border-blue-600 pl-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="calendar-days" class="w-5 h-5 text-blue-600"></i>
                            <h3 class="font-bold text-lg capitalize">${dayName}, ${date}</h3>
                        </div>
                        <div class="space-y-2">
                `;
                
                dateEvents.forEach(event => {
                    const priorityColors = {
                        'alta': 'bg-red-100 border-red-500 text-red-700',
                        'media': 'bg-yellow-100 border-yellow-500 text-yellow-700',
                        'bassa': 'bg-green-100 border-green-500 text-green-700',
                        'normale': 'bg-blue-100 border-blue-500 text-blue-700'
                    };
                    const priority = event.extendedProps?.priority || 'normale';
                    const colorClass = priorityColors[priority] || priorityColors['normale'];
                    
                    // Get client name from task
                    let clientName = 'N/A';
                    if (event.extendedProps?.taskId) {
                        const task = allTasks.find(t => t.id === event.extendedProps.taskId);
                        if (task && task.client) {
                            clientName = task.client.ragione_sociale;
                        }
                    }
                    
                    html += `
                        <div class="border-l-2 ${colorClass} pl-3 py-2 rounded-r cursor-pointer hover:shadow-md transition-shadow" onclick='showEventFromList(${JSON.stringify(event).replace(/'/g, "&#39;")})'>
                            <div class="font-semibold">${event.title}</div>
                            <div class="text-sm opacity-75">Cliente: ${clientName}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
            lucide.createIcons();
        }
        
        window.showEventFromList = async function(event) {
            // Create a fake FullCalendar-like event object
            const fakeEvent = {
                extendedProps: event.extendedProps
            };
            await showEventDetails(fakeEvent);
        };

        async function updateStats() {
            try {
                const user = window.AuthHelper.getCurrentUser();
                const tasks = await window.dataManager.getLavorazioni();
                
                // Carica multi-assignments (solo se user.id √® definito)
                let calMultiTaskIds = [];
                if (user && user.id) {
                    const { data: calMultiAssignments, error: assignError } = await supabaseClient
                        .from('task_assignments')
                        .select('task_id')
                        .eq('user_id', user.id);
                    
                    if (!assignError) {
                        calMultiTaskIds = calMultiAssignments?.map(a => a.task_id) || [];
                    }
                }
                
                // Filtra tasks: assigned_user_id O in task_assignments
                const myTasks = tasks.filter(t => 
                    t.assigned_user_id === user.id ||
                    calMultiTaskIds.includes(t.id)
                );
                
                const total = myTasks.length;
                const completed = myTasks.filter(t => t.stato === 'completato').length;
                const inProgress = myTasks.filter(t => t.stato === 'in_corso').length;
                
                document.getElementById('totalTasks').textContent = total;
                document.getElementById('completedTasks').textContent = completed;
                document.getElementById('inProgressTasks').textContent = inProgress;
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
            }
            
            // Listen for calendar updates from admin
            window.addEventListener('calendarSynced', function() {
                refreshCalendar();
            });
        }

        function refreshCalendar() {
            const myEvents = window.syncData.getCalendarEventsForUser(currentUser.id);
            calendar.removeAllEvents();
            calendar.addEventSource(myEvents);
            updateStats();
        }

        async function updateStats() {
            try {
                const allTasks = await window.dataManager.getLavorazioni();
                
                // Carica multi-assignments per secondo updateStats
                const { data: calMultiAssignments2 } = await supabaseClient
                    .from('task_assignments')
                    .select('task_id')
                    .eq('user_id', currentUser.id);
                
                const calMultiTaskIds2 = calMultiAssignments2?.map(a => a.task_id) || [];
                
                // Filtra tasks
                const myTasks = allTasks.filter(t => 
                    (t.assigned_user_id || t.assegnatario) === currentUser.id ||
                    calMultiTaskIds2.includes(t.id)
                );
                
                document.getElementById('totalMyTasks').textContent = myTasks.length;
                document.getElementById('highPriorityCount').textContent = myTasks.filter(t => (t.priority || t.priorita) === 'alta').length;
                
                // Tasks due in next 7 days
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                const upcoming = myTasks.filter(t => {
                    const dueDate = new Date(t.deadline || t.scadenza);
                    return dueDate <= nextWeek && dueDate >= new Date() && (t.status || t.stato) !== 'completato';
                });
                document.getElementById('upcomingCount').textContent = upcoming.length;
                
                document.getElementById('completedCount').textContent = myTasks.filter(t => (t.status || t.stato) === 'completato').length;
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
            }
        }

        async function showEventDetails(event) {
            const taskId = event.extendedProps.taskId;
            currentTaskId = taskId;
            
            try {
                const allTasks = await window.dataManager.getLavorazioni();
                const task = allTasks.find(t => t.id === taskId);
                
                if (!task) {
                    alert('Task non trovato');
                    return;
                }
                
                // Extract task info
                const titolo = task.titolo || task.title || 'Senza titolo';
                const descrizione = task.descrizione || task.description || 'Nessuna descrizione disponibile';
                const stato = task.stato || task.status || 'da_fare';
                const priorita = task.priorita || task.priority || 'normale';
                const scadenza = task.scadenza || task.deadline;
                const progresso = task.progresso || task.progress;
                const categoria = task.categoria || task.category || 'generale';
                const clienteId = task.client_id || task.clientId;
                const clienteName = task.client ? task.client.ragione_sociale : 'Nessun cliente';
                const assignedTeam = event.extendedProps?.teamName || null;
                
                // Set modal title
                document.getElementById('modalTitle').textContent = `Dettagli: ${titolo}`;
                
                // Populate modal content with RICH HTML like pannello-utente
                const content = document.getElementById('taskDetailsContent');
                const isOverdue = scadenza && new Date(scadenza) < new Date() && stato !== 'completato';
                
                content.innerHTML = `
                    <div class="space-y-3">
                        <!-- Main Info Grid - Grid 2x2 su mobile -->
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Cliente - VERDE -->
                            <div class="col-span-2 bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="building-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-green-700 font-medium">Cliente</p>
                                        <p class="font-bold text-sm text-gray-900 truncate">${clienteName}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scadenza - ARANCIO -->
                            <div class="bg-gradient-to-br from-orange-50 to-amber-100 border-2 border-orange-200 rounded-xl p-3">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg flex items-center justify-center mb-2">
                                        <i data-lucide="calendar" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <p class="text-xs text-orange-700 font-medium">Scadenza</p>
                                    <p class="font-bold text-sm ${isOverdue ? 'text-red-600' : 'text-gray-900'} mt-1">${scadenza ? new Date(scadenza).toLocaleDateString('it-IT', {day: '2-digit', month: '2-digit', year: 'numeric'}) : 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Priorit√† - ROSA -->
                            <div class="bg-gradient-to-br from-pink-50 to-rose-100 border-2 border-pink-200 rounded-xl p-3">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-rose-600 rounded-lg flex items-center justify-center mb-2">
                                        <i data-lucide="alert-circle" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <p class="text-xs text-pink-700 font-medium">Priorit√†</p>
                                    <p class="font-bold text-sm text-gray-900 mt-1">${getPriorityEmoji(priorita)} ${priorita.charAt(0).toUpperCase() + priorita.slice(1)}</p>
                                </div>
                            </div>
                            
                            <!-- Stato - BLU -->
                            <div class="col-span-2 bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="activity" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-blue-700 font-medium">Stato</p>
                                        <p class="font-bold text-sm text-gray-900">${getStatusText(stato)}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Categoria - GIALLO -->
                            ${assignedTeam ? `
                            <div class="col-span-2 bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="users" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-purple-700 font-medium">Team</p>
                                        <p class="font-bold text-sm text-gray-900 truncate">${assignedTeam}</p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="col-span-2 bg-gradient-to-br from-yellow-50 to-amber-100 border-2 border-yellow-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-amber-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="tag" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-yellow-700 font-medium">Categoria</p>
                                        <p class="font-bold text-sm text-gray-900">${getCategoryText(categoria)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progresso - CELESTE -->
                        ${progresso !== undefined ? `
                        <div class="bg-gradient-to-br from-cyan-50 to-sky-100 border-2 border-cyan-200 rounded-xl p-3">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="trending-up" class="w-4 h-4 text-cyan-700"></i>
                                    <span class="text-xs font-bold text-cyan-900">Progresso</span>
                                </div>
                                <span class="text-lg font-bold text-cyan-600">${progresso}%</span>
                            </div>
                            <div class="w-full bg-cyan-200 rounded-full h-2 overflow-hidden">
                                <div class="bg-gradient-to-r from-cyan-500 to-blue-600 h-2 rounded-full transition-all duration-500" style="width: ${progresso}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Descrizione - GRIGIO CHIARO -->
                        <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-3">
                            <div class="flex items-start gap-2">
                                <i data-lucide="file-text" class="w-4 h-4 text-gray-600 mt-1 flex-shrink-0"></i>
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-gray-700 mb-1">Descrizione</p>
                                    <p class="text-xs text-gray-600 leading-relaxed">${descrizione}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pulsante Chiudi -->
                        <div class="flex justify-center pt-2">
                            <button onclick="closeTaskModal()" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg">
                                Chiudi
                            </button>
                        </div>
                    </div>
                `;
                
                // Show modal
                document.getElementById('taskDetailsModal').classList.remove('hidden');
                
                // Refresh icons
                setTimeout(() => lucide.createIcons(), 100);
                
            } catch (error) {
                console.error('‚ùå Errore caricamento task:', error);
                alert('Errore nel caricamento dei dettagli del task');
            }
        }
        
        // Helper functions for formatting
        function getPriorityEmoji(priority) {
            const emojis = {
                'alta': '‚ö†Ô∏è',
                'media': 'üü°',
                'bassa': '‚úÖ',
                'normale': 'üìã'
            };
            return emojis[priority] || emojis['normale'];
        }
        
        function getPriorityBadgeClass(priority) {
            const classes = {
                'alta': 'bg-red-100 text-red-700',
                'media': 'bg-yellow-100 text-yellow-700',
                'bassa': 'bg-green-100 text-green-700',
                'normale': 'bg-blue-100 text-blue-700'
            };
            return classes[priority] || classes['normale'];
        }
        
        function getPriorityText(priority) {
            const texts = {
                'alta': 'üî¥ Alta',
                'media': 'üü° Media',
                'bassa': 'üü¢ Bassa',
                'normale': 'üîµ Normale'
            };
            return texts[priority] || texts['normale'];
        }
        
        function getStatusClass(status) {
            const classes = {
                'da_fare': 'bg-gray-100 text-gray-700',
                'in_corso': 'bg-blue-100 text-blue-700',
                'revisione': 'bg-yellow-100 text-yellow-700',
                'completato': 'bg-green-100 text-green-700'
            };
            return classes[status] || classes['da_fare'];
        }
        
        function getStatusText(status) {
            const texts = {
                'da_fare': 'Da Fare',
                'in_corso': 'In Corso',
                'revisione': 'In Revisione',
                'completato': 'Completato'
            };
            return texts[status] || 'Da Fare';
        }
        
        function getCategoryText(category) {
            const texts = {
                'antifurto': 'Antifurto',
                'videosorveglianza': 'Videosorveglianza',
                'networking': 'Networking',
                'automazione': 'Automazione',
                'generale': 'Generale'
            };
            return texts[category] || category.charAt(0).toUpperCase() + category.slice(1);
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        function closeTaskModal() {
            document.getElementById('taskDetailsModal').classList.add('hidden');
            currentTaskId = null;
        }

        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                window.location.href = 'Admin/index.html';
            }
        }
        
        // Toggle mobile sidebar (called from overlay)
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            }
        }
    </script>
    
    <!-- MOBILE ENHANCEMENTS -->
    <script src="mobile-enhancements.js"></script>
</body>
</html>
