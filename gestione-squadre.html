<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Squadre - AST Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    <script src="data-migration.js"></script>
    <script src="modal-system.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .team-card { transition: all 0.3s ease; }
        .team-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .member-badge { transition: all 0.2s ease; }
        .member-badge:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg z-50">
        <div class="flex items-center justify-center h-16 gradient-bg">
            <h1 class="text-white text-xl font-bold">Admin Panel</h1>
        </div>
        <nav class="mt-8">
            <a href="admin-functional.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="gestione-utenti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                Gestione Utenti
            </a>
            <a href="gestione-clienti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="building-2" class="w-5 h-5 mr-3"></i>
                Gestione Clienti
            </a>
            <a href="gestione-squadre.html" class="flex items-center px-6 py-3 bg-blue-50 text-blue-600 border-r-4 border-blue-600">
                <i data-lucide="users-2" class="w-5 h-5 mr-3"></i>
                Gestione Squadre
            </a>
            <a href="gestione-lavorazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                Gestione Lavorazioni
            </a>
            <a href="calendario-admin.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                Calendario
            </a>
            <a href="gestione-richieste.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                Gestione Richieste
            </a>
            <a href="comunicazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Comunicazioni
            </a>
            <div class="mt-8 border-t pt-4">
                <a href="pannello-utente.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-green-50 hover:text-green-600 transition-colors">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                    Pannello Utente
                </a>
                <a href="#" onclick="logout()" class="flex items-center px-6 py-3 text-red-700 hover:bg-red-50 hover:text-red-600 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">
                    <i data-lucide="users-2" class="w-8 h-8 inline mr-2"></i>
                    Gestione Squadre
                </h2>
                <p class="text-gray-600">Crea e gestisci squadre di lavoro</p>
            </div>
            <button onclick="openNewTeamModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all transform hover:scale-105 shadow-lg">
                <i class="fas fa-plus mr-2"></i>
                Nuova Squadra
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Squadre Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalTeams">0</p>
                    </div>
                    <div class="w-14 h-14 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="users-2" class="w-7 h-7 text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Dipendenti Totali</p>
                        <p class="text-3xl font-bold text-green-600" id="totalEmployees">0</p>
                    </div>
                    <div class="w-14 h-14 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="users" class="w-7 h-7 text-green-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Media Membri</p>
                        <p class="text-3xl font-bold text-purple-600" id="avgMembers">0</p>
                    </div>
                    <div class="w-14 h-14 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="bar-chart" class="w-7 h-7 text-purple-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teams Grid -->
        <div id="teamsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Teams will be loaded here -->
        </div>
    </div>

    <!-- Modal Nuova/Modifica Squadra -->
    <div id="teamModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="gradient-bg p-6 text-white rounded-t-2xl">
                <h3 class="text-2xl font-bold" id="modalTitle">Nuova Squadra</h3>
            </div>
            <div class="p-8">
                <form id="teamForm">
                    <input type="hidden" id="teamId">
                    
                    <!-- Nome Squadra -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Nome Squadra *
                        </label>
                        <input type="text" id="teamName" required
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                               placeholder="Es: Squadra Alpha, Team Installazioni...">
                    </div>

                    <!-- Descrizione -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-align-left mr-2"></i>Descrizione
                        </label>
                        <textarea id="teamDescription" rows="3"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                  placeholder="Descrizione della squadra..."></textarea>
                    </div>

                    <!-- Membri -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-users mr-2"></i>Membri della Squadra *
                        </label>
                        <div id="membersList" class="space-y-2 mb-3">
                            <!-- Members checkboxes will be loaded here -->
                        </div>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            Seleziona almeno 2 membri
                        </p>
                    </div>

                    <!-- Colore Squadra -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-palette mr-2"></i>Colore Identificativo
                        </label>
                        <div class="flex gap-3 flex-wrap">
                            <label class="cursor-pointer">
                                <input type="radio" name="teamColor" value="#3b82f6" class="hidden peer">
                                <div class="w-12 h-12 rounded-lg bg-blue-500 peer-checked:ring-4 peer-checked:ring-blue-300 transition-all"></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="teamColor" value="#10b981" class="hidden peer">
                                <div class="w-12 h-12 rounded-lg bg-green-500 peer-checked:ring-4 peer-checked:ring-green-300 transition-all"></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="teamColor" value="#f59e0b" class="hidden peer">
                                <div class="w-12 h-12 rounded-lg bg-orange-500 peer-checked:ring-4 peer-checked:ring-orange-300 transition-all"></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="teamColor" value="#ef4444" class="hidden peer">
                                <div class="w-12 h-12 rounded-lg bg-red-500 peer-checked:ring-4 peer-checked:ring-red-300 transition-all"></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="teamColor" value="#8b5cf6" class="hidden peer" checked>
                                <div class="w-12 h-12 rounded-lg bg-purple-500 peer-checked:ring-4 peer-checked:ring-purple-300 transition-all"></div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="teamColor" value="#ec4899" class="hidden peer">
                                <div class="w-12 h-12 rounded-lg bg-pink-500 peer-checked:ring-4 peer-checked:ring-pink-300 transition-all"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-3 justify-end">
                        <button type="button" onclick="closeTeamModal()" 
                                class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-all">
                            Annulla
                        </button>
                        <button type="submit" 
                                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all">
                            <i class="fas fa-save mr-2"></i>Salva Squadra
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            await loadTeams();
            await updateStats();
        });

        async function loadTeams() {
            try {
                const container = document.getElementById('teamsContainer');
                const teams = await window.dataManager.getSquadre();

                if (teams.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i data-lucide="users-2" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
                            <p class="text-gray-500 text-lg">Nessuna squadra creata</p>
                            <p class="text-gray-400 text-sm">Crea la tua prima squadra per iniziare</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                const users = await window.dataManager.getUtenti();

                container.innerHTML = teams.map(team => {
                    const memberCount = team.membri ? team.membri.length : 0;
                    return `
                    <div class="team-card bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-6" style="border-top: 4px solid ${team.colore}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-gray-800 mb-1">${team.nome}</h3>
                                    <p class="text-sm text-gray-500">${team.descrizione || 'Nessuna descrizione'}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editTeam('${team.id}')" 
                                            class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTeam('${team.id}', '${team.nome}')" 
                                            class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex items-center text-sm text-gray-600 mb-2">
                                    <i class="fas fa-users mr-2"></i>
                                    <span class="font-semibold">${memberCount} Membri</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${team.membri ? team.membri.map(member => `
                                        <span class="member-badge px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm flex items-center gap-2">
                                            <img src="${member.avatar || 'https://ui-avatars.com/api/?name=' + member.nome}" alt="${member.nome}" class="w-5 h-5 rounded-full">
                                            ${member.nome}
                                        </span>
                                    `).join('') : ''}
                                </div>
                            </div>

                            <div class="pt-4 border-t border-gray-200 text-sm text-gray-500">
                                <i class="far fa-calendar mr-2"></i>
                                Creata il ${new Date(team.created_at).toLocaleDateString('it-IT')}
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento squadre:', error);
                showAlert('Errore', 'Impossibile caricare le squadre: ' + error.message, 'error');
            }
        }

        async function updateStats() {
            try {
                const teams = await window.dataManager.getSquadre();
                const users = await window.dataManager.getUtenti();
                const employees = users.filter(u => u.ruolo !== 'admin');
                
                document.getElementById('totalTeams').textContent = teams.length;
                document.getElementById('totalEmployees').textContent = employees.length;
                
                const avgMembers = teams.length > 0 
                    ? (teams.reduce((sum, t) => (t.membri ? t.membri.length : 0) + sum, 0) / teams.length).toFixed(1)
                    : 0;
                document.getElementById('avgMembers').textContent = avgMembers;
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
            }
        }

        async function openNewTeamModal() {
            document.getElementById('modalTitle').textContent = 'Nuova Squadra';
            document.getElementById('teamForm').reset();
            document.getElementById('teamId').value = '';
            await loadMembersList();
            document.getElementById('teamModal').classList.remove('hidden');
        }

        function closeTeamModal() {
            document.getElementById('teamModal').classList.add('hidden');
        }

        async function loadMembersList() {
            try {
                const container = document.getElementById('membersList');
                const users = await window.dataManager.getUtenti();
                const employees = users.filter(u => u.ruolo !== 'admin');
                
                container.innerHTML = employees.map(user => `
                    <label class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors">
                        <input type="checkbox" name="teamMembers" value="${user.id}" 
                               class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mr-3">
                        <img src="${user.avatar || 'https://ui-avatars.com/api/?name=' + user.nome}" alt="${user.nome}" class="w-8 h-8 rounded-full mr-3">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${user.nome} ${user.cognome}</div>
                            <div class="text-sm text-gray-500">${user.email}</div>
                        </div>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Errore caricamento membri:', error);
            }
        }

        async function editTeam(teamId) {
            try {
                const teams = await window.dataManager.getSquadre();
                const team = teams.find(t => t.id === teamId);
                if (!team) return;

                document.getElementById('modalTitle').textContent = 'Modifica Squadra';
                document.getElementById('teamId').value = team.id;
                document.getElementById('teamName').value = team.nome;
                document.getElementById('teamDescription').value = team.descrizione || '';
                
                await loadMembersList();
                
                // Select members
                if (team.membri) {
                    team.membri.forEach(member => {
                        const checkbox = document.querySelector(`input[name="teamMembers"][value="${member.id}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Select color
                const colorRadio = document.querySelector(`input[name="teamColor"][value="${team.colore}"]`);
                if (colorRadio) colorRadio.checked = true;

                document.getElementById('teamModal').classList.remove('hidden');
            } catch (error) {
                console.error('Errore modifica squadra:', error);
                showAlert('Errore', 'Impossibile modificare la squadra: ' + error.message, 'error');
            }
        }

        async function deleteTeam(teamId, teamName) {
            try {
                const confirmed = await showConfirm(
                    'Elimina Squadra',
                    `Sei sicuro di voler eliminare la squadra "${teamName}"?\n\nQuesta azione non può essere annullata.`
                );

                if (confirmed) {
                    await window.dataManager.deleteSquadra(teamId);
                    await loadTeams();
                    await updateStats();
                    await showAlert('Successo', 'Squadra eliminata con successo', 'success');
                }
            } catch (error) {
                console.error('Errore eliminazione squadra:', error);
                showAlert('Errore', 'Impossibile eliminare la squadra: ' + error.message, 'error');
            }
        }

        document.getElementById('teamForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const teamId = document.getElementById('teamId').value;
                const teamName = document.getElementById('teamName').value.trim();
                const teamDescription = document.getElementById('teamDescription').value.trim();
                const selectedMembers = Array.from(document.querySelectorAll('input[name="teamMembers"]:checked'))
                    .map(cb => cb.value);
                const selectedColor = document.querySelector('input[name="teamColor"]:checked').value;

                // Validation
                if (!teamName) {
                    await showAlert('Errore', 'Inserisci il nome della squadra', 'error');
                    return;
                }

                if (selectedMembers.length < 2) {
                    await showAlert('Attenzione', 'Seleziona almeno 2 membri per la squadra', 'warning');
                    return;
                }

                const teamData = {
                    nome: teamName,
                    descrizione: teamDescription,
                    colore: selectedColor
                };

                if (teamId) {
                    teamData.id = teamId;
                }

                // Save team with members
                await window.dataManager.saveSquadra(teamData, selectedMembers);
                
                closeTeamModal();
                await loadTeams();
                await updateStats();
                
                await showAlert(
                    'Successo', 
                    teamId ? 'Squadra aggiornata con successo' : 'Squadra creata con successo', 
                    'success'
                );
            } catch (error) {
                console.error('Errore salvataggio squadra:', error);
                await showAlert('Errore', 'Impossibile salvare la squadra: ' + error.message, 'error');
            }
        });

        async function logout() {
            const confirmed = await showConfirm(
                'Logout',
                'Sei sicuro di voler uscire?',
                'Esci',
                'Annulla',
                'warning'
            );
            
            if (confirmed) {
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
