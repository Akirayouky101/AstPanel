<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Comunicazioni - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    <script src="data-migration.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .priority-alta { border-left: 4px solid #ef4444; }
        .priority-media { border-left: 4px solid #f59e0b; }
        .priority-bassa { border-left: 4px solid #10b981; }
        .status-draft { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); }
        .status-sent { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); }
        .status-scheduled { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .wysiwyg-editor {
            min-height: 200px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            background: white;
        }
        .wysiwyg-toolbar {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .toolbar-btn {
            padding: 0.25rem 0.5rem;
            margin: 0 0.125rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toolbar-btn:hover {
            background: #f3f4f6;
        }
        .toolbar-btn.active {
            background: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out z-50" id="sidebar">
        <div class="flex items-center justify-center h-16 gradient-bg">
            <h1 class="text-white text-xl font-bold">Admin Panel</h1>
        </div>
        <nav class="mt-8">
            <a href="admin-functional.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="gestione-utenti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                Gestione Utenti
            </a>
            <a href="gestione-lavorazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                Gestione Lavorazioni
            </a>
            <a href="magazzino-prodotti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="package" class="w-5 h-5 mr-3"></i>
                Magazzino Prodotti
            </a>
            <a href="gestione-richieste.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                Gestione Richieste
            </a>
            <a href="comunicazioni.html" class="flex items-center px-6 py-3 bg-blue-50 text-blue-600 border-r-4 border-blue-600">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Comunicazioni
                <span id="deletionsBadge" class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full hidden">0</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Sistema Comunicazioni</h2>
                <p class="text-gray-600">Gestisci annunci e comunicazioni aziendali</p>
            </div>
            <button onclick="openNewCommunicationModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                Nuova Comunicazione
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Comunicazioni Totali</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalCommunications">18</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Inviate Oggi</p>
                        <p class="text-2xl font-bold text-green-600" id="sentToday">3</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="send" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Programmate</p>
                        <p class="text-2xl font-bold text-orange-600" id="scheduled">5</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Bozze</p>
                        <p class="text-2xl font-bold text-gray-600" id="drafts">2</p>
                    </div>
                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="file-edit" class="w-6 h-6 text-gray-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="createQuickAnnouncement()">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Annuncio Urgente</h3>
                        <p class="text-blue-100">Comunicazione immediata a tutti</p>
                    </div>
                    <i data-lucide="megaphone" class="w-8 h-8"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="createNewsletter()">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Newsletter</h3>
                        <p class="text-green-100">Aggiornamenti aziendali mensili</p>
                    </div>
                    <i data-lucide="newspaper" class="w-8 h-8"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="createEventInvite()">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Invito Evento</h3>
                        <p class="text-purple-100">Meeting, formazioni, eventi</p>
                    </div>
                    <i data-lucide="calendar" class="w-8 h-8"></i>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 fade-in">
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-64">
                    <input type="text" id="searchCommunications" placeholder="Cerca comunicazioni..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <select id="typeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutti i tipi</option>
                    <option value="annuncio">Annuncio</option>
                    <option value="newsletter">Newsletter</option>
                    <option value="evento">Evento</option>
                    <option value="formazione">Formazione</option>
                    <option value="procedura">Procedura</option>
                </select>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutti gli stati</option>
                    <option value="bozza">Bozza</option>
                    <option value="programmata">Programmata</option>
                    <option value="inviata">Inviata</option>
                </select>
                <select id="priorityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutte le prioritÃ </option>
                    <option value="alta">Alta</option>
                    <option value="media">Media</option>
                    <option value="bassa">Bassa</option>
                </select>
            </div>
        </div>

        <!-- Communications List -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden fade-in mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Elenco Comunicazioni</h3>
                    <button onclick="toggleDeletionsSection()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        Visualizza Eliminazioni Utenti
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <div id="communicationsList" class="divide-y divide-gray-200">
                    <!-- Communications will be loaded here -->
                </div>
            </div>
        </div>

        <!-- User Deletions Section (Initially Hidden) -->
        <div id="deletionsSection" class="bg-white rounded-lg shadow-md overflow-hidden fade-in hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 flex items-center gap-2">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
                            Comunicazioni Eliminate dagli Utenti
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">Tracciamento di quali utenti hanno eliminato le comunicazioni</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="exportDeletionsToCSV()" 
                                class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 flex items-center gap-2"
                                title="Esporta in CSV per audit">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Esporta CSV
                        </button>
                        <button onclick="toggleDeletionsSection()" class="text-sm text-gray-600 hover:text-gray-800" title="Chiudi">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="mt-4 pb-4 border-b border-gray-200">
                    <!-- Search Bar -->
                    <div class="mb-3">
                        <div class="relative">
                            <input type="text" 
                                   id="deletionsSearchInput"
                                   placeholder="Cerca per titolo, nome utente o email..."
                                   oninput="applyDeletionsFilters()"
                                   class="w-full pl-10 pr-4 py-2 text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Filter Dropdowns -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Periodo</label>
                            <select id="deletionsPeriodFilter" 
                                    onchange="applyDeletionsFilters()"
                                    class="w-full text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="all">Tutte</option>
                                <option value="today">Oggi</option>
                                <option value="week">Ultima settimana</option>
                                <option value="month">Ultimo mese</option>
                                <option value="custom">Personalizzato</option>
                            </select>
                        </div>

                        <div id="customDateRange" class="hidden col-span-2">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Range personalizzato</label>
                            <div class="flex gap-2">
                                <input type="date" 
                                       id="deletionsFromDate" 
                                       onchange="applyDeletionsFilters()"
                                       class="flex-1 text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="date" 
                                       id="deletionsToDate" 
                                       onchange="applyDeletionsFilters()"
                                       class="flex-1 text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tipo</label>
                            <select id="deletionsTypeFilter" 
                                    onchange="applyDeletionsFilters()"
                                    class="w-full text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="all">Tutti</option>
                                <option value="generale">Generale</option>
                                <option value="urgente">Urgente</option>
                                <option value="informativa">Informativa</option>
                                <option value="promemoria">Promemoria</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Utente</label>
                            <select id="deletionsUserFilter" 
                                    onchange="applyDeletionsFilters()"
                                    class="w-full text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="all">Tutti gli utenti</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <div id="deletionsList" class="divide-y divide-gray-200">
                    <!-- Deletions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- New Communication Modal -->
    <div id="communicationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Nuova Comunicazione</h3>
                    <button onclick="closeCommunicationModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form id="communicationForm" class="p-6">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="commTitle" class="block text-sm font-medium text-gray-700 mb-2">Titolo</label>
                            <input type="text" id="commTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="commType" class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                            <select id="commType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="toggleSurveyOptions()">
                                <option value="">Seleziona tipo</option>
                                <option value="annuncio">Annuncio</option>
                                <option value="newsletter">Newsletter</option>
                                <option value="evento">Evento</option>
                                <option value="formazione">Formazione</option>
                                <option value="procedura">Procedura</option>
                                <option value="sondaggio">ðŸ“Š Sondaggio / Richiesta Partecipazione</option>
                            </select>
                        </div>
                        <div>
                            <label for="commPriority" class="block text-sm font-medium text-gray-700 mb-2">PrioritÃ </label>
                            <select id="commPriority" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="bassa">Bassa</option>
                                <option value="media" selected>Media</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                        <div>
                            <label for="commSchedule" class="block text-sm font-medium text-gray-700 mb-2">Programmazione</label>
                            <input type="datetime-local" id="commSchedule" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="commRecipients" class="block text-sm font-medium text-gray-700 mb-2">Destinatari</label>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="radio" name="recipientType" value="tutti" id="allEmployees" checked class="mr-2" onchange="toggleSpecificUsers()">
                                <span>Tutti i Dipendenti</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="recipientType" value="admin" id="managers" class="mr-2" onchange="toggleSpecificUsers()">
                                <span>Solo Manager</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="recipientType" value="specifici" id="specific" class="mr-2" onchange="toggleSpecificUsers()">
                                <span>Utenti Specifici</span>
                            </label>
                            
                            <!-- Specific Users Selector -->
                            <div id="specificUsersContainer" class="hidden ml-6 mt-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="mb-2 flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-700">Seleziona utenti</label>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="selectAllUsers()" class="text-xs text-blue-600 hover:text-blue-800">Seleziona tutti</button>
                                        <button type="button" onclick="deselectAllUsers()" class="text-xs text-gray-600 hover:text-gray-800">Deseleziona tutti</button>
                                    </div>
                                </div>
                                <div id="specificUsersList" class="max-h-48 overflow-y-auto space-y-2">
                                    <!-- Users will be populated here -->
                                </div>
                                <div id="selectedUsersCount" class="mt-2 text-xs text-gray-500">
                                    0 utenti selezionati
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contenuto</label>
                        <div class="wysiwyg-toolbar">
                            <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Grassetto">
                                <i data-lucide="bold" class="w-4 h-4"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Corsivo">
                                <i data-lucide="italic" class="w-4 h-4"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Sottolineato">
                                <i data-lucide="underline" class="w-4 h-4"></i>
                            </button>
                            <span class="border-l border-gray-300 mx-2"></span>
                            <button type="button" class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Lista">
                                <i data-lucide="list" class="w-4 h-4"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Lista Numerata">
                                <i data-lucide="list-ordered" class="w-4 h-4"></i>
                            </button>
                            <span class="border-l border-gray-300 mx-2"></span>
                            <button type="button" class="toolbar-btn" onclick="insertLink()" title="Link">
                                <i data-lucide="link" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="commContent" contenteditable="true" class="wysiwyg-editor" placeholder="Scrivi qui il contenuto della comunicazione..."></div>
                    </div>

                    <!-- Survey Options (shown only when type is sondaggio) -->
                    <div id="surveyOptionsContainer" class="mb-6 hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start gap-2">
                                <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Sondaggio / Richiesta Partecipazione:</strong> Gli utenti potranno votare una delle opzioni. I risultati saranno visibili solo agli admin.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="surveyQuestion" class="block text-sm font-medium text-gray-700 mb-2">Domanda del Sondaggio</label>
                            <input type="text" id="surveyQuestion" placeholder="Es: Quale giorno preferisci per la riunione?" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-3">
                            <label class="flex items-center gap-2 mb-3">
                                <input type="checkbox" id="surveyMultiple" class="rounded">
                                <span class="text-sm font-medium text-gray-700">Consenti risposte multiple</span>
                            </label>
                        </div>
                        
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Opzioni di Risposta</label>
                        </div>
                        
                        <div id="surveyOptionsList" class="space-y-2 mb-3">
                            <div class="flex gap-2">
                                <input type="text" placeholder="Opzione 1" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg survey-option">
                                <button type="button" onclick="removeSurveyOption(this)" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg" style="display:none;">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" placeholder="Opzione 2" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg survey-option">
                                <button type="button" onclick="removeSurveyOption(this)" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button type="button" onclick="addSurveyOption()" class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                            Aggiungi Opzione
                        </button>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Allegati</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="attachments" multiple class="hidden" onchange="handleFileUpload(event)">
                            <div onclick="document.getElementById('attachments').click()" class="cursor-pointer">
                                <i data-lucide="upload" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Clicca per caricare file o trascina qui</p>
                            </div>
                            <div id="fileList" class="mt-4 space-y-2"></div>
                        </div>
                    </div>

                    <div class="flex space-x-3">
                        <button type="button" onclick="saveDraft()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Salva Bozza
                        </button>
                        <button type="button" onclick="previewCommunication()" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                            <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                            Anteprima
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-lucide="send" class="w-4 h-4 inline mr-2"></i>
                            Invia Ora
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Anteprima Comunicazione</h3>
                    <button onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="previewContent" class="p-6">
                    <!-- Preview content will be loaded here -->
                </div>
                <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                    <button onclick="closePreviewModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Chiudi
                    </button>
                    <button onclick="sendFromPreview()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i data-lucide="send" class="w-4 h-4 inline mr-2"></i>
                        Invia Comunicazione
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Communication Modal -->
    <div id="viewCommunicationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Dettagli Comunicazione</h3>
                    <button onclick="closeViewCommunicationModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="viewCommunicationContent" class="p-6">
                    <!-- Content will be loaded here -->
                </div>
                <div class="flex justify-end p-6 border-t border-gray-200">
                    <button onclick="closeViewCommunicationModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data

        let uploadedFiles = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in and is admin
            const currentUser = window.AuthHelper.getCurrentUser();
            
            if (!currentUser) {
                alert('Devi effettuare il login per accedere a questa pagina');
                window.location.href = '/Admin/index.html';
                return;
            }
            
            // Check if user has admin role (Tecnico, Segreteria, Titolare)
            if (!window.AuthHelper.isAdmin()) {
                alert('Solo gli amministratori possono accedere a questa pagina');
                window.location.href = '/pannello-utente.html';
                return;
            }
            
            lucide.createIcons();
            await loadCommunications();
            await updateStats();
            await updateDeletionsBadge();
            setupFilters();
        });

        async function loadCommunications() {
            const communicationsList = document.getElementById('communicationsList');
            communicationsList.innerHTML = '';

            const filteredCommunications = await getFilteredCommunications();

            filteredCommunications.forEach(comm => {
                const commElement = createCommunicationElement(comm);
                communicationsList.appendChild(commElement);
            });
        }

        function createCommunicationElement(comm) {
            const commDiv = document.createElement('div');
            commDiv.className = 'p-6 hover:bg-gray-50 transition-colors border-b border-gray-200';
            
            const typeIcon = getTypeIcon(comm.tipo);
            
            // Parse allegati if it's a JSON string
            let allegatiCount = 0;
            if (comm.allegati) {
                try {
                    const parsed = typeof comm.allegati === 'string' ? JSON.parse(comm.allegati) : comm.allegati;
                    allegatiCount = Array.isArray(parsed) ? parsed.length : 0;
                } catch (e) {
                    allegatiCount = 0;
                }
            }
            
            // Calculate engagement stats
            const lettaCount = comm.letta_da?.length || 0;
            const archiviataCount = comm.archiviata_da?.length || 0;
            const eliminataCount = Array.isArray(comm.eliminata_da) ? comm.eliminata_da.length : 0;
            const totalEngagement = lettaCount + archiviataCount + eliminataCount;
            
            commDiv.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i data-lucide="${typeIcon}" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center">
                                <h4 class="text-lg font-medium text-gray-900">${comm.titolo}</h4>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${comm.contenuto ? comm.contenuto.substring(0, 100).replace(/<[^>]*>/g, '') + '...' : ''}</p>
                            <div class="flex items-center mt-2 space-x-4 flex-wrap">
                                <span class="text-sm text-gray-600">${comm.publisher?.email || 'Sistema'}</span>
                                <span class="text-sm text-gray-500">${formatDate(comm.created_at)}</span>
                                <span class="text-sm font-medium text-gray-600 capitalize">${comm.tipo}</span>
                                <span class="text-sm text-gray-500 capitalize">${comm.destinatari}</span>
                                ${allegatiCount > 0 ? `<span class="text-sm text-gray-500"><i data-lucide="paperclip" class="w-3 h-3 inline mr-1"></i>${allegatiCount} allegati</span>` : ''}
                            </div>
                            ${comm.stato !== 'bozza' ? `
                            <div class="flex items-center mt-3 space-x-3 text-xs">
                                <span class="flex items-center gap-1 px-2 py-1 bg-green-50 text-green-700 rounded cursor-pointer hover:bg-green-100" title="Clicca per vedere chi ha letto" onclick="toggleReadDetails('${comm.id}')">
                                    <i data-lucide="eye" class="w-3 h-3"></i>
                                    <span class="font-medium">${lettaCount}</span>
                                </span>
                                <span class="flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded cursor-pointer hover:bg-blue-100" title="Clicca per vedere chi ha archiviato" onclick="toggleArchivedDetails('${comm.id}')">
                                    <i data-lucide="archive" class="w-3 h-3"></i>
                                    <span class="font-medium">${archiviataCount}</span>
                                </span>
                                ${eliminataCount > 0 ? `
                                <span class="flex items-center gap-1 px-2 py-1 bg-red-50 text-red-700 rounded cursor-pointer hover:bg-red-100" title="Clicca per vedere chi ha eliminato" onclick="toggleDeletedDetails('${comm.id}')">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    <span class="font-medium">${eliminataCount}</span>
                                </span>
                                ` : ''}
                                ${totalEngagement > 0 ? `
                                <span class="text-gray-500">â€¢</span>
                                <span class="text-gray-600">Engagement: <span class="font-semibold">${totalEngagement}</span> interazioni</span>
                                ` : ''}
                            </div>
                            
                            <!-- Dettagli espandibili -->
                            <div id="details-${comm.id}" class="mt-3 hidden">
                                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                                    <!-- Lette da -->
                                    <div id="read-details-${comm.id}" class="hidden">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i data-lucide="eye" class="w-4 h-4 text-green-600"></i>
                                            <h5 class="font-semibold text-sm text-gray-700">Letta da (${lettaCount}):</h5>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            ${comm.letta_da?.map(userId => `<span class="px-2 py-1 bg-white border border-green-200 text-green-700 rounded text-xs user-badge" data-user-id="${userId}">Caricamento...</span>`).join('') || '<span class="text-gray-500 text-xs">Nessuno</span>'}
                                        </div>
                                    </div>
                                    
                                    <!-- Archiviate da -->
                                    <div id="archived-details-${comm.id}" class="hidden">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i data-lucide="archive" class="w-4 h-4 text-blue-600"></i>
                                            <h5 class="font-semibold text-sm text-gray-700">Archiviata da (${archiviataCount}):</h5>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            ${comm.archiviata_da?.map(userId => `<span class="px-2 py-1 bg-white border border-blue-200 text-blue-700 rounded text-xs user-badge" data-user-id="${userId}">Caricamento...</span>`).join('') || '<span class="text-gray-500 text-xs">Nessuno</span>'}
                                        </div>
                                    </div>
                                    
                                    <!-- Eliminate da -->
                                    ${eliminataCount > 0 ? `
                                    <div id="deleted-details-${comm.id}" class="hidden">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i>
                                            <h5 class="font-semibold text-sm text-gray-700">Eliminata da (${eliminataCount}):</h5>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            ${comm.eliminata_da?.map(item => `<span class="px-2 py-1 bg-white border border-red-200 text-red-700 rounded text-xs user-badge" data-user-id="${item.user_id}">Caricamento...</span>`).join('') || '<span class="text-gray-500 text-xs">Nessuno</span>'}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4 flex-shrink-0">
                        <button onclick="viewCommunication('${comm.id}')" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Visualizza">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                        <button onclick="editCommunication('${comm.id}')" class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Modifica">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        ${comm.stato === 'bozza' ? `
                            <button onclick="sendCommunication('${comm.id}')" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Invia">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        ` : ''}
                        <button onclick="deleteCommunication('${comm.id}')" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Elimina">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;

            return commDiv;
        }

        async function getFilteredCommunications() {
            const communications = await window.dataManager.getComunicazioni();
            const searchTerm = document.getElementById('searchCommunications').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;

            return communications.filter(comm => {
                const matchesSearch = comm.titolo.toLowerCase().includes(searchTerm) || 
                                    comm.contenuto.toLowerCase().includes(searchTerm) ||
                                    comm.autore.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || comm.tipo === typeFilter;
                const matchesStatus = !statusFilter || comm.stato === statusFilter;
                const matchesPriority = !priorityFilter || comm.priorita === priorityFilter;

                return matchesSearch && matchesType && matchesStatus && matchesPriority;
            });
        }

        function setupFilters() {
            const searchInput = document.getElementById('searchCommunications');
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const priorityFilter = document.getElementById('priorityFilter');

            [searchInput, typeFilter, statusFilter, priorityFilter].forEach(element => {
                element.addEventListener('input', loadCommunications);
                element.addEventListener('change', loadCommunications);
            });
        }

        function openNewCommunicationModal() {
            editingCommunicationId = null; // Reset editing state
            document.getElementById('communicationModal').classList.remove('hidden');
            document.getElementById('commContent').focus();
            
            // Reset modal title
            document.querySelector('#communicationModal h3').textContent = 'Nuova Comunicazione';
            
            // Load users for specific selection
            loadUsersForSelection();
            
            lucide.createIcons();
        }

        async function loadUsersForSelection() {
            try {
                const users = await window.CommunicationsAPI.getAllUsers();
                const usersList = document.getElementById('specificUsersList');
                
                if (!users || users.length === 0) {
                    usersList.innerHTML = '<p class="text-sm text-gray-500 p-2">Nessun utente disponibile</p>';
                    return;
                }

                usersList.innerHTML = users.map(user => `
                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                        <input type="checkbox" 
                               class="user-checkbox mr-3 h-4 w-4 text-blue-600 rounded" 
                               value="${user.id}"
                               onchange="updateSelectedUsersCount()">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="text-xs font-medium text-blue-600">${(user.nome?.[0] || '') + (user.cognome?.[0] || '')}</span>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${user.nome || ''} ${user.cognome || ''}</div>
                                <div class="text-xs text-gray-500">${user.email || ''}</div>
                            </div>
                        </div>
                    </label>
                `).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('specificUsersList').innerHTML = 
                    '<p class="text-sm text-red-500 p-2">Errore nel caricamento degli utenti</p>';
            }
        }

        function toggleSpecificUsers() {
            const specificRadio = document.getElementById('specific');
            const container = document.getElementById('specificUsersContainer');
            
            if (specificRadio.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                // Deselect all users when hiding
                deselectAllUsers();
            }
        }

        function selectAllUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedUsersCount();
        }

        function deselectAllUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedUsersCount();
        }

        function updateSelectedUsersCount() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = checkboxes.length;
            const countEl = document.getElementById('selectedUsersCount');
            countEl.textContent = `${count} utente${count !== 1 ? 'i' : ''} selezionato${count !== 1 ? 'i' : ''}`;
        }
        
        // ============================================
        // SURVEY OPTIONS MANAGEMENT
        // ============================================
        
        function toggleSurveyOptions() {
            const typeSelect = document.getElementById('commType');
            const surveyContainer = document.getElementById('surveyOptionsContainer');
            
            if (typeSelect.value === 'sondaggio') {
                surveyContainer.classList.remove('hidden');
            } else {
                surveyContainer.classList.add('hidden');
            }
            
            lucide.createIcons();
        }
        
        function addSurveyOption() {
            const optionsList = document.getElementById('surveyOptionsList');
            const optionCount = optionsList.children.length + 1;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'flex gap-2';
            optionDiv.innerHTML = `
                <input type="text" placeholder="Opzione ${optionCount}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg survey-option">
                <button type="button" onclick="removeSurveyOption(this)" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            
            optionsList.appendChild(optionDiv);
            lucide.createIcons();
        }
        
        function removeSurveyOption(button) {
            const optionDiv = button.parentElement;
            const optionsList = document.getElementById('surveyOptionsList');
            
            // Keep at least 2 options
            if (optionsList.children.length > 2) {
                optionDiv.remove();
            }
        }
        
        function getSurveyData() {
            const question = document.getElementById('surveyQuestion').value.trim();
            const multiple = document.getElementById('surveyMultiple').checked;
            const optionInputs = document.querySelectorAll('.survey-option');
            const options = Array.from(optionInputs)
                .map(input => input.value.trim())
                .filter(opt => opt.length > 0);
            
            if (options.length < 2) {
                return null;
            }
            
            return {
                domanda: question || 'Fai la tua scelta:',
                opzioni: options,
                multipla: multiple
            };
        }

        function closeCommunicationModal() {
            editingCommunicationId = null; // Reset editing state
            document.getElementById('communicationModal').classList.add('hidden');
            document.getElementById('communicationForm').reset();
            document.getElementById('commContent').innerHTML = '';
            uploadedFiles = [];
            document.getElementById('fileList').innerHTML = '';
        }

        function createQuickAnnouncement() {
            openNewCommunicationModal();
            document.getElementById('commType').value = 'annuncio';
            document.getElementById('commPriority').value = 'alta';
            document.getElementById('commTitle').value = 'Annuncio Urgente';
        }

        function createNewsletter() {
            openNewCommunicationModal();
            document.getElementById('commType').value = 'newsletter';
            document.getElementById('commPriority').value = 'media';
            document.getElementById('commTitle').value = 'Newsletter ' + new Date().toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
        }

        function createEventInvite() {
            openNewCommunicationModal();
            document.getElementById('commType').value = 'evento';
            document.getElementById('commPriority').value = 'media';
            document.getElementById('commTitle').value = 'Invito Evento';
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('commContent').focus();
        }

        function insertLink() {
            const url = prompt('Inserisci URL:');
            if (url) {
                document.execCommand('createLink', false, url);
            }
            document.getElementById('commContent').focus();
        }

        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;
            
            // Show loading
            const fileList = document.getElementById('fileList');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'text-sm text-gray-600 py-2';
            loadingEl.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline animate-spin"></i> Caricamento file...';
            fileList.appendChild(loadingEl);
            lucide.createIcons();
            
            try {
                // Upload to Supabase Storage
                const uploadedData = await window.StorageAPI.uploadFiles(files, 'communications');
                
                // Add to uploaded files array with full data
                uploadedData.forEach(fileData => {
                    uploadedFiles.push(fileData);
                });
                
                // Refresh file list
                loadFileList();
                showNotification(`${files.length} file caricati con successo!`, 'success');
            } catch (error) {
                console.error('Error uploading files:', error);
                showNotification('Errore durante il caricamento dei file', 'error');
                loadFileList(); // Remove loading
            }
        }

        function removeFile(fileName) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
            loadFileList();
        }

        function loadFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            uploadedFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between bg-gray-100 p-2 rounded';
                const displayName = file.name || file;
                fileElement.innerHTML = `
                    <span class="text-sm">${displayName}</span>
                    <button onclick="removeFile('${displayName}')" type="button" class="text-red-500 hover:text-red-700">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                fileList.appendChild(fileElement);
            });
            lucide.createIcons();
        }

        let isSaving = false;

        async function saveDraft() {
            if (isSaving) {
                console.log('GiÃ  in salvataggio, ignoro');
                return;
            }
            
            isSaving = true;
            
            try {
                const formData = getFormData();
                
                // Validate specific users selection
                if (formData.destinatari === 'specifici' && (!formData.destinatari_specifici || formData.destinatari_specifici.length === 0)) {
                    showNotification('Seleziona almeno un utente specifico', 'error');
                    isSaving = false;
                    return;
                }
                
                // Map form data to database schema
                const commData = {
                    titolo: formData.titolo,
                    tipo: formData.tipo,
                    priorita: formData.priorita,
                    contenuto: formData.contenuto,
                    destinatari: formData.destinatari,
                    destinatari_specifici: formData.destinatari_specifici,
                    allegati: formData.allegati.length > 0 ? JSON.stringify(formData.allegati) : '[]',
                    data_programmata: formData.data_programmata,
                    stato: 'bozza',
                    data_invio: null
                };
                
                // Save to Supabase
                await window.dataManager.saveComunicazione(commData);
                
                closeCommunicationModal();
                await loadCommunications();
                await updateStats();
                showNotification('Bozza salvata con successo!', 'success');
            } finally {
                isSaving = false;
            }
        }

        function previewCommunication() {
            const formData = getFormData();
            const previewContent = document.getElementById('previewContent');
            
            // Mappa destinatari per visualizzazione
            const destinatariMap = {
                'tutti': 'Tutti',
                'dipendenti': 'Tutti i Dipendenti',
                'admin': 'Solo Manager',
                'specifici': 'Utenti Specifici'
            };
            
            // Get selected users names if specific
            let specificUsersText = '';
            if (formData.destinatari === 'specifici' && formData.destinatari_specifici?.length > 0) {
                const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
                const userNames = Array.from(selectedCheckboxes).map(cb => {
                    const label = cb.closest('label');
                    const nameDiv = label.querySelector('.text-sm.font-medium');
                    return nameDiv ? nameDiv.textContent : '';
                }).filter(n => n);
                
                specificUsersText = `<div class="mt-2 text-sm text-gray-600">
                    <strong>Utenti selezionati (${userNames.length}):</strong>
                    <ul class="ml-4 mt-1 list-disc">
                        ${userNames.map(name => `<li>${name}</li>`).join('')}
                    </ul>
                </div>`;
            }
            
            previewContent.innerHTML = `
                <div class="space-y-6">
                    <div class="border-b pb-4">
                        <h2 class="text-2xl font-bold text-gray-900">${formData.titolo}</h2>
                        <div class="mt-2 text-sm text-gray-600">
                            <div class="flex items-center space-x-4">
                                <span>Tipo: ${formData.tipo}</span>
                                <span>PrioritÃ : ${formData.priorita}</span>
                                <span>Destinatari: ${destinatariMap[formData.destinatari] || formData.destinatari}</span>
                            </div>
                            ${specificUsersText}
                        </div>
                    </div>
                    <div class="prose max-w-none">
                        ${formData.contenuto}
                    </div>
                    ${formData.allegati.length ? `
                        <div class="border-t pt-4">
                            <h4 class="font-medium mb-2">Allegati:</h4>
                            <ul class="space-y-1">
                                ${formData.allegati.map(file => `<li class="text-sm text-gray-600">ðŸ“Ž ${file}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function sendFromPreview() {
            sendCommunicationNow();
            closePreviewModal();
        }

        async function sendCommunicationNow() {
            const formData = getFormData();
            
            // Validate specific users selection
            if (formData.destinatari === 'specifici' && (!formData.destinatari_specifici || formData.destinatari_specifici.length === 0)) {
                showNotification('Seleziona almeno un utente specifico', 'error');
                return;
            }
            
            // Map form data to database schema with all required fields
            const commData = {
                titolo: formData.titolo,
                tipo: formData.tipo,
                priorita: formData.priorita,
                contenuto: formData.contenuto,
                destinatari: formData.destinatari,
                destinatari_specifici: formData.destinatari_specifici,
                allegati: formData.allegati.length > 0 ? JSON.stringify(formData.allegati) : '[]',
                data_programmata: formData.data_programmata,
                stato: formData.stato,
                data_invio: formData.stato === 'inviata' ? new Date().toISOString() : null
            };
            
            // Save to Supabase (pubblicato_da sarÃ  aggiunto automaticamente da dataManager)
            await window.dataManager.saveComunicazione(commData);
            
            await loadCommunications();
            await updateStats();
            
            document.getElementById('communicationForm').reset();
            document.getElementById('commContent').innerHTML = '';
            uploadedFiles = [];
            document.getElementById('fileList').innerHTML = '';
            
            showNotification('Comunicazione inviata!', 'success');
        }

        function getFormData() {
            // Get recipient type
            let recipientType = 'tutti';
            let specificUserIds = [];
            
            if (document.getElementById('allEmployees').checked) {
                recipientType = 'tutti';
            } else if (document.getElementById('managers').checked) {
                recipientType = 'admin';
            } else if (document.getElementById('specific').checked) {
                recipientType = 'specifici';
                // Get selected user IDs
                const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
                specificUserIds = Array.from(checkedBoxes).map(cb => cb.value);
            }
            
            const scheduleDate = document.getElementById('commSchedule').value;
            
            return {
                titolo: document.getElementById('commTitle').value,
                tipo: document.getElementById('commType').value, // annuncio, newsletter, evento, formazione, procedura
                priorita: document.getElementById('commPriority').value, // bassa, media, alta
                contenuto: document.getElementById('commContent').innerHTML,
                destinatari: recipientType,
                destinatari_specifici: specificUserIds.length > 0 ? specificUserIds : null, // Array of user IDs
                allegati: uploadedFiles, // Save complete file data with URLs
                data_programmata: scheduleDate ? new Date(scheduleDate).toISOString() : null,
                stato: scheduleDate ? 'programmata' : 'inviata' // Se ha data futura = programmata, altrimenti inviata subito
            };
        }

        async function updateStats() {
            const communications = await window.dataManager.getComunicazioni();
            const total = communications.length;
            const today = new Date().toISOString().split('T')[0];
            const sentToday = communications.filter(c => c.data_invio === today).length;
            const scheduled = communications.filter(c => c.stato === 'programmata').length;
            const drafts = communications.filter(c => c.stato === 'bozza').length;

            const totalEl = document.getElementById('totalCommunications');
            const sentEl = document.getElementById('sentToday');
            const scheduledEl = document.getElementById('scheduled');
            const draftsEl = document.getElementById('drafts');

            if (totalEl) totalEl.textContent = total;
            if (sentEl) sentEl.textContent = sentToday;
            if (scheduledEl) scheduledEl.textContent = scheduled;
            if (draftsEl) draftsEl.textContent = drafts;
        }

        async function viewCommunication(id) {
            const communications = await window.dataManager.getComunicazioni();
            const comm = communications.find(c => c.id === id);
            if (!comm) {
                showNotification('Comunicazione non trovata', 'error');
                return;
            }
            
            // Parse allegati
            let allegatiArray = [];
            if (comm.allegati) {
                try {
                    allegatiArray = typeof comm.allegati === 'string' ? JSON.parse(comm.allegati) : comm.allegati;
                } catch (e) {
                    console.error('Error parsing allegati:', e);
                }
            }
            
            // Build content
            const content = `
                <div class="space-y-6">
                    <!-- Title and type -->
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h4 class="text-2xl font-bold text-gray-900">${comm.titolo}</h4>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                comm.tipo === 'annuncio' ? 'bg-blue-100 text-blue-800' :
                                comm.tipo === 'evento' ? 'bg-green-100 text-green-800' :
                                comm.tipo === 'newsletter' ? 'bg-purple-100 text-purple-800' :
                                'bg-gray-100 text-gray-800'
                            }">${comm.tipo}</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm text-gray-600">
                            <span class="flex items-center gap-1">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                ${new Date(comm.created_at).toLocaleDateString('it-IT')}
                            </span>
                            <span class="flex items-center gap-1">
                                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                PrioritÃ : <span class="font-medium ${
                                    comm.priorita === 'alta' ? 'text-red-600' :
                                    comm.priorita === 'media' ? 'text-orange-600' :
                                    'text-green-600'
                                }">${comm.priorita}</span>
                            </span>
                            <span class="flex items-center gap-1">
                                <i data-lucide="info" class="w-4 h-4"></i>
                                Stato: ${comm.stato}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="border-t pt-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Contenuto:</h5>
                        <div class="prose max-w-none bg-gray-50 p-4 rounded-lg">
                            ${comm.contenuto}
                        </div>
                    </div>
                    
                    <!-- Survey Results (if type is sondaggio) -->
                    ${comm.tipo === 'sondaggio' && comm.opzioni_sondaggio ? `
                    <div class="border-t pt-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-3">ðŸ“Š Risultati Sondaggio:</h5>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p class="font-medium text-gray-900 mb-1">${comm.opzioni_sondaggio.domanda}</p>
                            <p class="text-xs text-gray-600">${comm.opzioni_sondaggio.multipla ? 'Risposta multipla consentita' : 'Singola risposta'}</p>
                        </div>
                        ${(() => {
                            const risposte = comm.risposte_sondaggio || [];
                            const totalResponses = risposte.length;
                            const opzioni = comm.opzioni_sondaggio.opzioni || [];
                            
                            // Count votes for each option and track who voted
                            const voteCounts = {};
                            const voteUsers = {}; // Track user IDs per option
                            opzioni.forEach(opt => {
                                voteCounts[opt] = 0;
                                voteUsers[opt] = [];
                            });
                            
                            risposte.forEach(r => {
                                if (Array.isArray(r.risposta)) {
                                    r.risposta.forEach(ans => {
                                        if (voteCounts[ans] !== undefined) {
                                            voteCounts[ans]++;
                                            voteUsers[ans].push(r.user_id);
                                        }
                                    });
                                }
                            });
                            
                            const maxVotes = Math.max(...Object.values(voteCounts), 1);
                            
                            return `
                                <div class="space-y-4 mb-4">
                                    ${opzioni.map(opt => {
                                        const votes = voteCounts[opt];
                                        const percentage = totalResponses > 0 ? Math.round((votes / totalResponses) * 100) : 0;
                                        const barWidth = maxVotes > 0 ? (votes / maxVotes) * 100 : 0;
                                        const userIds = voteUsers[opt];
                                        
                                        return `
                                        <div class="bg-white border border-gray-200 rounded-lg p-3">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-medium text-gray-700">${opt}</span>
                                                <span class="text-sm text-gray-600 font-semibold">${votes} voti (${percentage}%)</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                                <div class="bg-blue-600 h-3 rounded-full transition-all" style="width: ${barWidth}%"></div>
                                            </div>
                                            ${votes > 0 ? `
                                            <div class="flex items-center gap-2 mt-2 pt-2 border-t border-gray-100">
                                                <div class="flex items-center gap-1 text-xs text-gray-500">
                                                    <i data-lucide="users" class="w-3 h-3"></i>
                                                    <span>Hanno votato:</span>
                                                </div>
                                                <div class="flex flex-wrap gap-1">
                                                    ${userIds.map(userId => `
                                                        <span class="survey-voter-badge inline-flex items-center gap-1 px-2 py-0.5 bg-blue-50 border border-blue-200 text-blue-700 rounded-full text-xs" data-user-id="${userId}">
                                                            <i data-lucide="user" class="w-3 h-3"></i>
                                                            <span class="voter-name">Caricamento...</span>
                                                        </span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            ` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                                    <strong>Totale risposte:</strong> ${totalResponses} su ${comm.letta_da?.length || 0} visualizzazioni
                                </div>
                            `;
                        })()}
                    </div>
                    ` : ''}
                    
                    <!-- Recipients -->
                    <div class="border-t pt-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Destinatari:</h5>
                        <p class="text-gray-600">${comm.destinatari}</p>
                    </div>
                    
                    <!-- Scheduled date -->
                    ${comm.data_programmata ? `
                    <div class="border-t pt-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Data programmata:</h5>
                        <p class="text-gray-600">${new Date(comm.data_programmata).toLocaleString('it-IT')}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Attachments -->
                    ${allegatiArray.length > 0 ? `
                    <div class="border-t pt-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Allegati (${allegatiArray.length}):</h5>
                        <div class="space-y-2">
                            ${allegatiArray.map(fileData => {
                                const fileName = typeof fileData === 'string' ? fileData : fileData.name;
                                const fileUrl = typeof fileData === 'object' && fileData.url ? fileData.url : null;
                                return `
                                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="file" class="w-4 h-4 text-gray-500"></i>
                                        <span class="text-sm text-gray-700">${fileName}</span>
                                    </div>
                                    ${fileUrl ? `
                                    <a href="${fileUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        Visualizza
                                    </a>
                                    ` : `
                                    <span class="text-gray-400 text-sm">Non disponibile</span>
                                    `}
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('viewCommunicationContent').innerHTML = content;
            document.getElementById('viewCommunicationModal').classList.remove('hidden');
            lucide.createIcons();
            
            // Load voter names for survey results
            if (comm.tipo === 'sondaggio' && comm.risposte_sondaggio?.length > 0) {
                await loadSurveyVoterNames();
            }
        }
        
        async function loadSurveyVoterNames() {
            const voterBadges = document.querySelectorAll('.survey-voter-badge');
            
            for (const badge of voterBadges) {
                const userId = badge.dataset.userId;
                const nameSpan = badge.querySelector('.voter-name');
                
                if (userId && nameSpan) {
                    const userName = await loadUserName(userId);
                    nameSpan.textContent = userName;
                }
            }
            
            lucide.createIcons();
        }
        
        function closeViewCommunicationModal() {
            document.getElementById('viewCommunicationModal').classList.add('hidden');
        }

        let editingCommunicationId = null;

        async function editCommunication(id) {
            const communications = await window.dataManager.getComunicazioni();
            const comm = communications.find(c => c.id === id);
            if (!comm) {
                showNotification('Comunicazione non trovata', 'error');
                return;
            }
            
            editingCommunicationId = id;
            openNewCommunicationModal();
            
            // Popola tutti i campi del form
            document.getElementById('commTitle').value = comm.titolo || '';
            document.getElementById('commType').value = comm.tipo || '';
            document.getElementById('commPriority').value = comm.priorita || 'media';
            document.getElementById('commContent').innerHTML = comm.contenuto || '';
            
            // Programma data
            if (comm.data_programmata) {
                const date = new Date(comm.data_programmata);
                const formatted = date.toISOString().slice(0, 16);
                document.getElementById('commSchedule').value = formatted;
            }
            
            // Destinatari
            const destinatariMap = {
                'dipendenti': 'allEmployees',
                'admin': 'managers',
                'specifici': 'specific',
                'tutti': null
            };
            
            // Reset checkboxes
            document.getElementById('allEmployees').checked = false;
            document.getElementById('managers').checked = false;
            document.getElementById('specific').checked = false;
            
            // Set checkbox
            const checkboxId = destinatariMap[comm.destinatari];
            if (checkboxId) {
                document.getElementById(checkboxId).checked = true;
            }
            
            // Allegati
            if (comm.allegati) {
                try {
                    const allegatiArray = typeof comm.allegati === 'string' ? JSON.parse(comm.allegati) : comm.allegati;
                    // Check if allegati are already objects with url/name, or just strings (old format)
                    uploadedFiles = allegatiArray.map(item => {
                        if (typeof item === 'string') {
                            // Old format: just filename
                            return { name: item };
                        } else {
                            // New format: full object with url, name, etc.
                            return item;
                        }
                    });
                    loadFileList();
                } catch (e) {
                    console.error('Error parsing allegati:', e);
                }
            }
            
            // Cambia il titolo della modale
            document.querySelector('#communicationModal h3').textContent = 'Modifica Comunicazione';
        }

        async function sendCommunication(id) {
            const communications = await window.dataManager.getComunicazioni();
            const comm = communications.find(c => c.id === id);
            if (comm) {
                await window.CommunicationsAPI.update(id, {
                    stato: 'inviata',
                    data_invio: new Date().toISOString().split('T')[0]
                });
                
                await loadCommunications();
                await updateStats();
                showNotification('Comunicazione inviata!', 'success');
            }
        }

        async function deleteCommunication(id) {
            // Get communication details for confirmation
            const communications = await window.dataManager.getComunicazioni();
            const comm = communications.find(c => c.id === id);
            
            if (!comm) {
                showNotification('Comunicazione non trovata', 'error');
                return;
            }
            
            // Create modal for confirmation
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
                    <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                        <i data-lucide="trash-2" class="w-8 h-8 text-red-600"></i>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-900 text-center mb-2">Conferma Eliminazione</h3>
                    <p class="text-gray-700 mb-4 text-center">Sei sicuro di voler ELIMINARE DEFINITIVAMENTE questa comunicazione?</p>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-4 space-y-2">
                        <div>
                            <span class="text-sm font-medium text-gray-600">Titolo:</span>
                            <span class="text-sm text-gray-900 ml-2">${comm.titolo}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Tipo:</span>
                            <span class="text-sm text-gray-900 ml-2">${comm.tipo}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Data:</span>
                            <span class="text-sm text-gray-900 ml-2">${new Date(comm.created_at).toLocaleDateString('it-IT')}</span>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-6">
                        <p class="text-sm text-red-800">
                            <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                            <strong>ATTENZIONE:</strong> Questa azione NON puÃ² essere annullata!<br>
                            La comunicazione verrÃ  eliminata permanentemente dal sistema.
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Annulla
                        </button>
                        <button onclick="confirmDeleteCommunication('${id}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                            Ok
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        async function confirmDeleteCommunication(id) {
            // Remove modal
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();
            
            try {
                await window.CommunicationsAPI.delete(id);
                await loadCommunications();
                await updateStats();
                showNotification('âœ… Comunicazione eliminata definitivamente con successo!', 'success');
            } catch (error) {
                console.error('Errore eliminazione comunicazione:', error);
                showNotification('âŒ Errore durante l\'eliminazione della comunicazione', 'error');
            }
        }

        // Form submission
        document.getElementById('communicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isSaving) {
                console.log('GiÃ  in salvataggio, ignoro');
                return;
            }
            
            isSaving = true;
            
            try {
                const formData = getFormData();
                
                // Map form data to database schema with all required fields
                const commData = {
                    titolo: formData.titolo,
                    tipo: formData.tipo,
                    priorita: formData.priorita,
                    contenuto: formData.contenuto,
                    destinatari: formData.destinatari,
                    allegati: formData.allegati.length > 0 ? JSON.stringify(formData.allegati) : '[]',
                    data_programmata: formData.data_programmata,
                    stato: formData.stato,
                    data_invio: formData.stato === 'inviata' ? new Date().toISOString() : null
                };
                
                // Add survey data if type is sondaggio
                if (formData.tipo === 'sondaggio') {
                    const surveyData = getSurveyData();
                    if (!surveyData || surveyData.opzioni.length < 2) {
                        showNotification('Aggiungi almeno 2 opzioni al sondaggio', 'error');
                        isSaving = false;
                        return;
                    }
                    commData.opzioni_sondaggio = surveyData;
                    commData.risposte_sondaggio = [];
                }
                
                // If editing, update existing communication
                if (editingCommunicationId) {
                    await window.CommunicationsAPI.update(editingCommunicationId, commData);
                    showNotification('Comunicazione aggiornata con successo!', 'success');
                } else {
                    // Otherwise create new
                    await window.dataManager.saveComunicazione(commData);
                    showNotification('Comunicazione inviata con successo!', 'success');
                }
                
                // Reset editing state
                editingCommunicationId = null;
                
                await loadCommunications();
                await updateStats();
                
                this.reset();
                document.getElementById('commContent').innerHTML = '';
                uploadedFiles = [];
                document.getElementById('fileList').innerHTML = '';
                closeCommunicationModal();
            } catch (error) {
                console.error('Errore invio comunicazione:', error);
                showNotification('Errore durante l\'invio della comunicazione', 'error');
            } finally {
                isSaving = false;
            }
        });

        // Utility functions
        function getStatusClass(status) {
            switch(status) {
                case 'bozza': return 'bg-gray-100 text-gray-800';
                case 'programmata': return 'bg-orange-100 text-orange-800';
                case 'inviata': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'bozza': return 'Bozza';
                case 'programmata': return 'Programmata';
                case 'inviata': return 'Inviata';
                default: return status;
            }
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'alta': return 'priority-alta';
                case 'media': return 'priority-media';
                case 'bassa': return 'priority-bassa';
                default: return '';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'alta': return 'bg-red-100 text-red-800';
                case 'media': return 'bg-yellow-100 text-yellow-800';
                case 'bassa': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getTypeIcon(type) {
            switch(type) {
                case 'annuncio': return 'megaphone';
                case 'newsletter': return 'newspaper';
                case 'evento': return 'calendar';
                case 'formazione': return 'graduation-cap';
                case 'procedura': return 'file-text';
                case 'sondaggio': return 'bar-chart-2';
                default: return 'message-circle';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-blue-500'} text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // User Deletions Tracking Functions
        let allDeletionsData = []; // Store all deletions for filtering

        async function toggleDeletionsSection() {
            const section = document.getElementById('deletionsSection');
            const isHidden = section.classList.contains('hidden');
            
            if (isHidden) {
                section.classList.remove('hidden');
                await loadUserDeletions();
            } else {
                section.classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        async function loadUserDeletions() {
            const deletionsList = document.getElementById('deletionsList');
            deletionsList.innerHTML = '<div class="p-6 text-center text-gray-500">Caricamento...</div>';

            try {
                const deletions = await window.CommunicationsAPI.getDeletions();
                allDeletionsData = deletions || []; // Store for filtering
                
                if (!deletions || deletions.length === 0) {
                    deletionsList.innerHTML = '<div class="p-6 text-center text-gray-500">Nessuna eliminazione registrata</div>';
                    populateUserFilter([]);
                    return;
                }

                // Populate user filter dropdown
                populateUserFilter(deletions);

                // Initial display
                renderDeletions(deletions);
                
                lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento eliminazioni:', error);
                deletionsList.innerHTML = '<div class="p-6 text-center text-red-500">Errore caricamento eliminazioni</div>';
            }
        }

        function createDeletionElement(comm) {
            const deletionDiv = document.createElement('div');
            deletionDiv.className = 'p-6 hover:bg-gray-50 transition-colors';
            
            const typeIcon = getTypeIcon(comm.tipo);
            const eliminataData = Array.isArray(comm.eliminata_da) ? comm.eliminata_da : [];
            
            const deletionRows = eliminataData.map(deletion => {
                const deletedDate = new Date(deletion.deleted_at);
                const formattedDate = deletedDate.toLocaleString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Get user info if available
                const userName = deletion.user ? `${deletion.user.nome} ${deletion.user.cognome}` : 'Utente sconosciuto';
                const userEmail = deletion.user ? deletion.user.email : deletion.user_id.substring(0, 8) + '...';
                
                return `
                    <div class="flex items-center justify-between py-3 px-4 bg-red-50 rounded-lg border border-red-100">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-8 h-8 bg-red-200 rounded-full flex items-center justify-center">
                                <i data-lucide="user-x" class="w-4 h-4 text-red-700"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-900">${userName}</p>
                                <p class="text-xs text-gray-600">${userEmail}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-right">
                            <div>
                                <p class="text-xs text-gray-500">Eliminata il</p>
                                <p class="text-sm font-medium text-gray-900">${formattedDate}</p>
                            </div>
                            <i data-lucide="clock" class="w-4 h-4 text-gray-400 ml-2"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            deletionDiv.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="${typeIcon}" class="w-5 h-5 text-red-600"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="text-lg font-medium text-gray-900">${comm.titolo}</h4>
                            <span class="text-xs text-gray-500 capitalize">${comm.tipo}</span>
                        </div>
                        <div class="mb-3">
                            <p class="text-sm text-gray-600">
                                <i data-lucide="calendar" class="w-3 h-3 inline mr-1"></i>
                                Creata il: ${formatDate(comm.created_at)}
                            </p>
                        </div>
                        <div class="space-y-2">
                            <p class="text-sm font-medium text-gray-700 mb-2">
                                <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                                Eliminata da ${eliminataData.length} utente${eliminataData.length > 1 ? 'i' : ''}:
                            </p>
                            ${deletionRows}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="viewCommunication('${comm.id}')" 
                                class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                title="Visualizza comunicazione">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;

            return deletionDiv;
        }

        // Export deletions to CSV for audit trail
        async function exportDeletionsToCSV() {
            try {
                const deletions = await window.CommunicationsAPI.getDeletions();
                
                if (!deletions || deletions.length === 0) {
                    showNotification('Nessuna eliminazione da esportare', 'info');
                    return;
                }

                // Build CSV content
                const csvRows = [];
                
                // Header
                csvRows.push(['Comunicazione ID', 'Titolo', 'Tipo', 'Data Creazione', 'Utente', 'Email Utente', 'Data Eliminazione'].join(','));
                
                // Data rows
                deletions.forEach(comm => {
                    const eliminataData = Array.isArray(comm.eliminata_da) ? comm.eliminata_da : [];
                    eliminataData.forEach(deletion => {
                        const userName = deletion.user ? `${deletion.user.nome} ${deletion.user.cognome}` : 'Sconosciuto';
                        const userEmail = deletion.user ? deletion.user.email : deletion.user_id;
                        const deletedDate = new Date(deletion.deleted_at).toLocaleString('it-IT');
                        const createdDate = new Date(comm.created_at).toLocaleDateString('it-IT');
                        
                        csvRows.push([
                            `"${comm.id}"`,
                            `"${comm.titolo.replace(/"/g, '""')}"`,
                            `"${comm.tipo}"`,
                            `"${createdDate}"`,
                            `"${userName.replace(/"/g, '""')}"`,
                            `"${userEmail}"`,
                            `"${deletedDate}"`
                        ].join(','));
                    });
                });

                // Create CSV file and download
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `eliminazioni_comunicazioni_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('CSV esportato con successo!', 'success');
            } catch (error) {
                console.error('Errore export CSV:', error);
                showNotification('Errore durante l\'export', 'error');
            }
        }

        // Update deletions badge notification
        async function updateDeletionsBadge() {
            try {
                const deletions = await window.CommunicationsAPI.getDeletions();
                
                if (!deletions || deletions.length === 0) {
                    document.getElementById('deletionsBadge').classList.add('hidden');
                    return;
                }

                // Count deletions in last 24 hours
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                let recentDeletionsCount = 0;
                
                deletions.forEach(comm => {
                    const eliminataData = Array.isArray(comm.eliminata_da) ? comm.eliminata_da : [];
                    eliminataData.forEach(deletion => {
                        const deletedDate = new Date(deletion.deleted_at);
                        if (deletedDate >= oneDayAgo) {
                            recentDeletionsCount++;
                        }
                    });
                });

                const badge = document.getElementById('deletionsBadge');
                if (recentDeletionsCount > 0) {
                    badge.textContent = recentDeletionsCount;
                    badge.classList.remove('hidden');
                    badge.title = `${recentDeletionsCount} eliminazione${recentDeletionsCount > 1 ? 'i' : ''} nelle ultime 24 ore`;
                } else {
                    badge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Errore aggiornamento badge:', error);
            }
        }

        // Filter and render functions
        function populateUserFilter(deletions) {
            const userFilter = document.getElementById('deletionsUserFilter');
            const uniqueUsers = new Map();

            deletions.forEach(comm => {
                const eliminataData = Array.isArray(comm.eliminata_da) ? comm.eliminata_da : [];
                eliminataData.forEach(deletion => {
                    if (deletion.user_id && deletion.user) {
                        uniqueUsers.set(deletion.user_id, deletion.user);
                    }
                });
            });

            // Clear current options except "Tutti gli utenti"
            userFilter.innerHTML = '<option value="all">Tutti gli utenti</option>';

            // Add unique users sorted by name
            Array.from(uniqueUsers.entries())
                .sort((a, b) => {
                    const nameA = `${a[1].nome || ''} ${a[1].cognome || ''}`.trim();
                    const nameB = `${b[1].nome || ''} ${b[1].cognome || ''}`.trim();
                    return nameA.localeCompare(nameB);
                })
                .forEach(([userId, user]) => {
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = `${user.nome || ''} ${user.cognome || ''}`.trim() || 'Utente sconosciuto';
                    userFilter.appendChild(option);
                });
        }

        function applyDeletionsFilters() {
            const periodFilter = document.getElementById('deletionsPeriodFilter').value;
            const typeFilter = document.getElementById('deletionsTypeFilter').value;
            const userFilter = document.getElementById('deletionsUserFilter').value;
            const searchQuery = document.getElementById('deletionsSearchInput').value.toLowerCase().trim();
            const customDateRange = document.getElementById('customDateRange');

            // Show/hide custom date range
            if (periodFilter === 'custom') {
                customDateRange.classList.remove('hidden');
            } else {
                customDateRange.classList.add('hidden');
            }

            // Filter deletions
            let filteredDeletions = allDeletionsData.filter(comm => {
                // Search filter - check title, user names, and emails
                if (searchQuery) {
                    const titleMatch = (comm.titolo || '').toLowerCase().includes(searchQuery);
                    
                    const eliminataData = Array.isArray(comm.eliminata_da) ? comm.eliminata_da : [];
                    const userMatch = eliminataData.some(deletion => {
                        if (!deletion.user) return false;
                        const userName = `${deletion.user.nome || ''} ${deletion.user.cognome || ''}`.toLowerCase();
                        const userEmail = (deletion.user.email || '').toLowerCase();
                        return userName.includes(searchQuery) || userEmail.includes(searchQuery);
                    });

                    if (!titleMatch && !userMatch) {
                        return false;
                    }
                }

                // Type filter
                if (typeFilter !== 'all' && comm.tipo !== typeFilter) {
                    return false;
                }

                // User filter - check if any deletion matches the user
                if (userFilter !== 'all') {
                    const eliminataData = Array.isArray(comm.eliminata_da) ? comm.eliminata_da : [];
                    const hasUser = eliminataData.some(del => del.user_id === userFilter);
                    if (!hasUser) return false;
                }

                // Period filter
                const eliminataData = Array.isArray(comm.eliminata_da) ? comm.eliminata_da : [];
                if (eliminataData.length === 0) return false;

                let periodMatch = false;
                const now = new Date();

                eliminataData.forEach(deletion => {
                    const deletedDate = new Date(deletion.deleted_at);

                    switch (periodFilter) {
                        case 'all':
                            periodMatch = true;
                            break;
                        case 'today':
                            if (deletedDate.toDateString() === now.toDateString()) {
                                periodMatch = true;
                            }
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (deletedDate >= weekAgo) {
                                periodMatch = true;
                            }
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            if (deletedDate >= monthAgo) {
                                periodMatch = true;
                            }
                            break;
                        case 'custom':
                            const fromDate = document.getElementById('deletionsFromDate').value;
                            const toDate = document.getElementById('deletionsToDate').value;
                            if (fromDate && toDate) {
                                const from = new Date(fromDate);
                                const to = new Date(toDate);
                                to.setHours(23, 59, 59, 999); // Include full day
                                if (deletedDate >= from && deletedDate <= to) {
                                    periodMatch = true;
                                }
                            } else if (fromDate) {
                                const from = new Date(fromDate);
                                if (deletedDate >= from) {
                                    periodMatch = true;
                                }
                            } else if (toDate) {
                                const to = new Date(toDate);
                                to.setHours(23, 59, 59, 999);
                                if (deletedDate <= to) {
                                    periodMatch = true;
                                }
                            } else {
                                periodMatch = true; // No dates specified
                            }
                            break;
                    }
                });

                return periodMatch;
            });

            renderDeletions(filteredDeletions);
        }

        function renderDeletions(deletions) {
            const deletionsList = document.getElementById('deletionsList');
            
            if (deletions.length === 0) {
                deletionsList.innerHTML = '<div class="p-6 text-center text-gray-500">Nessun risultato trovato con i filtri applicati</div>';
                return;
            }

            deletionsList.innerHTML = '';
            deletions.forEach(comm => {
                const deletionEl = createDeletionElement(comm);
                deletionsList.appendChild(deletionEl);
            });

            lucide.createIcons();
        }
        
        // ============================================
        // TOGGLE ENGAGEMENT DETAILS
        // ============================================
        
        let loadedUserNames = {};
        
        async function loadUserName(userId) {
            if (loadedUserNames[userId]) {
                return loadedUserNames[userId];
            }
            
            try {
                const users = await window.dataManager.getUtenti();
                const user = users.find(u => u.id === userId);
                const name = user ? `${user.nome || ''} ${user.cognome || ''}`.trim() || user.email : 'Utente Sconosciuto';
                loadedUserNames[userId] = name;
                return name;
            } catch (error) {
                console.error('Error loading user:', error);
                return 'Utente';
            }
        }
        
        async function toggleReadDetails(commId) {
            const detailsContainer = document.getElementById(`details-${commId}`);
            const readDetails = document.getElementById(`read-details-${commId}`);
            const archivedDetails = document.getElementById(`archived-details-${commId}`);
            const deletedDetails = document.getElementById(`deleted-details-${commId}`);
            
            // Show main container
            detailsContainer.classList.remove('hidden');
            
            // Toggle read details
            if (readDetails.classList.contains('hidden')) {
                readDetails.classList.remove('hidden');
                // Load user names
                const badges = readDetails.querySelectorAll('.user-badge');
                
                for (const badge of badges) {
                    const userId = badge.dataset.userId;
                    const userName = await loadUserName(userId);
                    badge.textContent = userName;
                }
            } else {
                readDetails.classList.add('hidden');
            }
            
            // Hide others
            if (archivedDetails) archivedDetails.classList.add('hidden');
            if (deletedDetails) deletedDetails.classList.add('hidden');
            
            // If all hidden, hide container
            if (readDetails.classList.contains('hidden') && 
                (archivedDetails?.classList.contains('hidden') ?? true) && 
                (deletedDetails?.classList.contains('hidden') ?? true)) {
                detailsContainer.classList.add('hidden');
            }
            
            lucide.createIcons();
        }
        
        async function toggleArchivedDetails(commId) {
            const detailsContainer = document.getElementById(`details-${commId}`);
            const readDetails = document.getElementById(`read-details-${commId}`);
            const archivedDetails = document.getElementById(`archived-details-${commId}`);
            const deletedDetails = document.getElementById(`deleted-details-${commId}`);
            
            // Show main container
            detailsContainer.classList.remove('hidden');
            
            // Toggle archived details
            if (archivedDetails.classList.contains('hidden')) {
                archivedDetails.classList.remove('hidden');
                // Load user names
                const badges = archivedDetails.querySelectorAll('.user-badge');
                for (const badge of badges) {
                    const userId = badge.dataset.userId;
                    const userName = await loadUserName(userId);
                    badge.textContent = userName;
                }
            } else {
                archivedDetails.classList.add('hidden');
            }
            
            // Hide others
            readDetails.classList.add('hidden');
            if (deletedDetails) deletedDetails.classList.add('hidden');
            
            // If all hidden, hide container
            if (readDetails.classList.contains('hidden') && 
                archivedDetails.classList.contains('hidden') && 
                (deletedDetails?.classList.contains('hidden') ?? true)) {
                detailsContainer.classList.add('hidden');
            }
            
            lucide.createIcons();
        }
        
        async function toggleDeletedDetails(commId) {
            const detailsContainer = document.getElementById(`details-${commId}`);
            const readDetails = document.getElementById(`read-details-${commId}`);
            const archivedDetails = document.getElementById(`archived-details-${commId}`);
            const deletedDetails = document.getElementById(`deleted-details-${commId}`);
            
            // Show main container
            detailsContainer.classList.remove('hidden');
            
            // Toggle deleted details
            if (deletedDetails.classList.contains('hidden')) {
                deletedDetails.classList.remove('hidden');
                // Load user names
                const badges = deletedDetails.querySelectorAll('.user-badge');
                for (const badge of badges) {
                    const userId = badge.dataset.userId;
                    const userName = await loadUserName(userId);
                    badge.textContent = userName;
                }
            } else {
                deletedDetails.classList.add('hidden');
            }
            
            // Hide others
            readDetails.classList.add('hidden');
            archivedDetails.classList.add('hidden');
            
            // If all hidden, hide container
            if (readDetails.classList.contains('hidden') && 
                archivedDetails.classList.contains('hidden') && 
                deletedDetails.classList.contains('hidden')) {
                detailsContainer.classList.add('hidden');
            }
            
            lucide.createIcons();
        }
    </script>
</body>
</html>