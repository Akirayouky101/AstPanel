<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Miei Orari - AST Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./supabase-client.js"></script>
    <script src="./Admin/auth-helper.js"></script>
    <script src="./timbrature-service.js"></script>
    <style>
        /* Animazioni Custom */
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .animate-slideup { animation: slideInUp 0.5s ease-out; }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header con Glassmorphism -->
        <div class="glass-effect rounded-3xl shadow-2xl p-8 mb-8 animate-slideup">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-4xl md:text-5xl font-black gradient-text flex items-center justify-center md:justify-start gap-4 mb-2">
                        <i data-lucide="clock" class="w-12 h-12"></i>
                        I Miei Orari
                    </h1>
                    <p class="text-gray-600 text-lg" id="welcomeText">Bentornato</p>
                </div>
                <div class="text-center bg-gradient-to-br from-blue-500 to-purple-600 text-white rounded-2xl p-6 shadow-xl">
                    <div class="text-sm font-medium opacity-90">Oggi</div>
                    <div class="text-2xl font-bold" id="currentDate"></div>
                    <div class="text-3xl font-black mt-2" id="currentTime"></div>
                </div>
            </div>
        </div>

        <!-- Timbratura Veloce con Design Premium -->
        <div class="relative overflow-hidden bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 rounded-3xl shadow-2xl p-10 mb-8 animate-slideup">
            <!-- Effetto shimmer background -->
            <div class="absolute inset-0 shimmer opacity-20"></div>
            
            <div class="relative z-10 text-center">
                <div class="inline-flex items-center gap-3 bg-white/20 backdrop-blur-sm rounded-full px-6 py-3 mb-6">
                    <i data-lucide="zap" class="w-5 h-5 text-yellow-300"></i>
                    <h2 class="text-2xl font-bold text-white">Timbratura Rapida</h2>
                </div>
                
                <p class="text-white/90 text-lg mb-8 font-medium" id="statusText">Clicca per timbrare l'ingresso</p>
                
                <button id="timbraBtn" 
                    class="pulse-glow bg-white text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 hover:from-purple-600 hover:to-pink-600 font-black text-2xl py-8 px-16 rounded-full shadow-2xl transform hover:scale-110 transition-all duration-300 flex items-center gap-4 mx-auto border-4 border-white/50"
                    style="background: white;"
                    >
                    <i data-lucide="log-in" class="w-10 h-10 text-blue-600"></i>
                    <span id="timbraBtnText" class="text-blue-600 font-black">Timbra Ingresso</span>
                </button>

                <!-- Bottoni Pausa Premium -->
                <div id="pausaBtns" class="mt-6 hidden flex flex-wrap gap-4 justify-center">
                    <button id="timbraPausaInizioBtn" 
                        class="group bg-gradient-to-r from-amber-400 to-orange-500 text-white hover:from-amber-500 hover:to-orange-600 font-bold py-4 px-8 rounded-2xl shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center gap-3">
                        <div class="bg-white/20 p-2 rounded-full group-hover:rotate-12 transition-transform">
                            <i data-lucide="coffee" class="w-6 h-6"></i>
                        </div>
                        <span class="text-lg">Inizio Pausa</span>
                    </button>
                    <button id="timbraPausaFineBtn" 
                        class="group bg-gradient-to-r from-green-400 to-emerald-500 text-white hover:from-green-500 hover:to-emerald-600 font-bold py-4 px-8 rounded-2xl shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center gap-3 hidden">
                        <div class="bg-white/20 p-2 rounded-full group-hover:rotate-12 transition-transform">
                            <i data-lucide="play" class="w-6 h-6"></i>
                        </div>
                        <span class="text-lg">Fine Pausa</span>
                    </button>
                </div>

                <!-- Info Sessione Attiva con Glow Effect -->
                <div id="currentSessionInfo" class="mt-8 hidden animate-slideup">
                    <div class="bg-white/30 backdrop-blur-md rounded-2xl p-6 inline-block border-2 border-white/40 shadow-2xl">
                        <div class="flex items-center gap-6 text-white">
                            <div class="text-center">
                                <div class="text-xs opacity-80 mb-1">Ingresso</div>
                                <div class="text-2xl font-black" id="ingressoTime">--:--</div>
                            </div>
                            <div class="h-12 w-px bg-white/30"></div>
                            <div class="text-center">
                                <div class="text-xs opacity-80 mb-1">Ore Lavorate</div>
                                <div class="text-2xl font-black font-mono" id="oreLavorate">0:00:00</div>
                            </div>
                        </div>
                        <div id="pausaInfo" class="mt-4 pt-4 border-t border-white/20 hidden">
                            <div class="flex items-center gap-2 text-amber-200 font-semibold">
                                <i data-lucide="coffee" class="w-5 h-5"></i>
                                <span>In pausa da: <span id="pausaInizioTime" class="font-bold text-white ml-2"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Riepilogo Oggi e Mese con Cards Premium -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Card Oggi con Gradient Border -->
            <div class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-purple-600 rounded-3xl blur opacity-25 group-hover:opacity-50 transition duration-300"></div>
                <div class="relative glass-effect rounded-3xl shadow-xl p-8">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-purple-600 p-3 rounded-2xl">
                            <i data-lucide="calendar-days" class="w-7 h-7 text-white"></i>
                        </div>
                        <h3 class="text-2xl font-black text-gray-800">Oggi</h3>
                    </div>
                </h3>
                <div class="space-y-4">
                    <!-- Ingresso -->
                    <div class="flex justify-between items-center py-3 px-4 bg-gradient-to-r from-blue-50 to-transparent rounded-xl">
                        <span class="text-gray-600 font-medium flex items-center gap-2">
                            <i data-lucide="log-in" class="w-4 h-4 text-blue-500"></i>
                            Ingresso
                        </span>
                        <span class="font-bold text-lg text-gray-800" id="todayIngresso">--:--</span>
                    </div>
                    
                    <!-- Uscita -->
                    <div class="flex justify-between items-center py-3 px-4 bg-gradient-to-r from-purple-50 to-transparent rounded-xl">
                        <span class="text-gray-600 font-medium flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4 text-purple-500"></i>
                            Uscita
                        </span>
                        <span class="font-bold text-lg text-gray-800" id="todayUscita">--:--</span>
                    </div>
                    
                    <!-- Pausa con Effetto Speciale -->
                    <div class="relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-amber-400/20 to-orange-400/20 rounded-xl"></div>
                        <div class="relative flex justify-between items-center py-3 px-4 backdrop-blur-sm rounded-xl border-2 border-amber-200">
                            <span class="text-gray-700 font-bold flex items-center gap-2">
                                <i data-lucide="coffee" class="w-5 h-5 text-amber-600"></i>
                                Pausa
                            </span>
                            <div class="text-right">
                                <span class="font-black text-lg text-amber-700" id="todayPausa">--</span>
                                <div class="text-xs text-amber-600 font-medium" id="todayPausaDettaglio"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ore Lavorate con Badge -->
                    <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold flex items-center gap-2">
                                <i data-lucide="clock" class="w-5 h-5"></i>
                                Ore Lavorate (nette)
                            </span>
                            <span class="font-black text-3xl" id="todayOre">0h 0m</span>
                        </div>
                    </div>
                    
                    <!-- Guadagno con Gradient Speciale -->
                    <div class="relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-green-400 to-emerald-500 rounded-2xl animate-pulse"></div>
                        <div class="relative bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white shadow-2xl">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg flex items-center gap-2">
                                    <div class="bg-white/20 p-2 rounded-full">
                                        <i data-lucide="coins" class="w-5 h-5"></i>
                                    </div>
                                    Guadagno Oggi
                                </span>
                                <span class="font-black text-4xl" id="todayCost">‚Ç¨0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mese Corrente -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
            <!-- Card Mese con Gradient Border -->
            <div class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-3xl blur opacity-25 group-hover:opacity-50 transition duration-300"></div>
                <div class="relative glass-effect rounded-3xl shadow-xl p-8">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-3 rounded-2xl">
                            <i data-lucide="bar-chart-3" class="w-7 h-7 text-white"></i>
                        </div>
                        <h3 class="text-2xl font-black text-gray-800">Mese Corrente</h3>
                    </div>
                <div class="space-y-4">
                    <!-- Ore Ordinarie -->
                    <div class="flex justify-between items-center py-3 px-4 bg-gradient-to-r from-purple-50 to-transparent rounded-xl">
                        <span class="text-gray-600 font-medium flex items-center gap-2">
                            <i data-lucide="clock-3" class="w-4 h-4 text-purple-500"></i>
                            Ore Ordinarie
                        </span>
                        <span class="font-bold text-lg text-gray-800" id="monthOrdinary">0h</span>
                    </div>
                    
                    <!-- Ore Straordinarie con Badge Arancione -->
                    <div class="flex justify-between items-center py-3 px-4 bg-gradient-to-r from-orange-50 to-transparent rounded-xl border-l-4 border-orange-400">
                        <span class="text-gray-600 font-medium flex items-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4 text-orange-500"></i>
                            Ore Straordinarie
                        </span>
                        <span class="font-bold text-lg text-orange-600" id="monthExtra">0h</span>
                    </div>
                    
                    <!-- Permessi/Ferie -->
                    <div class="flex justify-between items-center py-3 px-4 bg-gradient-to-r from-green-50 to-transparent rounded-xl">
                        <span class="text-gray-600 font-medium flex items-center gap-2">
                            <i data-lucide="umbrella" class="w-4 h-4 text-green-500"></i>
                            Permessi/Ferie
                        </span>
                        <span class="font-bold text-lg text-green-600" id="monthLeave">0 giorni</span>
                    </div>
                    
                    <!-- Totale Ore con Gradient -->
                    <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold flex items-center gap-2">
                                <i data-lucide="calendar-check" class="w-5 h-5"></i>
                                Totale Ore
                            </span>
                            <span class="font-black text-3xl" id="monthTotal">0h</span>
                        </div>
                    </div>
                    
                    <!-- Guadagno Mensile con Gradient Viola/Rosa -->
                    <div class="relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-purple-400 to-pink-500 rounded-2xl animate-pulse"></div>
                        <div class="relative bg-gradient-to-br from-purple-500 via-fuchsia-500 to-pink-600 rounded-2xl p-5 text-white shadow-2xl">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg flex items-center gap-2">
                                    <div class="bg-white/20 p-2 rounded-full">
                                        <i data-lucide="wallet" class="w-5 h-5"></i>
                                    </div>
                                    Guadagno Mese
                                </span>
                                <span class="font-black text-4xl" id="monthCost">‚Ç¨0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Richiesta Variazione con Design Moderno -->
        <div class="relative group mb-8">
            <div class="absolute -inset-0.5 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-3xl blur opacity-20 group-hover:opacity-40 transition duration-300"></div>
            <div class="relative glass-effect rounded-3xl shadow-xl p-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="file-edit" class="w-6 h-6 text-orange-600"></i>
                Richiesta Variazione Orario
            </h3>
            <form id="variazioneForm" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo Variazione</label>
                        <select id="tipoVariazione" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleziona tipo...</option>
                            <option value="straordinario">üïê Straordinario</option>
                            <option value="permesso">üö™ Permesso</option>
                            <option value="ferie">üèñÔ∏è Ferie</option>
                            <option value="malattia">ü§í Malattia</option>
                            <option value="trasferta">üöó Trasferta</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                        <input type="date" id="dataVariazione" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ora Ingresso (opzionale)</label>
                        <input type="time" id="oraIngressoVariazione" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ora Uscita (opzionale)</label>
                        <input type="time" id="oraUscitaVariazione" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
                    <textarea id="noteVariazione" rows="3" placeholder="Motivazione della richiesta..." class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <i data-lucide="send" class="w-5 h-5"></i>
                    Invia Richiesta Approvazione
                </button>
            </form>
        </div>

        <!-- Storico Timbrature Mensili -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="list" class="w-6 h-6 text-green-600"></i>
                Dettaglio Mensile
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingresso</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uscita</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ore</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                        </tr>
                    </thead>
                    <tbody id="storicoBody" class="bg-white divide-y divide-gray-200">
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let todayTimbratura = null;
        let updateInterval = null;
        let authCheckInProgress = false; // Flag anti-loop

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ [ORARI-DIPENDENTE] Pagina caricata, inizio inizializzazione...');
            console.log('üîç [CHECK] Verifica disponibilit√† Supabase Client...');
            
            if (!window.supabaseClient) {
                console.error('‚ùå [FATAL] window.supabaseClient non disponibile!');
                alert('Errore critico: Client database non inizializzato. Ricarica la pagina.');
                return;
            }
            
            console.log('‚úÖ [CHECK] Supabase Client disponibile');
            
            // Verifica se siamo in un loop di redirect
            const redirectCount = parseInt(sessionStorage.getItem('orariRedirectCount') || '0');
            console.log('üîÑ [LOOP-CHECK] Contatore redirect:', redirectCount);
            
            if (redirectCount > 3) {
                console.error('‚ùå [FATAL] Loop di redirect rilevato! Blocco ulteriori tentativi.');
                alert('Errore: Loop di autenticazione rilevato. Contatta il supporto.');
                sessionStorage.removeItem('orariRedirectCount');
                return;
            }
            
            try {
                console.log('üîê [AUTH] Verifica autenticazione...');
                await checkAuth();
                
                // Reset contatore se auth OK
                sessionStorage.removeItem('orariRedirectCount');
                
                console.log('‚úÖ [AUTH] Autenticazione completata, utente:', currentUser?.nome);
                
                // Mostra pausa dell'utente
                const pausaMinuti = currentUser?.pausa_pranzo_minuti || 60;
                document.getElementById('todayPausa').textContent = pausaMinuti === 0 ? 'Nessuna' : `${pausaMinuti} min`;
                
                console.log('‚è∞ [INIT] Avvio caricamento dati...');
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // Richiedi permessi notifiche
                await window.timbratureService.requestNotificationPermission();
                
                console.log('ÔøΩ [DATA] Caricamento timbratura di oggi...');
                await loadTodayTimbratura();
                
                console.log('ÔøΩ [DATA] Caricamento riepilogo mensile...');
                await loadMonthSummary();
                
                console.log('üìã [DATA] Caricamento dettaglio mensile...');
                await loadMonthDetails();

                document.getElementById('timbraBtn').addEventListener('click', handleTimbratura);
                document.getElementById('timbraPausaInizioBtn').addEventListener('click', handlePausaInizio);
                document.getElementById('timbraPausaFineBtn').addEventListener('click', handlePausaFine);
                document.getElementById('variazioneForm').addEventListener('submit', handleVariazioneSubmit);
                
                lucide.createIcons();
                console.log('‚úÖ [INIT] Inizializzazione completata con successo!');
            } catch (error) {
                console.error('‚ùå [ERROR] Errore durante inizializzazione:', error);
            }
        });

        // Verifica autenticazione
        async function checkAuth() {
            if (authCheckInProgress) {
                console.warn('‚ö†Ô∏è [AUTH] Verifica gi√† in corso, skip...');
                return;
            }
            
            authCheckInProgress = true;
            console.log('üîç [AUTH] Controllo autenticazione...');
            
            try {
                // PRIORIT√Ä 1: Prova AuthHelper (login semplificato)
                if (window.AuthHelper && window.AuthHelper.isLoggedIn()) {
                    console.log('‚úÖ [AUTH] Utente trovato in AuthHelper (login semplificato)');
                    const user = window.AuthHelper.getCurrentUser();
                    
                    if (!user || !user.id) {
                        throw new Error('Dati utente non validi in AuthHelper');
                    }
                    
                    console.log('‚úÖ [AUTH] Utente:', user.nome, user.cognome, '- Ruolo:', user.ruolo);
                    currentUser = user;
                    document.getElementById('welcomeText').textContent = `Bentornato, ${user.nome} ${user.cognome}`;
                    sessionStorage.removeItem('orariRedirectCount');
                    return;
                }
                
                // PRIORIT√Ä 2: Prova Supabase Auth (login completo)
                console.log('üîç [AUTH] AuthHelper vuoto, provo Supabase Auth...');
                const { data: { session }, error: sessionError } = await window.supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.error('‚ùå [AUTH] Errore recupero sessione:', sessionError);
                    throw new Error('Errore di autenticazione: ' + sessionError.message);
                }
                
                if (!session) {
                    console.warn('‚ö†Ô∏è [AUTH] Nessuna sessione attiva (n√© AuthHelper n√© Supabase)');
                    throw new Error('Sessione non attiva. Effettua il login.');
                }

                console.log('‚úÖ [AUTH] Sessione Supabase trovata, user ID:', session.user.id);
                console.log('üë§ [DB] Caricamento dati utente dal database...');
                
                const { data: user, error: userError } = await window.supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (userError) {
                    console.error('‚ùå [DB] Errore caricamento utente:', userError);
                    throw new Error('Errore nel caricamento dati utente: ' + userError.message);
                }

                if (!user) {
                    console.error('‚ùå [DB] Utente non trovato nel database');
                    throw new Error('Utente non trovato nel database');
                }

                console.log('‚úÖ [DB] Utente caricato:', user.nome, user.cognome, '- Ruolo:', user.ruolo);
                currentUser = user;
                document.getElementById('welcomeText').textContent = `Bentornato, ${user.nome} ${user.cognome}`;
                
                // Reset contatore se auth OK
                sessionStorage.removeItem('orariRedirectCount');
                
            } catch (error) {
                // Gestione errore senza redirect automatico
                console.error('‚ùå [AUTH-ERROR]', error.message);
                
                // Mostra messaggio all'utente
                const mainContent = document.querySelector('main') || document.body;
                mainContent.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gray-50">
                        <div class="max-w-md w-full bg-white shadow-lg rounded-lg p-8">
                            <div class="text-center">
                                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                    <i data-lucide="alert-circle" class="h-6 w-6 text-red-600"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Errore di Autenticazione</h3>
                                <p class="text-sm text-gray-500 mb-6">${error.message}</p>
                                <div class="space-y-3">
                                    <a href="/Admin/index.html" 
                                       class="block w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                        Torna alla Dashboard
                                    </a>
                                    <button onclick="location.reload()" 
                                            class="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                                        Riprova
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                throw error; // Re-throw per fermare l'inizializzazione
            } finally {
                authCheckInProgress = false;
            }
        }

        // Aggiorna data e ora
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'short', day: '2-digit', month: 'short' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('it-IT', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('it-IT', timeOptions);
        }

        // Carica timbratura di oggi
        async function loadTodayTimbratura() {
            const data = await window.timbratureService.loadTodayTimbratura(currentUser.id);
            
            if (data) {
                todayTimbratura = data;
                updateTodayUI();
            } else {
                todayTimbratura = null;
                resetTodayUI();
            }
        }

        // Aggiorna UI oggi
        function updateTodayUI() {
            if (!todayTimbratura) return;

            document.getElementById('todayIngresso').textContent = todayTimbratura.ora_ingresso || '--:--';
            document.getElementById('todayUscita').textContent = todayTimbratura.ora_uscita || '--:--';

            if (todayTimbratura.ora_ingresso && !todayTimbratura.ora_uscita) {
                // Sessione attiva - avvia timer in tempo reale
                document.getElementById('timbraBtnText').textContent = 'Timbra Uscita';
                const btnIcon = document.querySelector('#timbraBtn i');
                if (btnIcon) {
                    btnIcon.setAttribute('data-lucide', 'log-out');
                    if (window.lucide) window.lucide.createIcons();
                }
                document.getElementById('statusText').textContent = 'Sessione di lavoro attiva';
                document.getElementById('currentSessionInfo').classList.remove('hidden');
                document.getElementById('ingressoTime').textContent = todayTimbratura.ora_ingresso;
                
                // Mostra bottoni pausa
                document.getElementById('pausaBtns').classList.remove('hidden');
                
                // Gestisci stato pausa
                if (todayTimbratura.pausa_inizio && !todayTimbratura.pausa_fine) {
                    // Pausa in corso
                    document.getElementById('timbraPausaInizioBtn').classList.add('hidden');
                    document.getElementById('timbraPausaFineBtn').classList.remove('hidden');
                    document.getElementById('pausaInfo').classList.remove('hidden');
                    document.getElementById('pausaInizioTime').textContent = todayTimbratura.pausa_inizio;
                } else if (todayTimbratura.pausa_fine) {
                    // Pausa completata
                    document.getElementById('timbraPausaInizioBtn').classList.add('hidden');
                    document.getElementById('timbraPausaFineBtn').classList.add('hidden');
                } else {
                    // Nessuna pausa ancora
                    document.getElementById('timbraPausaInizioBtn').classList.remove('hidden');
                    document.getElementById('timbraPausaFineBtn').classList.add('hidden');
                    document.getElementById('pausaInfo').classList.add('hidden');
                }
                
                // Aggiorna display pausa
                updatePausaDisplay();
                
                // Avvia timer live con aggiornamento ogni secondo
                if (window.liveTimerInterval) clearInterval(window.liveTimerInterval);
                window.liveTimerInterval = window.timbratureService.startLiveTimer(
                    todayTimbratura.ora_ingresso,
                    (liveData) => {
                        // Mostra ore LORDE nel timer live (senza pausa)
                        document.getElementById('oreLavorate').textContent = `${liveData.hours}:${liveData.minutes.toString().padStart(2, '0')}:${liveData.seconds.toString().padStart(2, '0')}`;
                        
                        // Calcola ore NETTE (sottrai pausa effettiva o configurata)
                        let pausaMinuti = todayTimbratura.pausa_minuti > 0 
                            ? todayTimbratura.pausa_minuti  // Pausa timbrata
                            : (currentUser?.pausa_pranzo_minuti || 60);  // Pausa configurata
                        
                        const pausaOre = pausaMinuti / 60;
                        const oreNette = Math.max(0, liveData.total - pausaOre);
                        
                        // Mostra ore nette formattate
                        const netteHours = Math.floor(oreNette);
                        const netteMinutes = Math.round((oreNette - netteHours) * 60);
                        document.getElementById('todayOre').textContent = `${netteHours}h ${netteMinutes}m`;
                        
                        // Calcola guadagno su ore NETTE
                        const costoOrario = todayTimbratura.user?.costo_orario || 0;
                        const guadagno = window.timbratureService.calculateLiveCost(oreNette, costoOrario);
                        document.getElementById('todayCost').textContent = `‚Ç¨${guadagno}`;
                        
                        // Controlla alert straordinari
                        window.timbratureService.checkOvertimeAlert(todayTimbratura.ora_ingresso);
                    }
                );
                
                lucide.createIcons();
            } else if (todayTimbratura.ora_uscita) {
                // Sessione completata
                if (window.liveTimerInterval) clearInterval(window.liveTimerInterval);
                
                document.getElementById('timbraBtnText').textContent = 'Gi√† timbrato';
                document.querySelector('#timbraBtn').disabled = true;
                document.querySelector('#timbraBtn').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('statusText').textContent = 'Timbratura completata per oggi';
                document.getElementById('currentSessionInfo').classList.add('hidden');
                
                const hours = Math.floor(todayTimbratura.ore_lavorate);
                const minutes = Math.round((todayTimbratura.ore_lavorate - hours) * 60);
                document.getElementById('todayOre').textContent = `${hours}h ${minutes}m`;
                
                // Mostra guadagno giornaliero finale
                const costoOrario = todayTimbratura.user?.costo_orario || 0;
                const guadagno = window.timbratureService.calculateDailyCost(todayTimbratura.ore_lavorate, costoOrario);
                document.getElementById('todayCost').textContent = `‚Ç¨${guadagno}`;
            }
        }

        // Reset UI oggi
        function resetTodayUI() {
            if (window.liveTimerInterval) clearInterval(window.liveTimerInterval);
            
            document.getElementById('todayIngresso').textContent = '--:--';
            document.getElementById('todayUscita').textContent = '--:--';
            document.getElementById('todayOre').textContent = '0h 0m';
            document.getElementById('todayCost').textContent = '‚Ç¨0.00';
            document.getElementById('timbraBtnText').textContent = 'Timbra Ingresso';
            const btnIcon = document.querySelector('#timbraBtn i');
            if (btnIcon) {
                btnIcon.setAttribute('data-lucide', 'log-in');
                if (window.lucide) window.lucide.createIcons();
            }
            document.getElementById('statusText').textContent = 'Clicca per timbrare l\'ingresso';
            document.getElementById('currentSessionInfo').classList.add('hidden');
            document.getElementById('pausaBtns').classList.add('hidden');
            document.getElementById('pausaInfo').classList.add('hidden');
            document.querySelector('#timbraBtn').disabled = false;
            document.querySelector('#timbraBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            
            // Reset display pausa
            const pausaDefault = currentUser?.pausa_pranzo_minuti || 60;
            document.getElementById('todayPausa').textContent = pausaDefault === 0 ? 'Nessuna' : `${pausaDefault} min`;
            document.getElementById('todayPausaDettaglio').textContent = '(configurata)';
            
            lucide.createIcons();
        }

        // Aggiorna display pausa
        function updatePausaDisplay() {
            if (!todayTimbratura) return;
            
            const pausaDefault = currentUser?.pausa_pranzo_minuti || 60;
            
            if (todayTimbratura.pausa_minuti > 0) {
                // Pausa effettiva timbrata
                document.getElementById('todayPausa').textContent = `${todayTimbratura.pausa_minuti} min`;
                document.getElementById('todayPausaDettaglio').textContent = 
                    `${todayTimbratura.pausa_inizio || '--'} - ${todayTimbratura.pausa_fine || '--'}`;
            } else if (todayTimbratura.pausa_inizio && !todayTimbratura.pausa_fine) {
                // Pausa in corso
                document.getElementById('todayPausa').textContent = 'In corso...';
                document.getElementById('todayPausaDettaglio').textContent = 
                    `Iniziata: ${todayTimbratura.pausa_inizio}`;
            } else {
                // Usa pausa default
                document.getElementById('todayPausa').textContent = `${pausaDefault} min`;
                document.getElementById('todayPausaDettaglio').textContent = '(configurata)';
            }
        }

        // Gestisci timbratura
        async function handleTimbratura() {
            console.log('üïê [TIMBRATURA] Inizio processo timbratura...');
            const btn = document.getElementById('timbraBtn');
            
            if (!btn) {
                console.error('‚ùå [TIMBRATURA] Bottone non trovato!');
                return;
            }
            
            console.log('üîò [TIMBRATURA] Bottone trovato, disabilitazione...');
            btn.disabled = true;

            try {
                if (!todayTimbratura || !todayTimbratura.ora_ingresso) {
                    // Timbra ingresso usando il servizio
                    console.log('‚û°Ô∏è [INSERT] Timbratura ingresso con servizio...');
                    const gpsData = await window.timbratureService.getGPS();
                    console.log('üìç [GPS] Dati GPS:', gpsData);
                    
                    const data = await window.timbratureService.timbraIngresso(currentUser.id, gpsData);
                    
                    console.log('‚úÖ [INSERT] Ingresso registrato:', data);
                    todayTimbratura = data;
                    updateTodayUI();
                    showNotification('‚úÖ Ingresso registrato con successo!', 'success');
                } else {
                    // Timbra uscita usando il servizio
                    console.log('‚û°Ô∏è [UPDATE] Timbratura uscita con servizio...');
                    const data = await window.timbratureService.timbraUscita(todayTimbratura.id);
                    
                    console.log('‚úÖ [UPDATE] Uscita registrata:', data);
                    todayTimbratura = data;
                    updateTodayUI();
                    showNotification('‚úÖ Uscita registrata con successo!', 'success');
                    await loadMonthSummary();
                    await loadMonthDetails();
                }
            } catch (error) {
                console.error('‚ùå [TIMBRATURA] Errore:', error);
                console.error('‚ùå [TIMBRATURA] Stack:', error.stack);
                showNotification('‚ùå Errore durante la timbratura: ' + error.message, 'error');
            } finally {
                console.log('üîò [TIMBRATURA] Riabilitazione bottone...');
                btn.disabled = false;
                console.log('‚úÖ [TIMBRATURA] Processo completato');
            }
        }

        // Gestione Pausa Inizio
        async function handlePausaInizio() {
            try {
                const now = new Date();
                const pausaInizio = now.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
                
                // Aggiorna database
                const { data, error } = await supabaseClient
                    .from('timbrature')
                    .update({ 
                        pausa_inizio: pausaInizio,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('data', new Date().toISOString().split('T')[0])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Aggiorna UI
                document.getElementById('timbraPausaInizioBtn').classList.add('hidden');
                document.getElementById('timbraPausaFineBtn').classList.remove('hidden');
                document.getElementById('pausaInfo').classList.remove('hidden');
                document.getElementById('pausaInizioTime').textContent = pausaInizio;
                
                showNotification('‚òï Pausa iniziata!', 'info');
                await loadTodayTimbratura();
            } catch (error) {
                console.error('‚ùå Errore pausa inizio:', error);
                showNotification('‚ùå Errore durante timbratura pausa', 'error');
            }
        }

        // Gestione Pausa Fine
        async function handlePausaFine() {
            try {
                const now = new Date();
                const pausaFine = now.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
                
                // Recupera timbratura corrente per calcolare minuti pausa
                const { data: timbratura } = await supabaseClient
                    .from('timbrature')
                    .select('pausa_inizio')
                    .eq('user_id', currentUser.id)
                    .eq('data', new Date().toISOString().split('T')[0])
                    .single();
                
                if (!timbratura?.pausa_inizio) {
                    throw new Error('Nessuna pausa in corso');
                }
                
                // Calcola minuti pausa
                const [pausaH, pausaM] = timbratura.pausa_inizio.split(':').map(Number);
                const [fineH, fineM] = pausaFine.split(':').map(Number);
                const pausaMinuti = (fineH * 60 + fineM) - (pausaH * 60 + pausaM);
                
                // Aggiorna database
                const { data, error } = await supabaseClient
                    .from('timbrature')
                    .update({ 
                        pausa_fine: pausaFine,
                        pausa_minuti: pausaMinuti,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('data', new Date().toISOString().split('T')[0])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Aggiorna UI
                document.getElementById('timbraPausaInizioBtn').classList.remove('hidden');
                document.getElementById('timbraPausaFineBtn').classList.add('hidden');
                document.getElementById('pausaInfo').classList.add('hidden');
                
                showNotification(`‚úÖ Pausa terminata! Durata: ${pausaMinuti} minuti`, 'success');
                await loadTodayTimbratura();
            } catch (error) {
                console.error('‚ùå Errore pausa fine:', error);
                showNotification('‚ùå Errore durante timbratura pausa', 'error');
            }
        }

        // Carica riepilogo mensile
        async function loadMonthSummary() {
            const stats = await window.timbratureService.loadMonthlyStats(currentUser.id);

            document.getElementById('monthOrdinary').textContent = `${Math.round(stats.oreOrdinarie)}h`;
            document.getElementById('monthExtra').textContent = `${Math.round(stats.oreStraordinarie)}h`;
            document.getElementById('monthLeave').textContent = `${stats.giorniFerie} giorni`;
            document.getElementById('monthTotal').textContent = `${Math.round(stats.oreOrdinarie + stats.oreStraordinarie)}h`;
            document.getElementById('monthCost').textContent = `‚Ç¨${stats.costoTotale}`;
        }

        // Carica dettaglio mensile
        async function loadMonthDetails() {
            const year = new Date().getFullYear();
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            const startDate = `${year}-${month}-01`;
            const endDate = `${year}-${month}-31`;

            const { data, error } = await window.supabaseClient
                .from('timbrature')
                .select('*')
                .eq('user_id', currentUser.id)
                .gte('data', startDate)
                .lte('data', endDate)
                .order('data', { ascending: false });

            if (error) {
                console.error('Errore caricamento dettaglio:', error);
                return;
            }

            const tbody = document.getElementById('storicoBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nessuna timbratura questo mese</td></tr>';
                return;
            }

            data.forEach(t => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const tipoEmoji = {
                    'normale': 'üíº',
                    'straordinario': 'üïê',
                    'permesso': 'üö™',
                    'ferie': 'üèñÔ∏è',
                    'malattia': 'ü§í',
                    'trasferta': 'üöó'
                };

                const statoColors = {
                    'approved': 'bg-green-100 text-green-800',
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'rejected': 'bg-red-100 text-red-800'
                };

                const statoText = {
                    'approved': 'Approvato',
                    'pending': 'In Attesa',
                    'rejected': 'Rifiutato'
                };

                const hours = t.ore_lavorate ? Math.floor(t.ore_lavorate) : 0;
                const minutes = t.ore_lavorate ? Math.round((t.ore_lavorate - hours) * 60) : 0;

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(t.data).toLocaleDateString('it-IT')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${tipoEmoji[t.tipo] || 'üíº'} ${t.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.ora_ingresso || '--:--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.ora_uscita || '--:--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${hours}h ${minutes}m</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statoColors[t.stato]}">${statoText[t.stato]}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Gestisci submit variazione
        async function handleVariazioneSubmit(e) {
            e.preventDefault();

            const tipo = document.getElementById('tipoVariazione').value;
            const data = document.getElementById('dataVariazione').value;
            const oraIngresso = document.getElementById('oraIngressoVariazione').value;
            const oraUscita = document.getElementById('oraUscitaVariazione').value;
            const note = document.getElementById('noteVariazione').value;

            try {
                const { error } = await window.supabaseClient
                    .from('timbrature')
                    .insert({
                        user_id: currentUser.id,
                        data: data,
                        ora_ingresso: oraIngresso || null,
                        ora_uscita: oraUscita || null,
                        tipo: tipo,
                        note: note,
                        stato: 'pending'
                    });

                if (error) throw error;

                showNotification('‚úÖ Richiesta inviata! In attesa di approvazione.', 'success');
                document.getElementById('variazioneForm').reset();
                await loadMonthDetails();
            } catch (error) {
                console.error('Errore invio richiesta:', error);
                showNotification('‚ùå Errore durante l\'invio della richiesta', 'error');
            }
        }

        // Mostra notifica
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>
