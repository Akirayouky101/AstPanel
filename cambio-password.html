<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambio Password Obbligatorio - AST Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-red-50 to-orange-50 min-h-screen flex items-center justify-center p-4">
    
    <div class="max-w-md w-full">
        <!-- Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üîê</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Cambia Password</h1>
                <p class="text-gray-600 text-sm">
                    Questo √® il tuo primo accesso. Per sicurezza, devi impostare una nuova password personale.
                </p>
            </div>

            <!-- Alert -->
            <div id="alert" class="hidden mb-6 p-4 rounded-lg"></div>

            <!-- Form -->
            <form id="changePasswordForm" class="space-y-6">
                <!-- Password Temporanea -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Password Temporanea
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="tempPassword"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            placeholder="Inserisci la password temporanea"
                            required
                        >
                        <button 
                            type="button" 
                            onclick="togglePassword('tempPassword')"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                        >
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <!-- Nuova Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nuova Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="newPassword"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            placeholder="Minimo 8 caratteri"
                            required
                            minlength="8"
                        >
                        <button 
                            type="button" 
                            onclick="togglePassword('newPassword')"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                        >
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <!-- Conferma Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Conferma Nuova Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="confirmPassword"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            placeholder="Ripeti la nuova password"
                            required
                            minlength="8"
                        >
                        <button 
                            type="button" 
                            onclick="togglePassword('confirmPassword')"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                        >
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <!-- Password Requirements -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
                    <p class="font-medium text-blue-900 mb-2">Requisiti password:</p>
                    <ul class="space-y-1 text-blue-700">
                        <li id="req-length" class="flex items-center">
                            <span class="mr-2">‚ùå</span>
                            Minimo 8 caratteri
                        </li>
                        <li id="req-uppercase" class="flex items-center">
                            <span class="mr-2">‚ùå</span>
                            Almeno una lettera maiuscola
                        </li>
                        <li id="req-lowercase" class="flex items-center">
                            <span class="mr-2">‚ùå</span>
                            Almeno una lettera minuscola
                        </li>
                        <li id="req-number" class="flex items-center">
                            <span class="mr-2">‚ùå</span>
                            Almeno un numero
                        </li>
                    </ul>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit"
                    id="submitBtn"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Cambia Password e Accedi
                </button>
            </form>

            <!-- Logout Link -->
            <div class="mt-6 text-center">
                <button 
                    onclick="logout()"
                    class="text-sm text-gray-600 hover:text-gray-800"
                >
                    Esci e torna al login
                </button>
            </div>
        </div>

        <!-- Footer -->
        <p class="text-center text-gray-600 text-sm mt-6">
            AST Panel ¬© 2024
        </p>
    </div>

    <!-- Scripts -->
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    
    <script>
        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Valida password in real-time
        document.getElementById('newPassword').addEventListener('input', (e) => {
            const password = e.target.value;
            
            // Lunghezza
            const reqLength = password.length >= 8;
            updateReq('req-length', reqLength);
            
            // Maiuscola
            const reqUpper = /[A-Z]/.test(password);
            updateReq('req-uppercase', reqUpper);
            
            // Minuscola
            const reqLower = /[a-z]/.test(password);
            updateReq('req-lowercase', reqLower);
            
            // Numero
            const reqNumber = /[0-9]/.test(password);
            updateReq('req-number', reqNumber);
        });

        function updateReq(id, valid) {
            const el = document.getElementById(id);
            const icon = el.querySelector('span');
            if (valid) {
                icon.textContent = '‚úÖ';
                el.classList.remove('text-blue-700');
                el.classList.add('text-green-700');
            } else {
                icon.textContent = '‚ùå';
                el.classList.remove('text-green-700');
                el.classList.add('text-blue-700');
            }
        }

        // Valida che le password coincidano
        function validatePasswords() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            
            if (newPass !== confirmPass) {
                showAlert('Le password non coincidono!', 'error');
                return false;
            }
            
            // Verifica requisiti
            if (newPass.length < 8) {
                showAlert('La password deve essere di almeno 8 caratteri', 'error');
                return false;
            }
            
            if (!/[A-Z]/.test(newPass)) {
                showAlert('La password deve contenere almeno una lettera maiuscola', 'error');
                return false;
            }
            
            if (!/[a-z]/.test(newPass)) {
                showAlert('La password deve contenere almeno una lettera minuscola', 'error');
                return false;
            }
            
            if (!/[0-9]/.test(newPass)) {
                showAlert('La password deve contenere almeno un numero', 'error');
                return false;
            }
            
            return true;
        }

        // Handle form submit
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validatePasswords()) return;
            
            const submitBtn = document.getElementById('submitBtn');
            const newPassword = document.getElementById('newPassword').value;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Aggiornamento...';
                
                // Cambia password usando AuthHelper
                await window.AuthHelper.changePassword(newPassword);
                
                showAlert('‚úÖ Password aggiornata con successo!', 'success');
                
                // Redirect dopo 2 secondi
                setTimeout(() => {
                    const user = window.AuthHelper.getCurrentUser();
                    if (user && window.AuthHelper.isAdmin()) {
                        window.location.href = '/Admin/admin-functional.html';
                    } else {
                        window.location.href = '/pannello-utente.html';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Errore cambio password:', error);
                showAlert('‚ùå Errore: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cambia Password e Accedi';
            }
        });

        // Logout
        async function logout() {
            await window.AuthHelper.logout();
            window.location.href = '/Admin/';
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `mb-6 p-4 rounded-lg ${
                type === 'success' 
                    ? 'bg-green-50 border border-green-200 text-green-800' 
                    : 'bg-red-50 border border-red-200 text-red-800'
            }`;
            alert.textContent = message;
            alert.classList.remove('hidden');
        }

        // Verifica che l'utente debba veramente cambiare password
        window.addEventListener('load', async () => {
            const user = window.AuthHelper.getCurrentUser();
            
            if (!user) {
                // Nessun utente loggato, redirect a login
                window.location.href = '/Admin/';
                return;
            }
            
            if (!user.first_login) {
                // Non √® primo login, redirect a dashboard
                if (window.AuthHelper.isAdmin()) {
                    window.location.href = '/Admin/admin-functional.html';
                } else {
                    window.location.href = '/pannello-utente.html';
                }
            }
        });
    </script>
</body>
</html>
