<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
        <title>Pannello Utente - AST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    <script src="data-migration.js"></script>
    <script src="modal-system.js"></script>
    <script src="client-modal.js"></script>
    <script src="notification-service.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Firma Digitale + PDF -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- MOBILE OPTIMIZATIONS - Si attiva solo su mobile, non tocca il desktop -->
    <link rel="stylesheet" href="mobile-optimizations.css">
    
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .user-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .priority-alta { border-left: 4px solid #ef4444; }
        .priority-media { border-left: 4px solid #f59e0b; }
        .priority-bassa { border-left: 4px solid #10b981; }
        .progress-bar { transition: width 0.3s ease; }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Safe area for iOS/mobile devices */
        .pb-safe {
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
        }
        
        /* Communication filter tabs */
        .comm-filter-tab {
            transition: all 0.2s ease;
        }
        .comm-filter-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background-color: #eff6ff;
        }
        .comm-filter-tab:hover {
            background-color: #f3f4f6;
        }
        
        /* Team Members Collapsible */
        .team-members-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .team-members-container.expanded {
            max-height: 500px;
        }
        
        .team-toggle-btn {
            background: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .team-toggle-btn:hover {
            opacity: 0.8;
        }
        
        .team-toggle-btn .arrow {
            transition: transform 0.3s;
            font-size: 14px;
        }
        
        .team-toggle-btn.expanded .arrow {
            transform: rotate(180deg);
        }
        
        /* Hide communication filters on mobile */
        @media (max-width: 768px) {
            #communication-filters {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-gradient-to-b from-blue-600 via-purple-600 to-indigo-700 shadow-2xl transform transition-transform duration-300 ease-in-out z-50" id="sidebar">
        <div class="flex items-center justify-between px-3 h-20 bg-gradient-to-r from-green-500 to-emerald-600 shadow-lg">
            <h1 class="text-white text-base font-bold tracking-wide whitespace-nowrap">‚ö° ZG IMPIANTI S.R.L. ‚ö°</h1>
        </div>
        <nav class="mt-6 px-3 space-y-2">
            <a href="#dashboard" onclick="showSection('dashboard'); return false;" class="flex items-center px-4 py-3.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl shadow-lg border-2 border-blue-300 transform hover:scale-105 transition-all" id="nav-dashboard">
                <span class="text-2xl mr-3">üè†</span>
                <span class="font-bold">Dashboard</span>
            </a>
            <a href="#my-tasks" onclick="showSection('my-tasks'); return false;" class="flex items-center px-4 py-3.5 text-white hover:bg-white/20 rounded-xl transition-all hover:shadow-lg hover:scale-105 backdrop-blur-sm" id="nav-my-tasks">
                <span class="text-2xl mr-3">üìã</span>
                <span class="font-semibold">Le Mie Lavorazioni</span>
            </a>
            <a href="calendario-dipendente.html" class="flex items-center px-4 py-3.5 text-white hover:bg-white/20 rounded-xl transition-all hover:shadow-lg hover:scale-105 backdrop-blur-sm">
                <span class="text-2xl mr-3">üìÖ</span>
                <span class="font-semibold">Il Mio Calendario</span>
            </a>
            <a href="#requests" onclick="showSection('requests'); return false;" class="flex items-center justify-between px-4 py-3.5 text-white hover:bg-white/20 rounded-xl transition-all hover:shadow-lg hover:scale-105 backdrop-blur-sm" id="nav-requests">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">üìù</span>
                    <span class="font-semibold">Le Mie Richieste</span>
                </div>
                <span id="processed-requests-badge" class="hidden bg-green-500 text-white text-xs rounded-full px-2.5 py-1 min-w-[24px] text-center font-bold shadow-md"></span>
            </a>
            <a href="#communications" onclick="showSection('communications'); return false;" class="flex items-center justify-between px-4 py-3.5 text-white hover:bg-white/20 rounded-xl transition-all hover:shadow-lg hover:scale-105 backdrop-blur-sm" id="nav-communications">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">üí¨</span>
                    <span class="font-semibold">Comunicazioni</span>
                </div>
                <span id="unread-comm-badge" class="hidden bg-yellow-400 text-gray-900 text-xs rounded-full px-2.5 py-1 min-w-[24px] text-center font-bold shadow-md"></span>
            </a>
            <a href="#profile" onclick="showSection('profile'); return false;" class="flex items-center px-4 py-3.5 text-white hover:bg-white/20 rounded-xl transition-all hover:shadow-lg hover:scale-105 backdrop-blur-sm" id="nav-profile">
                <span class="text-2xl mr-3">üë§</span>
                <span class="font-semibold">Il Mio Profilo</span>
            </a>
            <div class="mt-8 pt-6 border-t-2 border-white/30">
                <a href="#" onclick="logout(); return false;" class="flex items-center px-4 py-3.5 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                    <span class="text-2xl mr-3">üö™</span>
                    <span class="font-bold">Logout</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <!-- User Header -->
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center space-x-4">
                    <div class="relative group cursor-pointer" onclick="openProfilePhotoModal()">
                        <img id="userProfilePhoto" src="https://i.pravatar.cc/60?img=1" alt="User Photo" class="w-16 h-16 rounded-full border-4 border-white shadow-lg">
                        <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-camera text-white text-xl"></i>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800" id="userNameHeader">
                            <span class="inline-block animate-pulse">Caricamento...</span>
                        </h2>
                        <p class="text-gray-600" id="userRoleHeader">
                            <span class="inline-block animate-pulse">Verifica autenticazione...</span>
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Ultimo accesso</p>
                    <p class="text-sm font-medium" id="lastLoginUser">Oggi, 09:30</p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
                <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Lavorazioni Attive</p>
                            <p class="text-2xl font-bold text-blue-600" id="userActiveTasks">3</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="clipboard-list" class="w-6 h-6 text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Completate Oggi</p>
                            <p class="text-2xl font-bold text-green-600" id="userCompletedToday">2</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">In Scadenza</p>
                            <p class="text-2xl font-bold text-orange-600" id="userOverdueTasks">1</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Produttivit√†</p>
                            <p class="text-2xl font-bold text-purple-600" id="userProductivity">87%</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="trending-up" class="w-6 h-6 text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="showSection('my-tasks')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Le Mie Lavorazioni</h3>
                            <p class="text-blue-100">Visualizza e aggiorna i tuoi task</p>
                        </div>
                        <i data-lucide="clipboard-list" class="w-8 h-8"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="createNewRequest()">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Nuova Richiesta</h3>
                            <p class="text-green-100">Ferie, permessi, materiali</p>
                        </div>
                        <i data-lucide="plus-circle" class="w-8 h-8"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="showSection('communications')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Comunicazioni</h3>
                            <p class="text-purple-100">Leggi gli ultimi annunci</p>
                        </div>
                        <i data-lucide="bell" class="w-8 h-8"></i>
                    </div>
                </div>
            </div>

            <!-- Today's Tasks -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8 fade-in">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Lavorazioni di Oggi</h3>
                </div>
                <div id="todayTasks" class="p-6">
                    <!-- Today's tasks will be loaded here -->
                </div>
            </div>
        </div>

        <!-- My Tasks Section -->
        <div id="my-tasks-section" class="section hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Le Mie Lavorazioni</h2>
                    <p class="text-gray-600">Gestisci e aggiorna le tue attivit√†</p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="calendario-dipendente.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <i data-lucide="calendar" class="w-5 h-5 mr-2"></i>
                        Apri Calendario
                    </a>
                    <select id="taskStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Tutti gli stati</option>
                        <option value="da_fare">Da Fare</option>
                        <option value="in_corso">In Corso</option>
                        <option value="revisione">Revisione</option>
                        <option value="completato">Completato</option>
                    </select>
                </div>
            </div>

            <!-- My Tasks Grid -->
            <div id="myTasksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- User's tasks will be loaded here -->
            </div>
        </div>

        <!-- Requests Section -->
        <div id="requests-section" class="section hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Le Mie Richieste</h2>
                    <p class="text-gray-600">Storico e stato delle tue richieste</p>
                </div>
                <button onclick="openRequestModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    Nuova Richiesta
                </button>
            </div>

            <!-- Requests List -->
            <div id="userRequestsList" class="space-y-4">
                <!-- User's requests will be loaded here -->
            </div>
        </div>

        <!-- Communications Section -->
        <div id="communications-section" class="section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Comunicazioni Aziendali</h2>
                <p class="text-gray-600">Annunci e aggiornamenti importanti</p>
            </div>

            <!-- Communication Filters -->
            <div class="bg-white rounded-lg shadow-md mb-6 overflow-hidden" id="communication-filters">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button onclick="filterCommunications('tutte')" 
                                class="comm-filter-tab active flex-1 py-4 px-6 text-sm font-medium text-center border-b-2 border-transparent hover:border-gray-300"
                                data-filter="tutte">
                            <i data-lucide="inbox" class="w-4 h-4 inline mr-2"></i>
                            Tutte
                            <span class="ml-2 bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs" id="count-tutte">0</span>
                        </button>
                        <button onclick="filterCommunications('da-leggere')" 
                                class="comm-filter-tab flex-1 py-4 px-6 text-sm font-medium text-center border-b-2 border-transparent hover:border-gray-300"
                                data-filter="da-leggere">
                            <i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>
                            Da leggere
                            <span class="ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold" id="count-da-leggere">0</span>
                        </button>
                        <button onclick="filterCommunications('lette')" 
                                class="comm-filter-tab flex-1 py-4 px-6 text-sm font-medium text-center border-b-2 border-transparent hover:border-gray-300"
                                data-filter="lette">
                            <i data-lucide="mail-open" class="w-4 h-4 inline mr-2"></i>
                            Lette
                            <span class="ml-2 bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs" id="count-lette">0</span>
                        </button>
                        <button onclick="filterCommunications('archiviate')" 
                                class="comm-filter-tab flex-1 py-4 px-6 text-sm font-medium text-center border-b-2 border-transparent hover:border-gray-300"
                                data-filter="archiviate">
                            <i data-lucide="archive" class="w-4 h-4 inline mr-2"></i>
                            Archiviate
                            <span class="ml-2 bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs" id="count-archiviate">0</span>
                        </button>
                        <button onclick="filterCommunications('eliminate')" 
                                class="comm-filter-tab flex-1 py-4 px-6 text-sm font-medium text-center border-b-2 border-transparent hover:border-gray-300"
                                data-filter="eliminate">
                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                            Eliminate
                            <span class="ml-2 bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs" id="count-eliminate">0</span>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Communications List -->
            <div id="userCommunicationsList" class="space-y-4">
                <!-- Communications will be loaded here -->
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profile Info Card -->
                <div class="lg:col-span-2">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-2xl shadow-lg overflow-hidden">
                        <!-- Header Card -->
                        <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 p-6">
                            <div class="flex items-center gap-4">
                                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-lg">
                                    <i data-lucide="user" class="w-10 h-10 text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">Informazioni Personali</h3>
                                    <p class="text-blue-100">Aggiorna i tuoi dati</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form -->
                        <form id="profileForm" class="p-6 space-y-4">
                            <!-- Nome e Cognome -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white rounded-xl p-4 border-2 border-blue-200">
                                    <label for="profileName" class="flex items-center gap-2 text-sm font-bold text-blue-700 mb-2">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                        Nome
                                    </label>
                                    <input type="text" id="profileName" placeholder="Inserisci nome" 
                                           class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                                </div>
                                <div class="bg-white rounded-xl p-4 border-2 border-purple-200">
                                    <label for="profileSurname" class="flex items-center gap-2 text-sm font-bold text-purple-700 mb-2">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                        Cognome
                                    </label>
                                    <input type="text" id="profileSurname" placeholder="Inserisci cognome" 
                                           class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium">
                                </div>
                            </div>
                            
                            <!-- Email -->
                            <div class="bg-white rounded-xl p-4 border-2 border-green-200">
                                <label for="profileEmail" class="flex items-center gap-2 text-sm font-bold text-green-700 mb-2">
                                    <i data-lucide="mail" class="w-4 h-4"></i>
                                    Email
                                </label>
                                <input type="email" id="profileEmail" placeholder="email@azienda.com" 
                                       class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 font-medium">
                            </div>
                            
                            <!-- Telefono e Ruolo -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white rounded-xl p-4 border-2 border-orange-200">
                                    <label for="profilePhone" class="flex items-center gap-2 text-sm font-bold text-orange-700 mb-2">
                                        <i data-lucide="phone" class="w-4 h-4"></i>
                                        Telefono
                                    </label>
                                    <input type="tel" id="profilePhone" placeholder="+39 340 1234567" 
                                           class="w-full px-3 py-2 border-2 border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium">
                                </div>
                                <div class="bg-gradient-to-br from-gray-100 to-slate-200 rounded-xl p-4 border-2 border-gray-300">
                                    <label for="profileRole" class="flex items-center gap-2 text-sm font-bold text-gray-700 mb-2">
                                        <i data-lucide="briefcase" class="w-4 h-4"></i>
                                        Ruolo
                                    </label>
                                    <input type="text" id="profileRole" placeholder="Ruolo" readonly 
                                           class="w-full px-3 py-2 border-2 border-gray-400 rounded-lg bg-gray-50 font-medium text-gray-600 cursor-not-allowed">
                                </div>
                            </div>
                            
                            <!-- Submit Button -->
                            <button type="submit" 
                                    class="w-full bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 text-white py-4 rounded-xl hover:from-blue-700 hover:via-purple-700 hover:to-indigo-700 transition-all shadow-lg font-bold text-lg flex items-center justify-center gap-2 hover:scale-[1.02] transform">
                                <i data-lucide="save" class="w-5 h-5"></i>
                                Aggiorna Profilo
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Sidebar: Stats & Photo -->
                <div class="space-y-6">
                    <!-- Foto Profilo Card -->
                    <div class="bg-gradient-to-br from-purple-50 to-pink-100 border-2 border-purple-200 rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <i data-lucide="camera" class="w-5 h-5"></i>
                                Foto Profilo
                            </h3>
                        </div>
                        <div class="p-6 text-center">
                            <div class="relative inline-block mb-4 group">
                                <img id="profilePhotoPreview" src="https://i.pravatar.cc/150?img=1" alt="Profile Photo" 
                                     class="w-32 h-32 rounded-full border-4 border-purple-300 shadow-lg mx-auto">
                                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                                    <i data-lucide="upload" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                            <input type="file" id="photoFileInput" accept="image/*"
                                   class="hidden" onchange="handlePhotoUpload(event)">
                            <button onclick="document.getElementById('photoFileInput').click()" 
                                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all font-bold flex items-center justify-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                Carica Nuova Foto
                            </button>
                            <div id="uploadProgressContainer" class="hidden mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="uploadProgressBar" class="bg-gradient-to-r from-purple-600 to-pink-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="uploadProgressText" class="text-xs text-gray-600 mt-1">Caricamento...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Notifiche Push Card -->
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-100 border-2 border-indigo-200 rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <i data-lucide="bell" class="w-5 h-5"></i>
                                Notifiche Push
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <!-- Toggle Notifiche -->
                            <div class="bg-white rounded-xl p-4 border-2 border-indigo-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="smartphone" class="w-5 h-5 text-indigo-600"></i>
                                        <div>
                                            <p class="font-semibold text-gray-800">Attiva Notifiche</p>
                                            <p class="text-xs text-gray-600">Ricevi aggiornamenti in tempo reale</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggleNotifications" class="sr-only peer" onchange="handleNotificationToggle(this)">
                                        <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-indigo-600"></div>
                                    </label>
                                </div>
                                <div id="notificationStatus" class="text-xs text-gray-500 flex items-center gap-1">
                                    <i data-lucide="info" class="w-3 h-3"></i>
                                    <span>Clicca per attivare</span>
                                </div>
                            </div>

                            <!-- Tipo Notifiche -->
                            <div class="bg-white rounded-xl p-4 border-2 border-purple-200">
                                <p class="text-sm font-semibold text-purple-700 mb-3 flex items-center gap-2">
                                    <i data-lucide="list" class="w-4 h-4"></i>
                                    Riceverai notifiche per:
                                </p>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2 text-gray-700">
                                        <i data-lucide="clipboard-list" class="w-4 h-4 text-blue-500"></i>
                                        <span>Nuove lavorazioni assegnate</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-gray-700">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                                        <span>Richieste approvate/rifiutate</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-gray-700">
                                        <i data-lucide="message-circle" class="w-4 h-4 text-purple-500"></i>
                                        <span>Nuove comunicazioni</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-gray-700">
                                        <i data-lucide="clock" class="w-4 h-4 text-orange-500"></i>
                                        <span>Scadenze imminenti</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Notification Button -->
                            <button onclick="testNotification()" 
                                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all font-semibold text-sm flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                                <i data-lucide="send" class="w-4 h-4"></i>
                                Invia Notifica di Test
                            </button>
                        </div>
                    </div>

                    <!-- Statistiche Card -->
                    <div class="bg-gradient-to-br from-cyan-50 to-blue-100 border-2 border-cyan-200 rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-cyan-600 to-blue-600 p-4">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                                Le Tue Statistiche
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="bg-white rounded-xl p-4 border-2 border-cyan-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-cyan-700 flex items-center gap-2">
                                        <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                                        Lavorazioni Totali
                                    </span>
                                    <span class="text-2xl font-bold text-cyan-600" id="profileTotalTasks">24</span>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border-2 border-green-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-green-700 flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                                        Completate
                                    </span>
                                    <span class="text-2xl font-bold text-green-600" id="profileCompletedTasks">18</span>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border-2 border-yellow-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-yellow-700 flex items-center gap-2">
                                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                                        Media Giornaliera
                                    </span>
                                    <span class="text-2xl font-bold text-yellow-600" id="profileAvgTasks">2.3</span>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border-2 border-orange-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-orange-700 flex items-center gap-2">
                                        <i data-lucide="star" class="w-4 h-4"></i>
                                        Valutazione
                                    </span>
                                    <div class="flex gap-1">
                                        <i data-lucide="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                                        <i data-lucide="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                                        <i data-lucide="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                                        <i data-lucide="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                                        <i data-lucide="star" class="w-5 h-5 text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Update Modal -->
    <div id="taskUpdateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[95vh] overflow-hidden flex flex-col my-4">
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 p-6 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white text-center flex-1">Aggiorna Lavorazione</h3>
                        <button onclick="closeTaskUpdateModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors ml-3">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Content scrollabile -->
                <div class="p-4 overflow-y-auto flex-1 space-y-3">
                    <!-- Team Members Section (only shown if team task) -->
                    <div id="updateModalTeamSection" class="hidden bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="users" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs text-purple-700 font-medium">Squadra</p>
                                <p id="updateModalTeamName" class="font-bold text-gray-900"></p>
                            </div>
                        </div>
                        <div id="updateModalTeamMembers" class="flex flex-wrap gap-2">
                        </div>
                    </div>
                    
                    <!-- Progresso -->
                    <div class="bg-gradient-to-br from-cyan-50 to-sky-100 border-2 border-cyan-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-sky-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="trending-up" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs text-cyan-700 font-medium mb-1">Progresso (%)</p>
                                <input type="range" id="taskProgress" min="0" max="100" class="w-full accent-cyan-500" oninput="updateProgressValue(this.value)">
                                <div class="flex justify-between text-xs text-cyan-600 font-medium mt-1">
                                    <span>0%</span>
                                    <span id="progressValue" class="text-base font-bold">50%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Note di Progresso -->
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-slate-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="file-text" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <label for="taskNotes" class="text-xs text-gray-700 font-medium mb-2 block">Note di Progresso</label>
                                <textarea id="taskNotes" rows="3" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Aggiungi note sul lavoro svolto..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cambia Stato -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="activity" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <label for="taskNewStatus" class="text-xs text-blue-700 font-medium mb-2 block">Cambia Stato</label>
                                <select id="taskNewStatus" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white font-medium">
                                    <option value="da_fare">Da Fare</option>
                                    <option value="in_corso">In Corso</option>
                                    <option value="revisione">Revisione</option>
                                    <option value="completato">Completato</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeTaskUpdateModal()" class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl text-gray-800 transition-colors font-bold">
                            Annulla
                        </button>
                        <button onclick="saveTaskUpdate()" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg font-bold">
                            Salva Aggiornamenti
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div id="requestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Nuova Richiesta</h3>
                    <button onclick="closeRequestModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form id="requestForm" class="p-6">
                    <div class="mb-4">
                        <label for="requestType" class="block text-sm font-medium text-gray-700 mb-2">Tipo Richiesta</label>
                        <select id="requestType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleziona tipo</option>
                            <option value="ferie">Ferie</option>
                            <option value="permessi">Permessi</option>
                            <option value="materiali">Materiali</option>
                            <option value="veicoli">Veicoli</option>
                            <option value="straordinari">Straordinari</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="requestTitle" class="block text-sm font-medium text-gray-700 mb-2">Titolo</label>
                        <input type="text" id="requestTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label for="requestDescription" class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                        <textarea id="requestDescription" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="requestStartDate" class="block text-sm font-medium text-gray-700 mb-2">Data Inizio</label>
                            <input type="date" id="requestStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="requestEndDate" class="block text-sm font-medium text-gray-700 mb-2">Data Fine</label>
                            <input type="date" id="requestEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeRequestModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Annulla
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Invia Richiesta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Details Modal with Components -->
    <div id="taskDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[95vh] overflow-hidden flex flex-col my-4">
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 p-6 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <h3 id="taskDetailsTitle" class="text-xl font-bold text-white text-center flex-1">Dettagli Lavorazione</h3>
                        <button onclick="closeTaskDetailsModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors ml-3" title="Chiudi">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Content scrollabile -->
                <div class="p-4 overflow-y-auto flex-1" id="taskDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <i class="fas fa-sign-out-alt text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                        Conferma Logout
                    </h3>
                    <p class="text-gray-600 mb-6">
                        Sei sicuro di voler uscire dal pannello?
                    </p>
                </div>
                
                <div class="flex gap-3 p-4 bg-gray-50 border-t border-gray-200">
                    <button onclick="closeLogoutModal()" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                        Annulla
                    </button>
                    <button onclick="confirmLogout()" 
                            class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Esci
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Management Modal for User -->
    <!-- Modal Componenti Utente -->
    <div id="userComponentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md sm:max-w-2xl lg:max-w-4xl max-h-[95vh] overflow-hidden flex flex-col my-4">
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-orange-600 via-amber-600 to-yellow-600 p-4 sm:p-6 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 sm:gap-3">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="package-search" class="w-6 h-6 sm:w-7 sm:h-7 text-orange-600"></i>
                            </div>
                            <h3 class="text-lg sm:text-2xl font-bold text-white">Componenti</h3>
                        </div>
                        <button onclick="closeUserComponentModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors" title="Chiudi">
                            <i data-lucide="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Search and Filter -->
                <div class="p-4 sm:p-6 border-b-2 bg-gradient-to-br from-orange-50 to-amber-100 space-y-3 sm:space-y-4">
                    <!-- Search Bar -->
                    <div class="bg-white rounded-xl p-3 sm:p-4 border-2 border-orange-200">
                        <label for="userComponentSearch" class="flex items-center gap-2 text-xs sm:text-sm font-bold text-orange-700 mb-2">
                            <i data-lucide="search" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            Cerca Componente
                        </label>
                        <input type="text" id="userComponentSearch" 
                               oninput="filterUserComponents()"
                               placeholder="üîç Cerca..."
                               class="w-full px-3 py-2 sm:px-4 sm:py-3 border-2 border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium text-sm sm:text-base">
                    </div>
                    
                    <!-- Category Filter -->
                    <div class="bg-white rounded-xl p-3 sm:p-4 border-2 border-yellow-200">
                        <label for="userComponentCategoryFilter" class="flex items-center gap-2 text-xs sm:text-sm font-bold text-yellow-700 mb-2">
                            <i data-lucide="folder" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            Categoria
                        </label>
                        <select id="userComponentCategoryFilter" onchange="filterUserComponents()" 
                                class="w-full px-3 py-2 sm:px-4 sm:py-3 border-2 border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 font-medium bg-white text-sm sm:text-base">
                            <option value="">üìÅ Tutte</option>
                            <option value="Antifurto">üîí Antifurto</option>
                            <option value="Videosorveglianza">üìπ Videosorveglianza</option>
                            <option value="Rete">üåê Rete</option>
                            <option value="Accessori">üîß Accessori</option>
                            <option value="Componentistica">‚öôÔ∏è Componentistica</option>
                            <option value="Materiali">üì¶ Materiali</option>
                        </select>
                    </div>
                </div>
                
                <!-- Lista Componenti -->
                <div class="p-4 sm:p-6 overflow-y-auto flex-1 bg-white">
                    <div id="userComponentsList" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <!-- Components will be loaded here -->
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="flex justify-end space-x-3 p-4 sm:p-6 border-t-2 bg-gradient-to-br from-orange-50 to-amber-100">
                    <button type="button" onclick="closeUserComponentModal()" 
                            class="px-4 py-2 sm:px-6 sm:py-3 border-2 border-gray-300 rounded-xl text-gray-700 hover:bg-gray-100 font-bold transition-all text-sm sm:text-base">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quantity Input Modal -->
    <div id="quantityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mx-auto mb-4">
                    <i data-lucide="package" class="w-8 h-8 text-blue-600"></i>
                </div>
                
                <h3 class="text-xl font-bold text-gray-900 text-center mb-2">Quantit√† Componente</h3>
                <p class="text-gray-600 text-center mb-6" id="quantityModalMessage">Quanti pz vuoi aggiungere?</p>
                
                <div class="mb-6">
                    <label for="componentQuantityInput" class="block text-sm font-medium text-gray-700 mb-2">Quantit√†</label>
                    <input type="number" id="componentQuantityInput" value="1" min="1"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-center text-2xl font-bold"
                           onkeypress="if(event.key === 'Enter') confirmQuantity()">
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="cancelQuantity()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Annulla
                    </button>
                    <button onclick="confirmQuantity()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Ok
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Current user data (should be loaded from login)
        const currentUser = {
            id: 'mario',
            nome: 'Mario',
            cognome: 'Rossi',
            email: 'mario.rossi@azienda.com',
            ruolo: 'Sviluppatore Frontend',
            avatar: 'https://i.pravatar.cc/60?img=1'
        };

        let currentEditingTask = null;

        // Get tasks data from admin panel (shared data)
        let userTasks = []; // Will be loaded from Supabase

        let userRequests = [
            {
                id: 1,
                tipo: 'ferie',
                titolo: 'Ferie Estive',
                descrizione: 'Richiesta 10 giorni di ferie per agosto',
                dataRichiesta: '2024-01-15',
                dataInizio: '2024-08-15',
                dataFine: '2024-08-25',
                stato: 'in_attesa'
            },
            {
                id: 2,
                tipo: 'materiali',
                titolo: 'Monitor Aggiuntivo',
                descrizione: 'Richiesta secondo monitor per produttivit√†',
                dataRichiesta: '2024-01-10',
                stato: 'approvata'
            }
        ];

        // Communications loaded from Supabase - no mock data needed

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing user panel...');
            try {
                // Prima di tutto verifica l'autenticazione
                const currentUser = await window.AuthHelper.getCurrentUser();
                if (!currentUser) {
                    console.warn('‚ö†Ô∏è Utente non autenticato, redirect al login');
                    window.location.href = '/index.html';
                    return;
                }
                
                console.log('‚úÖ Utente autenticato:', currentUser.nome, currentUser.cognome);
                
                lucide.createIcons();
                console.log('‚úÖ Icons loaded');
                
                await updateUserHeader();
                console.log('‚úÖ User header updated');
                
                await loadDashboardData();
                console.log('‚úÖ Dashboard data loaded');
                
                await loadMyTasks();
                console.log('‚úÖ Tasks loaded');
                
                await loadUserRequests();
                console.log('‚úÖ Requests loaded');
                
                await loadUserCommunications();
                console.log('‚úÖ Communications loaded');
                
                updateUserStats();
                console.log('‚úÖ Stats updated');
                
                // Inizializza notifiche push
                await initPushNotifications(currentUser.id);
                console.log('‚úÖ Push notifications initialized');
                
                // Check stato notifiche e aggiorna UI
                updateNotificationToggleState();
                
                console.log('üéâ User panel fully loaded!');
            } catch (error) {
                console.error('‚ùå Error during initialization:', error);
                alert('Errore nel caricamento del pannello. Verrai reindirizzato al login.');
                window.location.href = '/index.html';
            }
        });

        async function updateUserHeader() {
            try {
                const currentUser = await window.AuthHelper.getCurrentUser();
                if (currentUser) {
                    const userName = `${currentUser.nome || ''} ${currentUser.cognome || ''}`.trim() || 'Utente';
                    const userRole = currentUser.ruolo || currentUser.role || 'Dipendente';
                    const userTeam = currentUser.team || '';
                    
                    // Update name
                    const nameElement = document.getElementById('userNameHeader');
                    if (nameElement) {
                        nameElement.textContent = `Ciao, ${userName}!`;
                    }
                    
                    // Update role/team
                    const roleElement = document.getElementById('userRoleHeader');
                    if (roleElement) {
                        const roleText = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                        roleElement.textContent = userTeam ? `${roleText} ‚Ä¢ ${userTeam}` : roleText;
                    }
                    
                    // Update profile photo
                    const photoElement = document.getElementById('userProfilePhoto');
                    if (photoElement && currentUser.foto_profilo) {
                        photoElement.src = currentUser.foto_profilo;
                    }
                    
                    // Pre-load profile form data
                    loadUserProfile();
                } else {
                    // Se non c'√® utente autenticato, redirect al login
                    console.warn('‚ö†Ô∏è Nessun utente autenticato');
                    window.location.href = '/index.html';
                }
            } catch (error) {
                console.error('Error updating user header:', error);
                // In caso di errore, redirect al login
                window.location.href = '/index.html';
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active class from all nav items
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'shadow-lg', 'border-2', 'border-blue-300', 'scale-105');
                link.classList.add('hover:bg-white/20');
            });

            // Show selected section
            document.getElementById(sectionName + '-section').classList.remove('hidden');

            // Add active class to selected nav item
            const selectedNav = document.getElementById('nav-' + sectionName);
            if (selectedNav) {
                selectedNav.classList.remove('hover:bg-white/20');
                selectedNav.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'shadow-lg', 'border-2', 'border-blue-300', 'scale-105');
            }

            // Load section-specific data
            switch(sectionName) {
                case 'my-tasks':
                    loadMyTasks();
                    break;
                case 'requests':
                    loadUserRequests().then(() => {
                        // Marca tutte le richieste elaborate come visualizzate
                        markProcessedRequestsAsViewed();
                    });
                    // Nascondi badge quando visualizza le richieste
                    setTimeout(() => {
                        const badge = document.getElementById('processed-requests-badge');
                        if (badge) badge.classList.add('hidden');
                    }, 1000);
                    break;
                case 'communications':
                    loadUserCommunications();
                    break;
                case 'profile':
                    loadUserProfile();
                    break;
            }

            lucide.createIcons();
        }

        async function loadDashboardData() {
            await loadMyTasks(); // This will populate userTasks
            loadTodayTasks();
            updateUserStats();
        }

        function loadTodayTasks() {
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = userTasks.filter(task => 
                task.stato === 'in_corso' || task.stato === 'in-corso' ||
                (task.scadenza === today) || (task.deadline === today) ||
                (new Date(task.scadenza || task.deadline) <= new Date() && task.stato !== 'completato')
            );

            const container = document.getElementById('todayTasks');
            if (!container) return;
            
            container.innerHTML = '';

            if (todayTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna lavorazione per oggi</p>';
                return;
            }

            todayTasks.forEach(task => {
                const taskElement = createTodayTaskElement(task);
                container.appendChild(taskElement);
            });
        }

        function createTodayTaskElement(task) {
            const div = document.createElement('div');
            div.className = `task-card bg-gray-50 rounded-lg p-4 mb-4 ${getPriorityClass(task.priorita)}`;

            const isOverdue = new Date(task.scadenza) < new Date() && task.stato !== 'completato';

            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-900">${task.titolo}</h4>
                            <button onclick="openTaskDetails('${task.id}')" class="text-blue-600 hover:text-blue-800" title="Vedi Dettagli">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">${task.descrizione}</p>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="px-2 py-1 rounded text-xs font-medium ${getStatusClass(task.stato)}">${getStatusText(task.stato)}</span>
                                <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityBadgeClass(task.priorita)}">${task.priorita.charAt(0).toUpperCase() + task.priorita.slice(1)}</span>
                                <span class="text-xs ${isOverdue ? 'text-red-600 font-medium' : 'text-gray-500'}">
                                    <i data-lucide="calendar" class="w-3 h-3 inline mr-1"></i>
                                    ${formatDate(task.scadenza)}
                                </span>
                            </div>
                            <button onclick="openTaskUpdateModal('${task.id}')" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                Aggiorna
                            </button>
                        </div>
                        ${task.progresso !== undefined ? `
                            <div class="mt-3">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>Progresso</span>
                                    <span>${task.progresso}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: ${task.progresso}%"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            return div;
        }

        async function loadMyTasks() {
            const container = document.getElementById('myTasksGrid');
            if (!container) return;

            try {
                // Get current user
                const currentUser = await window.AuthHelper.getCurrentUser();
                if (!currentUser) {
                    console.error('No user logged in');
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Effettua il login per vedere le tue lavorazioni</p>';
                    return;
                }

                // Get user's teams
                const userTeamIds = await window.TeamsAPI.getUserTeams(currentUser.id);

                // Load all tasks from Supabase
                const allTasks = await window.dataManager.getLavorazioni();
                
                // Filter tasks assigned to current user OR to their teams
                userTasks = allTasks.filter(task => {
                    // Direct user assignment
                    const isDirectlyAssigned = task.assigned_user_id === currentUser.id || 
                                              task.assignedUserId === currentUser.id ||
                                              task.assegnatario === currentUser.id;
                    
                    // Team assignment
                    const isTeamAssigned = task.assigned_team_id && 
                                          userTeamIds.includes(task.assigned_team_id);
                    
                    return isDirectlyAssigned || isTeamAssigned;
                });

                // Load team details and members for team tasks
                for (const task of userTasks) {
                    if (task.assigned_team_id) {
                        try {
                            const team = await window.TeamsAPI.getById(task.assigned_team_id);
                            const members = await window.TeamsAPI.getMembers(task.assigned_team_id);
                            task.team = team;
                            task.teamMembers = members;
                        } catch (err) {
                            console.warn(`Could not load team details for task ${task.id}:`, err);
                        }
                    }
                }

                container.innerHTML = '';

                const statusFilter = document.getElementById('taskStatusFilter')?.value || '';
                const filteredTasks = userTasks.filter(task => 
                    !statusFilter || task.stato === statusFilter
                );

                if (filteredTasks.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessuna lavorazione trovata</p>';
                    return;
                }

                filteredTasks.forEach(task => {
                    const taskCard = createTaskCard(task);
                    container.appendChild(taskCard);
                });

                // Reinitialize Lucide icons
                if (window.lucide) lucide.createIcons();

                // Setup filter event listener
                const filter = document.getElementById('taskStatusFilter');
                if (filter) {
                    filter.removeEventListener('change', loadMyTasks);
                    filter.addEventListener('change', loadMyTasks);
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-8">Errore nel caricamento delle lavorazioni</p>';
            }
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card bg-white rounded-lg shadow-md p-6 ${getPriorityClass(task.priorita || task.priority)}`;

            // Support both snake_case and camelCase field names
            const titolo = task.titolo || task.title || 'N/A';
            const descrizione = task.descrizione || task.description || 'Nessuna descrizione';
            const stato = task.stato || task.status || 'da_fare';
            const scadenza = task.scadenza || task.deadline;
            const clienteId = task.cliente_id || task.client_id || task.clienteId;
            const clienteName = task.client_name || task.cliente || 'Cliente';
            const priorita = task.priorita || task.priority || 'media';
            const progresso = task.progresso || task.progress || 0;

            const isOverdue = scadenza && new Date(scadenza) < new Date() && stato !== 'completato';

            // Build team members display
            let teamMembersHTML = '';
            if (task.assigned_team_id && task.teamMembers && task.teamMembers.length > 0) {
                const memberBadges = task.teamMembers.map(member => 
                    `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i data-lucide="user" class="w-3 h-3 mr-1"></i>
                        ${member.nome} ${member.cognome}
                    </span>`
                ).join(' ');
                
                teamMembersHTML = `
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="text-xs text-gray-600 mb-2 flex items-center justify-between gap-1">
                            <div class="flex items-center gap-1">
                                <i data-lucide="users" class="w-4 h-4"></i>
                                <span class="font-medium">Squadra: ${task.team?.nome || 'N/A'}</span>
                            </div>
                            <button onclick="toggleTeamMembers(this)" class="team-toggle-btn" style="display: none;">
                                <i class="fas fa-users"></i> Mostra Membri <span class="arrow">‚ñº</span>
                            </button>
                        </div>
                        <div class="team-members-container">
                            <div class="flex flex-wrap gap-1">
                                ${memberBadges}
                            </div>
                        </div>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <h3 class="font-semibold text-gray-900">${titolo}</h3>
                    <button onclick="openTaskDetails('${task.id}')" class="text-blue-600 hover:text-blue-800" title="Vedi Dettagli">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-gray-600 text-sm mb-4">${descrizione}</p>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="px-2 py-1 rounded text-xs font-medium ${getStatusClass(stato)}">${getStatusText(stato)}</span>
                        <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityBadgeClass(priorita)}">${priorita.charAt(0).toUpperCase() + priorita.slice(1)}</span>
                    </div>
                    ${clienteId ? `
                    <div class="flex items-center justify-between text-sm">
                        <button onclick="window.ClientModal.show('${clienteId}')" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1">
                            <i class="fas fa-building"></i>
                            <span>${clienteName}</span>
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                        ${scadenza ? `
                        <span class="${isOverdue ? 'text-red-600 font-medium' : 'text-gray-500'}">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                            ${formatDate(scadenza)}
                        </span>
                        ` : ''}
                    </div>
                    ` : scadenza ? `
                    <div class="text-sm text-right">
                        <span class="${isOverdue ? 'text-red-600 font-medium' : 'text-gray-500'}">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                            ${formatDate(scadenza)}
                        </span>
                    </div>
                    ` : ''}
                    ${progresso !== undefined && progresso !== null ? `
                        <div>
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>Progresso</span>
                                <span id="task-progress-${task.id}">${progresso}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="task-progress-bar-${task.id}" class="progress-bar bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progresso}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    ${teamMembersHTML}
                </div>
                
                <!-- Azioni Lavorazione -->
                <div class="mt-4 pt-4 border-t border-gray-200 flex gap-2">
                    ${stato !== 'completata' && stato !== 'completato' ? `
                        <button 
                            onclick='openSignatureModal(${JSON.stringify(task).replace(/'/g, "&apos;")})'
                            class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 px-3 rounded-lg hover:shadow-lg transition font-semibold text-sm flex items-center justify-center gap-2">
                            <i data-lucide="pen-tool" class="w-4 h-4"></i>
                            Fai Firmare
                        </button>
                    ` : task.pdf_report_url ? `
                        <button 
                            onclick="window.open('${task.pdf_report_url}', '_blank')"
                            class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2 px-3 rounded-lg hover:shadow-lg transition font-semibold text-sm flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Scarica PDF
                        </button>
                    ` : `
                        <button 
                            onclick="downloadPDF('${task.id}')"
                            class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2 px-3 rounded-lg hover:shadow-lg transition font-semibold text-sm flex items-center justify-center gap-2">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Genera PDF
                        </button>
                    `}
                </div>
            `;

            return card;
        }

        async function loadUserRequests() {
            const container = document.getElementById('userRequestsList');
            if (!container) return;

            container.innerHTML = '<div class="text-center py-8 text-gray-500">Caricamento...</div>';

            try {
                // Carica richieste da Supabase
                const allRequests = await window.dataManager.getRichieste();
                const currentUser = window.AuthHelper.getCurrentUser();
                
                // Filtra solo le richieste dell'utente corrente
                const userRequests = allRequests.filter(req => req.user_id === currentUser?.id);

                // Recupera le richieste gi√† visualizzate da localStorage
                const viewedRequestsKey = `viewedRequests_${currentUser?.id}`;
                const viewedRequests = JSON.parse(localStorage.getItem(viewedRequestsKey) || '[]');

                // Conta richieste elaborate NON ancora visualizzate
                const processedRequests = userRequests.filter(req => {
                    const stato = req.stato || req.status;
                    const isProcessed = stato === 'approvata' || stato === 'approved' || stato === 'rifiutata' || stato === 'rejected';
                    const notViewed = !viewedRequests.includes(req.id);
                    return isProcessed && notViewed;
                });

                // Aggiorna badge nel menu
                const badge = document.getElementById('processed-requests-badge');
                if (badge) {
                    if (processedRequests.length > 0) {
                        badge.textContent = processedRequests.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                container.innerHTML = '';

                if (userRequests.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Nessuna richiesta trovata</div>';
                    return;
                }

                userRequests.forEach(request => {
                    const requestCard = createRequestCard(request);
                    container.appendChild(requestCard);
                });

                lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento richieste:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Errore caricamento richieste</div>';
            }
        }

        async function markProcessedRequestsAsViewed() {
            try {
                const allRequests = await window.dataManager.getRichieste();
                const currentUser = window.AuthHelper.getCurrentUser();
                
                // Filtra richieste elaborate dell'utente corrente
                const processedRequestIds = allRequests
                    .filter(req => {
                        const stato = req.stato || req.status;
                        const isProcessed = stato === 'approvata' || stato === 'approved' || stato === 'rifiutata' || stato === 'rejected';
                        return req.user_id === currentUser?.id && isProcessed;
                    })
                    .map(req => req.id);

                // Salva in localStorage
                const viewedRequestsKey = `viewedRequests_${currentUser?.id}`;
                const existingViewed = JSON.parse(localStorage.getItem(viewedRequestsKey) || '[]');
                const updatedViewed = [...new Set([...existingViewed, ...processedRequestIds])];
                localStorage.setItem(viewedRequestsKey, JSON.stringify(updatedViewed));
            } catch (error) {
                console.error('Errore salvataggio richieste visualizzate:', error);
            }
        }

        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow';

            const statusClass = getRequestStatusClass(request.stato);
            const typeIcon = getRequestTypeIcon(request.tipo);

            card.innerHTML = `
                <div class="flex flex-col space-y-4">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-1">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="${typeIcon}" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 mb-2 text-lg">${request.titolo || 'Senza titolo'}</h3>
                                <p class="text-gray-600 text-sm mb-3">${request.descrizione || ''}</p>
                            </div>
                            <span class="${statusClass} px-3 py-1 rounded-full text-sm font-medium h-fit">${getRequestStatusText(request.stato)}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-3 border-t border-gray-100">
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-400">üìÖ</span>
                            <div>
                                <div class="text-xs text-gray-500 font-medium">Richiesta il</div>
                                <div class="text-gray-900 font-semibold">${formatDate(request.created_at)}</div>
                            </div>
                        </div>
                        ${request.data_inizio && request.data_fine ? `
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-400">üóìÔ∏è</span>
                            <div>
                                <div class="text-xs text-gray-500 font-medium">Periodo richiesto</div>
                                <div class="text-gray-900 font-semibold">${formatDate(request.data_inizio)} - ${formatDate(request.data_fine)}</div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-400">‚ö°</span>
                            <div>
                                <div class="text-xs text-gray-500 font-medium">Priorit√†</div>
                                <div class="text-gray-900 font-semibold capitalize">${request.priorita || 'normale'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Click handler per aprire i dettagli
            card.addEventListener('click', () => {
                // Se ha note, mostra solo quelle
                if (request.note && (request.stato === 'approvata' || request.stato === 'rifiutata')) {
                    openRequestNotes(request);
                }
            });

            return card;
        }

        function openRequestNotes(request) {
            // Crea modal con solo le note
            const existingModal = document.getElementById('requestNotesModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'requestNotesModal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            
            const isApproved = request.stato === 'approvata';
            const bgColor = isApproved ? 'green' : 'red';
            const icon = isApproved ? '‚úÖ' : '‚ùå';
            const statusText = isApproved ? 'Approvata' : 'Rifiutata';

            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full animate-slide-up mx-4 request-notes-popup">
                    <div class="bg-${bgColor}-500 text-white px-5 py-4 rounded-t-xl flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">${icon}</span>
                            <h3 class="font-bold text-lg">${statusText}</h3>
                        </div>
                        <button onclick="closeRequestNotes()" class="text-white/90 hover:text-white text-2xl">&times;</button>
                    </div>
                    
                    <div class="p-5">
                        <div class="text-sm font-semibold text-gray-700 mb-2">Note dell'Admin:</div>
                        <div class="bg-${bgColor}-50 border border-${bgColor}-200 rounded-lg p-4">
                            <p class="text-${bgColor}-900 text-base leading-relaxed">${request.note}</p>
                        </div>
                        
                        <button onclick="closeRequestNotes()" class="w-full mt-4 bg-gray-600 text-white px-4 py-3 rounded-lg text-base font-medium hover:bg-gray-700 transition-colors">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeRequestNotes();
            });
        }

        function closeRequestNotes() {
            const modal = document.getElementById('requestNotesModal');
            if (modal) modal.remove();
        }

        async function loadUserCommunications() {
            const container = document.getElementById('userCommunicationsList');
            if (!container) return;

            container.innerHTML = '<div class="text-center py-8 text-gray-500">Caricamento...</div>';

            try {
                // Carica comunicazioni da Supabase
                const communications = await window.dataManager.getComunicazioni();
                
                // Filtra solo quelle destinate all'utente corrente
                const currentUser = window.AuthHelper.getCurrentUser();
                const userComms = communications.filter(comm => {
                    // Mostra se destinatari = 'tutti'
                    if (comm.destinatari === 'tutti') return true;
                    
                    // Mostra se destinatari = 'dipendenti' (tutti gli utenti loggati)
                    if (comm.destinatari === 'dipendenti') return true;
                    
                    // Mostra se destinatari = 'admin' E l'utente √® admin (Tecnico, Segreteria, Titolare)
                    if (comm.destinatari === 'admin' && window.AuthHelper.isAdmin()) return true;
                    
                    // Mostra se destinatari = 'specifici' E l'utente √® nella lista
                    if (comm.destinatari === 'specifici' && comm.destinatari_specifici?.includes(currentUser?.id)) return true;
                    
                    return false;
                });

                // Conta quelle non lette
                const unreadCount = userComms.filter(comm => !comm.letta_da?.includes(currentUser?.id)).length;
                
                // Aggiorna badge notifiche (sia desktop che mobile)
                const badge = document.getElementById('unread-comm-badge');
                const mobileBadge = document.getElementById('mobile-comm-badge');
                
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
                
                if (mobileBadge) {
                    if (unreadCount > 0) {
                        mobileBadge.textContent = unreadCount;
                        mobileBadge.style.display = 'flex';
                    } else {
                        mobileBadge.style.display = 'none';
                    }
                }

                container.innerHTML = '';

                if (userComms.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Nessuna comunicazione disponibile</div>';
                    return;
                }

                userComms.forEach(comm => {
                    // Use mobile version if available
                    const isMobile = window.innerWidth <= 768;
                    const hasMobileFunction = typeof window.createMobileCommunicationCard === 'function';
                    
                    const commCard = isMobile && hasMobileFunction
                        ? window.createMobileCommunicationCard(comm, currentUser)
                        : createCommunicationCard(comm);
                    container.appendChild(commCard);
                });

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                // Apply current filter and update counts
                filterCommunications(currentFilter);
            } catch (error) {
                console.error('Errore caricamento comunicazioni:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Errore caricamento comunicazioni</div>';
            }
        }

        function createCommunicationCard(comm) {
            const card = document.createElement('div');
            const currentUser = window.AuthHelper.getCurrentUser();
            const isRead = comm.letta_da?.includes(currentUser?.id);
            const isArchived = comm.archiviata_da?.includes(currentUser?.id);
            const isDeleted = comm.eliminata_da?.some(item => item.user_id === currentUser?.id);
            
            card.className = `bg-white rounded-lg shadow-md p-6 ${!isRead ? 'border-l-4 border-blue-500' : ''}`;
            card.dataset.commId = comm.id;
            card.dataset.read = isRead ? 'true' : 'false';
            card.dataset.archived = isArchived ? 'true' : 'false';
            card.dataset.deleted = isDeleted ? 'true' : 'false';

            const typeIcon = getCommunicationTypeIcon(comm.tipo);
            const priorityClass = comm.priorita === 'alta' ? 'text-red-600' : comm.priorita === 'media' ? 'text-orange-600' : 'text-green-600';

            // Estrai testo da HTML contenuto (rimuovi tag HTML)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = comm.contenuto || '';
            const plainText = tempDiv.textContent || tempDiv.innerText || '';
            const preview = plainText.substring(0, 150) + (plainText.length > 150 ? '...' : '');

            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-4 flex-1">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="${typeIcon}" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h3 class="font-semibold text-gray-900">${comm.titolo}</h3>
                                ${!isRead ? '<span class="w-2 h-2 bg-blue-500 rounded-full" title="Non letta"></span>' : ''}
                                ${isArchived ? '<i data-lucide="archive" class="w-4 h-4 text-gray-500" title="Archiviata"></i>' : ''}
                                ${isDeleted ? '<i data-lucide="trash-2" class="w-4 h-4 text-red-500" title="Eliminata"></i>' : ''}
                                <span class="text-xs ${priorityClass} font-medium">${comm.priorita.toUpperCase()}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">${preview}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="text-xs text-gray-500">${formatDate(comm.data_invio || comm.created_at)}</span>
                                    <span class="text-xs text-gray-500 capitalize">${comm.tipo}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="viewCommunicationDetail('${comm.id}')" 
                                            class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Leggi
                                    </button>
                                    ${!isRead ? `
                                    <button onclick="event.stopPropagation(); toggleRead('${comm.id}', true)" 
                                            class="px-3 py-1 text-xs border border-green-600 text-green-600 rounded hover:bg-green-50" 
                                            title="Segna come letta">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                    </button>
                                    ` : `
                                    <button onclick="event.stopPropagation(); toggleRead('${comm.id}', false)" 
                                            class="px-3 py-1 text-xs border border-gray-400 text-gray-600 rounded hover:bg-gray-50" 
                                            title="Segna come non letta">
                                        <i data-lucide="mail" class="w-3 h-3"></i>
                                    </button>
                                    `}
                                    ${!isArchived ? `
                                    <button onclick="event.stopPropagation(); toggleArchive('${comm.id}', true)" 
                                            class="px-3 py-1 text-xs border border-gray-400 text-gray-600 rounded hover:bg-gray-50" 
                                            title="Archivia">
                                        <i data-lucide="archive" class="w-3 h-3"></i>
                                    </button>
                                    ` : `
                                    <button onclick="event.stopPropagation(); toggleArchive('${comm.id}', false)" 
                                            class="px-3 py-1 text-xs border border-blue-600 text-blue-600 rounded hover:bg-blue-50" 
                                            title="Ripristina da archivio">
                                        <i data-lucide="archive-restore" class="w-3 h-3"></i>
                                    </button>
                                    `}
                                    ${!isDeleted ? `
                                    <button onclick="event.stopPropagation(); deleteCommunicationAsUser('${comm.id}')" 
                                            class="px-3 py-1 text-xs border border-red-600 text-red-600 rounded hover:bg-red-50" 
                                            title="Elimina">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        function openTaskUpdateModal(taskId) {
            // Find task in userTasks array - support both numeric and UUID IDs
            const task = userTasks.find(t => t.id == taskId || t.id === taskId);
            if (!task) {
                console.error('Task not found:', taskId);
                showNotification('Lavorazione non trovata', 'error');
                return;
            }

            currentEditingTask = task;
            
            document.getElementById('taskProgress').value = task.progresso || 0;
            document.getElementById('progressValue').textContent = (task.progresso || 0) + '%';
            document.getElementById('taskNewStatus').value = task.stato || 'da_fare';
            document.getElementById('taskNotes').value = task.note_progresso || '';
            
            // Show team members if this is a team task
            const teamSection = document.getElementById('updateModalTeamSection');
            if (task.assigned_team_id && task.team && task.teamMembers) {
                teamSection.classList.remove('hidden');
                document.getElementById('updateModalTeamName').textContent = task.team.nome || 'N/A';
                
                const membersContainer = document.getElementById('updateModalTeamMembers');
                membersContainer.innerHTML = task.teamMembers.map(member => `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        <i data-lucide="user" class="w-3 h-3 mr-1"></i>
                        ${member.nome} ${member.cognome}
                    </span>
                `).join('');
            } else {
                teamSection.classList.add('hidden');
            }
            
            document.getElementById('taskUpdateModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeTaskUpdateModal() {
            document.getElementById('taskUpdateModal').classList.add('hidden');
            currentEditingTask = null;
        }

        function updateProgressValue(value) {
            document.getElementById('progressValue').textContent = value + '%';
        }

        async function saveTaskUpdate() {
            if (!currentEditingTask) return;

            try {
                const newProgress = parseInt(document.getElementById('taskProgress').value);
                const newStatus = document.getElementById('taskNewStatus').value;
                const notes = document.getElementById('taskNotes').value;

                // Prepare updated task data
                const updatedTask = {
                    ...currentEditingTask,
                    progresso: newProgress,
                    stato: newStatus,
                    note_progresso: notes,
                    updated_at: new Date().toISOString()
                };
                
                // Auto-set progress based on status
                if (newStatus === 'completato') {
                    updatedTask.progresso = 100;
                } else if (newStatus === 'revisione' && newProgress < 90) {
                    updatedTask.progresso = 90;
                }

                // Save to Supabase
                await window.dataManager.saveLavorazione(updatedTask);

                // Update local array
                const taskIndex = userTasks.findIndex(t => t.id === currentEditingTask.id);
                if (taskIndex !== -1) {
                    userTasks[taskIndex] = updatedTask;
                }

                // Update progress bars in real-time if elements exist
                const progressBar = document.getElementById(`task-progress-bar-${currentEditingTask.id}`);
                const progressText = document.getElementById(`task-progress-${currentEditingTask.id}`);
                const detailProgressBar = document.getElementById('detail-progress-bar');
                const detailProgressText = document.getElementById('detail-progress-text');
                
                if (progressBar) {
                    progressBar.style.width = updatedTask.progresso + '%';
                }
                if (progressText) {
                    progressText.textContent = updatedTask.progresso + '%';
                }
                if (detailProgressBar) {
                    detailProgressBar.style.width = updatedTask.progresso + '%';
                }
                if (detailProgressText) {
                    detailProgressText.textContent = updatedTask.progresso + '%';
                }

                // Reload data to show updated progress bars
                await loadMyTasks();
                await loadDashboardData();
                updateUserStats();
                
                // Close modal after data is loaded
                closeTaskUpdateModal();
                
                showNotification('Lavorazione aggiornata con successo!', 'success');
            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
            }
        }

        function openRequestModal() {
            document.getElementById('requestForm').reset();
            document.getElementById('requestModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeRequestModal() {
            document.getElementById('requestModal').classList.add('hidden');
        }

        function createNewRequest() {
            openRequestModal();
        }

        // Request form submission
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentUser = window.AuthHelper.getCurrentUser();
            if (!currentUser) {
                showNotification('Errore: utente non autenticato', 'error');
                return;
            }

            const requestData = {
                user_id: currentUser.id,
                tipo: document.getElementById('requestType').value,
                titolo: document.getElementById('requestTitle').value,
                descrizione: document.getElementById('requestDescription').value,
                data_inizio: document.getElementById('requestStartDate').value,
                data_fine: document.getElementById('requestEndDate').value,
                stato: 'pendente',
                priorita: 'normale'
            };

            try {
                // Salva nel database usando dataManager
                await window.dataManager.saveRichiesta(requestData);
                
                closeRequestModal();
                showNotification('Richiesta inviata con successo!', 'success');
                
                // Ricarica la lista delle richieste
                await loadUserRequests();
            } catch (error) {
                console.error('Errore invio richiesta:', error);
                showNotification('Errore durante l\'invio della richiesta', 'error');
            }
        });

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showNotification('Profilo aggiornato con successo!', 'success');
        });
        
        // Load user profile data
        async function loadUserProfile() {
            try {
                const currentUser = window.AuthHelper.getCurrentUser();
                if (!currentUser) return;
                
                // Populate form fields
                document.getElementById('profileName').value = currentUser.nome || '';
                document.getElementById('profileSurname').value = currentUser.cognome || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profilePhone').value = currentUser.telefono || '';
                
                // Set role (readonly)
                const roleMap = {
                    'dipendente': 'Dipendente',
                    'tecnico': 'Tecnico',
                    'segreteria': 'Segreteria',
                    'titolare': 'Titolare'
                };
                document.getElementById('profileRole').value = roleMap[currentUser.ruolo] || currentUser.ruolo || '';
                
                // Update profile photo preview
                const photoPreview = document.getElementById('profilePhotoPreview');
                if (photoPreview && currentUser.foto_profilo) {
                    photoPreview.src = currentUser.foto_profilo;
                }
                
                // Load and display real statistics
                const tasks = await window.dataManager.getLavorazioni();
                const userTasksData = tasks.filter(t => t.assegnato_a === currentUser.id);
                
                const totalTasks = userTasksData.length;
                const completedTasks = userTasksData.filter(t => t.stato === 'completato').length;
                const avgTasks = totalTasks > 0 ? (totalTasks / 30).toFixed(1) : '0'; // Assumendo 30 giorni
                
                // Update stats in profile
                const totalEl = document.getElementById('profileTotalTasks');
                const completedEl = document.getElementById('profileCompletedTasks');
                const avgEl = document.getElementById('profileAvgTasks');
                
                if (totalEl) totalEl.textContent = totalTasks;
                if (completedEl) completedEl.textContent = completedTasks;
                if (avgEl) avgEl.textContent = avgTasks;
                
                // Update last login display (TODO: salvare last_login nel database)
                const now = new Date();
                const timeString = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('lastLoginUser').textContent = `Oggi, ${timeString}`;
                
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showNotification('Formato file non valido. Usa JPG, PNG o GIF', 'error');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File troppo grande. Massimo 5MB', 'error');
                return;
            }

            try {
                const currentUser = window.AuthHelper.getCurrentUser();
                if (!currentUser) {
                    showNotification('Errore: utente non autenticato', 'error');
                    return;
                }

                // Show progress
                const progressContainer = document.getElementById('uploadProgressContainer');
                const progressBar = document.getElementById('uploadProgressBar');
                const progressText = document.getElementById('uploadProgressText');
                
                if (progressContainer) {
                    progressContainer.classList.remove('hidden');
                    progressBar.style.width = '0%';
                }

                // Preview the image
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('profilePhotoPreview');
                    if (preview) {
                        preview.src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);

                // Simulate upload progress
                progressBar.style.width = '30%';
                progressText.textContent = 'Caricamento...';

                // Upload to Supabase Storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
                const filePath = `profile-photos/${fileName}`;

                progressBar.style.width = '60%';

                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('user-photos')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (uploadError) throw uploadError;

                progressBar.style.width = '80%';

                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('user-photos')
                    .getPublicUrl(filePath);

                const photoUrl = urlData.publicUrl;

                // Update user profile in database
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ foto_profilo: photoUrl })
                    .eq('id', currentUser.id);

                if (updateError) throw updateError;

                progressBar.style.width = '100%';
                progressText.textContent = 'Completato!';

                // Update header photo
                const headerPhoto = document.getElementById('userProfilePhoto');
                if (headerPhoto) {
                    headerPhoto.src = photoUrl;
                }

                setTimeout(() => {
                    if (progressContainer) {
                        progressContainer.classList.add('hidden');
                    }
                    showNotification('Foto profilo aggiornata con successo!', 'success');
                }, 500);

            } catch (error) {
                console.error('Error uploading photo:', error);
                const progressContainer = document.getElementById('uploadProgressContainer');
                if (progressContainer) {
                    progressContainer.classList.add('hidden');
                }
                showNotification('Errore nel caricamento della foto', 'error');
            }
        }

        async function markAsRead(commId) {
            try {
                const currentUser = window.AuthHelper.getCurrentUser();
                if (!currentUser) {
                    showNotification('Errore: utente non autenticato', 'error');
                    return;
                }

                // Recupera la comunicazione corrente
                const { data, error } = await supabase
                    .from('communications')
                    .select('letta_da')
                    .eq('id', commId)
                    .single();

                if (error) throw error;

                // Aggiungi l'utente corrente all'array letta_da
                const updatedLettaDa = data.letta_da || [];
                if (!updatedLettaDa.includes(currentUser.id)) {
                    updatedLettaDa.push(currentUser.id);
                }

                // Aggiorna il record
                const { error: updateError } = await supabase
                    .from('communications')
                    .update({ letta_da: updatedLettaDa })
                    .eq('id', commId);

                if (updateError) throw updateError;

                loadUserCommunications();
                showNotification('Comunicazione segnata come letta', 'info');
            } catch (error) {
                console.error('Errore mark as read:', error);
                showNotification('Errore durante l\'aggiornamento', 'error');
            }
        }

        // Toggle read/unread status
        async function toggleRead(commId, markAsRead) {
            try {
                const currentUser = window.AuthHelper.getCurrentUser();
                if (!currentUser) {
                    showNotification('Errore: utente non autenticato', 'error');
                    return;
                }

                const { data, error } = await supabase
                    .from('communications')
                    .select('letta_da')
                    .eq('id', commId)
                    .single();

                if (error) throw error;

                let lettaDa = data.letta_da || [];
                
                if (markAsRead && !lettaDa.includes(currentUser.id)) {
                    lettaDa.push(currentUser.id);
                } else if (!markAsRead) {
                    lettaDa = lettaDa.filter(id => id !== currentUser.id);
                }

                const { error: updateError } = await supabase
                    .from('communications')
                    .update({ letta_da: lettaDa })
                    .eq('id', commId);

                if (updateError) throw updateError;

                loadUserCommunications();
                showNotification(markAsRead ? 'Segnata come letta' : 'Segnata come non letta', 'success');
            } catch (error) {
                console.error('Errore toggle read:', error);
                showNotification('Errore durante l\'aggiornamento', 'error');
            }
        }

        // Toggle archive status
        async function toggleArchive(commId, archive) {
            try {
                const currentUser = window.AuthHelper.getCurrentUser();
                if (!currentUser) {
                    showNotification('Errore: utente non autenticato', 'error');
                    return;
                }

                if (archive) {
                    await window.CommunicationsAPI.archiveCommunication(commId, currentUser.id);
                    showNotification('Comunicazione archiviata', 'success');
                } else {
                    await window.CommunicationsAPI.unarchiveCommunication(commId, currentUser.id);
                    showNotification('Comunicazione ripristinata', 'success');
                }

                loadUserCommunications();
            } catch (error) {
                console.error('Errore toggle archive:', error);
                showNotification('Errore durante l\'archiviazione', 'error');
            }
        }

        // Delete communication for user (soft delete with tracking)
        async function deleteCommunicationAsUser(commId) {
            // Show custom confirmation modal instead of simple confirm
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Conferma Eliminazione</h3>
                    </div>
                    <div class="mb-6">
                        <p class="text-gray-700 mb-3">Sei sicuro di voler eliminare questa comunicazione?</p>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <div class="flex items-start gap-2">
                                <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                                <div>
                                    <p class="text-sm font-medium text-blue-900 mb-1">Informativa</p>
                                    <p class="text-sm text-blue-800">
                                        ‚Ä¢ La comunicazione sar√† spostata nel cestino<br>
                                        ‚Ä¢ <strong>L'amministratore ricever√† una notifica</strong> con data e ora dell'eliminazione<br>
                                        ‚Ä¢ Questo serve come prova che hai ricevuto la comunicazione
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">
                            Annulla
                        </button>
                        <button id="confirmDeleteBtn" 
                                class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                            Elimina
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            
            // Handle confirmation
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                modal.remove();
                
                try {
                    const currentUser = window.AuthHelper.getCurrentUser();
                    if (!currentUser) {
                        showNotification('Errore: utente non autenticato', 'error');
                        return;
                    }

                    await window.CommunicationsAPI.deleteCommunicationForUser(commId, currentUser.id);
                    
                    loadUserCommunications();
                    showNotification('Comunicazione eliminata. L\'admin √® stato notificato.', 'info');
                } catch (error) {
                    console.error('Errore delete communication:', error);
                    showNotification('Errore durante l\'eliminazione', 'error');
                }
            });
        }

        // Filter communications
        let currentFilter = 'tutte';

        async function filterCommunications(filter) {
            currentFilter = filter;
            
            // Update tab UI
            document.querySelectorAll('.comm-filter-tab').forEach(tab => {
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Filter and display cards
            const communications = await window.dataManager.getComunicazioni();
            const currentUser = window.AuthHelper.getCurrentUser();
            
            // Get all communication cards
            const cards = document.querySelectorAll('#userCommunicationsList > div[data-comm-id]');
            
            let counts = {
                tutte: 0,
                'da-leggere': 0,
                lette: 0,
                archiviate: 0,
                eliminate: 0
            };

            cards.forEach(card => {
                const commId = card.dataset.commId;
                const comm = communications.find(c => c.id === commId);
                if (!comm) return;

                const isRead = comm.letta_da?.includes(currentUser?.id);
                const isArchived = comm.archiviata_da?.includes(currentUser?.id);
                const isDeleted = comm.eliminata_da?.some(item => item.user_id === currentUser?.id);

                // Count
                counts.tutte++;
                if (!isRead && !isDeleted) counts['da-leggere']++;
                if (isRead && !isDeleted) counts.lette++;
                if (isArchived && !isDeleted) counts.archiviate++;
                if (isDeleted) counts.eliminate++;

                // Show/hide based on filter
                let show = false;
                switch(filter) {
                    case 'tutte':
                        show = !isDeleted;
                        break;
                    case 'da-leggere':
                        show = !isRead && !isDeleted;
                        break;
                    case 'lette':
                        show = isRead && !isDeleted;
                        break;
                    case 'archiviate':
                        show = isArchived && !isDeleted;
                        break;
                    case 'eliminate':
                        show = isDeleted;
                        break;
                }

                card.style.display = show ? 'block' : 'none';
            });

            // Update counts
            Object.keys(counts).forEach(key => {
                const countEl = document.getElementById(`count-${key}`);
                if (countEl) countEl.textContent = counts[key];
            });

            // Show empty message if needed
            const visibleCards = Array.from(cards).filter(c => c.style.display !== 'none');
            const container = document.getElementById('userCommunicationsList');
            const emptyMsg = container.querySelector('.empty-message');
            
            if (visibleCards.length === 0) {
                if (!emptyMsg) {
                    const msg = document.createElement('div');
                    msg.className = 'empty-message text-center py-8 text-gray-500';
                    msg.textContent = `Nessuna comunicazione ${filter === 'tutte' ? '' : filter.replace('-', ' ')}`;
                    container.appendChild(msg);
                }
            } else if (emptyMsg) {
                emptyMsg.remove();
            }

            lucide.createIcons();
        }

        async function viewCommunicationDetail(commId) {
            try {
                const communications = await window.dataManager.getComunicazioni();
                const comm = communications.find(c => c.id === commId);
                
                if (!comm) {
                    showNotification('Comunicazione non trovata', 'error');
                    return;
                }

                // Parse allegati if it's a JSON string
                let allegatiArray = [];
                if (comm.allegati) {
                    try {
                        allegatiArray = typeof comm.allegati === 'string' ? JSON.parse(comm.allegati) : comm.allegati;
                    } catch (e) {
                        console.error('Error parsing allegati:', e);
                        allegatiArray = [];
                    }
                }

                // Mostra modal con contenuto completo
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">${comm.titolo}</h3>
                                <div class="flex items-center space-x-3 mt-2">
                                    <span class="text-sm text-gray-500">${formatDate(comm.data_invio || comm.created_at)}</span>
                                    <span class="text-sm text-gray-500 capitalize">${comm.tipo}</span>
                                    <span class="text-sm font-medium ${comm.priorita === 'alta' ? 'text-red-600' : comm.priorita === 'media' ? 'text-orange-600' : 'text-green-600'}">${comm.priorita.toUpperCase()}</span>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="prose max-w-none">
                                ${comm.contenuto}
                            </div>
                            ${allegatiArray && allegatiArray.length > 0 ? `
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <h4 class="font-medium text-gray-900 mb-3">Allegati (${allegatiArray.length})</h4>
                                    <div class="space-y-2">
                                        ${allegatiArray.map((fileData, index) => {
                                            const fileName = typeof fileData === 'string' ? fileData : fileData.name;
                                            const fileUrl = typeof fileData === 'object' && fileData.url ? fileData.url : null;
                                            return `
                                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div class="flex items-center space-x-2">
                                                    <i data-lucide="paperclip" class="w-4 h-4 text-gray-600"></i>
                                                    <span class="text-sm text-gray-700">${fileName}</span>
                                                </div>
                                                ${fileUrl ? `
                                                <a href="${fileUrl}" target="_blank" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                    Visualizza
                                                </a>
                                                ` : `
                                                <span class="text-xs text-gray-400">Non disponibile</span>
                                                `}
                                            </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="p-6 border-t border-gray-200 bg-gray-50">
                            <button onclick="markAsRead('${comm.id}'); this.closest('.fixed').remove();" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Segna come letta e chiudi
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();

                // Marca automaticamente come letta dopo 3 secondi
                setTimeout(() => {
                    markAsRead(commId);
                }, 3000);
            } catch (error) {
                console.error('Errore visualizzazione comunicazione:', error);
                showNotification('Errore durante il caricamento', 'error');
            }
        }

        function viewAttachment(filename, index) {
            // Crea modal per visualizzare l'allegato
            const attachmentModal = document.createElement('div');
            attachmentModal.className = 'fixed inset-0 bg-black bg-opacity-75 z-[60] flex items-center justify-center p-4';
            
            // Determina il tipo di file
            const ext = filename.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext);
            const isPdf = ext === 'pdf';
            
            let content = '';
            if (isImage) {
                // Per le immagini, mostra l'immagine (nota: questo √® un placeholder, servirebbero URL reali)
                content = `
                    <div class="text-center">
                        <img src="/uploads/${filename}" alt="${filename}" class="max-w-full max-h-[70vh] rounded-lg shadow-lg" 
                             onerror="this.parentElement.innerHTML='<p class=text-white>Impossibile caricare l\\'immagine</p>'">
                    </div>
                `;
            } else if (isPdf) {
                content = `
                    <div class="bg-white rounded-lg p-4 w-full max-w-4xl h-[80vh]">
                        <embed src="/uploads/${filename}" type="application/pdf" class="w-full h-full rounded" />
                    </div>
                `;
            } else {
                content = `
                    <div class="bg-white rounded-lg p-8 text-center">
                        <i data-lucide="file" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                        <p class="text-gray-700 mb-4">File: ${filename}</p>
                        <p class="text-sm text-gray-500 mb-4">Tipo file non supportato per l'anteprima</p>
                        <a href="/uploads/${filename}" download class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Scarica File
                        </a>
                    </div>
                `;
            }
            
            attachmentModal.innerHTML = `
                <div class="relative">
                    ${content}
                    <button onclick="this.closest('.fixed').remove()" 
                            class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg hover:bg-gray-100">
                        <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(attachmentModal);
            lucide.createIcons();
        }

        function updateUserStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // Count active tasks (in progress)
            const activeTasks = userTasks.filter(t => {
                const stato = t.stato || t.status;
                return stato === 'in_corso' || stato === 'in_progress';
            }).length;
            
            // Count completed tasks (updated today)
            const completedToday = userTasks.filter(t => {
                const stato = t.stato || t.status;
                const isCompleted = stato === 'completato' || stato === 'completed';
                if (!isCompleted) return false;
                
                // Check if updated today
                const updatedAt = t.updated_at || t.dataAggiornamento;
                if (updatedAt) {
                    const updateDate = new Date(updatedAt).toISOString().split('T')[0];
                    return updateDate === today;
                }
                return false;
            }).length;
            
            // Count overdue tasks
            const overdueTasks = userTasks.filter(t => {
                const scadenza = t.scadenza || t.deadline;
                const stato = t.stato || t.status;
                const isCompleted = stato === 'completato' || stato === 'completed';
                
                if (!scadenza || isCompleted) return false;
                return new Date(scadenza) < new Date();
            }).length;

            // Update DOM
            document.getElementById('userActiveTasks').textContent = activeTasks;
            document.getElementById('userCompletedToday').textContent = completedToday;
            document.getElementById('userOverdueTasks').textContent = overdueTasks;

            // Calculate productivity
            const totalTasks = userTasks.length;
            const completedTasks = userTasks.filter(t => {
                const stato = t.stato || t.status;
                return stato === 'completato' || stato === 'completed';
            }).length;
            const productivity = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('userProductivity').textContent = productivity + '%';
        }

        function logout() {
            document.getElementById('logoutModal').classList.remove('hidden');
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.add('hidden');
        }

        async function confirmLogout() {
            closeLogoutModal();
            showNotification('Logout in corso...', 'info');
            
            try {
                // Sign out from Supabase
                await supabase.auth.signOut();
                
                // Clear all stored user data
                localStorage.removeItem('currentUser');
                localStorage.removeItem('ast_current_user');
                sessionStorage.removeItem('ast_current_user');
                sessionStorage.clear();
                
                showNotification('Logout effettuato', 'success');
                setTimeout(() => {
                    window.location.href = 'Admin/index.html';
                }, 500);
            } catch (error) {
                console.error('Error during logout:', error);
                // Even if there's an error, clear session and redirect
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'Admin/index.html';
            }
        }

        // Profile Photo Management
        let selectedPhotoFile = null;

        function openProfilePhotoModal() {
            document.getElementById('profilePhotoModal').classList.remove('hidden');
            const currentPhoto = document.getElementById('userProfilePhoto').src;
            document.getElementById('photoPreview').src = currentPhoto;
        }

        function closeProfilePhotoModal() {
            document.getElementById('profilePhotoModal').classList.add('hidden');
            selectedPhotoFile = null;
            document.getElementById('photoFileInput').value = '';
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'immagine deve essere inferiore a 5MB', 'error');
                    return;
                }
                
                selectedPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function uploadProfilePhoto() {
            if (!selectedPhotoFile) {
                showNotification('Seleziona un\'immagine prima di salvare', 'error');
                return;
            }

            try {
                const currentUser = await window.AuthHelper.getCurrentUser();
                if (!currentUser) {
                    showNotification('Errore: utente non autenticato', 'error');
                    return;
                }

                // Show progress
                document.getElementById('uploadProgress').classList.remove('hidden');
                document.getElementById('uploadProgressBar').style.width = '20%';

                // Resize image before upload
                const resizedImage = await resizeImage(selectedPhotoFile, 400, 400);
                
                document.getElementById('uploadProgressBar').style.width = '60%';

                // Update user profile with resized image
                const result = await window.UsersAPI.update(currentUser.id, {
                    foto_profilo: resizedImage
                });

                console.log('Update successful:', result);

                document.getElementById('uploadProgressBar').style.width = '100%';
                
                // Update UI
                document.getElementById('userProfilePhoto').src = resizedImage;
                
                setTimeout(() => {
                    closeProfilePhotoModal();
                    showNotification('Foto profilo aggiornata con successo!', 'success');
                }, 500);
            } catch (error) {
                console.error('Error uploading photo:', error);
                console.error('Error details:', JSON.stringify(error, null, 2));
                
                let errorMessage = 'Errore durante il caricamento della foto';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showNotification(errorMessage, 'error');
                document.getElementById('uploadProgress').classList.add('hidden');
            }
        }

        // Helper function to resize image
        function resizeImage(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64 with compression
                        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(resizedBase64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Utility functions (same as admin panel)
        function getStatusClass(status) {
            switch(status) {
                case 'da_fare': return 'bg-gray-100 text-gray-800';
                case 'in_corso': return 'bg-blue-100 text-blue-800';
                case 'revisione': return 'bg-orange-100 text-orange-800';
                case 'completato': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'da_fare': return 'Da Fare';
                case 'in_corso': return 'In Corso';
                case 'revisione': return 'Revisione';
                case 'completato': return 'Completato';
                default: return status;
            }
        }

        function getPriorityEmoji(priority) {
            const emojis = {
                'alta': '‚ö†Ô∏è',
                'media': 'üü°',
                'bassa': '‚úÖ',
                'normale': 'üìã'
            };
            return emojis[priority] || emojis['normale'];
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'alta': return 'priority-alta';
                case 'media': return 'priority-media';
                case 'bassa': return 'priority-bassa';
                default: return '';
            }
        }

        function getPriorityBadgeClass(priority) {
            const p = priority?.toLowerCase() || 'media';
            switch(p) {
                case 'urgent':
                case 'urgente':
                    return 'bg-red-600 text-white';
                case 'high':
                case 'alta':
                    return 'bg-orange-100 text-orange-800';
                case 'medium':
                case 'media':
                    return 'bg-yellow-100 text-yellow-800';
                case 'low':
                case 'bassa':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getPriorityText(priority) {
            const p = priority?.toLowerCase() || 'media';
            switch(p) {
                case 'urgent': return 'Urgente';
                case 'urgente': return 'Urgente';
                case 'high': return 'Alta';
                case 'alta': return 'Alta';
                case 'medium': return 'Media';
                case 'media': return 'Media';
                case 'low': return 'Bassa';
                case 'bassa': return 'Bassa';
                default: return priority;
            }
        }

        function getCategoryText(category) {
            const c = category?.toLowerCase() || 'other';
            switch(c) {
                case 'maintenance':
                case 'manutenzione':
                    return 'Manutenzione';
                case 'production':
                case 'produzione':
                    return 'Produzione';
                case 'quality':
                case 'controllo_qualita':
                    return 'Controllo Qualit√†';
                case 'cleaning':
                case 'pulizia':
                    return 'Pulizia';
                case 'logistics':
                case 'logistica':
                    return 'Logistica';
                case 'other':
                case 'altro':
                    return 'Altro';
                default:
                    return category;
            }
        }

        function getRequestStatusClass(status) {
            switch(status) {
                case 'in_attesa': return 'bg-orange-100 text-orange-800';
                case 'approvata': return 'bg-green-100 text-green-800';
                case 'rifiutata': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getRequestStatusText(status) {
            switch(status) {
                case 'in_attesa': return 'In Attesa';
                case 'approvata': return 'Approvata';
                case 'rifiutata': return 'Rifiutata';
                default: return status;
            }
        }

        function getRequestTypeIcon(type) {
            switch(type) {
                case 'ferie': return 'calendar';
                case 'permessi': return 'clock';
                case 'materiali': return 'package';
                case 'veicoli': return 'car';
                case 'straordinari': return 'zap';
                default: return 'file-text';
            }
        }

        function getCommunicationTypeIcon(type) {
            switch(type) {
                case 'annuncio': return 'megaphone';
                case 'evento': return 'calendar';
                case 'newsletter': return 'newspaper';
                case 'formazione': return 'graduation-cap';
                default: return 'message-circle';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            
            // Usa top-24 invece di top-4 per evitare che vada sotto l'header
            notification.className = `fixed top-24 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-[9999] fade-in max-w-md`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000); // Aumentato a 5 secondi per dare tempo di leggere
        }

        // Task Details and Component Management Functions
        let currentTaskForComponents = null;

        function openTaskDetails(taskId) {
            const task = userTasks.find(t => t.id == taskId || t.id === taskId);
            if (!task) {
                console.error('Task not found:', taskId);
                return;
            }

            currentTaskForComponents = task;
            
            const titolo = task.titolo || task.title || 'N/A';
            const descrizione = task.descrizione || task.description || 'Nessuna descrizione';
            const stato = task.stato || task.status || 'da_fare';
            const priorita = task.priorita || task.priority || 'media';
            const scadenza = task.scadenza || task.deadline;
            const progresso = task.progresso || task.progress || 0;
            const categoria = task.categoria || task.category || 'other';
            const clienteId = task.client_id || task.cliente_id;
            const clienteName = task.client_name || task.cliente || 'Cliente';
            const assignedUser = task.user_name || task.assigned_user_name || null;
            const assignedUserId = task.assigned_user_id || task.assignedUserId || null;
            const assignedTeam = task.team_name || task.assigned_team_name || null;
            const assignedTeamId = task.assigned_team_id || task.assignedTeamId || null;
            const createdAt = task.created_at || null;
            
            document.getElementById('taskDetailsTitle').textContent = `Dettagli: ${titolo}`;
            
            const content = document.getElementById('taskDetailsContent');
            const isOverdue = scadenza && new Date(scadenza) < new Date() && stato !== 'completato';
            
            content.innerHTML = `
                <div class="space-y-3">
                    <!-- Main Info Grid - COLONNA SINGOLA -->
                    <div class="space-y-3">
                        <!-- Cliente - VERDE -->
                        ${clienteId ? `
                        <div class="bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="building-2" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-green-700 font-medium mb-1">Cliente</p>
                                    <button onclick="window.ClientModal.show('${clienteId}')" 
                                            class="font-bold text-gray-900 hover:text-green-700 hover:underline flex items-center gap-1 text-left">
                                        <span class="truncate">${clienteName}</span>
                                        <i data-lucide="external-link" class="w-3 h-3 flex-shrink-0"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Scadenza - ARANCIO -->
                        <div class="bg-gradient-to-br from-orange-50 to-amber-100 border-2 border-orange-200 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="calendar" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-orange-700 font-medium mb-1">Scadenza</p>
                                    ${scadenza ? `
                                    <p class="font-bold ${isOverdue ? 'text-red-600' : 'text-gray-900'}">
                                        ${new Date(scadenza).toLocaleDateString('it-IT', {day: '2-digit', month: '2-digit', year: 'numeric'})}
                                        ${isOverdue ? '<span class="ml-1 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">!</span>' : ''}
                                    </p>
                                    ` : '<p class="font-bold text-gray-500">Non impostata</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- Priorit√† - ROSA -->
                        <div class="bg-gradient-to-br from-pink-50 to-rose-100 border-2 border-pink-200 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="alert-circle" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-pink-700 font-medium mb-1">Priorit√†</p>
                                    <p class="font-bold text-gray-900">${getPriorityEmoji(priorita)} ${priorita.charAt(0).toUpperCase() + priorita.slice(1)}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Stato - BLU -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-blue-700 font-medium mb-1">Stato</p>
                                    <p class="font-bold text-gray-900">${getStatusText(stato)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Assegnato a - VIOLA -->
                        <div class="bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="${assignedTeamId ? 'users' : 'user'}" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-purple-700 font-medium mb-1">Assegnato a</p>
                                    ${assignedTeamId ? `
                                        <p class="font-bold text-gray-900 truncate">Team: ${assignedTeam || 'N/A'}</p>
                                    ` : `
                                        <p class="font-bold text-gray-900 truncate">${assignedUser || 'N/A'}</p>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- Categoria - GIALLO -->
                        <div class="bg-gradient-to-br from-yellow-50 to-amber-100 border-2 border-yellow-200 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-amber-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="tag" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-yellow-700 font-medium mb-1">Categoria</p>
                                    <p class="font-bold text-gray-900">${getCategoryText(categoria)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Team Members (only if assigned to team) - VIOLA CHIARO -->
                    ${assignedTeamId ? `
                    <div class="bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200 rounded-xl p-4">
                        <button onclick="toggleTeamMembers(this)" class="team-toggle-btn w-full text-left flex items-center justify-between">
                            <span class="flex items-center gap-2">
                                <i data-lucide="users" class="w-5 h-5 text-purple-700"></i>
                                <span class="text-sm font-bold text-purple-800">Membri del Team</span>
                            </span>
                            <span class="arrow text-purple-600">‚ñº</span>
                        </button>
                        <div class="team-members-container mt-3">
                            <div id="team-members-${task.id}" class="flex flex-wrap gap-2">
                                <span class="text-gray-500 text-sm">Caricamento...</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Data Creazione - GRIGIO -->
                    ${createdAt ? `
                    <div class="bg-gradient-to-br from-gray-50 to-slate-100 border-2 border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-gray-500 to-slate-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-700 font-medium">Creata il</p>
                                <p class="font-bold text-gray-900">${formatDate(createdAt)}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Progresso - CELESTE -->
                    ${progresso !== undefined ? `
                    <div class="bg-gradient-to-br from-cyan-50 to-sky-100 border-2 border-cyan-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-5 h-5 text-cyan-700"></i>
                                <span class="text-sm font-bold text-cyan-900">Progresso</span>
                            </div>
                            <span id="detail-progress-text" class="text-2xl font-bold text-cyan-600">${progresso}%</span>
                        </div>
                        <div class="w-full bg-cyan-200 rounded-full h-3 overflow-hidden">
                            <div id="detail-progress-bar" class="bg-gradient-to-r from-cyan-500 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${progresso}%"></div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Descrizione - GRIGIO CHIARO -->
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <i data-lucide="file-text" class="w-5 h-5 text-gray-600 mt-1 flex-shrink-0"></i>
                            <div>
                                <p class="text-sm font-bold text-gray-700 mb-2">Descrizione</p>
                                <p class="text-gray-600 leading-relaxed">${descrizione}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Posizione Cliente - BLU CHIARO -->
                    ${clienteId ? `
                    <div class="bg-gradient-to-br from-blue-50 to-sky-100 border-2 border-blue-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-sky-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="map-pin" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs text-blue-700 font-medium mb-1">Cliente</p>
                                <button onclick="window.ClientModal.show('${clienteId}')" 
                                        class="font-bold text-gray-900 hover:text-blue-700 hover:underline text-left">
                                    ${clienteName}
                                </button>
                            </div>
                        </div>
                        <button onclick="openClientMapFullscreen('${clienteId}')" 
                                class="w-full py-3 px-4 bg-white border-2 border-blue-300 rounded-lg hover:bg-blue-50 transition-colors flex items-center justify-center gap-2 text-blue-700 font-bold">
                            <i data-lucide="map" class="w-5 h-5"></i>
                            Visualizza su Mappa
                        </button>
                    </div>
                    ` : ''}

                    <!-- Componenti - VERDE CHIARO -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="package" class="w-5 h-5 text-green-700"></i>
                                <span class="text-sm font-bold text-green-900">Componenti Utilizzati</span>
                            </div>
                            <button onclick="openUserComponentSelector()" 
                                    class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-colors text-sm flex items-center gap-2 font-medium">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Aggiungi
                            </button>
                        </div>
                        <div id="taskComponentsList-${task.id}" class="space-y-2">
                            <p class="text-gray-500 text-sm">Caricamento componenti...</p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-2">
                        <button onclick="openTaskUpdateModal('${task.id}')" 
                                class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg flex items-center justify-center gap-2 font-bold">
                            <i data-lucide="trending-up" class="w-5 h-5"></i>
                            Aggiorna Progresso e Stato
                        </button>
                        <button onclick="closeTaskDetailsModal()" 
                                class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl text-gray-800 transition-colors font-bold">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('taskDetailsModal').classList.remove('hidden');
            
            // Load team members if team assignment
            if (assignedTeamId) {
                loadTeamMembers(assignedTeamId, task.id);
            }
            
            // Load task components
            loadTaskComponents(task.id);
            
            lucide.createIcons();
        }

        async function loadTeamMembers(teamId, taskId) {
            try {
                // Get team members using TeamsAPI
                const teamMembers = await window.TeamsAPI.getMembers(teamId);
                
                const container = document.getElementById(`team-members-${taskId}`);
                if (!container) return;
                
                if (teamMembers && teamMembers.length > 0) {
                    container.innerHTML = teamMembers.map(member => `
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-100 text-purple-800 rounded-lg text-sm font-medium">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            ${member.nome} ${member.cognome}
                        </span>
                    `).join('');
                    // Reinitialize icons
                    if (window.lucide) lucide.createIcons();
                } else {
                    container.innerHTML = '<span class="text-gray-500 text-sm">Nessun membro trovato</span>';
                }
            } catch (error) {
                console.error('Error loading team members:', error);
                const container = document.getElementById(`team-members-${taskId}`);
                if (container) {
                    container.innerHTML = '<span class="text-red-500 text-sm">Errore caricamento membri</span>';
                }
            }
        }

        async function loadTaskComponents(taskId) {
            try {
                const components = await window.TasksAPI.getComponents(taskId);
                
                const container = document.getElementById(`taskComponentsList-${taskId}`);
                if (!container) return;
                
                if (components && components.length > 0) {
                    container.innerHTML = components.map(tc => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="box" class="w-5 h-5 text-blue-600"></i>
                                <div>
                                    <p class="font-semibold text-gray-900">${tc.component?.nome || tc.component?.name || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">Codice: ${tc.component?.codice || tc.component?.code || 'N/A'} ‚Ä¢ Quantit√†: ${tc.quantita || tc.quantity} ${tc.component?.unita_misura || tc.component?.unit || ''}</p>
                                </div>
                            </div>
                            <button onclick="removeTaskComponent('${tc.id}', '${taskId}')" 
                                    class="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Nessun componente aggiunto</p>';
                }
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading task components:', error);
                const container = document.getElementById(`taskComponentsList-${taskId}`);
                if (container) {
                    container.innerHTML = '<p class="text-red-500 text-sm">Errore nel caricamento componenti</p>';
                }
            }
        }

        async function removeTaskComponent(componentId, taskId) {
            if (!confirm('Sei sicuro di voler rimuovere questo componente?')) return;
            
            try {
                await window.TasksAPI.removeComponent(componentId);
                
                showNotification('Componente rimosso con successo', 'success');
                loadTaskComponents(taskId);
            } catch (error) {
                console.error('Error removing component:', error);
                showNotification('Errore nella rimozione del componente', 'error');
            }
        }

        async function openClientMapFullscreen(clientId) {
            try {
                const clients = await window.dataManager.getClienti();
                const client = clients.find(c => c.id === clientId);
                
                if (!client) {
                    showNotification('Cliente non trovato', 'error');
                    return;
                }
                
                // Build address from client data
                const address = client.indirizzo || 
                               `${client.citta || ''} ${client.provincia || ''}`.trim() ||
                               client.ragione_sociale || 
                               'N/A';
                
                // Open Google Maps in new tab
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
                window.open(mapsUrl, '_blank');
                
            } catch (error) {
                console.error('Errore apertura mappa:', error);
                showNotification('Errore apertura mappa', 'error');
            }
        }

        function closeTaskDetailsModal() {
            document.getElementById('taskDetailsModal').classList.add('hidden');
            currentTaskForComponents = null;
        }

        function openUserComponentSelector() {
            // Reset search and filters
            document.getElementById('userComponentSearch').value = '';
            document.getElementById('userComponentCategoryFilter').value = '';
            
            document.getElementById('userComponentModal').classList.remove('hidden');
            
            // Load only added components (no search/filter)
            loadUserComponents('', '');
            
            lucide.createIcons();
        }

        function closeUserComponentModal() {
            document.getElementById('userComponentModal').classList.add('hidden');
        }

        async function loadUserComponents(category = '', searchTerm = '') {
            try {
                const allComponents = await window.dataManager.getComponenti();
                
                // Get components already added to this task
                const taskComponents = currentTaskForComponents.componenti || [];
                const addedComponentIds = taskComponents.map(tc => tc.id);
                
                let components = [];
                
                // If searching or filtering, show all matching components
                if (searchTerm || category) {
                    components = allComponents.filter(c => {
                        const matchesCategory = !category || c.categoria === category;
                        const matchesSearch = !searchTerm || 
                            c.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            c.codice.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (c.descrizione && c.descrizione.toLowerCase().includes(searchTerm.toLowerCase()));
                        return matchesCategory && matchesSearch;
                    });
                } else {
                    // No search/filter: show ONLY components already added to task
                    components = allComponents.filter(c => addedComponentIds.includes(c.id));
                }
                
                const container = document.getElementById('userComponentsList');
                
                if (components.length === 0) {
                    if (searchTerm || category) {
                        container.innerHTML = `
                            <div class="col-span-2 text-center text-gray-500 py-12">
                                <i class="fas fa-inbox text-5xl mb-4 opacity-30"></i>
                                <p class="text-lg font-medium">Nessun componente trovato</p>
                                <p class="text-sm mt-2">Prova con altri termini di ricerca</p>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="col-span-2 text-center text-gray-500 py-12">
                                <i class="fas fa-box-open text-5xl mb-4 opacity-30"></i>
                                <p class="text-lg font-medium mb-2">Nessun componente aggiunto</p>
                                <p class="text-sm text-gray-400">
                                    <i class="fas fa-search mr-1"></i>
                                    Usa la barra di ricerca qui sopra per trovare e aggiungere componenti
                                </p>
                            </div>
                        `;
                    }
                    return;
                }
                
                container.innerHTML = '';
                
                components.forEach(component => {
                    const isAdded = addedComponentIds.includes(component.id);
                    const currentQty = isAdded ? taskComponents.find(tc => tc.id === component.id)?.quantita || 1 : 1;
                
                const card = document.createElement('div');
                card.className = `bg-gray-50 rounded-lg p-4 border ${isAdded ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${component.nome}</h4>
                            <p class="text-xs text-gray-500">${component.codice}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded ${getCategoryBadge(component.categoria)}">
                            ${component.categoria}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${component.descrizione}</p>
                    <div class="flex justify-between items-center text-sm mb-3">
                        <span class="text-gray-600">
                            <i class="fas fa-warehouse mr-1"></i>
                            Disponibili: <strong>${component.quantita_disponibile || 0} ${component.unita_misura || 'pz'}</strong>
                        </span>
                        <span class="text-gray-600">
                            ‚Ç¨${(component.prezzo_unitario || 0).toFixed(2)}/${component.unita_misura || 'pz'}
                        </span>
                    </div>
                    ${isAdded ? `
                        <div class="space-y-2">
                            <div class="bg-blue-100 border border-blue-300 rounded p-2 text-sm text-blue-800 flex items-center justify-between">
                                <span>
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Gi√† presente: <strong>${currentQty} ${component.unita_misura || 'pz'}</strong>
                                </span>
                            </div>
                            <button onclick="addUserComponent('${component.id}')" 
                                    class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                <i class="fas fa-edit mr-1"></i>
                                Modifica Quantit√†
                            </button>
                        </div>
                    ` : `
                        <button onclick="addUserComponent('${component.id}')" 
                                class="w-full px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                            <i class="fas fa-plus mr-1"></i>
                            Aggiungi
                        </button>
                    `}
                `;
                container.appendChild(card);
            });
            } catch (error) {
                console.error('Errore caricamento componenti:', error);
                document.getElementById('userComponentsList').innerHTML = '<p class="text-red-500 text-center py-4">Errore nel caricamento dei componenti</p>';
            }
        }

        function filterUserComponentsByCategory() {
            filterUserComponents();
        }

        function filterUserComponents() {
            const category = document.getElementById('userComponentCategoryFilter').value;
            const searchTerm = document.getElementById('userComponentSearch').value.toLowerCase();
            loadUserComponents(category, searchTerm);
        }

        let pendingComponentId = null;
        let pendingComponent = null;

        async function addUserComponent(componentId) {
            if (!currentTaskForComponents) return;
            
            try {
                const allComponents = await window.dataManager.getComponenti();
                const component = allComponents.find(c => c.id === componentId);
                if (!component) return;
                
                // Check if component is already in task
                const existingComponent = currentTaskForComponents.componenti?.find(c => c.id === componentId);
                const currentQty = existingComponent ? existingComponent.quantita : 1;
                
                // Store component info for modal
                pendingComponentId = componentId;
                pendingComponent = component;
                
                // Show quantity modal with current quantity if editing
                const action = existingComponent ? 'modificare' : 'aggiungere';
                document.getElementById('quantityModalMessage').textContent = 
                    `Quanti ${component.unita_misura || 'pz'} di "${component.nome}" vuoi ${action}?`;
                document.getElementById('componentQuantityInput').value = currentQty;
                document.getElementById('quantityModal').classList.remove('hidden');
                
                // Focus on input
                setTimeout(() => {
                    document.getElementById('componentQuantityInput').focus();
                    document.getElementById('componentQuantityInput').select();
                }, 100);
                
            } catch (error) {
                console.error('Errore aggiunta componente:', error);
                showNotification('Errore durante l\'aggiunta del componente', 'error');
            }
        }

        function cancelQuantity() {
            document.getElementById('quantityModal').classList.add('hidden');
            pendingComponentId = null;
            pendingComponent = null;
        }

        async function confirmQuantity() {
            if (!currentTaskForComponents || !pendingComponentId || !pendingComponent) return;
            
            const quantita = document.getElementById('componentQuantityInput').value;
            
            if (!quantita || isNaN(quantita) || parseInt(quantita) <= 0) {
                showNotification('Quantit√† non valida', 'error');
                return;
            }
            
            const qty = parseInt(quantita);
            
            // Close quantity modal
            document.getElementById('quantityModal').classList.add('hidden');
            
            try {
                // Check availability
                if (qty > (pendingComponent.quantita_disponibile || 0)) {
                    // Create confirmation modal for low stock
                    const confirmModal = document.createElement('div');
                    confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]';
                    confirmModal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
                            <div class="flex items-center justify-center w-16 h-16 bg-orange-100 rounded-full mx-auto mb-4">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-orange-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 text-center mb-2">Attenzione Stock</h3>
                            <p class="text-gray-700 text-center mb-6">
                                Stai richiedendo <strong>${qty} ${pendingComponent.unita_misura || 'pz'}</strong> ma in magazzino ce ne sono solo <strong>${pendingComponent.quantita_disponibile || 0}</strong>.<br><br>
                                Vuoi procedere comunque?
                            </p>
                            <div class="flex space-x-3">
                                <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                    Annulla
                                </button>
                                <button onclick="proceedWithQuantity(${qty}); this.closest('.fixed').remove();" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                                    Procedi
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmModal);
                    lucide.createIcons();
                    return;
                }
                
                await proceedWithQuantity(qty);
            } catch (error) {
                console.error('Errore aggiunta componente:', error);
                showNotification('Errore durante l\'aggiunta del componente', 'error');
            }
        }

        async function proceedWithQuantity(qty) {
            try {
                // Add to task components
                if (!currentTaskForComponents.componenti) {
                    currentTaskForComponents.componenti = [];
                }
                
                const existingIndex = currentTaskForComponents.componenti.findIndex(c => c.id === pendingComponentId);
                if (existingIndex >= 0) {
                    currentTaskForComponents.componenti[existingIndex].quantita = qty;
                } else {
                    currentTaskForComponents.componenti.push({ id: pendingComponentId, quantita: qty });
                }
                
                // Update task in database
                await window.dataManager.saveLavorazione(currentTaskForComponents);
                
                showNotification('Componente aggiunto con successo!', 'success');
                
                // Reset pending
                pendingComponentId = null;
                pendingComponent = null;
                
                // Reload both modals
                openTaskDetails(currentTaskForComponents.id);
                closeUserComponentModal();
            } catch (error) {
                console.error('Errore salvataggio componente:', error);
                showNotification('Errore durante il salvataggio', 'error');
            }
        }

        async function removeUserComponent(componentId) {
            if (!currentTaskForComponents) return;
            
            try {
                const allComponents = await window.dataManager.getComponenti();
                const component = allComponents.find(c => c.id === componentId);
                if (!component) return;
                
                if (!confirm(`Sei sicuro di voler rimuovere "${component.nome}" dalla lavorazione?\n\nQuesta azione notificher√† l'amministratore.`)) {
                    return;
                }
                
                // Remove from task components
                if (currentTaskForComponents.componenti) {
                    currentTaskForComponents.componenti = currentTaskForComponents.componenti.filter(c => c.id !== componentId);
                }
                
                // Update task in database
                await window.dataManager.saveLavorazione(currentTaskForComponents);
                
                showNotification('Componente rimosso. Amministratore notificato.', 'success');
                
                // Reload details
                openTaskDetails(currentTaskForComponents.id);
            } catch (error) {
                console.error('Errore rimozione componente:', error);
                showNotification('Errore durante la rimozione del componente', 'error');
            }
        }

        function getCategoryBadge(category) {
            switch(category) {
                case 'Antifurto': return 'bg-red-100 text-red-700';
                case 'Videosorveglianza': return 'bg-blue-100 text-blue-700';
                case 'Rete': return 'bg-green-100 text-green-700';
                case 'Accessori': return 'bg-purple-100 text-purple-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }
    </script>

    <!-- Modal Firma Digitale -->
    <div id="signatureModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full animate-slide-up max-h-screen flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl flex-shrink-0">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i data-lucide="pen-tool" class="w-7 h-7"></i>
                    Firma Digitale Cliente
                </h2>
                <p class="text-blue-100 text-sm mt-1">Fai firmare il cliente per completare la lavorazione</p>
            </div>

            <!-- Body Scrollabile -->
            <div class="p-6 pb-safe overflow-y-auto flex-1">
                <!-- Info Lavorazione -->
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg p-4 mb-4 border-2 border-blue-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div class="flex items-center gap-2 min-w-0">
                            <i data-lucide="user" class="w-4 h-4 text-blue-600 flex-shrink-0"></i>
                            <span class="text-gray-600 flex-shrink-0">Cliente:</span>
                            <span id="signClientName" class="font-semibold text-gray-800 truncate"></span>
                        </div>
                        <div class="flex items-center gap-2 min-w-0">
                            <i data-lucide="calendar" class="w-4 h-4 text-blue-600 flex-shrink-0"></i>
                            <span class="text-gray-600 flex-shrink-0">Data:</span>
                            <span id="signDate" class="font-semibold text-gray-800 truncate"></span>
                        </div>
                        <div class="flex items-center gap-2 min-w-0">
                            <i data-lucide="wrench" class="w-4 h-4 text-blue-600 flex-shrink-0"></i>
                            <span class="text-gray-600 flex-shrink-0">Tipo:</span>
                            <span id="signType" class="font-semibold text-gray-800 truncate"></span>
                        </div>
                        <div class="flex items-center gap-2 min-w-0 overflow-hidden">
                            <i data-lucide="map-pin" class="w-4 h-4 text-blue-600 flex-shrink-0"></i>
                            <span class="text-gray-600 flex-shrink-0">Indirizzo:</span>
                            <span id="signAddress" class="font-semibold text-gray-800 truncate block max-w-full"></span>
                        </div>
                    </div>
                </div>

                <!-- Pulsante Visualizza Riepilogo -->
                <button onclick="openTaskPreview()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:shadow-xl text-white py-4 px-6 rounded-xl mb-4 transition font-semibold flex items-center justify-center gap-3 transform hover:scale-[1.02]">
                    <i data-lucide="eye" class="w-6 h-6"></i>
                    <span>Visualizza Riepilogo Completo Lavorazione</span>
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>

                <!-- Canvas Firma -->
                <div class="border-4 border-dashed border-gray-300 rounded-xl mb-4 bg-white overflow-hidden">
                    <canvas id="signatureCanvas" class="w-full cursor-crosshair" style="touch-action: none;"></canvas>
                </div>

                <!-- Istruzioni -->
                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-3 mb-4 flex items-start gap-2">
                    <i data-lucide="info" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"></i>
                    <p class="text-yellow-800 text-sm">
                        <strong>Istruzioni:</strong> Firma con il dito su dispositivi touch o con il mouse su desktop. 
                        La firma verr√† salvata insieme al report PDF della lavorazione.
                    </p>
                </div>

                <!-- Buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="clearSignature()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded-lg transition font-semibold flex items-center justify-center gap-2">
                        <i data-lucide="eraser" class="w-5 h-5"></i>
                        Cancella
                    </button>
                    <button onclick="closeSignatureModal()" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 py-3 px-4 rounded-lg transition font-semibold flex items-center justify-center gap-2">
                        <i data-lucide="x" class="w-5 h-5"></i>
                        Annulla
                    </button>
                    <button onclick="saveSignature()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:shadow-lg text-white py-3 px-4 rounded-lg transition font-semibold flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-5 h-5"></i>
                        Conferma & Genera PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Preview Lavorazione (Fullscreen) -->
    <div id="taskPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[60]">
        <div class="bg-white w-full h-full flex flex-col overflow-hidden">
            <!-- Header Fisso -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 shadow-lg flex-shrink-0">
                <div class="flex items-center justify-between max-w-4xl mx-auto">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="file-text" class="w-6 h-6"></i>
                        Riepilogo Lavorazione
                    </h2>
                    <button onclick="closeTaskPreview()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Contenuto Scrollabile -->
            <div class="flex-1 overflow-y-auto">
                <div class="max-w-4xl mx-auto p-6 pb-6">
                <!-- Info Cliente e Lavorazione -->
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-6 mb-6 border-2 border-blue-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Cliente</p>
                            <p id="previewClientName" class="text-lg font-bold text-gray-800"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Indirizzo</p>
                            <p id="previewAddress" class="text-lg font-semibold text-gray-800"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Data Scadenza</p>
                            <p id="previewDate" class="text-lg font-semibold text-gray-800"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Tipo Lavorazione</p>
                            <p id="previewType" class="text-lg font-semibold text-gray-800"></p>
                        </div>
                    </div>
                </div>

                <!-- Descrizione -->
                <div class="bg-white rounded-xl p-6 mb-6 border-2 border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg">
                        <i data-lucide="align-left" class="w-5 h-5 text-indigo-600"></i>
                        Descrizione
                    </h3>
                    <p id="previewDescription" class="text-gray-700 leading-relaxed"></p>
                </div>

                <!-- Componenti -->
                <div class="bg-white rounded-xl p-6 mb-6 border-2 border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                        <i data-lucide="package" class="w-5 h-5 text-indigo-600"></i>
                        Componenti Installati
                    </h3>
                    <div id="previewComponents" class="space-y-2"></div>
                </div>

                <!-- Stato e Progresso -->
                <div class="bg-white rounded-xl p-6 mb-6 border-2 border-gray-200 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg">
                                <i data-lucide="activity" class="w-5 h-5 text-indigo-600"></i>
                                Stato
                            </h3>
                            <span id="previewStatus" class="inline-block px-4 py-2 text-sm rounded-lg font-semibold"></span>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg">
                                <i data-lucide="trending-up" class="w-5 h-5 text-indigo-600"></i>
                                Progresso
                            </h3>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 bg-gray-200 rounded-full h-4 overflow-hidden">
                                    <div id="previewProgressBar" class="bg-gradient-to-r from-green-500 to-emerald-600 h-full transition-all"></div>
                                </div>
                                <span id="previewProgressText" class="text-lg font-bold text-gray-700 min-w-[3rem]"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Note (se presenti) -->
                <div id="previewNotesSection" class="bg-amber-50 rounded-xl p-6 mb-6 border-2 border-amber-200 shadow-sm hidden">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg">
                        <i data-lucide="message-square" class="w-5 h-5 text-amber-600"></i>
                        Note Aggiuntive
                    </h3>
                    <p id="previewNotes" class="text-gray-700 italic leading-relaxed"></p>
                </div>
                </div>
            </div>

            <!-- Footer Fisso -->
            <div class="bg-white border-t-2 border-gray-200 p-4 shadow-lg flex-shrink-0">
                <div class="max-w-4xl mx-auto">
                    <button onclick="closeTaskPreview()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:shadow-xl text-white py-4 px-6 rounded-xl transition font-bold text-lg flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                        Ho letto e compreso - Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== FIRMA DIGITALE + PDF ==========
        let signaturePad;
        let currentTaskForSignature = null;

        function openSignatureModal(task) {
            currentTaskForSignature = task;
            
            console.log('[Firma] Task ricevuto:', task); // Debug
            
            // Popola info base
            const clientName = task.client_name || task.cliente || task.clienteName || 'N/A';
            const taskDate = task.deadline || task.scadenza || task.created_at;
            const taskType = task.titolo || task.title || 'Lavorazione';
            const taskAddress = task.client_address || task.client?.address || task.indirizzo || 'Da definire';
            
            document.getElementById('signClientName').textContent = clientName;
            document.getElementById('signDate').textContent = taskDate ? 
                new Date(taskDate).toLocaleDateString('it-IT') : 'N/A';
            document.getElementById('signType').textContent = taskType;
            document.getElementById('signAddress').textContent = taskAddress;
            
            // Mostra modal
            document.getElementById('signatureModal').classList.remove('hidden');
            
            // Inizializza canvas (con delay per rendering)
            setTimeout(() => {
                const canvas = document.getElementById('signatureCanvas');
                canvas.width = canvas.offsetWidth;
                canvas.height = 250;
                
                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 139)',
                    minWidth: 1,
                    maxWidth: 3,
                    throttle: 16
                });
                
                lucide.createIcons();
            }, 100);
        }

        function openTaskPreview() {
            if (!currentTaskForSignature) return;
            
            const task = currentTaskForSignature;
            
            // Popola dati preview
            const clientName = task.client_name || task.cliente || 'N/A';
            const taskDate = task.deadline || task.scadenza || task.created_at;
            const taskType = task.titolo || task.title || 'Lavorazione';
            const taskAddress = task.client_address || task.client?.address || task.indirizzo || 'Da definire';
            const city = task.client_city ? `, ${task.client_city}` : '';
            const zip = task.client_zip ? ` ${task.client_zip}` : '';
            
            document.getElementById('previewClientName').textContent = clientName;
            document.getElementById('previewAddress').textContent = taskAddress + city + zip;
            document.getElementById('previewDate').textContent = taskDate ? 
                new Date(taskDate).toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }) : 'Non specificata';
            document.getElementById('previewType').textContent = taskType;
            
            // Descrizione
            document.getElementById('previewDescription').textContent = task.descrizione || 'Nessuna descrizione disponibile per questa lavorazione.';
            
            // Componenti
            const componentsContainer = document.getElementById('previewComponents');
            componentsContainer.innerHTML = '';
            if (task.componenti && task.componenti.length > 0) {
                task.componenti.forEach((comp, index) => {
                    const compDiv = document.createElement('div');
                    compDiv.className = 'flex items-center justify-between bg-gray-50 px-4 py-3 rounded-lg border border-gray-200';
                    compDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="flex items-center justify-center w-8 h-8 bg-indigo-100 text-indigo-700 rounded-full font-bold text-sm">${index + 1}</span>
                            <span class="text-gray-800 font-medium">${comp.nome || comp.name || 'Componente'}</span>
                        </div>
                        <span class="bg-indigo-600 text-white px-3 py-1 rounded-full font-semibold text-sm">x${comp.quantita || comp.quantity || 1}</span>
                    `;
                    componentsContainer.appendChild(compDiv);
                });
            } else {
                componentsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4">Nessun componente specificato per questa lavorazione</p>';
            }
            
            // Stato
            const statusEl = document.getElementById('previewStatus');
            const stato = task.stato || task.status || 'in_corso';
            statusEl.textContent = stato === 'completata' ? '‚úì Completata' : 
                                   stato === 'in_corso' ? '‚è≥ In Corso' : 
                                   stato === 'da_iniziare' ? 'üìã Da Iniziare' : stato;
            statusEl.className = 'inline-block px-4 py-2 text-sm rounded-lg font-semibold ' + 
                (stato === 'completata' ? 'bg-green-100 text-green-700' : 
                 stato === 'in_corso' ? 'bg-blue-100 text-blue-700' : 
                 'bg-gray-100 text-gray-700');
            
            // Progresso
            const progresso = task.progresso || 0;
            document.getElementById('previewProgressBar').style.width = progresso + '%';
            document.getElementById('previewProgressText').textContent = progresso + '%';
            
            // Note
            const notesSection = document.getElementById('previewNotesSection');
            const notesText = document.getElementById('previewNotes');
            if (task.note_progresso || task.note) {
                notesSection.classList.remove('hidden');
                notesText.textContent = task.note_progresso || task.note;
            } else {
                notesSection.classList.add('hidden');
            }
            
            // Mostra modale preview
            document.getElementById('taskPreviewModal').classList.remove('hidden');
            
            // Re-init icone
            setTimeout(() => lucide.createIcons(), 100);
        }

        function closeTaskPreview() {
            document.getElementById('taskPreviewModal').classList.add('hidden');
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.add('hidden');
            if (signaturePad) {
                signaturePad.clear();
            }
            currentTaskForSignature = null;
        }

        function clearSignature() {
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        async function saveSignature() {
            if (!signaturePad || signaturePad.isEmpty()) {
                showNotification('‚ö†Ô∏è Inserisci la firma prima di continuare', 'warning');
                return;
            }

            if (!currentTaskForSignature) {
                showNotification('‚ùå Errore: nessuna lavorazione selezionata', 'error');
                return;
            }

            try {
                // Mostra loading
                showNotification('üíæ Salvataggio firma in corso...', 'info');
                
                // 1. Ottieni firma come base64
                const signatureData = signaturePad.toDataURL('image/png');
                
                // 2. Salva in Supabase
                const { data, error } = await window.supabaseClient
                    .from('tasks')
                    .update({
                        firma_cliente: signatureData,
                        firma_timestamp: new Date().toISOString(),
                        stato: 'completato'
                    })
                    .eq('id', currentTaskForSignature.id)
                    .select()
                    .single();

                if (error) throw error;

                // 3. Genera PDF
                await generatePDF({ ...currentTaskForSignature, ...data });
                
                closeSignatureModal();
                showNotification('‚úÖ Firma salvata e PDF generato con successo!', 'success');
                
                // Ricarica dati
                setTimeout(() => {
                    loadTasks();
                }, 1500);
                
            } catch (error) {
                console.error('Error saving signature:', error);
                showNotification('‚ùå Errore nel salvare la firma: ' + error.message, 'error');
            }
        }

        async function generatePDF(task) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            try {
                console.log('[PDF] Task data:', task); // Debug
                
                // 1. Header con gradiente blu
                doc.setFillColor(66, 126, 234);
                doc.rect(0, 0, 210, 45, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('AST PANEL', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('Report Lavorazione Completata', 105, 32, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Generato il ${new Date().toLocaleString('it-IT')}`, 105, 40, { align: 'center' });

                // 2. Info Lavorazione
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                let y = 58;
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.text('DETTAGLI LAVORAZIONE', 20, y);
                y += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Cliente: ${task.client_name || 'N/A'}`, 20, y);
                y += 6;
                doc.text(`Indirizzo: ${task.client_address || 'N/A'}`, 20, y);
                y += 6;
                doc.text(`Data: ${task.scadenza ? new Date(task.scadenza).toLocaleDateString('it-IT') : 'N/A'}`, 20, y);
                y += 6;
                doc.text(`Tipo Lavorazione: ${task.titolo || 'N/A'}`, 20, y);
                y += 6;
                doc.text(`Stato: ${task.stato}`, 20, y);
                y += 6;
                doc.text(`Dipendente: ${task.user_name || 'N/A'}`, 20, y);
                y += 12;

                // 3. Descrizione
                if (task.descrizione) {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.text('DESCRIZIONE INTERVENTO', 20, y);
                    y += 8;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    const splitText = doc.splitTextToSize(task.descrizione, 170);
                    doc.text(splitText, 20, y);
                    y += (splitText.length * 5) + 10;
                }

                // 4. Componenti utilizzati
                if (task.componenti && task.componenti.length > 0) {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.text('COMPONENTI UTILIZZATI', 20, y);
                    y += 8;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    task.componenti.forEach(comp => {
                        doc.text(`‚Ä¢ ${comp.nome || comp.name} - Quantit√†: ${comp.quantita || comp.quantity}`, 25, y);
                        y += 6;
                    });
                    y += 6;
                }

                // 5. Note
                if (task.note_progresso || task.note) {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.text('NOTE AGGIUNTIVE', 20, y);
                    y += 8;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    const splitNotes = doc.splitTextToSize(task.note_progresso || task.note, 170);
                    doc.text(splitNotes, 20, y);
                    y += (splitNotes.length * 5) + 10;
                }

                // 6. Firma Cliente
                if (task.firma_cliente) {
                    // Nuova pagina se necessario
                    if (y > 220) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.text('FIRMA CLIENTE', 20, y);
                    y += 8;
                    
                    // Box firma
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.rect(20, y, 90, 45);
                    
                    // Aggiungi immagine firma
                    doc.addImage(task.firma_cliente, 'PNG', 22, y + 2, 86, 41);
                    y += 50;
                    
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Firmato digitalmente il ${new Date(task.firma_timestamp).toLocaleString('it-IT')}`, 20, y);
                    doc.text(`Cliente: ${task.client_name || 'N/A'}`, 20, y + 4);
                }

                // 7. Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Documento generato automaticamente da AST Panel - Sistema di gestione lavorazioni', 105, 285, { align: 'center' });
                doc.text(`ID Lavorazione: ${task.id}`, 105, 290, { align: 'center' });

                // 8. Salva PDF
                const filename = `Lavorazione_${task.client_name?.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Download locale
                doc.save(filename);
                
                // 9. Upload a Supabase Storage
                const pdfBlob = doc.output('blob');
                await uploadPDFToStorage(pdfBlob, filename, task.id);
                
                return filename;
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }

        async function uploadPDFToStorage(blob, filename, taskId) {
            try {
                // Upload a Supabase Storage
                const filePath = `lavorazioni/${taskId}/${filename}`;
                
                const { data, error } = await window.supabaseClient.storage
                    .from('reports')
                    .upload(filePath, blob, {
                        contentType: 'application/pdf',
                        upsert: true
                    });

                if (error) {
                    console.warn('[Storage] Upload fallito (bucket potrebbe non esistere):', error.message);
                    // Non bloccare se storage fallisce - PDF scaricato localmente
                    showNotification('‚ö†Ô∏è PDF salvato localmente (cloud storage non disponibile)', 'warning');
                    return null;
                }

                // Ottieni URL pubblico
                const { data: { publicUrl } } = window.supabaseClient.storage
                    .from('reports')
                    .getPublicUrl(filePath);

                // Salva URL in database
                await window.supabaseClient
                    .from('tasks')
                    .update({ pdf_report_url: publicUrl })
                    .eq('id', taskId);

                console.log('PDF uploaded to:', publicUrl);
                return publicUrl;
                
            } catch (error) {
                console.error('Error uploading PDF to storage:', error);
                return null;
            }
        }

        async function downloadPDF(taskId) {
            try {
                showNotification('üìÑ Caricamento PDF...', 'info');
                
                const { data: task, error } = await window.supabaseClient
                    .from('tasks')
                    .select('*')
                    .eq('id', taskId)
                    .single();

                if (error) throw error;

                if (task.pdf_report_url) {
                    // Apri URL PDF
                    window.open(task.pdf_report_url, '_blank');
                    showNotification('‚úÖ PDF aperto', 'success');
                } else {
                    // Rigenera PDF
                    showNotification('üîÑ Generazione PDF in corso...', 'info');
                    await generatePDF(task);
                }
            } catch (error) {
                console.error('Error downloading PDF:', error);
                showNotification('‚ùå Errore nel scaricare il PDF: ' + error.message, 'error');
            }
        }

        // ========== PUSH NOTIFICATIONS ==========
        let notificationService = null;
        let unreadNotifications = 0;
        let notificationsEnabled = false;
        let isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        // VAPID Public Key (generata 3 dicembre 2025)
        const VAPID_PUBLIC_KEY = 'BLjW0SXifp_sEAHa551mhnN-CJEFs-LytLQnxuOBCMLsr51s66rIzJiOhUmEDK0UF7JkZvb05eOhmwuTDzPXv_c';

        // Detecta se il browser supporta Push API nativo
        function supportsPushAPI() {
            return 'serviceWorker' in navigator && 
                   'PushManager' in window && 
                   'Notification' in window &&
                   !isSafari; // Safari non supporta bene Web Push
        }

        async function initPushNotifications(userId) {
            console.log('[Push] Initializing push notifications...');
            console.log('[Push] Browser:', isSafari ? 'Safari (fallback mode)' : 'Chrome/Firefox (native push)');

            try {
                // SEMPRE inizializza Supabase Realtime (funziona su tutti i browser)
                notificationService = new window.NotificationService();
                await notificationService.init(userId);
                console.log('[Push] Realtime notifications initialized');

                // Setup listener per notifiche in-app
                setupInAppNotifications();

                // Se supporta Push API nativo (Chrome, Firefox), registra anche quello
                if (supportsPushAPI()) {
                    console.log('[Push] Browser supports native Push API');
                    await initNativePushNotifications(userId);
                } else {
                    console.log('[Push] Using in-app notifications only (Safari compatible)');
                }

                // Check scadenze ogni ora
                setInterval(() => {
                    if (notificationService) {
                        notificationService.checkScadenzeImminenti();
                    }
                }, 60 * 60 * 1000); // 1 ora

                console.log('[Push] Notifications initialized successfully');

            } catch (error) {
                console.error('[Push] Initialization error:', error);
            }
        }

        // Inizializza notifiche native (Chrome, Firefox, Edge)
        async function initNativePushNotifications(userId) {
            try {
                // 1. Registra Service Worker
                const registration = await navigator.serviceWorker.register('/Admin/sw.js', {
                    scope: '/'
                });
                console.log('[Push] Service Worker registered:', registration);

                // Aspetta che sia ready
                await navigator.serviceWorker.ready;

                // 2. Check permesso notifiche
                let permission = Notification.permission;
                
                if (permission === 'default') {
                    console.log('[Push] Notification permission not requested yet');
                } else if (permission === 'granted') {
                    await subscribeToPush(registration, userId);
                } else {
                    console.warn('[Push] Notification permission denied');
                }

            } catch (error) {
                console.error('[Push] Native push initialization error:', error);
            }
        }

        // Setup listener per notifiche in-app (compatibile Safari)
        function setupInAppNotifications() {
            console.log('[Push] Setting up in-app notifications (Safari compatible)');
            
            // Listener per eventi Realtime da NotificationService
            window.addEventListener('realtimeNotification', (event) => {
                console.log('[Push] Received realtime notification:', event.detail);
                showInAppNotification(event.detail);
            });
        }

        // Mostra notifica in-app (funziona su Safari)
        function showInAppNotification(data) {
            const { title, body, type, icon } = data;
            
            console.log('[Push] Showing in-app notification:', title);
            
            // 1. Incrementa badge
            unreadNotifications++;
            updateNotificationBadge();
            
            // 2. Mostra toast persistente
            const notification = document.createElement('div');
            notification.className = `fixed top-24 right-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4 rounded-xl shadow-2xl z-[9999] fade-in max-w-md cursor-pointer hover:shadow-3xl transition-all`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="${icon || 'bell'}" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-sm mb-1">${title}</h4>
                        <p class="text-xs text-white/90 line-clamp-2">${body}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white/70 hover:text-white">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            if (window.lucide) lucide.createIcons();
            
            // 3. Riproduci suono (se disponibile)
            playNotificationSound();
            
            // 4. Vibrazione (su mobile)
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // Auto-rimuovi dopo 8 secondi
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => notification.remove(), 300);
            }, 8000);
            
            // Click per andare alla sezione correlata
            notification.addEventListener('click', () => {
                if (type === 'lavorazione' || type === 'task') {
                    switchSection('tasks');
                } else if (type === 'richiesta') {
                    switchSection('requests');
                } else if (type === 'comunicazione') {
                    switchSection('communications');
                }
                notification.remove();
                unreadNotifications = Math.max(0, unreadNotifications - 1);
                updateNotificationBadge();
            });
        }

        // Aggiorna badge notifiche (numero rosso)
        function updateNotificationBadge() {
            // Badge nel browser tab title
            if (unreadNotifications > 0) {
                document.title = `(${unreadNotifications}) ZG IMPIANTI`;
            } else {
                document.title = 'ZG IMPIANTI - Pannello Utente';
            }
            
            // Badge visuale nell'header (se esiste)
            const bellIcon = document.querySelector('[data-notification-bell]');
            if (bellIcon) {
                let badge = bellIcon.querySelector('.notification-badge');
                if (unreadNotifications > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'notification-badge absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold';
                        bellIcon.style.position = 'relative';
                        bellIcon.appendChild(badge);
                    }
                    badge.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
                } else if (badge) {
                    badge.remove();
                }
            }
        }

        // Suono notifica
        function playNotificationSound() {
            try {
                // Audio API context (compatibile Safari)
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.warn('[Push] Sound not available:', error);
            }
        }

        async function subscribeToPush(registration, userId) {
            try {
                console.log('[Push] Starting push subscription for user:', userId);
                
                // Check se gi√† subscribed
                let subscription = await registration.pushManager.getSubscription();
                console.log('[Push] Existing subscription:', subscription);
                
                if (!subscription) {
                    console.log('[Push] Creating new subscription with VAPID key...');
                    // Crea nuova subscription
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });
                    console.log('[Push] New subscription created:', subscription.endpoint);
                }

                // Salva subscription in Supabase
                console.log('[Push] Saving subscription to database...');
                await savePushSubscription(subscription, userId);
                console.log('[Push] Subscription saved successfully');
                
                return subscription;

            } catch (error) {
                console.error('[Push] Subscribe error:', error);
                console.error('[Push] Error details:', error.message, error.stack);
                throw error;
            }
        }

        async function savePushSubscription(subscription, userId) {
            try {
                const subscriptionData = subscription.toJSON();
                console.log('[Push] Subscription data:', {
                    endpoint: subscriptionData.endpoint,
                    hasKeys: !!subscriptionData.keys
                });
                
                const dataToSave = {
                    user_id: userId,
                    endpoint: subscriptionData.endpoint,
                    p256dh: subscriptionData.keys.p256dh,
                    auth: subscriptionData.keys.auth,
                    user_agent: navigator.userAgent,
                    updated_at: new Date().toISOString()
                };
                
                console.log('[Push] Saving to Supabase:', {
                    user_id: userId,
                    endpoint_preview: subscriptionData.endpoint.substring(0, 50) + '...'
                });
                
                const { data, error } = await window.supabase
                    .from('push_subscriptions')
                    .upsert(dataToSave, {
                        onConflict: 'user_id,endpoint'
                    });

                if (error) {
                    console.error('[Push] Supabase error:', error);
                    throw error;
                }
                
                console.log('[Push] Subscription saved to database successfully');

            } catch (error) {
                console.error('[Push] Save subscription error:', error);
                console.error('[Push] Error details:', error.message);
                throw error;
            }
        }

        async function requestNotificationPermission() {
            try {
                console.log('[Push] Requesting notification permission...');
                
                // Safari: usa solo notifiche in-app (sempre disponibili)
                if (isSafari || !supportsPushAPI()) {
                    console.log('[Push] Safari detected - using in-app notifications');
                    notificationsEnabled = true;
                    showNotification('‚úÖ Notifiche in-app attivate! (Safari compatibile)', 'success');
                    
                    const toggle = document.getElementById('toggleNotifications');
                    if (toggle) toggle.checked = true;
                    updateNotificationStatus(true);
                    
                    // Salva preferenza
                    localStorage.setItem('notificationsEnabled', 'true');
                    return;
                }
                
                // Chrome/Firefox: usa Push API nativo
                const permission = await Notification.requestPermission();
                console.log('[Push] Permission result:', permission);
                
                if (permission === 'granted') {
                    console.log('[Push] Permission granted, subscribing to push...');
                    showNotification('‚úÖ Notifiche push attivate!', 'success');
                    
                    notificationsEnabled = true;
                    
                    // Subscribe to push
                    const registration = await navigator.serviceWorker.ready;
                    console.log('[Push] Service Worker ready:', registration);
                    
                    const currentUser = await window.AuthHelper.getCurrentUser();
                    console.log('[Push] Current user:', currentUser?.id);
                    
                    if (!currentUser || !currentUser.id) {
                        throw new Error('Utente non autenticato');
                    }
                    
                    await subscribeToPush(registration, currentUser.id);
                    console.log('[Push] Successfully subscribed to push');
                    
                    // Update UI
                    const toggle = document.getElementById('toggleNotifications');
                    if (toggle) toggle.checked = true;
                    updateNotificationStatus(true);
                    
                } else if (permission === 'denied') {
                    console.warn('[Push] Permission denied by user');
                    showNotification('‚ùå Permesso negato. Abilita le notifiche nelle impostazioni del browser.', 'error');
                    updateNotificationStatus(false);
                } else {
                    console.warn('[Push] Permission not granted (dismissed)');
                    showNotification('‚ö†Ô∏è Permesso non concesso', 'warning');
                    updateNotificationStatus(false);
                }

            } catch (error) {
                console.error('[Push] Request permission error:', error);
                console.error('[Push] Error stack:', error.stack);
                showNotification(`‚ùå Errore: ${error.message}`, 'error');
                updateNotificationStatus(false);
                
                // Reset toggle
                const toggle = document.getElementById('toggleNotifications');
                if (toggle) toggle.checked = false;
            }
        }

        async function handleNotificationToggle(checkbox) {
            if (checkbox.checked) {
                await requestNotificationPermission();
            } else {
                notificationsEnabled = false;
                localStorage.setItem('notificationsEnabled', 'false');
                await unsubscribeFromPush();
                updateNotificationStatus(false);
            }
        }

        function updateNotificationStatus(enabled) {
            const statusEl = document.getElementById('notificationStatus');
            if (!statusEl) return;

            if (enabled) {
                const mode = isSafari ? 'In-App (Safari)' : 'Push Native';
                statusEl.innerHTML = `
                    <i data-lucide="check-circle" class="w-3 h-3 text-green-600"></i>
                    <span class="text-green-600 font-semibold">Notifiche attive - ${mode}</span>
                `;
            } else {
                statusEl.innerHTML = `
                    <i data-lucide="x-circle" class="w-3 h-3 text-gray-500"></i>
                    <span class="text-gray-500">Notifiche disattivate</span>
                `;
            }
            
            if (window.lucide) lucide.createIcons();
        }

        async function updateNotificationToggleState() {
            try {
                // Safari: controlla localStorage
                if (isSafari || !supportsPushAPI()) {
                    const enabled = localStorage.getItem('notificationsEnabled') === 'true';
                    const toggle = document.getElementById('toggleNotifications');
                    if (toggle) toggle.checked = enabled;
                    updateNotificationStatus(enabled);
                    notificationsEnabled = enabled;
                    return;
                }
                
                // Chrome/Firefox: controlla Notification API
                const permission = Notification.permission;
                const toggle = document.getElementById('toggleNotifications');
                
                if (toggle) {
                    toggle.checked = (permission === 'granted');
                }
                
                notificationsEnabled = (permission === 'granted');
                updateNotificationStatus(permission === 'granted');
                
            } catch (error) {
                console.warn('[Push] Update toggle state error:', error);
                // Fallback a localStorage
                const enabled = localStorage.getItem('notificationsEnabled') === 'true';
                const toggle = document.getElementById('toggleNotifications');
                if (toggle) toggle.checked = enabled;
                updateNotificationStatus(enabled);
            }
        }

        async function unsubscribeFromPush() {
            try {
                // Safari: rimuovi solo da localStorage
                if (isSafari || !supportsPushAPI()) {
                    console.log('[Push] Disabling in-app notifications (Safari)');
                    showNotification('Notifiche disattivate', 'info');
                    return;
                }
                
                // Chrome/Firefox: rimuovi subscription
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    await subscription.unsubscribe();
                    console.log('[Push] Unsubscribed from push');
                }

                // Rimuovi dal database
                const currentUser = await window.AuthHelper.getCurrentUser();
                await window.supabase
                    .from('push_subscriptions')
                    .delete()
                    .eq('user_id', currentUser.id);

                showNotification('Notifiche disattivate', 'info');

            } catch (error) {
                console.error('[Push] Unsubscribe error:', error);
            }
        }

        async function testNotification() {
            console.log('[Push] Testing notification...');
            console.log('[Push] Notification service:', notificationService);
            
            if (!notificationService) {
                console.warn('[Push] Notification service not initialized');
                showNotification('‚ö†Ô∏è Servizio notifiche non inizializzato', 'warning');
                return;
            }

            try {
                await notificationService.sendNotification({
                    title: 'üß™ Test Notifica',
                    body: 'Le notifiche push funzionano correttamente! üéâ',
                    tag: 'test',
                    data: {
                        url: window.location.href,
                        type: 'test'
                    },
                    requireInteraction: false
                });
                console.log('[Push] Test notification sent successfully');
                showNotification('‚úÖ Notifica di test inviata!', 'success');
            } catch (error) {
                console.error('[Push] Test notification error:', error);
                showNotification(`‚ùå Errore test: ${error.message}`, 'error');
            }
        }

        // Utility: Convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
    </script>
    
    <!-- MOBILE ENHANCEMENTS - Funzionalit√† touch e gestures (solo mobile) -->
    <script src="mobile-enhancements.js"></script>
</body>
</html>