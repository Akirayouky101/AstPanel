<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - AST Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/supabase-client.js"></script>
    <script src="/Admin/auth-helper.js"></script>
    <script src="/data-migration.js"></script>
    <script src="/shared-data.js"></script>
    <!-- FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-gradient { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .success-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .warning-gradient { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .info-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out z-50" id="sidebar">
        <div class="flex items-center justify-center h-16 gradient-bg">
            <h1 class="text-white text-xl font-bold">Admin Panel</h1>
        </div>
        <nav class="mt-8">
            <a href="/Admin/admin-functional.html" class="flex items-center px-6 py-3 bg-blue-50 text-blue-600 border-r-4 border-blue-600">
                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="/gestione-utenti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                Gestione Utenti
            </a>
            <a href="/gestione-clienti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="building-2" class="w-5 h-5 mr-3"></i>
                Gestione Clienti
            </a>
            <a href="/gestione-lavorazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                Gestione Lavorazioni
            </a>
            <a href="/calendario-admin.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                Calendario
            </a>
            <a href="/gestione-richieste.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                Gestione Richieste
            </a>
            <a href="/comunicazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Comunicazioni
            </a>
            <div class="mt-8 border-t pt-4">
                <a href="/pannello-utente.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-green-50 hover:text-green-600 transition-colors">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                    Pannello Utente
                </a>
                <a href="#" onclick="logout()" class="flex items-center px-6 py-3 text-red-700 hover:bg-red-50 hover:text-red-600 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Admin</h2>
                <p class="text-gray-600">Panoramica generale del sistema</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-sm text-gray-500">Ultimo accesso</p>
                    <p class="text-sm font-medium" id="lastLogin">Oggi, 09:30</p>
                </div>
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Dipendenti Totali</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalEmployees">24</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-green-600 text-sm font-medium">+3 questo mese</span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Lavorazioni Attive</p>
                        <p class="text-2xl font-bold text-gray-900" id="activeTasks">12</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-green-600 text-sm font-medium">5 completate oggi</span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Richieste Pendenti</p>
                        <p class="text-2xl font-bold text-gray-900" id="pendingRequests">8</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-orange-600 text-sm font-medium">Richiede attenzione</span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Comunicazioni</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalCommunications">18</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-6 h-6 text-purple-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-purple-600 text-sm font-medium">3 inviate oggi</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="window.location.href='/gestione-lavorazioni.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Nuova Lavorazione</h3>
                        <p class="text-blue-100">Crea e assegna nuovo task</p>
                    </div>
                    <i data-lucide="plus-circle" class="w-8 h-8"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="window.location.href='/gestione-richieste.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Gestisci Richieste</h3>
                        <p class="text-green-100">Approva o rifiuta richieste</p>
                    </div>
                    <i data-lucide="check-circle" class="w-8 h-8"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="window.location.href='/comunicazioni.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Nuova Comunicazione</h3>
                        <p class="text-purple-100">Invia annuncio a tutti</p>
                    </div>
                    <i data-lucide="send" class="w-8 h-8"></i>
                </div>
            </div>
        </div>

        <!-- Recent Activities & Pending Requests -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recent Activities -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden fade-in">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Attività Recenti</h3>
                </div>
                <div class="divide-y divide-gray-200">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-4">
                                <i data-lucide="check" class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">Lavorazione "Progetto Alpha" completata</p>
                                <p class="text-sm text-gray-500">Mario Rossi • 2 ore fa</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                                <i data-lucide="user-plus" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">Nuovo dipendente aggiunto</p>
                                <p class="text-sm text-gray-500">Anna Verdi • 4 ore fa</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center mr-4">
                                <i data-lucide="clock" class="w-5 h-5 text-orange-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">Richiesta ferie in attesa</p>
                                <p class="text-sm text-gray-500">Giuseppe Neri • 6 ore fa</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-3 bg-gray-50">
                    <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-500">Vedi tutte le attività</a>
                </div>
            </div>

            <!-- Pending Requests -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden fade-in">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Richieste da Approvare</h3>
                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">8 pendenti</span>
                </div>
                <div id="pendingRequestsList" class="divide-y divide-gray-200">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="px-6 py-3 bg-gray-50">
                    <a href="gestione-richieste.html" class="text-sm font-medium text-blue-600 hover:text-blue-500">Gestisci tutte le richieste</a>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6 fade-in">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Stato del Sistema</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-400 rounded-full mr-3"></div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Server Database</p>
                        <p class="text-sm text-gray-500">Operativo</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-400 rounded-full mr-3"></div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Sistema di Backup</p>
                        <p class="text-sm text-gray-500">Ultimo backup: 2 ore fa</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-yellow-400 rounded-full mr-3"></div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Aggiornamenti</p>
                        <p class="text-sm text-gray-500">1 aggiornamento disponibile</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data for pending requests
        const mockPendingRequests = [
            {
                id: 1,
                tipo: 'ferie',
                titolo: 'Richiesta Ferie Estive',
                dipendente: 'Mario Rossi',
                data: '2024-01-15'
            },
            {
                id: 2,
                tipo: 'materiali',
                titolo: 'Richiesta Laptop Nuovo',
                dipendente: 'Anna Verdi',
                data: '2024-01-16'
            },
            {
                id: 3,
                tipo: 'permessi',
                titolo: 'Permesso Medico',
                dipendente: 'Giuseppe Neri',
                data: '2024-01-17'
            }
        ];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            await loadPendingRequests();
            updateLastLogin();
            await updateStats();
        });

        async function loadPendingRequests() {
            try {
                const container = document.getElementById('pendingRequestsList');
                const requests = await window.dataManager.getRichieste();
                const pendingRequests = requests.filter(r => r.stato === 'pendente');
                
                document.getElementById('pendingRequests').textContent = pendingRequests.length;
                
                if (pendingRequests.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna richiesta pendente</p>';
                    return;
                }
                
                container.innerHTML = pendingRequests.slice(0, 5).map(req => `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${req.titolo}</p>
                            <p class="text-sm text-gray-500">${req.tipo}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveRequest('${req.id}')" class="text-green-600 hover:text-green-900" title="Approva">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="rejectRequest('${req.id}')" class="text-red-600 hover:text-red-900" title="Rifiuta">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento richieste:', error);
            }
            if (!container) return;

            container.innerHTML = '';

            mockPendingRequests.forEach(request => {
                const requestElement = createRequestElement(request);
                container.appendChild(requestElement);
            });
        }

        function createRequestElement(request) {
            const div = document.createElement('div');
            div.className = 'p-6';
            
            const typeIcon = getTypeIcon(request.tipo);
            
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                            <i data-lucide="${typeIcon}" class="w-4 h-4 text-orange-600"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${request.titolo}</p>
                            <p class="text-sm text-gray-500">${request.dipendente} • ${formatDate(request.data)}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="approveRequest(${request.id})" class="p-1 text-green-600 hover:bg-green-50 rounded" title="Approva">
                            <i data-lucide="check" class="w-4 h-4"></i>
                        </button>
                        <button onclick="rejectRequest(${request.id})" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Rifiuta">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;

            return div;
        }

        function getTypeIcon(type) {
            switch(type) {
                case 'ferie': return 'calendar';
                case 'permessi': return 'clock';
                case 'materiali': return 'package';
                case 'veicoli': return 'car';
                default: return 'file-text';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function updateLastLogin() {
            const now = new Date();
            const loginElement = document.getElementById('lastLogin');
            if (loginElement) {
                loginElement.textContent = `Oggi, ${now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
            }
        }

        async function updateStats() {
            try {
                const tasks = await window.dataManager.getLavorazioni();
                const clients = await window.dataManager.getClienti();
                const users = await window.dataManager.getUtenti();
                
                // Update counters
                const activeTasks = tasks.filter(t => t.stato === 'in_corso').length;
                const totalClients = clients.length;
                const teamMembers = users.filter(u => u.ruolo !== 'admin').length;
                
                document.getElementById('activeTasks').textContent = activeTasks;
                document.getElementById('totalClients').textContent = totalClients;
                document.getElementById('teamMembers').textContent = teamMembers;
                
                // Calculate completion rate
                const completedTasks = tasks.filter(t => t.stato === 'completato').length;
                const totalTasks = tasks.length;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                document.getElementById('completionRate').textContent = completionRate + '%';
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
            }
        }

        function approveRequest(requestId) {
            showNotification('Richiesta approvata con successo!', 'success');
            // Remove from pending list
            const index = mockPendingRequests.findIndex(r => r.id === requestId);
            if (index > -1) {
                mockPendingRequests.splice(index, 1);
                loadPendingRequests();
                lucide.createIcons();
                
                // Update pending count
                const pendingCount = document.getElementById('pendingRequests');
                if (pendingCount) {
                    pendingCount.textContent = mockPendingRequests.length;
                }
            }
        }

        function rejectRequest(requestId) {
            showNotification('Richiesta rifiutata', 'error');
            // Remove from pending list
            const index = mockPendingRequests.findIndex(r => r.id === requestId);
            if (index > -1) {
                mockPendingRequests.splice(index, 1);
                loadPendingRequests();
                lucide.createIcons();
                
                // Update pending count
                const pendingCount = document.getElementById('pendingRequests');
                if (pendingCount) {
                    pendingCount.textContent = mockPendingRequests.length;
                }
            }
        }

        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                showNotification('Logout effettuato', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Real-time clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT');
            document.title = `Dashboard Admin - ${timeString}`;
        }

        setInterval(updateClock, 1000);
    </script>
</body>
</html>