<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - AST Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <!-- Tailwind CDN - For production, consider installing via npm -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/supabase-client.js"></script>
    <script src="/Admin/auth-helper.js"></script>
    <script src="/data-migration.js"></script>
    <!-- FullCalendar JS only - CSS inline below -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        /* FullCalendar basic styles */
        .fc { max-width: 100%; margin: 0 auto; }
        .fc-toolbar-title { font-size: 1.5rem; font-weight: bold; }
        .fc-button { background-color: #3b82f6; border: none; padding: 0.5rem 1rem; }
        .fc-button:hover { background-color: #2563eb; }
        .fc-day { cursor: pointer; }
        .fc-day:hover { background-color: #f3f4f6; }
        
        /* Animation styles */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-gradient { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .success-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .warning-gradient { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .info-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out z-50" id="sidebar">
        <div class="flex items-center justify-center h-16 gradient-bg">
            <h1 class="text-white text-xl font-bold">Admin Panel</h1>
        </div>
        <nav class="mt-8">
            <a href="/Admin/admin-functional.html" class="flex items-center px-6 py-3 bg-blue-50 text-blue-600 border-r-4 border-blue-600">
                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="/gestione-utenti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                Gestione Utenti
            </a>
            <a href="/gestione-clienti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="building-2" class="w-5 h-5 mr-3"></i>
                Gestione Clienti
            </a>
            <a href="/gestione-lavorazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                Gestione Lavorazioni
            </a>
            <a href="/magazzino-prodotti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="package" class="w-5 h-5 mr-3"></i>
                Magazzino Prodotti
            </a>
            <a href="/calendario-admin.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                Calendario
            </a>
            <a href="/gestione-richieste.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                Gestione Richieste
            </a>
            <a href="/comunicazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Comunicazioni
            </a>
            <div class="mt-8 border-t pt-4">
                <a href="/pannello-utente.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-green-50 hover:text-green-600 transition-colors">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                    Pannello Utente
                </a>
                <a href="/superuser.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 transition-colors">
                    <i data-lucide="shield-alert" class="w-5 h-5 mr-3"></i>
                    SuperUser Panel
                </a>
                <a href="#" onclick="logout()" class="flex items-center px-6 py-3 text-red-700 hover:bg-red-50 hover:text-red-600 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Admin</h2>
                <p class="text-gray-600">Panoramica generale del sistema</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-sm text-gray-500">Ultimo accesso</p>
                    <p class="text-sm font-medium" id="lastLogin">Oggi, 09:30</p>
                </div>
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Dipendenti Totali</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalEmployees">...</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-green-600 text-sm font-medium" id="newEmployeesText">Caricamento...</span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Lavorazioni Attive</p>
                        <p class="text-2xl font-bold text-gray-900" id="activeTasks">...</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-green-600 text-sm font-medium" id="completedTasksText">Caricamento...</span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Richieste Pendenti</p>
                        <p class="text-2xl font-bold text-gray-900" id="pendingRequests">...</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-orange-600 text-sm font-medium">Richiede attenzione</span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Comunicazioni</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalCommunications">...</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-6 h-6 text-purple-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-purple-600 text-sm font-medium" id="sentTodayText">Caricamento...</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="window.location.href='/gestione-lavorazioni.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Nuova Lavorazione</h3>
                        <p class="text-blue-100">Crea e assegna nuovo task</p>
                    </div>
                    <i data-lucide="plus-circle" class="w-8 h-8"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="window.location.href='/gestione-richieste.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Gestisci Richieste</h3>
                        <p class="text-green-100">Approva o rifiuta richieste</p>
                    </div>
                    <i data-lucide="check-circle" class="w-8 h-8"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white hover-scale cursor-pointer" onclick="window.location.href='/comunicazioni.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Nuova Comunicazione</h3>
                        <p class="text-purple-100">Invia annuncio a tutti</p>
                    </div>
                    <i data-lucide="send" class="w-8 h-8"></i>
                </div>
            </div>
        </div>

        <!-- Recent Activities & Pending Requests -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recent Activities -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden fade-in">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Attivit√† Recenti</h3>
                    <button onclick="clearRecentActivities()" 
                            class="flex items-center gap-2 px-3 py-1.5 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                            title="Elimina tutte le attivit√† recenti">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Elimina attivit√†</span>
                    </button>
                </div>
                <div id="recentActivitiesList" class="divide-y divide-gray-200">
                    <!-- Populated by JavaScript -->
                    <div class="p-6 text-center text-gray-500">
                        <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                        <p>Caricamento attivit√†...</p>
                    </div>
                </div>
                <div class="px-6 py-3 bg-gray-50">
                    <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-500">Vedi tutte le attivit√†</a>
                </div>
            </div>

            <!-- Pending Requests -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden fade-in">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Richieste da Approvare</h3>
                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">8 pendenti</span>
                </div>
                <div id="pendingRequestsList" class="divide-y divide-gray-200">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="px-6 py-3 bg-gray-50">
                    <a href="gestione-richieste.html" class="text-sm font-medium text-blue-600 hover:text-blue-500">Gestisci tutte le richieste</a>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6 fade-in">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Stato del Sistema</h3>
            <div id="systemStatus" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-gray-400 rounded-full mr-3 animate-pulse"></div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Server Database</p>
                        <p class="text-sm text-gray-500">Controllo...</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-gray-400 rounded-full mr-3 animate-pulse"></div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Sistema di Backup</p>
                        <p class="text-sm text-gray-500">Controllo...</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-gray-400 rounded-full mr-3 animate-pulse"></div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Ultimo Aggiornamento</p>
                        <p class="text-sm text-gray-500">Controllo...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data for pending requests
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Check admin access
            if (!window.AuthHelper.requireAdmin()) {
                return; // requireAdmin() handles redirect
            }
            
            lucide.createIcons();
            
            // Wait for dataManager to be available
            if (typeof window.dataManager === 'undefined') {
                console.error('dataManager non disponibile');
                return;
            }
            
            await loadPendingRequests();
            await loadRecentActivities();
            await loadSystemStatus();
            updateLastLogin();
            await updateStats();
        });

        async function loadPendingRequests() {
            try {
                const container = document.getElementById('pendingRequestsList');
                if (!container) return;
                
                const requests = await window.dataManager.getRichieste();
                const pendingRequests = requests.filter(r => r.status === 'pending');
                
                document.getElementById('pendingRequests').textContent = pendingRequests.length;
                
                if (pendingRequests.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna richiesta pendente</p>';
                    return;
                }
                
                container.innerHTML = pendingRequests.slice(0, 5).map(req => `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${req.title || req.type}</p>
                            <p class="text-sm text-gray-500">${req.type}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveRequest('${req.id}')" class="text-green-600 hover:text-green-900" title="Approva">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="rejectRequest('${req.id}')" class="text-red-600 hover:text-red-900" title="Rifiuta">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento richieste:', error);
                const container = document.getElementById('pendingRequestsList');
                if (container) {
                    container.innerHTML = '<p class="text-red-500 text-center py-4">Errore caricamento richieste</p>';
                }
            }
        }

        async function loadRecentActivities() {
            try {
                const container = document.getElementById('recentActivitiesList');
                if (!container) return;

                // Fetch all data sources
                const [tasks, users, requests, communications] = await Promise.all([
                    window.dataManager.getLavorazioni(),
                    window.dataManager.getUtenti(),
                    window.dataManager.getRichieste(),
                    window.dataManager.getComunicazioni()
                ]);

                // Create activity objects with timestamps
                const activities = [];

                // Add completed tasks
                tasks.filter(t => t.stato === 'completato' && t.data_completamento).forEach(task => {
                    activities.push({
                        type: 'task_completed',
                        timestamp: new Date(task.data_completamento),
                        icon: 'check',
                        iconColor: 'green',
                        title: `Lavorazione "${task.titolo}" completata`,
                        user: task.assigned_to_name || 'Utente',
                        data: task
                    });
                });

                // Add new users (created in last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                users.filter(u => u.created_at && new Date(u.created_at) > thirtyDaysAgo).forEach(user => {
                    activities.push({
                        type: 'user_created',
                        timestamp: new Date(user.created_at),
                        icon: 'user-plus',
                        iconColor: 'blue',
                        title: `Nuovo dipendente aggiunto: ${user.nome} ${user.cognome}`,
                        user: 'Admin',
                        data: user
                    });
                });

                // Add pending requests
                requests.filter(r => r.status === 'pending' && r.created_at).forEach(req => {
                    activities.push({
                        type: 'request_pending',
                        timestamp: new Date(req.created_at),
                        icon: 'clock',
                        iconColor: 'orange',
                        title: `Richiesta ${req.type || 'generica'} in attesa`,
                        user: req.user_name || 'Dipendente',
                        data: req
                    });
                });

                // Add recent communications
                communications.filter(c => c.created_at).forEach(comm => {
                    activities.push({
                        type: 'communication',
                        timestamp: new Date(comm.created_at),
                        icon: 'message-square',
                        iconColor: 'purple',
                        title: `Nuova comunicazione: ${comm.titolo}`,
                        user: 'Admin',
                        data: comm
                    });
                });

                // Sort by timestamp (most recent first)
                activities.sort((a, b) => b.timestamp - a.timestamp);

                // Take top 10
                const recentActivities = activities.slice(0, 10);

                if (recentActivities.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessuna attivit√† recente</p>';
                    return;
                }

                // Render activities
                container.innerHTML = recentActivities.map(activity => {
                    const timeAgo = getTimeAgo(activity.timestamp);
                    return `
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-${activity.iconColor}-100 rounded-full flex items-center justify-center mr-4">
                                    <i data-lucide="${activity.icon}" class="w-5 h-5 text-${activity.iconColor}-600"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                                    <p class="text-sm text-gray-500">${activity.user} ‚Ä¢ ${timeAgo}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento attivit√†:', error);
                const container = document.getElementById('recentActivitiesList');
                if (container) {
                    container.innerHTML = '<p class="text-red-500 text-center py-4">Errore caricamento attivit√†</p>';
                }
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Pochi secondi fa';
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} ${minutes === 1 ? 'minuto' : 'minuti'} fa`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} ${hours === 1 ? 'ora' : 'ore'} fa`;
            
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} ${days === 1 ? 'giorno' : 'giorni'} fa`;
            
            const weeks = Math.floor(days / 7);
            if (weeks < 4) return `${weeks} ${weeks === 1 ? 'settimana' : 'settimane'} fa`;
            
            const months = Math.floor(days / 30);
            return `${months} ${months === 1 ? 'mese' : 'mesi'} fa`;
        }

        async function loadSystemStatus() {
            try {
                const statusContainer = document.getElementById('systemStatus');
                if (!statusContainer) return;

                // Test database connection
                let dbStatus = 'offline';
                let dbColor = 'red';
                let dbText = 'Non raggiungibile';
                
                try {
                    const { data, error } = await supabase.from('users').select('id').limit(1);
                    if (!error) {
                        dbStatus = 'online';
                        dbColor = 'green';
                        dbText = 'Operativo';
                    }
                } catch (e) {
                    console.error('DB check failed:', e);
                }

                // Get last activity timestamp (most recent update across all tables)
                let lastBackup = null;
                let backupColor = 'yellow';
                let backupText = 'Nessun dato';

                try {
                    const [tasks, users, communications] = await Promise.all([
                        window.dataManager.getLavorazioni(),
                        window.dataManager.getUtenti(),
                        window.dataManager.getComunicazioni()
                    ]);

                    const allDates = [
                        ...tasks.map(t => t.updated_at || t.created_at),
                        ...users.map(u => u.updated_at || u.created_at),
                        ...communications.map(c => c.updated_at || c.created_at)
                    ].filter(Boolean).map(d => new Date(d));

                    if (allDates.length > 0) {
                        lastBackup = new Date(Math.max(...allDates));
                        const hoursSinceBackup = (new Date() - lastBackup) / (1000 * 60 * 60);
                        
                        if (hoursSinceBackup < 24) {
                            backupColor = 'green';
                            backupText = `Ultimo backup: ${getTimeAgo(lastBackup)}`;
                        } else if (hoursSinceBackup < 72) {
                            backupColor = 'yellow';
                            backupText = `Ultimo backup: ${getTimeAgo(lastBackup)}`;
                        } else {
                            backupColor = 'red';
                            backupText = `‚ö†Ô∏è Backup obsoleto: ${getTimeAgo(lastBackup)}`;
                        }
                    }
                } catch (e) {
                    console.error('Backup check failed:', e);
                }

                // Get app version from commits (simulated - in real app use version from package.json or git)
                const appVersion = 'v2.5.0';
                const lastUpdate = new Date('2025-11-28'); // Today's date
                const updateText = `Versione ${appVersion} ‚Ä¢ ${getTimeAgo(lastUpdate)}`;

                statusContainer.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-${dbColor}-400 rounded-full mr-3"></div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Server Database</p>
                            <p class="text-sm text-gray-500">${dbText}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-${backupColor}-400 rounded-full mr-3"></div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Sistema di Backup</p>
                            <p class="text-sm text-gray-500">${backupText}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-400 rounded-full mr-3"></div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Ultimo Aggiornamento</p>
                            <p class="text-sm text-gray-500">${updateText}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Errore caricamento stato sistema:', error);
            }
        }

        async function clearRecentActivities() {
            // SAFE VERSION: Clear only visualization, does NOT delete from database
            if (!confirm('Vuoi nascondere le attivit√† visualizzate?\n\nNOTA: Questa azione nasconde solo la lista visualizzata.\nI dati rimangono nel database e riappariranno ricaricando la pagina.')) {
                return;
            }

            try {
                const container = document.getElementById('recentActivitiesList');
                
                // Clear the visual list only
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <i data-lucide="eye-off" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                        <p class="text-gray-600 font-medium mb-2">Attivit√† nascoste</p>
                        <p class="text-sm text-gray-500 mb-4">La lista √® stata nascosta. I dati sono ancora nel database.</p>
                        <button onclick="loadRecentActivities()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                            Ricarica Attivit√†
                        </button>
                    </div>
                `;
                
                lucide.createIcons();
            } catch (error) {
                console.error('Errore durante l\'eliminazione:', error);
                alert('‚ùå Errore durante l\'eliminazione delle attivit√†: ' + error.message);
                await loadRecentActivities();
            }
        }

        function createRequestElement(request) {
            const div = document.createElement('div');
            div.className = 'p-6';
            
            const typeIcon = getTypeIcon(request.tipo);
            
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                            <i data-lucide="${typeIcon}" class="w-4 h-4 text-orange-600"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${request.titolo}</p>
                            <p class="text-sm text-gray-500">${request.dipendente} ‚Ä¢ ${formatDate(request.data)}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="approveRequest(${request.id})" class="p-1 text-green-600 hover:bg-green-50 rounded" title="Approva">
                            <i data-lucide="check" class="w-4 h-4"></i>
                        </button>
                        <button onclick="rejectRequest(${request.id})" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Rifiuta">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;

            return div;
        }

        function getTypeIcon(type) {
            switch(type) {
                case 'ferie': return 'calendar';
                case 'permessi': return 'clock';
                case 'materiali': return 'package';
                case 'veicoli': return 'car';
                default: return 'file-text';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function updateLastLogin() {
            const now = new Date();
            const loginElement = document.getElementById('lastLogin');
            if (loginElement) {
                loginElement.textContent = `Oggi, ${now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
            }
        }

        async function updateStats() {
            try {
                const users = await window.dataManager.getUtenti();
                const clients = await window.dataManager.getClienti();
                const tasks = await window.dataManager.getLavorazioni();
                const requests = await window.dataManager.getRichieste();
                const communications = await window.dataManager.getComunicazioni();
                
                // Calculate today's date for comparisons
                const today = new Date().toISOString().split('T')[0];
                const thisMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
                
                // Update main counters
                const totalEmployeesEl = document.getElementById('totalEmployees');
                const totalClientsEl = document.getElementById('totalClients');
                const activeTasksEl = document.getElementById('activeTasks');
                const pendingRequestsEl = document.getElementById('pendingRequests');
                const totalCommsEl = document.getElementById('totalCommunications');
                
                if (totalEmployeesEl) totalEmployeesEl.textContent = users.length || '0';
                if (totalClientsEl) totalClientsEl.textContent = clients.length || '0';
                if (activeTasksEl) {
                    const activeTasks = tasks.filter(t => t.status === 'in_progress' || t.status === 'pending').length;
                    activeTasksEl.textContent = activeTasks || '0';
                }
                if (pendingRequestsEl) {
                    const pending = requests.filter(r => r.status === 'pending').length;
                    pendingRequestsEl.textContent = pending || '0';
                }
                if (totalCommsEl) totalCommsEl.textContent = communications.length || '0';
                
                // Update secondary stats
                // New employees this month
                const newEmployeesText = document.getElementById('newEmployeesText');
                if (newEmployeesText) {
                    const newThisMonth = users.filter(u => u.created_at?.startsWith(thisMonth)).length;
                    newEmployeesText.textContent = newThisMonth > 0 ? `+${newThisMonth} questo mese` : 'Nessuno questo mese';
                }
                
                // Completed tasks today
                const completedTasksText = document.getElementById('completedTasksText');
                if (completedTasksText) {
                    const completedToday = tasks.filter(t => 
                        t.status === 'completed' && t.completed_at?.startsWith(today)
                    ).length;
                    completedTasksText.textContent = completedToday > 0 ? `${completedToday} completate oggi` : 'Nessuna completata oggi';
                }
                
                // Communications sent today
                const sentTodayText = document.getElementById('sentTodayText');
                if (sentTodayText) {
                    const sentToday = communications.filter(c => 
                        c.stato === 'inviata' && c.data_invio === today
                    ).length;
                    sentTodayText.textContent = sentToday > 0 ? `${sentToday} inviate oggi` : 'Nessuna inviata oggi';
                }
                
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
                // Show 0 instead of errors
                document.getElementById('totalEmployees').textContent = '0';
                document.getElementById('activeTasks').textContent = '0';
                document.getElementById('pendingRequests').textContent = '0';
                document.getElementById('totalCommunications').textContent = '0';
            }
        }

        async function approveRequest(requestId) {
            try {
                // Update request status in Supabase
                await window.RequestsAPI.update(requestId, { status: 'approved' });
                
                showNotification('Richiesta approvata con successo!', 'success');
                
                // Reload pending requests
                await loadPendingRequests();
                lucide.createIcons();
            } catch (error) {
                console.error('Errore approvazione richiesta:', error);
                showNotification('Errore durante l\'approvazione', 'error');
            }
        }

        async function rejectRequest(requestId) {
            try {
                // Update request status in Supabase
                await window.RequestsAPI.update(requestId, { status: 'rejected' });
                
                showNotification('Richiesta rifiutata', 'error');
                
                // Reload pending requests
                await loadPendingRequests();
                lucide.createIcons();
            } catch (error) {
                console.error('Errore rifiuto richiesta:', error);
                showNotification('Errore durante il rifiuto', 'error');
            }
        }

        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                showNotification('Logout effettuato', 'info');
                setTimeout(() => {
                    window.location.href = 'Admin/index.html';
                }, 1000);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Real-time clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT');
            document.title = `Dashboard Admin - ${timeString}`;
        }

        setInterval(updateClock, 1000);
    </script>
</body>
</html>