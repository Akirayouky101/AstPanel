<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“§ Gestione Email Commercialista - AST Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./supabase-client.js"></script>
    <script src="./auth-helper.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .recipient-card {
            transition: all 0.3s ease;
        }
        .recipient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        .badge-commercialista {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-consulente {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-altro {
            background: #f3e8ff;
            color: #6b21a8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <i class="fas fa-envelope"></i>
                        Gestione Email Commercialista
                    </h1>
                    <p class="text-blue-100 mt-2">Configura i destinatari per l'invio automatico dei report mensili</p>
                </div>
                <button onclick="history.back()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-arrow-left mr-2"></i>Indietro
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Statistiche -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Destinatari Attivi</p>
                        <p class="text-3xl font-bold text-blue-600 mt-2" id="countActive">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-full">
                        <i class="fas fa-user-check text-blue-600 text-2xl"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Massimo 5 destinatari</p>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Inattivi</p>
                        <p class="text-3xl font-bold text-gray-400 mt-2" id="countInactive">0</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-full">
                        <i class="fas fa-user-slash text-gray-400 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Totale Email</p>
                        <p class="text-3xl font-bold text-green-600 mt-2" id="countTotal">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-full">
                        <i class="fas fa-envelope text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Azioni -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-wrap gap-4">
                <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    Aggiungi Destinatario
                </button>
                <button onclick="loadDestinatari()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center gap-2">
                    <i class="fas fa-sync"></i>
                    Aggiorna Lista
                </button>
                <button onclick="testEmail()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center gap-2">
                    <i class="fas fa-paper-plane"></i>
                    Test Email
                </button>
            </div>
        </div>

        <!-- Lista Destinatari -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fas fa-list text-blue-600"></i>
                Lista Destinatari
            </h2>
            <div id="destinatariList" class="space-y-4">
                <!-- Caricamento... -->
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                    <p>Caricamento destinatari...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Aggiungi/Modifica -->
    <div id="modalDestinatario" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-lg">
                <h3 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-envelope-plus"></i>
                    <span id="modalTitle">Aggiungi Destinatario</span>
                </h3>
            </div>
            
            <form id="formDestinatario" class="p-6 space-y-6">
                <input type="hidden" id="destinatarioId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope text-blue-600 mr-2"></i>Email *
                    </label>
                    <input type="email" id="destinatarioEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="commercialista@example.com">
                    <p class="text-xs text-gray-500 mt-1">Email del destinatario per ricevere i report mensili</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-building text-blue-600 mr-2"></i>Nome / Ragione Sociale *
                    </label>
                    <input type="text" id="destinatarioNome" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Studio Commercialista Rossi">
                    <p class="text-xs text-gray-500 mt-1">Nome o ragione sociale del destinatario</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tag text-blue-600 mr-2"></i>Tipo Destinatario *
                    </label>
                    <select id="destinatarioTipo" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="commercialista">Commercialista</option>
                        <option value="consulente">Consulente del Lavoro</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>

                <div>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="destinatarioAttivo" checked 
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">
                            <i class="fas fa-toggle-on text-green-600 mr-2"></i>Destinatario Attivo
                        </span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-8">Se disattivato, non riceverÃ  piÃ¹ le email</p>
                </div>

                <div class="flex gap-3 pt-4 border-t">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-save mr-2"></i>Salva
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-times mr-2"></i>Annulla
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        let destinatari = [];
        let currentUser = null;

        // ============================================
        // INIT
        // ============================================
        window.addEventListener('load', async () => {
            try {
                // Check auth
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }

                // Get current user data
                const { data: userData } = await window.supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                currentUser = userData;

                // Check permissions
                if (!['Titolare', 'Amministratore', 'Tecnico', 'Segreteria'].includes(currentUser.ruolo)) {
                    alert('â›” Accesso negato. Solo admin possono gestire i destinatari email.');
                    window.location.href = 'pannello-utente.html';
                    return;
                }

                await loadDestinatari();
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                alert('Errore caricamento pagina: ' + error.message);
            }
        });

        // ============================================
        // LOAD DESTINATARI
        // ============================================
        async function loadDestinatari() {
            const listDiv = document.getElementById('destinatariList');
            listDiv.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p>Caricamento...</p></div>';

            try {
                const { data, error } = await window.supabaseClient
                    .from('email_destinatari')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                destinatari = data || [];
                updateStats();
                renderDestinatari();

            } catch (error) {
                console.error('Errore caricamento destinatari:', error);
                listDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                        <p class="text-red-700 font-medium">Errore caricamento destinatari</p>
                        <p class="text-red-600 text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================
        // RENDER DESTINATARI
        // ============================================
        function renderDestinatari() {
            const listDiv = document.getElementById('destinatariList');

            if (destinatari.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-6xl mb-4"></i>
                        <p class="text-lg font-medium">Nessun destinatario configurato</p>
                        <p class="text-sm mt-2">Aggiungi il primo destinatario per iniziare</p>
                        <button onclick="openAddModal()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                            <i class="fas fa-plus mr-2"></i>Aggiungi Primo Destinatario
                        </button>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = destinatari.map(dest => `
                <div class="recipient-card bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-800">${escapeHtml(dest.nome)}</h3>
                                <span class="badge badge-${dest.attivo ? 'active' : 'inactive'}">
                                    ${dest.attivo ? 'âœ“ Attivo' : 'âœ• Inattivo'}
                                </span>
                                <span class="badge badge-${dest.tipo}">
                                    ${dest.tipo.charAt(0).toUpperCase() + dest.tipo.slice(1)}
                                </span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <i class="fas fa-envelope text-blue-600"></i>
                                <a href="mailto:${dest.email}" class="hover:text-blue-600">${escapeHtml(dest.email)}</a>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">
                                <i class="fas fa-calendar mr-1"></i>
                                Aggiunto il ${new Date(dest.created_at).toLocaleDateString('it-IT')}
                            </p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="editDestinatario('${dest.id}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-edit mr-1"></i>Modifica
                            </button>
                            <button onclick="toggleAttivo('${dest.id}', ${!dest.attivo})" 
                                    class="bg-${dest.attivo ? 'orange' : 'green'}-600 hover:bg-${dest.attivo ? 'orange' : 'green'}-700 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-toggle-${dest.attivo ? 'off' : 'on'} mr-1"></i>
                                ${dest.attivo ? 'Disattiva' : 'Attiva'}
                            </button>
                            <button onclick="deleteDestinatario('${dest.id}', '${escapeHtml(dest.nome)}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-trash mr-1"></i>Elimina
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // UPDATE STATS
        // ============================================
        function updateStats() {
            const active = destinatari.filter(d => d.attivo).length;
            const inactive = destinatari.filter(d => !d.attivo).length;
            const total = destinatari.length;

            document.getElementById('countActive').textContent = active;
            document.getElementById('countInactive').textContent = inactive;
            document.getElementById('countTotal').textContent = total;
        }

        // ============================================
        // MODAL
        // ============================================
        function openAddModal() {
            // Apri sempre la modal
            document.getElementById('modalTitle').textContent = 'Aggiungi Destinatario';
            document.getElementById('destinatarioId').value = '';
            document.getElementById('formDestinatario').reset();
            document.getElementById('destinatarioAttivo').checked = true;
            document.getElementById('modalDestinatario').classList.remove('hidden');
            
            // Controlla il limite DOPO aver aperto la modal
            const activeCount = destinatari.filter(d => d.attivo).length;
            if (activeCount >= 5) {
                // Se giÃ  5 attivi, preimposta checkbox a false e mostra messaggio nella modal
                document.getElementById('destinatarioAttivo').checked = false;
                const warningDiv = document.createElement('div');
                warningDiv.id = 'warningMaxDestinatari';
                warningDiv.className = 'bg-orange-50 border-l-4 border-orange-500 p-4 mb-4';
                warningDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-orange-600"></i>
                        <p class="text-sm text-orange-800 font-medium">
                            Hai giÃ  5 destinatari attivi. Puoi aggiungere questo destinatario come <strong>Inattivo</strong>,
                            oppure disattivarne uno esistente prima di attivare questo.
                        </p>
                    </div>
                `;
                const form = document.getElementById('formDestinatario');
                if (!document.getElementById('warningMaxDestinatari')) {
                    form.insertBefore(warningDiv, form.firstChild);
                }
            }
        }

        async function editDestinatario(id) {
            const dest = destinatari.find(d => d.id === id);
            if (!dest) return;

            document.getElementById('modalTitle').textContent = 'Modifica Destinatario';
            document.getElementById('destinatarioId').value = dest.id;
            document.getElementById('destinatarioEmail').value = dest.email;
            document.getElementById('destinatarioNome').value = dest.nome;
            document.getElementById('destinatarioTipo').value = dest.tipo;
            document.getElementById('destinatarioAttivo').checked = dest.attivo;
            document.getElementById('modalDestinatario').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalDestinatario').classList.add('hidden');
            document.getElementById('formDestinatario').reset();
            // Rimuovi warning se presente
            const warning = document.getElementById('warningMaxDestinatari');
            if (warning) warning.remove();
        }

        // ============================================
        // SAVE DESTINATARIO
        // ============================================
        document.getElementById('formDestinatario').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('destinatarioId').value;
            const email = document.getElementById('destinatarioEmail').value.trim();
            const nome = document.getElementById('destinatarioNome').value.trim();
            const tipo = document.getElementById('destinatarioTipo').value;
            const attivo = document.getElementById('destinatarioAttivo').checked;

            if (!email || !nome) {
                alert('Compila tutti i campi obbligatori');
                return;
            }

            try {
                if (id) {
                    // UPDATE
                    const { error } = await window.supabaseClient
                        .from('email_destinatari')
                        .update({ email, nome, tipo, attivo, updated_at: new Date().toISOString() })
                        .eq('id', id);

                    if (error) throw error;
                    alert('âœ… Destinatario modificato con successo!');
                } else {
                    // INSERT
                    // Verifica limiti prima dell'insert
                    const activeCount = destinatari.filter(d => d.attivo).length;
                    if (attivo && activeCount >= 5) {
                        alert('âš ï¸ Massimo 5 destinatari attivi consentiti!\n\nDisattiva la checkbox "Destinatario Attivo" per aggiungerlo come inattivo.');
                        return;
                    }

                    const { error } = await window.supabaseClient
                        .from('email_destinatari')
                        .insert([{ email, nome, tipo, attivo }]);

                    if (error) {
                        if (error.message.includes('Massimo 5 destinatari') || error.message.includes('duplicat')) {
                            alert('âš ï¸ Errore: Massimo 5 destinatari attivi o email giÃ  esistente!');
                        } else {
                            throw error;
                        }
                        return;
                    }
                    alert('âœ… Destinatario aggiunto con successo!');
                }

                closeModal();
                await loadDestinatari();

            } catch (error) {
                console.error('Errore salvataggio:', error);
                alert('âŒ Errore: ' + error.message);
            }
        });

        // ============================================
        // TOGGLE ATTIVO
        // ============================================
        async function toggleAttivo(id, newValue) {
            const dest = destinatari.find(d => d.id === id);
            if (!dest) return;

            const activeCount = destinatari.filter(d => d.attivo && d.id !== id).length;

            if (newValue && activeCount >= 5) {
                alert('âš ï¸ Massimo 5 destinatari attivi consentiti!');
                return;
            }

            const action = newValue ? 'attivare' : 'disattivare';
            if (!confirm(`Confermi di voler ${action} "${dest.nome}"?`)) return;

            try {
                const { error } = await window.supabaseClient
                    .from('email_destinatari')
                    .update({ attivo: newValue, updated_at: new Date().toISOString() })
                    .eq('id', id);

                if (error) throw error;

                alert(`âœ… Destinatario ${newValue ? 'attivato' : 'disattivato'}!`);
                await loadDestinatari();

            } catch (error) {
                console.error('Errore toggle:', error);
                alert('âŒ Errore: ' + error.message);
            }
        }

        // ============================================
        // DELETE DESTINATARIO
        // ============================================
        async function deleteDestinatario(id, nome) {
            if (!confirm(`âš ï¸ ATTENZIONE!\n\nVuoi eliminare definitivamente "${nome}"?\n\nQuesta azione non puÃ² essere annullata.`)) {
                return;
            }

            try {
                const { error } = await window.supabaseClient
                    .from('email_destinatari')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('âœ… Destinatario eliminato!');
                await loadDestinatari();

            } catch (error) {
                console.error('Errore eliminazione:', error);
                alert('âŒ Errore: ' + error.message);
            }
        }

        // ============================================
        // TEST EMAIL
        // ============================================
        async function testEmail() {
            alert('ðŸš§ Funzione Test Email in arrivo!\n\nInvierÃ  una email di test a tutti i destinatari attivi.');
        }

        // ============================================
        // UTILS
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
