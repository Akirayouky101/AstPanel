<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - AST Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    <script src="data-migration.js"></script>
    
    <link rel="stylesheet" href="mobile-optimizations.css">
    
    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #e5e7eb;
            padding: 4px;
            min-height: 60px;
            background: white;
            font-size: 14px;
        }
        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }
        .calendar-day.today {
            border: 2px solid #3b82f6;
            background: #eff6ff;
        }
        .event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin: 1px;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 50px;
                padding: 2px;
                font-size: 12px;
            }
            .event-dot {
                width: 4px;
                height: 4px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-6xl mx-auto p-2 md:p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-4 md:mb-6 px-2">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                    <i data-lucide="calendar" class="w-6 h-6 md:w-8 md:h-8 inline mr-2"></i>
                    Calendario
                </h1>
            </div>
            <a href="calendario-dipendente.html" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 md:px-4 rounded-lg text-sm md:text-base">
                <i data-lucide="list" class="w-4 h-4 md:w-5 md:h-5 inline mr-1 md:mr-2"></i>
                Vista Lista
            </a>
        </div>

        <!-- Calendar Controls -->
        <div class="bg-white rounded-lg shadow p-3 md:p-4 mb-3 md:mb-4">
            <div class="flex justify-between items-center">
                <button onclick="prevMonth()" class="p-2 hover:bg-gray-100 rounded" title="Mese precedente">
                    <i data-lucide="chevron-left" class="w-5 h-5 md:w-6 md:h-6"></i>
                </button>
                <h2 id="monthYear" class="text-xl md:text-2xl font-bold"></h2>
                <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded" title="Mese successivo">
                    <i data-lucide="chevron-right" class="w-5 h-5 md:w-6 md:h-6"></i>
                </button>
            </div>
        </div>

        <!-- Calendar -->
        <div class="bg-white rounded-lg shadow p-2 md:p-4">
            <!-- Day headers -->
            <div class="calendar-grid mb-1 md:mb-2">
                <div class="text-center font-bold text-gray-600 p-1 md:p-2 text-xs md:text-sm">Lun</div>
                <div class="text-center font-bold text-gray-600 p-1 md:p-2 text-xs md:text-sm">Mar</div>
                <div class="text-center font-bold text-gray-600 p-1 md:p-2 text-xs md:text-sm">Mer</div>
                <div class="text-center font-bold text-gray-600 p-1 md:p-2 text-xs md:text-sm">Gio</div>
                <div class="text-center font-bold text-gray-600 p-1 md:p-2 text-xs md:text-sm">Ven</div>
                <div class="text-center font-bold text-gray-600 p-1 md:p-2 text-xs md:text-sm">Sab</div>
                <div class="text-center font-bold text-gray-600 p-1 md:p-2 text-xs md:text-sm">Dom</div>
            </div>
            
            <!-- Days -->
            <div id="calendarDays" class="calendar-grid">
                <!-- Generated by JavaScript -->
            </div>
        </div>

        <!-- Events List -->
        <div id="eventsList" class="mt-6">
            <!-- Generated by JavaScript -->
        </div>
    </div>

    <!-- Task Details Modal - IDENTICA a pannello-utente.html -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md md:max-w-2xl max-h-[90vh] overflow-hidden flex flex-col my-4">
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 p-4 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <h3 id="modalTitle" class="text-lg font-bold text-white flex-1">Dettagli Lavorazione</h3>
                        <button onclick="closeEventModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors ml-2" title="Chiudi">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Content scrollabile -->
                <div class="p-3 overflow-y-auto flex-1" id="modalContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let myEvents = [];

        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            await loadEvents();
            renderCalendar();
        });

        async function loadEvents() {
            try {
                const user = window.AuthHelper.getCurrentUser();
                const allEvents = await window.dataManager.syncCalendarFromTasks();
                myEvents = allEvents.filter(event => 
                    event.extendedProps && event.extendedProps.userId === user.id
                );
                console.log('‚úÖ Caricati', myEvents.length, 'eventi');
            } catch (error) {
                console.error('‚ùå Errore caricamento eventi:', error);
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update title
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month (0 = Sunday, 1 = Monday, etc.)
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            // Adjust first day to start from Monday
            const startDay = firstDay === 0 ? 6 : firstDay - 1;
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            // Previous month days
            for (let i = startDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const cell = createDayCell(day, true, false);
                calendarDays.appendChild(cell);
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && today.getDate() === day;
                const cell = createDayCell(day, false, isToday);
                
                // Add events for this day
                const dayEvents = getEventsForDate(new Date(year, month, day));
                if (dayEvents.length > 0) {
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'mt-2';
                    dayEvents.forEach(event => {
                        const dot = document.createElement('span');
                        dot.className = 'event-dot';
                        dot.style.backgroundColor = event.backgroundColor || '#3b82f6';
                        dot.title = event.title;
                        dot.onclick = () => showEventInfo(event);
                        eventsContainer.appendChild(dot);
                    });
                    cell.appendChild(eventsContainer);
                }
                
                calendarDays.appendChild(cell);
            }
            
            // Next month days
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(day, true, false);
                calendarDays.appendChild(cell);
            }
            
            lucide.createIcons();
            renderEventsList();
        }

        function createDayCell(day, otherMonth, isToday) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (otherMonth) cell.classList.add('other-month');
            if (isToday) cell.classList.add('today');
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'font-semibold text-sm';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);
            
            return cell;
        }

        function getEventsForDate(date) {
            return myEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.toDateString() === date.toDateString();
            });
        }

        function renderEventsList() {
            const eventsList = document.getElementById('eventsList');
            const monthEvents = myEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.getMonth() === currentDate.getMonth() && 
                       eventDate.getFullYear() === currentDate.getFullYear();
            });
            
            if (monthEvents.length === 0) {
                eventsList.innerHTML = '<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">Nessun evento questo mese</div>';
                return;
            }
            
            let html = '<div class="bg-white rounded-lg shadow p-6"><h3 class="text-xl font-bold mb-4">Eventi del mese</h3>';
            monthEvents.forEach(event => {
                const date = new Date(event.start).toLocaleDateString('it-IT');
                html += `
                    <div class="border-l-4 border-blue-600 pl-4 py-2 mb-2 hover:bg-gray-50 cursor-pointer" onclick='showEventInfo(${JSON.stringify(event).replace(/'/g, "&#39;")})'>
                        <div class="font-semibold">${event.title}</div>
                        <div class="text-sm text-gray-600">${date}</div>
                    </div>
                `;
            });
            html += '</div>';
            eventsList.innerHTML = html;
        }

        async function showEventInfo(event) {
            console.log('üìã Evento completo:', event);
            
            try {
                // Load full task from database
                const allTasks = await window.dataManager.getLavorazioni();
                const task = allTasks.find(t => t.id === event.extendedProps.taskId);
                
                if (!task) {
                    alert('Task non trovato');
                    return;
                }
                
                // Extract task info (come pannello-utente.html)
                const titolo = task.titolo || task.title || 'N/A';
                const descrizione = task.descrizione || task.description || 'Nessuna descrizione';
                const stato = task.stato || task.status || 'da_fare';
                const priorita = task.priorita || task.priority || 'media';
                const scadenza = task.scadenza || task.deadline;
                const progresso = task.progresso || task.progress || 0;
                const categoria = task.categoria || task.category || 'other';
                const clienteName = task.client ? task.client.ragione_sociale : 'Nessun cliente';
                const assignedUser = task.assigned_user ? `${task.assigned_user.nome} ${task.assigned_user.cognome}` : 'Non assegnato';
                
                // Set modal title
                document.getElementById('modalTitle').textContent = `Dettagli: ${titolo}`;
                
                // Generate HTML content (IDENTICO a pannello-utente.html)
                const content = document.getElementById('modalContent');
                const isOverdue = scadenza && new Date(scadenza) < new Date() && stato !== 'completato';
                
                content.innerHTML = `
                    <div class="space-y-3">
                        <!-- Main Info Grid -->
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Cliente - VERDE -->
                            <div class="col-span-2 bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="building-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-green-700 font-medium">Cliente</p>
                                        <p class="font-bold text-gray-900 text-sm truncate">${clienteName}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scadenza - ARANCIO -->
                            <div class="bg-gradient-to-br from-orange-50 to-amber-100 border-2 border-orange-200 rounded-xl p-3">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg flex items-center justify-center mb-2">
                                        <i data-lucide="calendar" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <p class="text-xs text-orange-700 font-medium">Scadenza</p>
                                    ${scadenza ? `
                                    <p class="font-bold text-sm ${isOverdue ? 'text-red-600' : 'text-gray-900'} mt-1">
                                        ${new Date(scadenza).toLocaleDateString('it-IT', {day: '2-digit', month: '2-digit', year: 'numeric'})}
                                    </p>
                                    ` : '<p class="font-bold text-sm text-gray-500 mt-1">Non impostata</p>'}
                                </div>
                            </div>

                            <!-- Priorit√† - ROSA -->
                            <div class="bg-gradient-to-br from-pink-50 to-rose-100 border-2 border-pink-200 rounded-xl p-3">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-rose-600 rounded-lg flex items-center justify-center mb-2">
                                        <i data-lucide="alert-circle" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <p class="text-xs text-pink-700 font-medium">Priorit√†</p>
                                    <p class="font-bold text-sm text-gray-900 mt-1">${getPriorityEmoji(priorita)} ${priorita.charAt(0).toUpperCase() + priorita.slice(1)}</p>
                                </div>
                            </div>

                            <!-- Stato - BLU -->
                            <div class="col-span-2 bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="activity" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-blue-700 font-medium">Stato</p>
                                        <p class="font-bold text-sm text-gray-900">${getStatusText(stato)}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Assegnato - VIOLA -->
                            <div class="col-span-2 bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-purple-700 font-medium">Assegnato a</p>
                                        <p class="font-bold text-sm text-gray-900 truncate">${assignedUser}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Categoria - GIALLO -->
                            <div class="col-span-2 bg-gradient-to-br from-yellow-50 to-amber-100 border-2 border-yellow-200 rounded-xl p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-amber-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="tag" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-yellow-700 font-medium">Categoria</p>
                                        <p class="font-bold text-sm text-gray-900">${getCategoryText(categoria)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progresso - CELESTE -->
                        ${progresso !== undefined ? `
                        <div class="bg-gradient-to-br from-cyan-50 to-sky-100 border-2 border-cyan-200 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="trending-up" class="w-5 h-5 text-cyan-700"></i>
                                    <span class="text-sm font-bold text-cyan-900">Progresso</span>
                                </div>
                                <span class="text-2xl font-bold text-cyan-600">${progresso}%</span>
                            </div>
                            <div class="w-full bg-cyan-200 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-cyan-500 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${progresso}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Descrizione - GRIGIO -->
                        <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                            <div class="flex items-start gap-3">
                                <i data-lucide="file-text" class="w-5 h-5 text-gray-600 mt-1"></i>
                                <div>
                                    <p class="text-sm font-bold text-gray-700 mb-2">Descrizione</p>
                                    <p class="text-gray-600 leading-relaxed">${descrizione}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show modal
                document.getElementById('eventModal').classList.remove('hidden');
                
                // Refresh icons
                setTimeout(() => lucide.createIcons(), 100);
                
            } catch (error) {
                console.error('‚ùå Errore caricamento task:', error);
                alert('Errore nel caricamento dei dettagli');
            }
        }
        
        // Helper functions for formatting
        function getPriorityEmoji(priority) {
            const emojis = {
                'alta': '‚ö†Ô∏è',
                'media': 'üü°',
                'bassa': '‚úÖ',
                'normale': 'üìã'
            };
            return emojis[priority] || emojis['normale'];
        }
        
        function getPriorityBadgeClass(priority) {
            const classes = {
                'alta': 'bg-red-100 text-red-700',
                'media': 'bg-yellow-100 text-yellow-700',
                'bassa': 'bg-green-100 text-green-700',
                'normale': 'bg-blue-100 text-blue-700'
            };
            return classes[priority] || classes['normale'];
        }
        
        function getPriorityText(priority) {
            const texts = {
                'alta': 'üî¥ Alta',
                'media': 'ÔøΩ Media',
                'bassa': 'üü¢ Bassa',
                'normale': 'üîµ Normale'
            };
            return texts[priority] || texts['normale'];
        }
        
        function getStatusClass(status) {
            const classes = {
                'da_fare': 'bg-gray-100 text-gray-700',
                'in_corso': 'bg-blue-100 text-blue-700',
                'revisione': 'bg-yellow-100 text-yellow-700',
                'completato': 'bg-green-100 text-green-700'
            };
            return classes[status] || classes['da_fare'];
        }
        
        function getStatusText(status) {
            const texts = {
                'da_fare': 'Da Fare',
                'in_corso': 'In Corso',
                'revisione': 'In Revisione',
                'completato': 'Completato'
            };
            return texts[status] || 'Da Fare';
        }
        
        function getCategoryText(category) {
            const texts = {
                'antifurto': 'Antifurto',
                'videosorveglianza': 'Videosorveglianza',
                'networking': 'Networking',
                'automazione': 'Automazione',
                'generale': 'Generale'
            };
            return texts[category] || category.charAt(0).toUpperCase() + category.slice(1);
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        function closeEventModal() {
            document.getElementById('eventModal').classList.add('hidden');
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
    </script>
</body>
</html>
