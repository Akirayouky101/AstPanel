<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Orari - AST Panel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./supabase-client.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        <i data-lucide="user-check" class="w-8 h-8 text-blue-600"></i>
                        Gestione Orari Dipendenti
                    </h1>
                    <p class="text-gray-600 mt-2">Riepilogo presenze e approvazioni</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Esporta CSV
                    </button>
                    <button onclick="window.location.href='./superuser.html'" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Approvazioni Pending -->
        <div id="pendingSection" class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-2xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-orange-800 mb-4 flex items-center gap-2">
                <i data-lucide="alert-circle" class="w-7 h-7"></i>
                Richieste in Attesa di Approvazione
                <span id="pendingBadge" class="ml-2 bg-orange-600 text-white text-sm font-bold px-3 py-1 rounded-full">0</span>
            </h2>
            <div id="pendingList" class="space-y-3">
                <!-- Popolato dinamicamente -->
            </div>
        </div>

        <!-- Filtri -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="filter" class="w-6 h-6 text-purple-600"></i>
                Filtri
            </h3>
            <div class="grid md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dipendente</label>
                    <select id="filterEmployee" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">Tutti i dipendenti</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                    <select id="filterType" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">Tutti i tipi</option>
                        <option value="normale">Normale</option>
                        <option value="straordinario">Straordinario</option>
                        <option value="permesso">Permesso</option>
                        <option value="ferie">Ferie</option>
                        <option value="malattia">Malattia</option>
                        <option value="trasferta">Trasferta</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Da Data</label>
                    <input type="date" id="filterStartDate" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">A Data</label>
                    <input type="date" id="filterEndDate" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Riepilogo Mensile per Dipendente -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                Riepilogo Mensile Dipendenti
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dipendente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ore Ordinarie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ore Straordinarie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permessi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ferie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale Ore</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody" class="bg-white divide-y divide-gray-200">
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dettaglio Timbrature -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="list" class="w-6 h-6 text-green-600"></i>
                Dettaglio Timbrature
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dipendente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingresso</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uscita</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ore</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Posizione</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                        </tr>
                    </thead>
                    <tbody id="detailBody" class="bg-white divide-y divide-gray-200">
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Dettaglio Dipendente -->
    <div id="employeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white">
                <h3 class="text-2xl font-bold" id="modalEmployeeName">Dettaglio Dipendente</h3>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="modalContent"></div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeEmployeeModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allEmployees = [];
        let allTimbrature = [];

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadEmployees();
            await loadPendingApprovals();
            await loadData();
            lucide.createIcons();

            // Imposta date filtro al mese corrente
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            document.getElementById('filterStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filterEndDate').value = lastDay.toISOString().split('T')[0];
        });

        // Verifica autenticazione admin
        async function checkAuth() {
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = './index.html';
                return;
            }

            const { data: user } = await window.supabaseClient
                .from('users')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (!user || (user.ruolo !== 'Titolare' && user.ruolo !== 'Amministratore')) {
                alert('Accesso non autorizzato');
                window.location.href = './index.html';
                return;
            }

            currentUser = user;
        }

        // Carica lista dipendenti
        async function loadEmployees() {
            const { data, error } = await window.supabaseClient
                .from('users')
                .select('*')
                .order('cognome');

            if (error) {
                console.error('Errore caricamento dipendenti:', error);
                return;
            }

            allEmployees = data;

            // Popola filtro dipendenti
            const select = document.getElementById('filterEmployee');
            data.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.nome} ${emp.cognome} (${emp.ruolo})`;
                select.appendChild(option);
            });
        }

        // Carica richieste in attesa
        async function loadPendingApprovals() {
            const { data, error } = await window.supabaseClient
                .from('timbrature')
                .select('*, users(nome, cognome)')
                .eq('stato', 'pending')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Errore caricamento pending:', error);
                return;
            }

            const section = document.getElementById('pendingSection');
            const badge = document.getElementById('pendingBadge');
            const list = document.getElementById('pendingList');

            if (data.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            badge.textContent = data.length;
            list.innerHTML = '';

            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl p-4 shadow border-l-4 border-orange-500';
                
                const tipoEmoji = {
                    'normale': 'üíº',
                    'straordinario': 'üïê',
                    'permesso': 'üö™',
                    'ferie': 'üèñÔ∏è',
                    'malattia': 'ü§í',
                    'trasferta': 'üöó'
                };

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-bold text-lg text-gray-800">${t.users.nome} ${t.users.cognome}</div>
                            <div class="text-sm text-gray-600 mt-1">
                                ${tipoEmoji[t.tipo] || 'üíº'} ${t.tipo.charAt(0).toUpperCase() + t.tipo.slice(1)} - ${new Date(t.data).toLocaleDateString('it-IT')}
                            </div>
                            ${t.ora_ingresso ? `<div class="text-sm text-gray-600">Ingresso: ${t.ora_ingresso}</div>` : ''}
                            ${t.ora_uscita ? `<div class="text-sm text-gray-600">Uscita: ${t.ora_uscita}</div>` : ''}
                            ${t.note ? `<div class="text-sm text-gray-700 mt-2 italic">"${t.note}"</div>` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="approveTimbratura('${t.id}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-1">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Approva
                            </button>
                            <button onclick="rejectTimbratura('${t.id}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-1">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                Rifiuta
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });

            lucide.createIcons();
        }

        // Approva timbratura
        async function approveTimbratura(id) {
            const reason = null; // Potenzialmente chiedere una nota

            const { error } = await window.supabaseClient
                .from('timbrature')
                .update({
                    stato: 'approved',
                    approved_by: currentUser.id,
                    approved_at: new Date().toISOString()
                })
                .eq('id', id);

            if (error) {
                console.error('Errore approvazione:', error);
                showNotification('‚ùå Errore durante l\'approvazione', 'error');
                return;
            }

            showNotification('‚úÖ Richiesta approvata!', 'success');
            await loadPendingApprovals();
            await loadData();
        }

        // Rifiuta timbratura
        async function rejectTimbratura(id) {
            const reason = prompt('Motivo del rifiuto (opzionale):');

            const { error } = await window.supabaseClient
                .from('timbrature')
                .update({
                    stato: 'rejected',
                    approved_by: currentUser.id,
                    approved_at: new Date().toISOString(),
                    rejection_reason: reason
                })
                .eq('id', id);

            if (error) {
                console.error('Errore rifiuto:', error);
                showNotification('‚ùå Errore durante il rifiuto', 'error');
                return;
            }

            showNotification('‚úÖ Richiesta rifiutata', 'success');
            await loadPendingApprovals();
            await loadData();
        }

        // Carica dati con filtri
        async function loadData() {
            const employeeFilter = document.getElementById('filterEmployee').value;
            const typeFilter = document.getElementById('filterType').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            let query = window.supabaseClient
                .from('timbrature')
                .select('*, users(nome, cognome, ruolo)')
                .order('data', { ascending: false });

            if (employeeFilter) query = query.eq('user_id', employeeFilter);
            if (typeFilter) query = query.eq('tipo', typeFilter);
            if (startDate) query = query.gte('data', startDate);
            if (endDate) query = query.lte('data', endDate);

            const { data, error } = await query;

            if (error) {
                console.error('Errore caricamento dati:', error);
                return;
            }

            allTimbrature = data;
            renderSummary();
            renderDetail();
        }

        // Rendering riepilogo
        function renderSummary() {
            const employeeStats = {};

            allTimbrature.forEach(t => {
                if (t.stato !== 'approved') return;

                const empId = t.user_id;
                if (!employeeStats[empId]) {
                    employeeStats[empId] = {
                        nome: t.users.nome,
                        cognome: t.users.cognome,
                        ruolo: t.users.ruolo,
                        oreOrdinarie: 0,
                        oreStraordinarie: 0,
                        permessi: 0,
                        ferie: 0,
                        totale: 0
                    };
                }

                const hours = t.ore_lavorate || 0;
                if (t.tipo === 'normale') {
                    employeeStats[empId].oreOrdinarie += hours;
                } else if (t.tipo === 'straordinario') {
                    employeeStats[empId].oreStraordinarie += hours;
                } else if (t.tipo === 'permesso') {
                    employeeStats[empId].permessi += 1;
                } else if (t.tipo === 'ferie') {
                    employeeStats[empId].ferie += 1;
                }
                employeeStats[empId].totale += hours;
            });

            const tbody = document.getElementById('summaryBody');
            tbody.innerHTML = '';

            Object.entries(employeeStats).forEach(([empId, stats]) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => showEmployeeModal(empId);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${stats.nome} ${stats.cognome}</div>
                        <div class="text-xs text-gray-500">${stats.ruolo}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Math.round(stats.oreOrdinarie)}h</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600 font-semibold">${Math.round(stats.oreStraordinarie)}h</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.permessi} giorni</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.ferie} giorni</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">${Math.round(stats.totale)}h</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="event.stopPropagation(); showEmployeeModal('${empId}')" class="text-blue-600 hover:text-blue-800 font-medium">
                            Dettaglio ‚Üí
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (Object.keys(employeeStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nessun dato disponibile con i filtri selezionati</td></tr>';
            }
        }

        // Rendering dettaglio
        function renderDetail() {
            const tbody = document.getElementById('detailBody');
            tbody.innerHTML = '';

            if (allTimbrature.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nessuna timbratura trovata</td></tr>';
                return;
            }

            allTimbrature.forEach(t => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const tipoEmoji = {
                    'normale': 'üíº',
                    'straordinario': 'üïê',
                    'permesso': 'üö™',
                    'ferie': 'üèñÔ∏è',
                    'malattia': 'ü§í',
                    'trasferta': 'üöó'
                };

                const statoColors = {
                    'approved': 'bg-green-100 text-green-800',
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'rejected': 'bg-red-100 text-red-800'
                };

                const statoText = {
                    'approved': 'Approvato',
                    'pending': 'In Attesa',
                    'rejected': 'Rifiutato'
                };

                const hours = t.ore_lavorate ? Math.floor(t.ore_lavorate) : 0;
                const minutes = t.ore_lavorate ? Math.round((t.ore_lavorate - hours) * 60) : 0;

                const gpsIcon = t.posizione_gps ? 
                    `<a href="https://www.google.com/maps?q=${t.posizione_gps.lat},${t.posizione_gps.lng}" target="_blank" class="text-blue-600 hover:text-blue-800">üìç Mappa</a>` : 
                    '<span class="text-gray-400">-</span>';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${t.users.nome} ${t.users.cognome}</div>
                        <div class="text-xs text-gray-500">${t.users.ruolo}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(t.data).toLocaleDateString('it-IT')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${tipoEmoji[t.tipo] || 'üíº'} ${t.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.ora_ingresso || '--:--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.ora_uscita || '--:--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${hours}h ${minutes}m</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${gpsIcon}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statoColors[t.stato]}">${statoText[t.stato]}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">${t.note || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Mostra modal dettaglio dipendente
        function showEmployeeModal(empId) {
            const employee = allEmployees.find(e => e.id === empId);
            if (!employee) return;

            document.getElementById('modalEmployeeName').textContent = `${employee.nome} ${employee.cognome}`;

            const empTimbrature = allTimbrature.filter(t => t.user_id === empId && t.stato === 'approved');

            let html = '<div class="space-y-4">';
            empTimbrature.forEach(t => {
                const hours = t.ore_lavorate ? Math.floor(t.ore_lavorate) : 0;
                const minutes = t.ore_lavorate ? Math.round((t.ore_lavorate - hours) * 60) : 0;

                html += `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold">${new Date(t.data).toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}</div>
                                <div class="text-sm text-gray-600 mt-1">${t.tipo.charAt(0).toUpperCase() + t.tipo.slice(1)}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-lg text-blue-600">${hours}h ${minutes}m</div>
                            </div>
                        </div>
                        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                            <div><span class="text-gray-500">Ingresso:</span> <span class="font-semibold">${t.ora_ingresso || '--:--'}</span></div>
                            <div><span class="text-gray-500">Uscita:</span> <span class="font-semibold">${t.ora_uscita || '--:--'}</span></div>
                        </div>
                        ${t.note ? `<div class="mt-2 text-sm text-gray-700 italic">"${t.note}"</div>` : ''}
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('employeeModal').classList.remove('hidden');
        }

        // Chiudi modal
        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
        }

        // Esporta CSV
        function exportToCSV() {
            let csv = 'Dipendente,Ruolo,Data,Tipo,Ingresso,Uscita,Ore Lavorate,Stato,Note\n';

            allTimbrature.forEach(t => {
                const hours = t.ore_lavorate ? t.ore_lavorate.toFixed(2) : '0.00';
                csv += `"${t.users.nome} ${t.users.cognome}","${t.users.ruolo}","${t.data}","${t.tipo}","${t.ora_ingresso || ''}","${t.ora_uscita || ''}","${hours}","${t.stato}","${t.note || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orari_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('‚úÖ Export CSV completato!', 'success');
        }

        // Mostra notifica
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>
