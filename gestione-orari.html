<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Orari - AST Panel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet CSS/JS per GPS Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- html2pdf per generazione PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="./supabase-client.js"></script>
    <script src="/Admin/auth-helper.js"></script>
    <script src="./gps-map-modal.js"></script>
    <script src="./pdf-email-service.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        <i data-lucide="user-check" class="w-8 h-8 text-blue-600"></i>
                        Gestione Orari Dipendenti
                    </h1>
                    <p class="text-gray-600 mt-2">Riepilogo presenze e approvazioni</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openEmailModal()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="mail" class="w-5 h-5"></i>
                        Email Commercialista
                    </button>
                    <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Esporta CSV
                    </button>
                    <button onclick="window.location.href='./superuser.html'" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Stato Live Dipendenti -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-800 flex items-center gap-2">
                    <i data-lucide="activity" class="w-7 h-7"></i>
                    Stato Live Dipendenti
                    <span class="ml-2 text-sm font-normal text-blue-600">(aggiornato in tempo reale)</span>
                </h2>
                <button onclick="loadLiveStatus()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Aggiorna
                </button>
            </div>
            <div id="liveStatusGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Popolato dinamicamente -->
            </div>
        </div>

        <!-- Approvazioni Pending -->
        <div id="pendingSection" class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-2xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-orange-800 mb-4 flex items-center gap-2">
                <i data-lucide="alert-circle" class="w-7 h-7"></i>
                Richieste in Attesa di Approvazione
                <span id="pendingBadge" class="ml-2 bg-orange-600 text-white text-sm font-bold px-3 py-1 rounded-full">0</span>
            </h2>
            <div id="pendingList" class="space-y-3">
                <!-- Popolato dinamicamente -->
            </div>
        </div>

        <!-- Filtri -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="filter" class="w-6 h-6 text-purple-600"></i>
                Filtri
            </h3>
            <div class="grid md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dipendente</label>
                    <select id="filterEmployee" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">Tutti i dipendenti</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                    <select id="filterType" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">Tutti i tipi</option>
                        <option value="normale">Normale</option>
                        <option value="straordinario">Straordinario</option>
                        <option value="permesso">Permesso</option>
                        <option value="ferie">Ferie</option>
                        <option value="malattia">Malattia</option>
                        <option value="trasferta">Trasferta</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Da Data</label>
                    <input type="date" id="filterStartDate" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">A Data</label>
                    <input type="date" id="filterEndDate" onchange="loadData()" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Riepilogo Mensile per Dipendente -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                Riepilogo Mensile Dipendenti
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dipendente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ore Ordinarie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ore Straordinarie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permessi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ferie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale Ore</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody" class="bg-white divide-y divide-gray-200">
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dettaglio Timbrature -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="list" class="w-6 h-6 text-green-600"></i>
                    Dettaglio Timbrature
                </h3>
                <button onclick="toggleStoricoModifiche()" 
                        class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all flex items-center gap-2">
                    <i data-lucide="history" class="w-5 h-5"></i>
                    Storico Modifiche
                </button>
            </div>
            
            <!-- Pannello Storico Modifiche (collassabile) -->
            <div id="storicoModifichePanel" class="hidden mb-6 bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 rounded-xl p-6">
                <h4 class="text-lg font-bold text-indigo-800 mb-4 flex items-center gap-2">
                    <i data-lucide="clock" class="w-6 h-6"></i>
                    Ultime Modifiche alle Timbrature
                </h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-indigo-200">
                        <thead class="bg-indigo-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Data Modifica</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Dipendente</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Campo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Vecchio ‚Üí Nuovo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Modificato da</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Motivo</th>
                            </tr>
                        </thead>
                        <tbody id="storicoModificheBody" class="bg-white divide-y divide-indigo-100">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dipendente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingresso</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‚òï Pausa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uscita</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ore</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="detailBody" class="bg-white divide-y divide-gray-200">
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Dettaglio Dipendente -->
    <div id="employeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white">
                <h3 class="text-2xl font-bold" id="modalEmployeeName">Dettaglio Dipendente</h3>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="modalContent"></div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeEmployeeModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal Modifica Timbratura -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                <h3 class="text-2xl font-bold flex items-center gap-3">
                    <i data-lucide="pencil" class="w-7 h-7"></i>
                    Modifica Timbratura
                </h3>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <form id="editForm" class="space-y-6">
                    <input type="hidden" id="editTimbratureId">
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Data</label>
                            <input type="date" id="editData" required
                                   class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Tipo Timbratura</label>
                            <select id="editTipo" required
                                    class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500">
                                <option value="normale">üíº Normale</option>
                                <option value="straordinario">üïê Straordinario</option>
                                <option value="permesso">üö™ Permesso</option>
                                <option value="ferie">üèñÔ∏è Ferie</option>
                                <option value="malattia">ü§í Malattia</option>
                                <option value="trasferta">üöó Trasferta</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Ora Ingresso</label>
                            <input type="time" id="editIngresso" required
                                   class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Ora Uscita</label>
                            <input type="time" id="editUscita"
                                   class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>

                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                        <h4 class="font-bold text-green-800 mb-3 flex items-center gap-2">
                            <i data-lucide="coffee" class="w-5 h-5"></i>
                            Pausa Pranzo (Opzionale)
                        </h4>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-2">Inizio Pausa</label>
                                <input type="time" id="editPausaInizio"
                                       class="w-full border-2 border-green-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-2">Fine Pausa</label>
                                <input type="time" id="editPausaFine"
                                       class="w-full border-2 border-green-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Note</label>
                        <textarea id="editNote" rows="3"
                                  class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500"
                                  placeholder="Note aggiuntive (opzionale)..."></textarea>
                    </div>

                    <div class="bg-orange-50 border-2 border-orange-200 rounded-xl p-4">
                        <label class="block text-sm font-bold text-orange-800 mb-2">
                            ‚ö†Ô∏è Motivo Modifica (obbligatorio)
                        </label>
                        <input type="text" id="editMotivo" required
                               class="w-full border-2 border-orange-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-orange-500"
                               placeholder="Es: Correzione orario, Dimenticato timbrato uscita, ecc.">
                    </div>
                </form>
            </div>
            <div class="p-6 border-t flex justify-between gap-3">
                <button onclick="closeEditModal()" type="button"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                    Annulla
                </button>
                <button onclick="saveEdit()" type="button"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl">
                    üíæ Salva Modifiche
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Email Commercialista -->
    <div id="emailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                <h3 class="text-2xl font-bold flex items-center gap-3">
                    <i data-lucide="mail" class="w-7 h-7"></i>
                    Sistema Email Commercialista
                </h3>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                
                <!-- Sezione Invio Report -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6">
                    <h4 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                        <i data-lucide="send" class="w-6 h-6"></i>
                        Invia Report Mensile
                    </h4>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Mese</label>
                            <select id="emailMese" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                                <option value="1">Gennaio</option>
                                <option value="2">Febbraio</option>
                                <option value="3">Marzo</option>
                                <option value="4">Aprile</option>
                                <option value="5">Maggio</option>
                                <option value="6">Giugno</option>
                                <option value="7">Luglio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Settembre</option>
                                <option value="10">Ottobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">Dicembre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Anno</label>
                            <input type="number" id="emailAnno" value="2024" min="2020" max="2030"
                                   class="w-full border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                            <button onclick="sendMonthlyReport()" 
                                    class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                <i data-lucide="rocket" class="w-5 h-5"></i>
                                Genera & Invia
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-blue-700 bg-blue-100 rounded-lg p-3">
                        <strong>‚ÑπÔ∏è Info:</strong> Il PDF verr√† generato e inviato a tutti i destinatari attivi configurati.
                        Include ore lavorate e costo orario per ciascun dipendente.
                    </div>
                </div>

                <!-- Sezione Gestione Destinatari -->
                <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-xl font-bold text-orange-800 flex items-center gap-2">
                            <i data-lucide="users" class="w-6 h-6"></i>
                            Destinatari Email (Max 5)
                        </h4>
                        <button onclick="openAddRecipientForm()" 
                                class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i data-lucide="user-plus" class="w-4 h-4"></i>
                            Aggiungi
                        </button>
                    </div>
                    <div id="recipientsList" class="space-y-3">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

                <!-- Sezione Storico Invii -->
                <div class="bg-gradient-to-r from-green-50 to-teal-50 border-2 border-green-200 rounded-xl p-6">
                    <h4 class="text-xl font-bold text-green-800 mb-4 flex items-center gap-2">
                        <i data-lucide="history" class="w-6 h-6"></i>
                        Storico Invii Email
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-green-200">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase">Data Invio</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase">Periodo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase">Destinatario</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase">Dipendenti</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase">Ore Totali</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase">Costo Totale</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase">Stato</th>
                                </tr>
                            </thead>
                            <tbody id="emailLogBody" class="bg-white divide-y divide-green-100">
                                <!-- Popolato dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeEmailModal()" type="button"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                    Chiudi
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allEmployees = [];
        let allTimbrature = [];

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ [GESTIONE-ORARI] Pagina admin caricata...');
            console.log('üîç [CHECK] Verifica Supabase Client...');
            
            if (!window.supabaseClient) {
                console.error('‚ùå [FATAL] window.supabaseClient non disponibile!');
                alert('Errore: Database non inizializzato');
                return;
            }
            
            console.log('‚úÖ [CHECK] Supabase Client OK');
            console.log('üîê [AUTH] Verifica autenticazione admin...');
            
            await checkAuth();
            
            console.log('üë• [DATA] Caricamento lista dipendenti...');
            await loadEmployees();
            
            console.log('üì° [DATA] Caricamento stato live dipendenti...');
            await loadLiveStatus();
            
            console.log('‚è≥ [DATA] Caricamento approvazioni pending...');
            await loadPendingApprovals();
            
            console.log('üìä [DATA] Caricamento dati orari...');
            await loadData();
            
            lucide.createIcons();
            console.log('‚úÖ [INIT] Inizializzazione admin completata!');

            // Imposta date filtro al mese corrente
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            document.getElementById('filterStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filterEndDate').value = lastDay.toISOString().split('T')[0];
        });

        // Verifica autenticazione admin
        async function checkAuth() {
            console.log('üîç [AUTH] Controllo autenticazione...');
            
            // Usa AuthHelper (sessionStorage) invece di Supabase Auth
            const user = window.AuthHelper?.getCurrentUser();
            
            if (!user) {
                console.warn('‚ö†Ô∏è [AUTH] Nessun utente in sessionStorage, redirect login...');
                alert('‚õî Sessione scaduta. Effettua nuovamente il login.');
                window.location.href = '/Admin/index.html';
                return;
            }
            
            console.log('‚úÖ [AUTH] Utente trovato:', user.nome, user.cognome, '- Ruolo:', user.ruolo);
            
            // Verifica ruolo admin
            const adminRoles = ['Titolare', 'Amministratore', 'Tecnico', 'Segreteria'];
            if (!adminRoles.includes(user.ruolo)) {
                console.error('‚ùå [AUTH] Accesso negato. Ruolo:', user.ruolo);
                alert('‚õî Accesso non autorizzato. Solo amministratori.');
                window.location.href = '/pannello-utente.html';
                return;
            }
            
            console.log('‚úÖ [AUTH] Admin verificato:', user.nome, user.cognome);
            currentUser = user;
        }
        
        // Helper redirect admin
        function incrementAdminRedirectAndGo() {
            const count = parseInt(sessionStorage.getItem('adminOrariRedirectCount') || '0');
            const newCount = count + 1;
            console.log('üîÑ [ADMIN-REDIRECT] Incremento:', count, '‚Üí', newCount);
            sessionStorage.setItem('adminOrariRedirectCount', newCount.toString());
            
            console.log('‚Ü©Ô∏è [REDIRECT] Redirect a /Admin/index.html...');
            window.location.href = '/Admin/index.html';
        }

        // Carica lista dipendenti
        async function loadEmployees() {
            const { data, error } = await window.supabaseClient
                .from('users')
                .select('*')
                .order('cognome');

            if (error) {
                console.error('Errore caricamento dipendenti:', error);
                return;
            }

            allEmployees = data;

            // Popola filtro dipendenti
            const select = document.getElementById('filterEmployee');
            data.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.nome} ${emp.cognome} (${emp.ruolo})`;
                select.appendChild(option);
            });
        }

        // Carica stato live dipendenti
        async function loadLiveStatus() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Carica TUTTI i dipendenti (non admin)
                const { data: allEmployees, error: empError } = await window.supabaseClient
                    .from('users')
                    .select('id, nome, cognome, ruolo')
                    .not('ruolo', 'in', '("Titolare","Amministratore")')
                    .order('cognome');

                if (empError) {
                    console.error('Errore caricamento dipendenti:', empError);
                    return;
                }

                // Carica timbrature di oggi
                const { data: todayTimbrature, error: timbError } = await window.supabaseClient
                    .from('timbrature')
                    .select('*')
                    .eq('data', today);

                if (timbError) {
                    console.error('Errore caricamento timbrature:', timbError);
                    return;
                }

                const container = document.getElementById('liveStatusGrid');
                container.innerHTML = '';

                if (!allEmployees || allEmployees.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nessun dipendente trovato</div>';
                    return;
                }

                // Crea mappa timbrature per user_id
                const timbratureMap = {};
                (todayTimbrature || []).forEach(t => {
                    if (!timbratureMap[t.user_id]) {
                        timbratureMap[t.user_id] = t;
                    }
                });

                // Crea card per ogni dipendente
                allEmployees.forEach(employee => {
                    const t = timbratureMap[employee.id]; // Pu√≤ essere undefined se non ha timbrato
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl p-4 shadow-md border-l-4 hover:shadow-lg transition-all';
                    
                    // Determina stato
                    let statoHtml = '';
                    let borderColor = 'border-gray-300';
                    let statoIcon = '';
                    let statoText = '';
                    let statoColor = '';
                    let oraIngresso = '--:--';
                    let oraUscita = '--:--';
                    
                    if (!t || !t.ora_ingresso) {
                        // Non ha ancora timbrato ingresso
                        borderColor = 'border-gray-400';
                        statoIcon = 'üè†';
                        statoText = 'Fuori sede';
                        statoColor = 'text-gray-600 bg-gray-100';
                        statoHtml = `<div class="text-xs text-gray-500 mt-1">Nessuna timbratura oggi</div>`;
                    } else {
                        oraIngresso = t.ora_ingresso;
                        oraUscita = t.ora_uscita || '--:--';
                        
                        if (t.pausa_inizio && !t.pausa_fine) {
                            // In pausa pranzo
                            borderColor = 'border-orange-400';
                            statoIcon = '‚òï';
                            statoText = 'In pausa pranzo';
                            statoColor = 'text-orange-700 bg-orange-100';
                            const pausaDa = t.pausa_inizio;
                            statoHtml = `<div class="text-xs text-orange-600 mt-1">Iniziata alle ${pausaDa}</div>`;
                        } else if (t.ora_ingresso && !t.ora_uscita) {
                            // Al lavoro
                            borderColor = 'border-green-400';
                            statoIcon = 'üíº';
                            statoText = 'Al lavoro';
                            statoColor = 'text-green-700 bg-green-100';
                            
                            // Calcola ore lavorate
                            const now = new Date();
                            const [h, m] = t.ora_ingresso.split(':');
                            const ingressoDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(h), parseInt(m));
                            const diffMs = now - ingressoDate;
                            const hours = Math.floor(diffMs / (1000 * 60 * 60));
                            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                            statoHtml = `<div class="text-xs text-green-600 mt-1">Da ${hours}h ${minutes}m</div>`;
                        } else if (t.ora_uscita) {
                            // Ha finito
                            borderColor = 'border-blue-400';
                            statoIcon = '‚úÖ';
                            statoText = 'Giornata completata';
                            statoColor = 'text-blue-700 bg-blue-100';
                            const oreH = Math.floor(t.ore_lavorate || 0);
                            const oreM = Math.round(((t.ore_lavorate || 0) - oreH) * 60);
                            statoHtml = `<div class="text-xs text-blue-600 mt-1">Totale: ${oreH}h ${oreM}m</div>`;
                        }
                    }
                    
                    card.className += ` ${borderColor}`;
                    
                    card.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-bold text-gray-900 text-lg">${employee.nome} ${employee.cognome}</div>
                                <div class="text-xs text-gray-500 mb-2">${employee.ruolo}</div>
                                
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="text-2xl">${statoIcon}</span>
                                    <div>
                                        <div class="px-3 py-1 rounded-full text-sm font-bold ${statoColor}">
                                            ${statoText}
                                        </div>
                                        ${statoHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200 grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-500">Ingresso:</span>
                                <span class="font-semibold ml-1">${oraIngresso}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Uscita:</span>
                                <span class="font-semibold ml-1">${oraUscita}</span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });

                lucide.createIcons();

            } catch (err) {
                console.error('Errore loadLiveStatus:', err);
            }
        }

        // Carica richieste in attesa
        async function loadPendingApprovals() {
            const { data, error } = await window.supabaseClient
                .from('timbrature')
                .select('*, user:users!user_id(nome, cognome)')
                .eq('stato', 'pending')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Errore caricamento pending:', error);
                return;
            }

            const section = document.getElementById('pendingSection');
            const badge = document.getElementById('pendingBadge');
            const list = document.getElementById('pendingList');

            if (data.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            badge.textContent = data.length;
            list.innerHTML = '';

            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl p-4 shadow border-l-4 border-orange-500';
                
                const tipoEmoji = {
                    'normale': 'üíº',
                    'straordinario': 'üïê',
                    'permesso': 'üö™',
                    'ferie': 'üèñÔ∏è',
                    'malattia': 'ü§í',
                    'trasferta': 'üöó'
                };

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-bold text-lg text-gray-800">${t.user.nome} ${t.user.cognome}</div>
                            <div class="text-sm text-gray-600 mt-1">
                                ${tipoEmoji[t.tipo] || 'üíº'} ${t.tipo.charAt(0).toUpperCase() + t.tipo.slice(1)} - ${new Date(t.data).toLocaleDateString('it-IT')}
                            </div>
                            ${t.ora_ingresso ? `<div class="text-sm text-gray-600">Ingresso: ${t.ora_ingresso}</div>` : ''}
                            ${t.ora_uscita ? `<div class="text-sm text-gray-600">Uscita: ${t.ora_uscita}</div>` : ''}
                            ${t.note ? `<div class="text-sm text-gray-700 mt-2 italic">"${t.note}"</div>` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="approveTimbratura('${t.id}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-1">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Approva
                            </button>
                            <button onclick="rejectTimbratura('${t.id}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-1">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                Rifiuta
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });

            lucide.createIcons();
        }

        // Approva timbratura
        async function approveTimbratura(id) {
            const reason = null; // Potenzialmente chiedere una nota

            const { error } = await window.supabaseClient
                .from('timbrature')
                .update({
                    stato: 'approved',
                    approved_by: currentUser.id,
                    approved_at: new Date().toISOString()
                })
                .eq('id', id);

            if (error) {
                console.error('Errore approvazione:', error);
                showNotification('‚ùå Errore durante l\'approvazione', 'error');
                return;
            }

            showNotification('‚úÖ Richiesta approvata!', 'success');
            await loadPendingApprovals();
            await loadData();
        }

        // Rifiuta timbratura
        async function rejectTimbratura(id) {
            const reason = prompt('Motivo del rifiuto (opzionale):');

            const { error } = await window.supabaseClient
                .from('timbrature')
                .update({
                    stato: 'rejected',
                    approved_by: currentUser.id,
                    approved_at: new Date().toISOString(),
                    rejection_reason: reason
                })
                .eq('id', id);

            if (error) {
                console.error('Errore rifiuto:', error);
                showNotification('‚ùå Errore durante il rifiuto', 'error');
                return;
            }

            showNotification('‚úÖ Richiesta rifiutata', 'success');
            await loadPendingApprovals();
            await loadData();
        }

        // Carica dati con filtri
        async function loadData() {
            const employeeFilter = document.getElementById('filterEmployee').value;
            const typeFilter = document.getElementById('filterType').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            let query = window.supabaseClient
                .from('timbrature')
                .select('*, user:users!user_id(nome, cognome, ruolo)')
                .order('data', { ascending: false });

            if (employeeFilter) query = query.eq('user_id', employeeFilter);
            if (typeFilter) query = query.eq('tipo', typeFilter);
            if (startDate) query = query.gte('data', startDate);
            if (endDate) query = query.lte('data', endDate);

            const { data, error } = await query;

            if (error) {
                console.error('Errore caricamento dati:', error);
                return;
            }

            allTimbrature = data;
            renderSummary();
            renderDetail();
        }

        // Rendering riepilogo
        function renderSummary() {
            const employeeStats = {};

            allTimbrature.forEach(t => {
                if (t.stato !== 'approved') return;

                const empId = t.user_id;
                if (!employeeStats[empId]) {
                    employeeStats[empId] = {
                        nome: t.user.nome,
                        cognome: t.user.cognome,
                        ruolo: t.user.ruolo,
                        oreOrdinarie: 0,
                        oreStraordinarie: 0,
                        permessi: 0,
                        ferie: 0,
                        totale: 0
                    };
                }

                const hours = t.ore_lavorate || 0;
                if (t.tipo === 'normale') {
                    employeeStats[empId].oreOrdinarie += hours;
                } else if (t.tipo === 'straordinario') {
                    employeeStats[empId].oreStraordinarie += hours;
                } else if (t.tipo === 'permesso') {
                    employeeStats[empId].permessi += 1;
                } else if (t.tipo === 'ferie') {
                    employeeStats[empId].ferie += 1;
                }
                employeeStats[empId].totale += hours;
            });

            const tbody = document.getElementById('summaryBody');
            tbody.innerHTML = '';

            Object.entries(employeeStats).forEach(([empId, stats]) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => showEmployeeModal(empId);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${stats.nome} ${stats.cognome}</div>
                        <div class="text-xs text-gray-500">${stats.ruolo}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Math.round(stats.oreOrdinarie)}h</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600 font-semibold">${Math.round(stats.oreStraordinarie)}h</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.permessi} giorni</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.ferie} giorni</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">${Math.round(stats.totale)}h</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="event.stopPropagation(); showEmployeeModal('${empId}')" class="text-blue-600 hover:text-blue-800 font-medium">
                            Dettaglio ‚Üí
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (Object.keys(employeeStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nessun dato disponibile con i filtri selezionati</td></tr>';
            }
        }

        // Rendering dettaglio
        function renderDetail() {
            const tbody = document.getElementById('detailBody');
            tbody.innerHTML = '';

            if (allTimbrature.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nessuna timbratura trovata</td></tr>';
                return;
            }

            allTimbrature.forEach(t => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';

                const tipoEmoji = {
                    'normale': 'üíº',
                    'straordinario': 'üïê',
                    'permesso': 'üö™',
                    'ferie': 'üèñÔ∏è',
                    'malattia': 'ü§í',
                    'trasferta': 'üöó'
                };

                const statoColors = {
                    'approved': 'bg-green-100 text-green-800',
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'rejected': 'bg-red-100 text-red-800'
                };

                const statoText = {
                    'approved': 'Approvato',
                    'pending': 'In Attesa',
                    'rejected': 'Rifiutato'
                };

                const hours = t.ore_lavorate ? Math.floor(t.ore_lavorate) : 0;
                const minutes = t.ore_lavorate ? Math.round((t.ore_lavorate - hours) * 60) : 0;

                // Calcolo pausa pranzo
                let pausaHtml = '<span class="text-gray-400 text-xs">--</span>';
                if (t.pausa_inizio && t.pausa_fine) {
                    const pausaMinutes = Math.round((new Date(`1970-01-01T${t.pausa_fine}`) - new Date(`1970-01-01T${t.pausa_inizio}`)) / 60000);
                    pausaHtml = `
                        <div class="flex flex-col gap-1">
                            <span class="text-xs text-gray-600">${t.pausa_inizio} - ${t.pausa_fine}</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ‚òï ${pausaMinutes} min
                            </span>
                        </div>
                    `;
                }

                // GPS + Edit buttons
                const hasGPS = t.posizione_gps && t.posizione_gps.latitude && t.posizione_gps.longitude;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${t.user.nome} ${t.user.cognome}</div>
                        <div class="text-xs text-gray-500">${t.user.ruolo}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(t.data).toLocaleDateString('it-IT')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${tipoEmoji[t.tipo] || 'üíº'} ${t.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${t.ora_ingresso || '--:--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${pausaHtml}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${t.ora_uscita || '--:--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${hours}h ${minutes}m</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statoColors[t.stato]}">${statoText[t.stato]}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex gap-2">
                            ${hasGPS ? `
                                <button onclick='showMapForTimbratura(${JSON.stringify(t)})' 
                                        class="inline-flex items-center px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow-md">
                                    <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i>
                                    Mappa
                                </button>
                            ` : ''}
                            <button onclick='openEditModal(${JSON.stringify(t)})' 
                                    class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white text-xs font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow-md">
                                <i data-lucide="pencil" class="w-3 h-3 mr-1"></i>
                                Modifica
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            lucide.createIcons();
        }

        // Mostra mappa GPS per timbratura
        function showMapForTimbratura(timbratura) {
            if (!window.gpsMapModal) {
                alert('‚ùå Sistema mappe non disponibile');
                return;
            }
            
            if (!timbratura.posizione_gps || !timbratura.posizione_gps.latitude) {
                alert('‚ùå GPS non disponibile per questa timbratura');
                return;
            }
            
            window.gpsMapModal.showHistoryModal(timbratura);
        }

        // Toggle pannello storico modifiche
        async function toggleStoricoModifiche() {
            const panel = document.getElementById('storicoModifichePanel');
            const isHidden = panel.classList.contains('hidden');
            
            if (isHidden) {
                panel.classList.remove('hidden');
                await loadStoricoModifiche();
            } else {
                panel.classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        // Carica storico modifiche
        async function loadStoricoModifiche() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('timbrature_modifiche')
                    .select(`
                        *,
                        timbratura:timbrature!timbratura_id(
                            data,
                            user:users!user_id(nome, cognome)
                        ),
                        modificato_da_user:users!modificato_da(nome, cognome)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) {
                    console.warn('‚ö†Ô∏è Tabella timbrature_modifiche non trovata:', error);
                    document.getElementById('storicoModificheBody').innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-6 text-center text-gray-500">
                                <div class="text-lg mb-2">üìã Tabella modifiche non ancora creata</div>
                                <div class="text-sm">Esegui la migration: <code class="bg-gray-100 px-2 py-1 rounded">migrations/create-timbrature-modifiche.sql</code></div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const tbody = document.getElementById('storicoModificheBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-6 text-center text-gray-500">
                                ‚úÖ Nessuna modifica registrata
                            </td>
                        </tr>
                    `;
                    return;
                }

                data.forEach(modifica => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-indigo-50 transition-colors';

                    const campoTraduzioni = {
                        'data': 'üìÖ Data',
                        'tipo': 'üè∑Ô∏è Tipo',
                        'ora_ingresso': 'üïê Ingresso',
                        'ora_uscita': 'üïë Uscita',
                        'pausa_inizio': '‚òï Inizio Pausa',
                        'pausa_fine': '‚òï Fine Pausa',
                        'note': 'üìù Note'
                    };

                    const campoNome = campoTraduzioni[modifica.campo_modificato] || modifica.campo_modificato;

                    // Formatta valori per leggibilit√†
                    const formatValue = (val) => {
                        if (val === null || val === '') return '<span class="text-gray-400">vuoto</span>';
                        return `<strong>${val}</strong>`;
                    };

                    // Evidenzia modifiche recenti (ultime 24h)
                    const isRecent = (new Date() - new Date(modifica.created_at)) < 24 * 60 * 60 * 1000;
                    const recentBadge = isRecent ? '<span class="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full font-bold">NEW</span>' : '';

                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            ${new Date(modifica.created_at).toLocaleString('it-IT', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: 'numeric',
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}
                            ${recentBadge}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <div class="font-medium text-gray-900">${modifica.timbratura.user.nome} ${modifica.timbratura.user.cognome}</div>
                            <div class="text-xs text-gray-500">${new Date(modifica.timbratura.data).toLocaleDateString('it-IT')}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-700">${campoNome}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex items-center gap-2">
                                ${formatValue(modifica.valore_vecchio)}
                                <span class="text-indigo-600 font-bold">‚Üí</span>
                                ${formatValue(modifica.valore_nuovo)}
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            ${modifica.modificato_da_user.nome} ${modifica.modificato_da_user.cognome}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700 max-w-xs">
                            <span class="italic">"${modifica.motivo}"</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                lucide.createIcons();

            } catch (err) {
                console.error('‚ùå Errore caricamento storico modifiche:', err);
                document.getElementById('storicoModificheBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-6 text-center text-red-500">
                            ‚ùå Errore caricamento storico modifiche
                        </td>
                    </tr>
                `;
            }
        }

        // Mostra modal dettaglio dipendente
        function showEmployeeModal(empId) {
            const employee = allEmployees.find(e => e.id === empId);
            if (!employee) return;

            document.getElementById('modalEmployeeName').textContent = `${employee.nome} ${employee.cognome}`;

            const empTimbrature = allTimbrature.filter(t => t.user_id === empId && t.stato === 'approved');

            let html = '<div class="space-y-4">';
            empTimbrature.forEach(t => {
                const hours = t.ore_lavorate ? Math.floor(t.ore_lavorate) : 0;
                const minutes = t.ore_lavorate ? Math.round((t.ore_lavorate - hours) * 60) : 0;

                html += `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold">${new Date(t.data).toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}</div>
                                <div class="text-sm text-gray-600 mt-1">${t.tipo.charAt(0).toUpperCase() + t.tipo.slice(1)}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-lg text-blue-600">${hours}h ${minutes}m</div>
                            </div>
                        </div>
                        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                            <div><span class="text-gray-500">Ingresso:</span> <span class="font-semibold">${t.ora_ingresso || '--:--'}</span></div>
                            <div><span class="text-gray-500">Uscita:</span> <span class="font-semibold">${t.ora_uscita || '--:--'}</span></div>
                        </div>
                        ${t.note ? `<div class="mt-2 text-sm text-gray-700 italic">"${t.note}"</div>` : ''}
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('employeeModal').classList.remove('hidden');
        }

        // Chiudi modal
        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
        }

        // Apri modal modifica timbratura
        function openEditModal(timbratura) {
            document.getElementById('editTimbratureId').value = timbratura.id;
            document.getElementById('editData').value = timbratura.data;
            document.getElementById('editTipo').value = timbratura.tipo;
            document.getElementById('editIngresso').value = timbratura.ora_ingresso || '';
            document.getElementById('editUscita').value = timbratura.ora_uscita || '';
            document.getElementById('editPausaInizio').value = timbratura.pausa_inizio || '';
            document.getElementById('editPausaFine').value = timbratura.pausa_fine || '';
            document.getElementById('editNote').value = timbratura.note || '';
            document.getElementById('editMotivo').value = '';
            
            document.getElementById('editModal').classList.remove('hidden');
            lucide.createIcons();
        }

        // Chiudi modal modifica
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // Salva modifiche timbratura
        async function saveEdit() {
            const timbratureId = document.getElementById('editTimbratureId').value;
            const motivo = document.getElementById('editMotivo').value.trim();

            if (!motivo) {
                showNotification('‚ö†Ô∏è Inserisci il motivo della modifica', 'error');
                return;
            }

            // Valori del form
            const newData = document.getElementById('editData').value;
            const newTipo = document.getElementById('editTipo').value;
            const newIngresso = document.getElementById('editIngresso').value;
            const newUscita = document.getElementById('editUscita').value;
            const newPausaInizio = document.getElementById('editPausaInizio').value;
            const newPausaFine = document.getElementById('editPausaFine').value;
            const newNote = document.getElementById('editNote').value;

            // Validazione orari
            if (newIngresso && newUscita && newUscita <= newIngresso) {
                showNotification('‚ùå L\'ora di uscita deve essere successiva all\'ingresso', 'error');
                return;
            }

            if (newPausaInizio && newPausaFine && newPausaFine <= newPausaInizio) {
                showNotification('‚ùå La fine pausa deve essere successiva all\'inizio', 'error');
                return;
            }

            // Calcola ore lavorate
            let oreLavorate = 0;
            if (newIngresso && newUscita) {
                const ingressoMinutes = parseInt(newIngresso.split(':')[0]) * 60 + parseInt(newIngresso.split(':')[1]);
                const uscitaMinutes = parseInt(newUscita.split(':')[0]) * 60 + parseInt(newUscita.split(':')[1]);
                let totalMinutes = uscitaMinutes - ingressoMinutes;

                // Sottrai pausa se presente
                if (newPausaInizio && newPausaFine) {
                    const pausaInizioMinutes = parseInt(newPausaInizio.split(':')[0]) * 60 + parseInt(newPausaInizio.split(':')[1]);
                    const pausaFineMinutes = parseInt(newPausaFine.split(':')[0]) * 60 + parseInt(newPausaFine.split(':')[1]);
                    totalMinutes -= (pausaFineMinutes - pausaInizioMinutes);
                }

                oreLavorate = totalMinutes / 60;
            }

            // Recupera timbratura originale
            const originalTimbratura = allTimbrature.find(t => t.id === timbratureId);
            if (!originalTimbratura) {
                showNotification('‚ùå Timbratura non trovata', 'error');
                return;
            }

            // Prepara record modifiche
            const modifiche = [];
            if (originalTimbratura.data !== newData) {
                modifiche.push({
                    timbratura_id: timbratureId,
                    campo_modificato: 'data',
                    valore_vecchio: originalTimbratura.data,
                    valore_nuovo: newData,
                    motivo: motivo,
                    modificato_da: currentUser.id
                });
            }
            if (originalTimbratura.tipo !== newTipo) {
                modifiche.push({
                    timbratura_id: timbratureId,
                    campo_modificato: 'tipo',
                    valore_vecchio: originalTimbratura.tipo,
                    valore_nuovo: newTipo,
                    motivo: motivo,
                    modificato_da: currentUser.id
                });
            }
            if (originalTimbratura.ora_ingresso !== newIngresso) {
                modifiche.push({
                    timbratura_id: timbratureId,
                    campo_modificato: 'ora_ingresso',
                    valore_vecchio: originalTimbratura.ora_ingresso || null,
                    valore_nuovo: newIngresso,
                    motivo: motivo,
                    modificato_da: currentUser.id
                });
            }
            if (originalTimbratura.ora_uscita !== newUscita) {
                modifiche.push({
                    timbratura_id: timbratureId,
                    campo_modificato: 'ora_uscita',
                    valore_vecchio: originalTimbratura.ora_uscita || null,
                    valore_nuovo: newUscita,
                    motivo: motivo,
                    modificato_da: currentUser.id
                });
            }
            if ((originalTimbratura.pausa_inizio || '') !== newPausaInizio) {
                modifiche.push({
                    timbratura_id: timbratureId,
                    campo_modificato: 'pausa_inizio',
                    valore_vecchio: originalTimbratura.pausa_inizio || null,
                    valore_nuovo: newPausaInizio || null,
                    motivo: motivo,
                    modificato_da: currentUser.id
                });
            }
            if ((originalTimbratura.pausa_fine || '') !== newPausaFine) {
                modifiche.push({
                    timbratura_id: timbratureId,
                    campo_modificato: 'pausa_fine',
                    valore_vecchio: originalTimbratura.pausa_fine || null,
                    valore_nuovo: newPausaFine || null,
                    motivo: motivo,
                    modificato_da: currentUser.id
                });
            }
            if ((originalTimbratura.note || '') !== newNote) {
                modifiche.push({
                    timbratura_id: timbratureId,
                    campo_modificato: 'note',
                    valore_vecchio: originalTimbratura.note || null,
                    valore_nuovo: newNote || null,
                    motivo: motivo,
                    modificato_da: currentUser.id
                });
            }

            try {
                // 1. Salva log modifiche (se tabella esiste)
                if (modifiche.length > 0) {
                    const { error: logError } = await window.supabaseClient
                        .from('timbrature_modifiche')
                        .insert(modifiche);

                    if (logError) {
                        console.warn('‚ö†Ô∏è Tabella timbrature_modifiche non trovata, skip log modifiche:', logError);
                    } else {
                        console.log('‚úÖ Log modifiche salvato:', modifiche.length, 'campi');
                    }
                }

                // 2. Aggiorna timbratura
                const { error: updateError } = await window.supabaseClient
                    .from('timbrature')
                    .update({
                        data: newData,
                        tipo: newTipo,
                        ora_ingresso: newIngresso,
                        ora_uscita: newUscita || null,
                        pausa_inizio: newPausaInizio || null,
                        pausa_fine: newPausaFine || null,
                        ore_lavorate: oreLavorate,
                        note: newNote || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', timbratureId);

                if (updateError) {
                    console.error('‚ùå Errore aggiornamento timbratura:', updateError);
                    showNotification('‚ùå Errore durante il salvataggio', 'error');
                    return;
                }

                showNotification('‚úÖ Timbratura modificata con successo!', 'success');
                closeEditModal();
                await loadData();

            } catch (err) {
                console.error('‚ùå Errore durante il salvataggio:', err);
                showNotification('‚ùå Errore imprevisto durante il salvataggio', 'error');
            }
        }

        // =====================================================
        // Sistema Email Commercialista
        // =====================================================

        // Apri modal email
        async function openEmailModal() {
            // Imposta mese/anno correnti
            const now = new Date();
            document.getElementById('emailMese').value = now.getMonth() + 1;
            document.getElementById('emailAnno').value = now.getFullYear();

            document.getElementById('emailModal').classList.remove('hidden');
            
            await loadRecipients();
            await loadEmailLog();
            
            lucide.createIcons();
        }

        // Chiudi modal email
        function closeEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
        }

        // Carica lista destinatari
        async function loadRecipients() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('email_destinatari')
                    .select('*')
                    .order('attivo', { ascending: false })
                    .order('nome');

                if (error) {
                    console.warn('‚ö†Ô∏è Tabella email_destinatari non trovata:', error);
                    document.getElementById('recipientsList').innerHTML = `
                        <div class="text-center text-orange-600 p-4">
                            <div class="text-lg mb-2">üìã Tabella destinatari non ancora creata</div>
                            <div class="text-sm">Esegui la migration: <code class="bg-orange-100 px-2 py-1 rounded">migrations/create-email-system.sql</code></div>
                        </div>
                    `;
                    return;
                }

                const container = document.getElementById('recipientsList');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 p-4">Nessun destinatario configurato</div>';
                    return;
                }

                data.forEach(recipient => {
                    const card = document.createElement('div');
                    card.className = `bg-white rounded-lg p-4 border-2 ${recipient.attivo ? 'border-green-300' : 'border-gray-300'}`;
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-900">${recipient.nome}</span>
                                    ${recipient.attivo ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-bold">ATTIVO</span>' : '<span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">Disattivato</span>'}
                                </div>
                                <div class="text-sm text-gray-600 mt-1">üìß ${recipient.email}</div>
                                <div class="text-xs text-gray-500 mt-1">üè∑Ô∏è ${recipient.tipo}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick='toggleRecipient("${recipient.id}", ${!recipient.attivo})' 
                                        class="px-3 py-1.5 ${recipient.attivo ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-500 hover:bg-green-600'} text-white text-xs rounded-lg transition-all">
                                    ${recipient.attivo ? 'Disattiva' : 'Attiva'}
                                </button>
                                <button onclick='deleteRecipient("${recipient.id}")' 
                                        class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded-lg transition-all">
                                    Elimina
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

            } catch (err) {
                console.error('‚ùå Errore caricamento destinatari:', err);
            }
        }

        // Aggiungi destinatario
        async function openAddRecipientForm() {
            const activeCount = await getActiveRecipientsCount();
            
            if (activeCount >= 5) {
                showNotification('‚ö†Ô∏è Massimo 5 destinatari attivi consentiti', 'error');
                return;
            }

            const nome = prompt('Nome destinatario (es: Studio Rossi):');
            if (!nome) return;

            const email = prompt('Email:');
            if (!email || !email.includes('@')) {
                showNotification('‚ùå Email non valida', 'error');
                return;
            }

            const tipo = prompt('Tipo (commercialista/consulente/altro):', 'commercialista');

            const { error } = await window.supabaseClient
                .from('email_destinatari')
                .insert({
                    nome: nome,
                    email: email,
                    tipo: tipo || 'commercialista',
                    attivo: true
                });

            if (error) {
                console.error('‚ùå Errore inserimento destinatario:', error);
                showNotification('‚ùå Errore: ' + error.message, 'error');
                return;
            }

            showNotification('‚úÖ Destinatario aggiunto!', 'success');
            await loadRecipients();
        }

        // Toggle attivo/disattivo destinatario
        async function toggleRecipient(id, newStatus) {
            if (newStatus === true) {
                const activeCount = await getActiveRecipientsCount();
                if (activeCount >= 5) {
                    showNotification('‚ö†Ô∏è Massimo 5 destinatari attivi consentiti', 'error');
                    return;
                }
            }

            const { error } = await window.supabaseClient
                .from('email_destinatari')
                .update({ attivo: newStatus })
                .eq('id', id);

            if (error) {
                console.error('‚ùå Errore aggiornamento destinatario:', error);
                showNotification('‚ùå Errore aggiornamento', 'error');
                return;
            }

            showNotification(newStatus ? '‚úÖ Destinatario attivato' : '‚ö†Ô∏è Destinatario disattivato', 'success');
            await loadRecipients();
        }

        // Elimina destinatario
        async function deleteRecipient(id) {
            if (!confirm('Sei sicuro di voler eliminare questo destinatario?')) return;

            const { error } = await window.supabaseClient
                .from('email_destinatari')
                .delete()
                .eq('id', id);

            if (error) {
                console.error('‚ùå Errore eliminazione destinatario:', error);
                showNotification('‚ùå Errore eliminazione', 'error');
                return;
            }

            showNotification('‚úÖ Destinatario eliminato', 'success');
            await loadRecipients();
        }

        // Conta destinatari attivi
        async function getActiveRecipientsCount() {
            const { count } = await window.supabaseClient
                .from('email_destinatari')
                .select('*', { count: 'exact', head: true })
                .eq('attivo', true);

            return count || 0;
        }

        // Carica storico invii email
        async function loadEmailLog() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('email_log')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) {
                    console.warn('‚ö†Ô∏è Tabella email_log non trovata:', error);
                    document.getElementById('emailLogBody').innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-6 text-center text-gray-500">
                                <div class="text-lg mb-2">üìã Tabella log non ancora creata</div>
                                <div class="text-sm">Esegui la migration: <code class="bg-gray-100 px-2 py-1 rounded">migrations/create-email-system.sql</code></div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const tbody = document.getElementById('emailLogBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-6 text-center text-gray-500">
                                Nessun invio registrato
                            </td>
                        </tr>
                    `;
                    return;
                }

                data.forEach(log => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-green-50 transition-colors';

                    const statoColors = {
                        'sent': 'bg-green-100 text-green-800',
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'failed': 'bg-red-100 text-red-800'
                    };

                    const statoIcons = {
                        'sent': '‚úÖ',
                        'pending': '‚è≥',
                        'failed': '‚ùå'
                    };

                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            ${log.inviato_at ? new Date(log.inviato_at).toLocaleString('it-IT', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '--'}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${log.periodo_riferimento}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${log.email_destinatario}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${log.totale_dipendenti || 0}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right">${(log.totale_ore_lavorate || 0).toFixed(2)} h</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-600">${(log.totale_costo || 0).toFixed(2)} ‚Ç¨</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs font-semibold rounded-full ${statoColors[log.stato]}">
                                ${statoIcons[log.stato]} ${log.stato.toUpperCase()}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (err) {
                console.error('‚ùå Errore caricamento log email:', err);
            }
        }

        // Invia report mensile
        async function sendMonthlyReport() {
            const mese = parseInt(document.getElementById('emailMese').value);
            const anno = parseInt(document.getElementById('emailAnno').value);

            if (!confirm(`Confermi l'invio del report ${mese}/${anno} a tutti i destinatari attivi?`)) {
                return;
            }

            try {
                showNotification('‚è≥ Generazione PDF e invio email in corso...', 'success');

                const result = await window.pdfEmailService.sendMonthlyReport(anno, mese, currentUser);

                if (result.success) {
                    showNotification(`‚úÖ Report inviato! ${result.sent}/${result.total} email inviate`, 'success');
                    await loadEmailLog();
                } else {
                    showNotification('‚ùå Errore durante l\'invio', 'error');
                }

            } catch (err) {
                console.error('‚ùå Errore invio report:', err);
                showNotification('‚ùå ' + err.message, 'error');
            }
        }

        // Esporta CSV
        function exportToCSV() {
            let csv = 'Dipendente,Ruolo,Data,Tipo,Ingresso,Uscita,Ore Lavorate,Stato,Note\n';

            allTimbrature.forEach(t => {
                const hours = t.ore_lavorate ? t.ore_lavorate.toFixed(2) : '0.00';
                csv += `"${t.user.nome} ${t.user.cognome}","${t.user.ruolo}","${t.data}","${t.tipo}","${t.ora_ingresso || ''}","${t.ora_uscita || ''}","${hours}","${t.stato}","${t.note || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orari_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('‚úÖ Export CSV completato!', 'success');
        }

        // Mostra notifica
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Auto-refresh stato live ogni 60 secondi
        setInterval(() => {
            loadLiveStatus();
        }, 60000);
    </script>
</body>
</html>
