<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Lavorazioni - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    <script src="data-migration.js"></script>
    <script src="modal-system.js"></script>
    <script src="client-modal.js"></script>
    <script src="availability-checker.js"></script>
    <script src="task-wizard.js"></script>
    <script src="multi-user-assignment.js"></script>
    <script src="product-scanner.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .kanban-column { min-height: 500px; }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .priority-alta { border-left: 4px solid #ef4444; }
        .priority-media { border-left: 4px solid #f59e0b; }
        .priority-bassa { border-left: 4px solid #10b981; }
        .drag-over { background-color: #f3f4f6; border: 2px dashed #d1d5db; }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out z-50" id="sidebar">
        <div class="flex items-center justify-center h-16 gradient-bg">
            <h1 class="text-white text-xl font-bold">Admin Panel</h1>
        </div>
        <nav class="mt-8">
            <a href="admin-functional.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="gestione-utenti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                Gestione Utenti
            </a>
            <a href="gestione-clienti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="building-2" class="w-5 h-5 mr-3"></i>
                Gestione Clienti
            </a>
            <a href="gestione-squadre.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="users-2" class="w-5 h-5 mr-3"></i>
                Gestione Squadre
            </a>
            <a href="gestione-lavorazioni.html" class="flex items-center px-6 py-3 bg-blue-50 text-blue-600 border-r-4 border-blue-600">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                Gestione Lavorazioni
            </a>
            <a href="magazzino-prodotti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="package" class="w-5 h-5 mr-3"></i>
                Magazzino Prodotti
            </a>
            <a href="gestione-richieste.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                Gestione Richieste
            </a>
            <a href="comunicazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Comunicazioni
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Gestione Lavorazioni</h2>
                <p class="text-gray-600">Organizza e monitora tutte le attività aziendali</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex bg-white rounded-lg shadow-sm border">
                    <button id="kanbanViewBtn" onclick="switchView('kanban')" class="px-4 py-2 bg-blue-600 text-white rounded-l-lg transition-colors">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 mr-2 inline"></i>
                        Kanban
                    </button>
                    <button id="listViewBtn" onclick="switchView('list')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-r-lg hover:bg-gray-200 transition-colors">
                        <i data-lucide="list" class="w-4 h-4 mr-2 inline"></i>
                        Lista
                    </button>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.availabilityChecker.mostraCheckVeloce()" 
                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors flex items-center shadow-lg">
                        <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                        Check Veloce
                    </button>
                    <button onclick="window.availabilityChecker.mostraDashboardCompleta()" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>
                        Dashboard
                    </button>
                    <button onclick="mostraMenuCreazione()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Nuova Lavorazione
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Totale Lavorazioni</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalTasks">18</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">In Corso</p>
                        <p class="text-2xl font-bold text-orange-600" id="inProgressTasks">6</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Completate</p>
                        <p class="text-2xl font-bold text-green-600" id="completedTasks">8</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">In Ritardo</p>
                        <p class="text-2xl font-bold text-red-600" id="overdueTasks">2</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 fade-in">
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-64">
                    <input type="text" id="searchTasks" placeholder="Cerca lavorazioni..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutti gli stati</option>
                    <option value="da_fare">Da Fare</option>
                    <option value="in_corso">In Corso</option>
                    <option value="revisione">Revisione</option>
                    <option value="completato">Completato</option>
                </select>
                <select id="priorityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutte le priorità</option>
                    <option value="alta">Alta</option>
                    <option value="media">Media</option>
                    <option value="bassa">Bassa</option>
                </select>
                <select id="assigneeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutti gli assegnatari</option>
                    <option value="mario">Mario Rossi</option>
                    <option value="anna">Anna Verdi</option>
                    <option value="giuseppe">Giuseppe Neri</option>
                    <option value="laura">Laura Blu</option>
                </select>
            </div>
        </div>

        <!-- Kanban Board -->
        <div id="kanbanView" class="fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Da Fare Column -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gray-100 px-4 py-3 border-b">
                        <h3 class="font-medium text-gray-900 flex items-center">
                            <i data-lucide="circle" class="w-4 h-4 mr-2 text-gray-500"></i>
                            Da Fare
                            <span class="ml-auto bg-gray-500 text-white text-xs px-2 py-1 rounded-full" id="todoCount">4</span>
                        </h3>
                    </div>
                    <div class="kanban-column p-4 space-y-4" id="todoColumn" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="da_fare">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>

                <!-- In Corso Column -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-blue-100 px-4 py-3 border-b">
                        <h3 class="font-medium text-gray-900 flex items-center">
                            <i data-lucide="play-circle" class="w-4 h-4 mr-2 text-blue-500"></i>
                            In Corso
                            <span class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-full" id="inProgressCount">6</span>
                        </h3>
                    </div>
                    <div class="kanban-column p-4 space-y-4" id="inProgressColumn" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="in_corso">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>

                <!-- Revisione Column -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-orange-100 px-4 py-3 border-b">
                        <h3 class="font-medium text-gray-900 flex items-center">
                            <i data-lucide="eye" class="w-4 h-4 mr-2 text-orange-500"></i>
                            Revisione
                            <span class="ml-auto bg-orange-500 text-white text-xs px-2 py-1 rounded-full" id="reviewCount">2</span>
                        </h3>
                    </div>
                    <div class="kanban-column p-4 space-y-4" id="reviewColumn" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="revisione">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>

                <!-- Completato Column -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-green-100 px-4 py-3 border-b">
                        <h3 class="font-medium text-gray-900 flex items-center">
                            <i data-lucide="check-circle" class="w-4 h-4 mr-2 text-green-500"></i>
                            Completato
                            <span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full" id="completedCount">6</span>
                        </h3>
                    </div>
                    <div class="kanban-column p-4 space-y-4" id="completedColumn" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="completato">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- List View -->
        <div id="listView" class="hidden bg-white rounded-lg shadow-md overflow-hidden fade-in">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Elenco Lavorazioni</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lavorazione</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assegnatario</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priorità</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scadenza</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Tasks will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[95vh] overflow-hidden flex flex-col my-4">
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 p-6 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <h3 id="taskModalTitle" class="text-xl font-bold text-white text-center flex-1">Nuova Lavorazione</h3>
                        <button onclick="closeTaskModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors ml-3">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Content scrollabile -->
                <form id="taskForm" class="p-4 overflow-y-auto flex-1 space-y-3">
                    <!-- Titolo - BLU -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-xl p-4">
                        <label for="taskTitle" class="block text-sm font-bold text-blue-900 mb-2">
                            <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                            Titolo Lavorazione
                        </label>
                        <input type="text" id="taskTitle" required class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                    </div>
                    
                    <!-- Assegnazione - VIOLA -->
                    <div class="bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-bold text-purple-900">
                                <i data-lucide="users" class="w-4 h-4 inline mr-1"></i>
                                Assegnazione
                            </label>
                            <button type="button" id="autoSuggestBtn" onclick="suggerisciAutomatico()" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i>
                                <span id="autoSuggestBtnText">Suggerisci Singolo</span>
                            </button>
                        </div>
                        
                        <!-- Suggerimento Automatico Alert -->
                        <div id="suggestionAlert" class="hidden mb-3 bg-green-100 border-2 border-green-300 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">✅</span>
                                <span class="font-bold text-green-900" id="suggestionTitle">Suggerimento Automatico</span>
                            </div>
                            <p id="suggestionText" class="text-sm text-green-800 mb-2"></p>
                            <button type="button" onclick="applicaSuggerimento()" 
                                    class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-3 py-1.5 rounded transition-colors">
                                ✓ Applica Suggerimento
                            </button>
                        </div>
                        
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" id="assignSingle" name="assignType" value="single" checked 
                                       onchange="toggleAssignmentType()" 
                                       class="w-4 h-4 text-purple-600 focus:ring-purple-500 mr-2">
                                <span class="text-sm text-purple-900 font-medium">Singolo Dipendente</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" id="assignMulti" name="assignType" value="multi" 
                                       onchange="toggleAssignmentType()" 
                                       class="w-4 h-4 text-purple-600 focus:ring-purple-500 mr-2">
                                <span class="text-sm text-purple-900 font-medium">Multi Dipendente</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" id="assignTeam" name="assignType" value="team" 
                                       onchange="toggleAssignmentType()" 
                                       class="w-4 h-4 text-purple-600 focus:ring-purple-500 mr-2">
                                <span class="text-sm text-purple-900 font-medium">Squadra</span>
                            </label>
                        </div>
                        
                        <!-- Single Assignment -->
                        <div id="singleAssignment" class="assignment-section">
                            <select id="taskAssignee" class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white">
                                <option value="">Seleziona dipendente</option>
                                <option value="mario">Mario Rossi</option>
                                <option value="anna">Anna Verdi</option>
                                <option value="giuseppe">Giuseppe Neri</option>
                                <option value="laura">Laura Blu</option>
                            </select>
                        </div>
                        
                        <!-- Multi Assignment -->
                        <div id="multiAssignment" class="assignment-section hidden">
                            <div class="space-y-2 max-h-60 overflow-y-auto border-2 border-purple-300 rounded-lg p-3 bg-white">
                                <p class="text-sm font-bold text-purple-800 mb-2">
                                    <i data-lucide="users" class="w-4 h-4 inline mr-1"></i>
                                    Seleziona più dipendenti:
                                </p>
                                <div id="multiUsersList">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div id="selectedUsersPreview" class="mt-3 p-3 bg-purple-100 border border-purple-200 rounded-lg hidden">
                                <p class="text-sm font-bold text-purple-800 mb-2">
                                    <i class="fas fa-check-circle mr-2"></i>Dipendenti selezionati: <span id="selectedUsersCount">0</span>
                                </p>
                                <div id="selectedUsersList" class="flex flex-wrap gap-2">
                                    <!-- Selected users will be shown here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Team Assignment -->
                        <div id="teamAssignment" class="assignment-section hidden">
                            <select id="taskTeam" onchange="showTeamMembers()" class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white">
                                <option value="">Seleziona squadra</option>
                                <!-- Populated by JavaScript -->
                            </select>
                            <div id="teamMembersPreview" class="mt-3 p-3 bg-purple-100 border border-purple-200 rounded-lg hidden">
                                <p class="text-sm font-bold text-purple-800 mb-2">
                                    <i class="fas fa-users mr-2"></i>Membri della squadra:
                                </p>
                                <div id="teamMembersList" class="flex flex-wrap gap-2">
                                    <!-- Team members will be shown here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Priorità e Scadenza - Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Priorità - ROSA -->
                        <div class="bg-gradient-to-br from-pink-50 to-rose-100 border-2 border-pink-200 rounded-xl p-4">
                            <label for="taskPriority" class="block text-sm font-bold text-pink-900 mb-2">
                                <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i>
                                Priorità
                            </label>
                            <select id="taskPriority" required class="w-full px-3 py-2 border-2 border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-500 bg-white">
                                <option value="bassa">Bassa</option>
                                <option value="media" selected>Media</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                        
                        <!-- Scadenza - ARANCIO -->
                        <div class="bg-gradient-to-br from-orange-50 to-amber-100 border-2 border-orange-200 rounded-xl p-4">
                            <label for="taskDeadline" class="block text-sm font-bold text-orange-900 mb-2">
                                <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                                Scadenza
                            </label>
                            <input type="date" id="taskDeadline" required class="w-full px-3 py-2 border-2 border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 bg-white">
                        </div>
                    </div>
                    
                    <!-- Cliente - VERDE -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl p-4">
                        <label for="taskClient" class="block text-sm font-bold text-green-900 mb-2">
                            <i data-lucide="building-2" class="w-4 h-4 inline mr-1"></i>
                            Cliente/Progetto
                        </label>
                        <select id="taskClient" required class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-white">
                            <option value="">Seleziona cliente</option>
                            <!-- Populated by JavaScript -->
                        </select>
                        <div class="flex gap-3 mt-2 items-center">
                            <button type="button" onclick="window.open('gestione-clienti.html', '_blank')" 
                                    class="text-green-600 hover:text-green-700 transition-colors" 
                                    title="Crea nuovo cliente">
                                <i class="fas fa-plus-circle text-2xl"></i>
                            </button>
                            <button type="button" onclick="viewSelectedClient()" 
                                    class="text-blue-600 hover:text-blue-700 transition-colors" 
                                    title="Visualizza dettagli cliente">
                                <i class="fas fa-eye text-2xl"></i>
                            </button>
                            <p class="text-xs text-green-700 ml-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Clicca <i class="fas fa-plus-circle text-green-600 mx-1"></i> per creare o <i class="fas fa-eye text-blue-600 mx-1"></i> per vedere dettagli
                            </p>
                        </div>
                    </div>
                    
                    <!-- Components Section - VERDE CHIARO -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-bold text-green-900">
                                <i class="fas fa-box mr-2"></i>
                                Componenti Necessari
                            </label>
                            <button type="button" onclick="openComponentSelector()" 
                                    class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 text-sm transition-colors font-medium">
                                <i class="fas fa-plus mr-1"></i>
                                Aggiungi Componente
                            </button>
                        </div>
                        <div id="taskComponentsList" class="space-y-2">
                            <p class="text-sm text-green-700 italic">Nessun componente selezionato</p>
                        </div>
                    </div>
                    
                    <!-- Descrizione - GRIGIO -->
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                        <label for="taskDescription" class="block text-sm font-bold text-gray-700 mb-2">
                            <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                            Descrizione
                        </label>
                        <textarea id="taskDescription" rows="4" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"></textarea>
                    </div>
                    
                    <!-- Progresso Section (visible only in edit mode) - CELESTE -->
                    <div id="progressSection" class="hidden bg-gradient-to-br from-cyan-50 to-sky-100 border-2 border-cyan-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-bold text-cyan-900">
                                <i class="fas fa-tasks mr-2"></i>
                                Progresso & Note Dipendente
                            </label>
                            <span id="progressPercentage" class="text-2xl font-bold text-cyan-600">0%</span>
                        </div>
                        <div class="mb-4">
                            <div class="w-full bg-cyan-200 rounded-full h-3">
                                <div id="progressBar" class="bg-gradient-to-r from-cyan-500 to-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white border-2 border-cyan-200 p-4 rounded-lg">
                            <label class="block text-sm font-bold text-cyan-900 mb-2">
                                <i class="fas fa-sticky-note mr-2"></i>
                                Ultime Note sul Progresso
                            </label>
                            <div id="progressNotes" class="text-sm text-gray-700 italic">
                                Nessuna nota disponibile
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lock/Unlock Toggle - GIALLO -->
                    <div id="editLockSection" class="hidden bg-gradient-to-br from-yellow-50 to-amber-100 border-2 border-yellow-200 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i id="lockIcon" class="fas fa-lock text-yellow-600 mr-3 text-xl"></i>
                                <div>
                                    <p id="lockText" class="text-sm font-bold text-yellow-900">Campi bloccati per sicurezza</p>
                                    <p class="text-xs text-yellow-700">Sblocca per modificare i dettagli della lavorazione</p>
                                </div>
                            </div>
                            <button type="button" id="toggleLockButton" onclick="toggleFieldsLock()" 
                                    class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-amber-600 text-white rounded-lg hover:from-yellow-600 hover:to-amber-700 transition-colors text-sm font-bold">
                                <i class="fas fa-unlock mr-2"></i>Sblocca
                            </button>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-3 pt-2">
                        <button type="button" onclick="closeTaskModal()" class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl text-gray-800 font-bold transition-colors">
                            Annulla
                        </button>
                        <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 font-bold transition-all shadow-lg">
                            Salva Lavorazione
                        </button>
                    </div>
                    <div id="deleteTaskButton" class="mt-3 hidden">
                        <button type="button" onclick="deleteTaskFromModal()" class="w-full px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 flex items-center justify-center font-bold transition-all shadow-lg">
                            <i class="fas fa-trash mr-2"></i>
                            Elimina Lavorazione
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Component Selector Modal -->
    <div id="componentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-hidden flex flex-col my-4">
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 p-6 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white text-center flex-1">
                            <i class="fas fa-warehouse mr-2"></i>
                            Seleziona Componenti da Magazzino
                        </h3>
                        <button onclick="closeComponentModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors ml-3" title="Chiudi">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Search and Filter - GRIGIO CHIARO -->
                <div class="p-4 bg-gray-50 border-b-2 border-gray-200 space-y-3">
                    <!-- Search Bar -->
                    <div class="bg-white border-2 border-blue-200 rounded-xl p-3">
                        <label for="componentSearch" class="block text-sm font-bold text-blue-900 mb-2">
                            <i class="fas fa-search mr-1"></i>
                            Cerca Componente
                        </label>
                        <input type="text" id="componentSearch" 
                               oninput="filterComponents()"
                               placeholder="Cerca per nome, codice o descrizione..."
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Category Filter -->
                    <div class="bg-white border-2 border-purple-200 rounded-xl p-3">
                        <label for="componentCategoryFilter" class="block text-sm font-bold text-purple-900 mb-2">
                            <i class="fas fa-filter mr-1"></i>
                            Filtra per Categoria
                        </label>
                        <select id="componentCategoryFilter" onchange="filterComponents()" 
                                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white">
                            <option value="">Tutte le categorie</option>
                            <option value="Antifurto">Antifurto</option>
                            <option value="Videosorveglianza">Videosorveglianza</option>
                            <option value="Rete">Rete</option>
                            <option value="Accessori">Accessori</option>
                        </select>
                    </div>
                </div>
                
                <!-- Components List -->
                <div class="p-4 overflow-y-auto flex-1">
                    <div id="componentsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Components will be loaded here -->
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="flex justify-end p-4 border-t-2 border-gray-200 bg-gray-50">
                    <button type="button" onclick="closeComponentModal()" 
                            class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl text-gray-800 font-bold transition-colors">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditingTask = null;
        let currentView = 'kanban';
        let taskComponents = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            await loadTasks();
            await updateStats();
            setupFilters();
            await loadTeamsDropdown();
            await loadUsersDropdown();
            
            // Set default deadline to next week
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('taskDeadline').value = nextWeek.toISOString().split('T')[0];
            
            // Listen for team selection changes
            document.getElementById('taskTeam').addEventListener('change', updateTeamPreview);
            
            // Check if taskId is in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('taskId');
            if (taskId) {
                // Wait a bit for tasks to load, then open the task
                setTimeout(() => {
                    editTask(taskId);
                }, 500);
            }
        });

        function switchView(view) {
            currentView = view;
            
            if (view === 'kanban') {
                document.getElementById('kanbanView').classList.remove('hidden');
                document.getElementById('listView').classList.add('hidden');
                document.getElementById('kanbanViewBtn').className = 'px-4 py-2 bg-blue-600 text-white rounded-l-lg transition-colors';
                document.getElementById('listViewBtn').className = 'px-4 py-2 bg-gray-100 text-gray-700 rounded-r-lg hover:bg-gray-200 transition-colors';
            } else {
                document.getElementById('kanbanView').classList.add('hidden');
                document.getElementById('listView').classList.remove('hidden');
                document.getElementById('kanbanViewBtn').className = 'px-4 py-2 bg-gray-100 text-gray-700 rounded-l-lg hover:bg-gray-200 transition-colors';
                document.getElementById('listViewBtn').className = 'px-4 py-2 bg-blue-600 text-white rounded-r-lg transition-colors';
                loadTasksList();
            }
        }

        async function loadTasks() {
            if (currentView === 'kanban') {
                await loadKanbanTasks();
            } else {
                await loadTasksList();
            }
        }

        async function loadKanbanTasks() {
            try {
                const filteredTasks = await getFilteredTasks();
                
                // Clear all columns
                ['todoColumn', 'inProgressColumn', 'reviewColumn', 'completedColumn'].forEach(columnId => {
                    document.getElementById(columnId).innerHTML = '';
                });

                // Distribute tasks to columns
                filteredTasks.forEach(task => {
                    const taskElement = createTaskCard(task);
                    const columnId = getColumnId(task.stato);
                    if (columnId) {
                        document.getElementById(columnId).appendChild(taskElement);
                    }
                });

                updateColumnCounts();
                lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento tasks:', error);
                await showNotification('Impossibile caricare le lavorazioni', 'error');
            }
        }

        function loadTasksList() {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = '';

            const filteredTasks = getFilteredTasks();

            filteredTasks.forEach(task => {
                const row = createTaskRow(task);
                tbody.appendChild(row);
            });
            
            lucide.createIcons();
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card bg-white rounded-lg border shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow ${getPriorityClass(task.priorita || 'medium')}`;
            card.draggable = true;
            card.setAttribute('data-task-id', task.id);
            card.ondragstart = drag;
            card.onclick = () => editTask(task.id);

            const isOverdue = new Date(task.scadenza) < new Date() && task.stato !== 'completato';
            const overdueClass = isOverdue ? 'text-red-600' : 'text-gray-500';
            
            // Prepare assignee HTML
            let assigneeHTML = '';
            if (task.assigned_team_id) {
                assigneeHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-users text-blue-600"></i>
                        <span class="text-xs font-semibold text-blue-600">${task.team_name || 'Squadra'}</span>
                    </div>`;
            } else {
                const assigneeName = task.user_name || 'Non assegnato';
                const assigneeInitial = (task.user_name || 'U').charAt(0).toUpperCase();
                if (task.avatar) {
                    assigneeHTML = `<img src="${task.avatar}" alt="${assigneeName}" class="w-6 h-6 rounded-full">`;
                } else {
                    assigneeHTML = `<div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">${assigneeInitial}</div>`;
                }
                assigneeHTML += `<span class="text-xs text-gray-600">${assigneeName}</span>`;
            }

            card.innerHTML = `
                <div class="mb-3">
                    <h4 class="font-medium text-gray-900 text-sm">${task.titolo}</h4>
                </div>
                <p class="text-xs text-gray-600 mb-3">${(task.descrizione || '').substring(0, 60)}...</p>
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        ${assigneeHTML}
                    </div>
                    <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityBadgeClass(task.priorita || 'medium')}">${(task.priorita || 'media').charAt(0).toUpperCase() + (task.priorita || 'media').slice(1)}</span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    ${task.client_id ? `
                        <span class="text-blue-600 flex items-center">
                            <i class="fas fa-building text-blue-600 mr-1"></i>
                            ${task.client_name || 'Cliente'}
                        </span>
                    ` : `
                        <span class="text-gray-500 flex items-center">
                            <i class="fas fa-building text-gray-500 mr-1"></i>
                            ${task.client_name || 'Nessun cliente'}
                        </span>
                    `}
                    <span class="${overdueClass}">
                        <i class="fas fa-calendar text-gray-500 mr-1"></i>
                        ${formatDate(task.scadenza)}
                    </span>
                </div>
                ${task.progresso !== undefined ? `
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progresso</span>
                            <span>${task.progresso}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1">
                            <div class="bg-blue-600 h-1 rounded-full" style="width: ${task.progresso}%"></div>
                        </div>
                    </div>
                ` : ''}
            `;

            return card;
        }

        function createTaskRow(task) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 cursor-pointer';
            tr.onclick = () => editTask(task.id);

            const statusClass = getStatusClass(task.stato);
            const priorityClass = getPriorityBadgeClass(task.priorita || 'medium');
            const isOverdue = new Date(task.scadenza) < new Date() && task.stato !== 'completato';
            
            // Prepare assignee HTML
            let assigneeHTML = '';
            if (task.assigned_team_id) {
                assigneeHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-users text-blue-600 w-8 h-8 flex items-center justify-center mr-3"></i>
                        <div>
                            <div class="text-sm font-semibold text-blue-900">${task.team_name || 'Squadra'}</div>
                            <div class="text-xs text-blue-600">Squadra</div>
                        </div>
                    </div>`;
            } else {
                const assigneeName = task.user_name || 'Non assegnato';
                const assigneeInitial = (task.user_name || 'U').charAt(0).toUpperCase();
                if (task.avatar) {
                    assigneeHTML = `
                        <div class="flex items-center">
                            <img src="${task.avatar}" alt="${assigneeName}" class="w-8 h-8 rounded-full mr-3">
                            <div class="text-sm text-gray-900">${assigneeName}</div>
                        </div>`;
                } else {
                    assigneeHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold mr-3">${assigneeInitial}</div>
                            <div class="text-sm text-gray-900">${assigneeName}</div>
                        </div>`;
                }
            }

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div>
                        <div class="text-sm font-medium text-gray-900">${task.titolo}</div>
                        <div class="text-sm text-gray-500">${(task.descrizione || '').substring(0, 50)}...</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${assigneeHTML}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="${statusClass} px-2 py-1 rounded-full text-xs font-medium">${getStatusText(task.stato)}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="${priorityClass} px-2 py-1 rounded-full text-xs font-medium">${(task.priorita || 'media').charAt(0).toUpperCase() + (task.priorita || 'media').slice(1)}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-600 font-medium' : 'text-gray-500'}">
                    ${formatDate(task.scadenza)}
                    ${isOverdue ? '<i class="fas fa-exclamation-circle inline ml-1"></i>' : ''}
                </td>
            `;

            return tr;
        }

        async function getFilteredTasks() {
            try {
                const tasks = await window.dataManager.getLavorazioni();
                const searchTerm = document.getElementById('searchTasks').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
                const assigneeFilter = document.getElementById('assigneeFilter').value;

                return tasks.filter(task => {
                    const matchesSearch = task.titolo.toLowerCase().includes(searchTerm) || 
                                        (task.descrizione || '').toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || task.stato === statusFilter;
                    const matchesPriority = !priorityFilter || task.priorita === priorityFilter;
                    const matchesAssignee = !assigneeFilter || 
                                          task.assigned_user_id === assigneeFilter ||
                                          task.assigned_team_id === assigneeFilter;

                    return matchesSearch && matchesStatus && matchesPriority && matchesAssignee;
                });
            } catch (error) {
                console.error('Errore filtro tasks:', error);
                return [];
            }
        }

        function setupFilters() {
            const searchInput = document.getElementById('searchTasks');
            const statusFilter = document.getElementById('statusFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const assigneeFilter = document.getElementById('assigneeFilter');

            [searchInput, statusFilter, priorityFilter, assigneeFilter].forEach(element => {
                element.addEventListener('input', loadTasks);
                element.addEventListener('change', loadTasks);
            });
        }

        // Drag and Drop Functions
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.getAttribute('data-task-id'));
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const taskId = ev.dataTransfer.getData("text");
            const newStatus = ev.currentTarget.getAttribute('data-status');
            
            updateTaskStatus(parseInt(taskId), newStatus);
        }

        async function updateTaskStatus(taskId, newStatus) {
            try {
                const tasks = await window.dataManager.getLavorazioni();
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                // Update progress based on status
                let progresso = task.progresso || 0;
                switch(newStatus) {
                    case 'da_fare':
                        progresso = 0;
                        break;
                    case 'in_corso':
                        if (progresso === 0) progresso = 25;
                        break;
                    case 'revisione':
                        progresso = 90;
                        break;
                    case 'completato':
                        progresso = 100;
                        break;
                }
                
                // Save updated task
                await window.dataManager.saveLavorazione({
                    ...task,
                    stato: newStatus,
                    progresso: progresso
                });
                
                await loadTasks();
                await updateStats();
                showNotification(`Lavorazione spostata in "${getStatusText(newStatus)}"`, 'success');
            } catch (error) {
                console.error('Errore aggiornamento stato:', error);
                showNotification('Impossibile aggiornare lo stato della lavorazione', 'error');
            }
        }

        async function changeTaskStatus(taskId) {
            try {
                const tasks = await window.dataManager.getLavorazioni();
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                const statuses = ['da_fare', 'in_corso', 'revisione', 'completato'];
                const currentIndex = statuses.indexOf(task.stato);
                const nextIndex = (currentIndex + 1) % statuses.length;
                
                await updateTaskStatus(taskId, statuses[nextIndex]);
            } catch (error) {
                console.error('Errore cambio stato:', error);
            }
        }

        function openTaskModal() {
            currentEditingTask = null;
            previousAssignmentType = null; // Reset for new task
            document.getElementById('taskModalTitle').textContent = 'Nuova Lavorazione';
            document.getElementById('taskForm').reset();
            
            // Hide delete button for new tasks
            document.getElementById('deleteTaskButton').classList.add('hidden');
            
            // Reset components
            taskComponents = [];
            updateTaskComponentsList();
            
            // Set default deadline
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('taskDeadline').value = nextWeek.toISOString().split('T')[0];
            
            // Set default assignment type to single (only if element exists)
            const assignSingleRadio = document.getElementById('assignSingle');
            if (assignSingleRadio) {
                assignSingleRadio.checked = true;
                previousAssignmentType = 'single';
                toggleAssignmentType();
            }
            
            // Populate clients dropdown
            populateClientsDropdown();
            
            // Load teams and users
            loadTeamsDropdown();
            loadUsersDropdown();
            
            document.getElementById('taskModal').classList.remove('hidden');
        }

        async function populateClientsDropdown() {
            try {
                const clients = await window.dataManager.getClienti();
                const select = document.getElementById('taskClient');
                
                // Clear existing options except first one
                select.innerHTML = '<option value="">Seleziona cliente</option>';
                
                // Add client options
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.ragione_sociale} - ${client.nome || ''} ${client.cognome || ''}`.trim();
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Errore caricamento clienti:', error);
            }
        }

        function viewSelectedClient() {
            const clientId = document.getElementById('taskClient').value;
            if (!clientId) {
                alert('Seleziona prima un cliente dalla lista');
                return;
            }
            window.ClientModal.show(clientId);
        }

        async function loadTeamsDropdown() {
            try {
                const teams = await window.dataManager.getSquadre();
                const select = document.getElementById('taskTeam');
                
                select.innerHTML = '<option value="">Seleziona squadra</option>';
                
                // Load team members for each team
                for (const team of teams) {
                    // Get team members
                    const members = await window.TeamsAPI.getMembers(team.id);
                    team.membri = members || [];
                    
                    const option = document.createElement('option');
                    option.value = team.id;
                    const memberCount = team.membri.length;
                    option.textContent = `${team.nome} (${memberCount} membri)`;
                    // Store team data in option for later use
                    option.dataset.teamData = JSON.stringify(team);
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Errore caricamento squadre:', error);
            }
        }

        async function showTeamMembers() {
            const select = document.getElementById('taskTeam');
            const preview = document.getElementById('teamMembersPreview');
            const membersList = document.getElementById('teamMembersList');
            
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                preview.classList.add('hidden');
                return;
            }
            
            try {
                const team = JSON.parse(selectedOption.dataset.teamData);
                
                if (!team.membri || team.membri.length === 0) {
                    membersList.innerHTML = '<p class="text-sm text-gray-500">Nessun membro nella squadra</p>';
                    preview.classList.remove('hidden');
                    return;
                }
                
                // Load users to get names
                const allUsers = await window.dataManager.getUtenti();
                
                membersList.innerHTML = team.membri.map(member => {
                    const user = allUsers.find(u => u.id === member.user_id);
                    if (!user) return '';
                    
                    return `
                        <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                            <i class="fas fa-user mr-2"></i>
                            ${user.nome} ${user.cognome}
                        </span>
                    `;
                }).join('');
                
                preview.classList.remove('hidden');
            } catch (error) {
                console.error('Errore visualizzazione membri:', error);
                preview.classList.add('hidden');
            }
        }

        async function loadUsersDropdown() {
            try {
                const users = await window.dataManager.getUtenti();
                const select = document.getElementById('taskAssignee');
                
                select.innerHTML = '<option value="">Seleziona dipendente</option>';
                
                // Filter only active users
                const activeUsers = users.filter(u => u.stato === 'attivo');
                
                activeUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.nome} ${user.cognome}${user.ruolo ? ' - ' + user.ruolo : ''}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Errore caricamento utenti:', error);
            }
        }

        let previousAssignmentType = null;

        async function toggleAssignmentType() {
            const assignType = document.querySelector('input[name="assignType"]:checked').value;
            const singleAssignment = document.getElementById('singleAssignment');
            const multiAssignment = document.getElementById('multiAssignment');
            const teamAssignment = document.getElementById('teamAssignment');
            
            // If editing an existing task and fields are unlocked, ask for confirmation
            if (currentEditingTask && !fieldsLocked && previousAssignmentType && previousAssignmentType !== assignType) {
                const typeNames = {
                    'single': 'Singolo Dipendente',
                    'multi': 'Multi Dipendente',
                    'team': 'Squadra'
                };
                const confirmed = await showConfirm(
                    'Conferma Cambio Assegnazione',
                    `Sei sicuro di voler cambiare l'assegnazione da "${typeNames[previousAssignmentType]}" a "${typeNames[assignType]}"?`
                );
                
                if (!confirmed) {
                    // Revert to previous selection
                    document.getElementById('assign' + previousAssignmentType.charAt(0).toUpperCase() + previousAssignmentType.slice(1)).checked = true;
                    return;
                }
            }
            
            // Update previous assignment type
            previousAssignmentType = assignType;
            
            // Hide all sections first
            singleAssignment.classList.add('hidden');
            multiAssignment.classList.add('hidden');
            teamAssignment.classList.add('hidden');
            document.getElementById('teamMembersPreview').classList.add('hidden');
            
            // Update suggest button text based on assignment type
            const suggestBtnText = document.getElementById('autoSuggestBtnText');
            if (assignType === 'single') {
                suggestBtnText.textContent = 'Suggerisci Singolo';
            } else if (assignType === 'multi') {
                suggestBtnText.textContent = 'Suggerisci Multi';
            } else if (assignType === 'team') {
                suggestBtnText.textContent = 'Suggerisci Squadra';
            }
            
            // Show selected section
            if (assignType === 'single') {
                singleAssignment.classList.remove('hidden');
            } else if (assignType === 'multi') {
                multiAssignment.classList.remove('hidden');
                loadMultiUsersList(); // Carica la lista utenti
            } else if (assignType === 'team') {
                teamAssignment.classList.remove('hidden');
            }
        }

        function updateTeamPreview() {
            const teamId = document.getElementById('taskTeam').value;
            const preview = document.getElementById('teamMembersPreview');
            const membersList = document.getElementById('teamMembersList');
            
            if (!teamId) {
                preview.classList.add('hidden');
                return;
            }
            
            const team = window.sharedData.squadre.find(t => t.id === teamId);
            if (!team) return;
            
            membersList.innerHTML = team.membri.map(userId => {
                const user = window.sharedData.users.find(u => u.id === userId);
                return user ? `
                    <span class="px-3 py-1 bg-white border border-blue-200 text-blue-700 rounded-full text-sm flex items-center gap-2">
                        ${user.avatar ? 
                            `<img src="${user.avatar}" alt="${user.nome || 'User'}" class="w-5 h-5 rounded-full">` : 
                            `<div class="w-5 h-5 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">${(user.nome || 'U').charAt(0).toUpperCase()}</div>`
                        }
                        ${user.nome || 'Utente'}
                    </span>
                ` : '';
            }).join('');
            
            preview.classList.remove('hidden');
        }

        // ===================================
        // MULTI USER ASSIGNMENT FUNCTIONS
        // ===================================
        
        let selectedMultiUsers = [];
        
        async function loadMultiUsersList() {
            const container = document.getElementById('multiUsersList');
            if (!container) return;
            
            try {
                // Carica utenti dal database
                const { data: users, error } = await window.supabaseClient
                    .from('users')
                    .select('id, nome, cognome, ruolo, email')
                    .in('ruolo', ['Dipendente', 'Tecnico', 'Segreteria'])
                    .order('nome');
                
                if (error) throw error;
                
                if (!users || users.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm italic">Nessun dipendente disponibile</p>';
                    return;
                }
                
                container.innerHTML = users.map(user => `
                    <label class="flex items-center p-2 hover:bg-purple-50 rounded cursor-pointer">
                        <input type="checkbox" 
                               value="${user.id}" 
                               onchange="toggleMultiUser('${user.id}')"
                               class="w-4 h-4 text-purple-600 focus:ring-purple-500 mr-3">
                        <div class="flex items-center gap-2 flex-1">
                            <div class="w-8 h-8 rounded-full bg-purple-200 flex items-center justify-center text-purple-700 font-bold text-sm">
                                ${user.nome[0]}${user.cognome[0]}
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">${user.nome} ${user.cognome}</div>
                                <div class="text-xs text-gray-500">${user.ruolo}</div>
                            </div>
                        </div>
                    </label>
                `).join('');
                
            } catch (error) {
                console.error('Errore caricamento utenti:', error);
                container.innerHTML = '<p class="text-red-600 text-sm">Errore caricamento utenti</p>';
            }
        }
        
        function toggleMultiUser(userId) {
            const index = selectedMultiUsers.indexOf(userId);
            if (index > -1) {
                selectedMultiUsers.splice(index, 1);
            } else {
                selectedMultiUsers.push(userId);
            }
            updateSelectedUsersPreview();
        }
        
        async function updateSelectedUsersPreview() {
            const preview = document.getElementById('selectedUsersPreview');
            const count = document.getElementById('selectedUsersCount');
            const list = document.getElementById('selectedUsersList');
            
            count.textContent = selectedMultiUsers.length;
            
            if (selectedMultiUsers.length === 0) {
                preview.classList.add('hidden');
                return;
            }
            
            try {
                const { data: users, error } = await window.supabaseClient
                    .from('users')
                    .select('id, nome, cognome, ruolo')
                    .in('id', selectedMultiUsers);
                
                if (error) throw error;
                
                list.innerHTML = users.map(user => `
                    <span class="px-3 py-1 bg-white border border-purple-200 text-purple-700 rounded-full text-sm flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full bg-purple-200 flex items-center justify-center text-purple-700 text-xs font-bold">
                            ${user.nome[0]}${user.cognome[0]}
                        </div>
                        ${user.nome} ${user.cognome}
                        <button onclick="toggleMultiUser('${user.id}')" class="text-purple-500 hover:text-purple-700">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </span>
                `).join('');
                
                preview.classList.remove('hidden');
                
                // Re-initialize Lucide icons
                if (window.lucide) {
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('Errore caricamento dettagli utenti:', error);
            }
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
            currentEditingTask = null;
            
            // Reset progress section and lock
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('editLockSection').classList.add('hidden');
            fieldsLocked = true;
            
            // Unlock all fields for next use
            lockAllFields(false);
            
            // Hide delete button
            document.getElementById('deleteTaskButton').classList.add('hidden');
        }

        async function editTask(taskId) {
            try {
                const tasks = await window.dataManager.getLavorazioni();
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                currentEditingTask = task;
                document.getElementById('taskModalTitle').textContent = 'Modifica Lavorazione';
                
                // Show delete button for existing tasks
                document.getElementById('deleteTaskButton').classList.remove('hidden');
                
                // Show progress section and lock controls
                document.getElementById('progressSection').classList.remove('hidden');
                document.getElementById('editLockSection').classList.remove('hidden');
                
                // Update progress display
                const progresso = task.progresso || 0;
                document.getElementById('progressPercentage').textContent = progresso + '%';
                document.getElementById('progressBar').style.width = progresso + '%';
                
                // Show progress notes from user
                const progressNotes = task.note_progresso || task.notes || '';
                if (progressNotes) {
                    document.getElementById('progressNotes').innerHTML = progressNotes.replace(/\n/g, '<br>');
                    document.getElementById('progressNotes').classList.remove('italic');
                } else {
                    document.getElementById('progressNotes').textContent = 'Nessuna nota disponibile';
                    document.getElementById('progressNotes').classList.add('italic');
                }
                
                // Populate clients dropdown first and wait for it to complete
                await populateClientsDropdown();
                
                // Load teams and users
                await loadTeamsDropdown();
                await loadUsersDropdown();
                
                document.getElementById('taskTitle').value = task.title || task.titolo || '';
                document.getElementById('taskPriority').value = task.priority || task.priorita || '';
                document.getElementById('taskDeadline').value = task.deadline || task.scadenza || '';
                document.getElementById('taskClient').value = task.client_id || task.clienteId || '';
                document.getElementById('taskDescription').value = task.description || task.descrizione || '';
                
                // Set assignment type based on task data (only if elements exist)
                const assignTeamRadio = document.getElementById('assignTeam');
                const assignSingleRadio = document.getElementById('assignSingle');
                const taskTeamSelect = document.getElementById('taskTeam');
                const taskAssigneeSelect = document.getElementById('taskAssignee');
                
                if (assignTeamRadio && assignSingleRadio) {
                    if (task.assigned_team_id) {
                        // Task assigned to team
                        assignTeamRadio.checked = true;
                        previousAssignmentType = 'team';
                        if (taskTeamSelect) {
                            taskTeamSelect.value = task.assigned_team_id;
                            console.log('✅ Team assignment set:', task.assigned_team_id);
                        }
                        // Call showTeamMembers after a brief delay to ensure DOM is ready
                        setTimeout(() => showTeamMembers(), 100);
                    } else if (task.assigned_user_id) {
                        // Task assigned to single user
                        assignSingleRadio.checked = true;
                        previousAssignmentType = 'single';
                        if (taskAssigneeSelect) {
                            taskAssigneeSelect.value = task.assigned_user_id;
                            console.log('✅ User assignment set:', task.assigned_user_id);
                        }
                    } else {
                        // No assignment - default to single
                        assignSingleRadio.checked = true;
                        previousAssignmentType = 'single';
                        console.log('⚠️ No assignment found, defaulting to single');
                    }
                    toggleAssignmentType();
                } else {
                    // Fallback for old modal structure without assignment type radio
                    console.log('⚠️ Assignment type radio buttons not found, using fallback');
                    if (taskAssigneeSelect && task.assigned_user_id) {
                        taskAssigneeSelect.value = task.assigned_user_id;
                    }
                }
                
                // Lock all fields by default
                lockAllFields(true);
                
                // Load components
                taskComponents = task.components || task.componenti || [];
                await updateTaskComponentsList();
                
                document.getElementById('taskModal').classList.remove('hidden');
            } catch (error) {
                console.error('Errore caricamento task:', error);
            }
        }

        let fieldsLocked = true;

        function toggleFieldsLock() {
            fieldsLocked = !fieldsLocked;
            lockAllFields(fieldsLocked);
            
            const lockIcon = document.getElementById('lockIcon');
            const lockText = document.getElementById('lockText');
            const toggleButton = document.getElementById('toggleLockButton');
            
            if (fieldsLocked) {
                lockIcon.classList.remove('fa-unlock');
                lockIcon.classList.add('fa-lock');
                lockText.textContent = 'Campi bloccati per sicurezza';
                toggleButton.innerHTML = '<i class="fas fa-unlock mr-2"></i>Sblocca';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            } else {
                lockIcon.classList.remove('fa-lock');
                lockIcon.classList.add('fa-unlock');
                lockText.textContent = 'Campi sbloccati - Modifica attiva';
                toggleButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Blocca';
                toggleButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        function lockAllFields(lock) {
            const fields = [
                'taskTitle',
                'taskAssignee',
                'taskTeam',
                'taskPriority',
                'taskDeadline',
                'taskClient',
                'taskDescription'
            ];
            
            // Lock/unlock text inputs and selects
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (lock) {
                        field.setAttribute('readonly', 'readonly');
                        field.setAttribute('disabled', 'disabled');
                        field.classList.add('bg-gray-100', 'cursor-not-allowed');
                    } else {
                        field.removeAttribute('readonly');
                        field.removeAttribute('disabled');
                        field.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    }
                }
            });
            
            // Lock/unlock assignment type radio buttons
            const assignSingleRadio = document.getElementById('assignSingle');
            const assignTeamRadio = document.getElementById('assignTeam');
            
            if (assignSingleRadio && assignTeamRadio) {
                if (lock) {
                    assignSingleRadio.setAttribute('disabled', 'disabled');
                    assignTeamRadio.setAttribute('disabled', 'disabled');
                    assignSingleRadio.classList.add('cursor-not-allowed');
                    assignTeamRadio.classList.add('cursor-not-allowed');
                } else {
                    assignSingleRadio.removeAttribute('disabled');
                    assignTeamRadio.removeAttribute('disabled');
                    assignSingleRadio.classList.remove('cursor-not-allowed');
                    assignTeamRadio.classList.remove('cursor-not-allowed');
                }
            }
        }


        async function deleteTaskFromModal() {
            if (!currentEditingTask) return;
            
            try {
                const confirmed = await showConfirm(
                    'Elimina Lavorazione',
                    'Sei sicuro di voler eliminare questa lavorazione?'
                );
                
                if (confirmed) {
                    await window.dataManager.deleteLavorazione(currentEditingTask.id);
                    closeTaskModal();
                    await loadTasks();
                    await showNotification('Lavorazione eliminata con successo!', 'success');
                }
            } catch (error) {
                console.error('Errore eliminazione task:', error);
                await showNotification('Errore durante l\'eliminazione della lavorazione', 'error');
            }
        }

        async function deleteTask(taskId) {
            try {
                const confirmed = await showConfirm(
                    'Elimina Lavorazione',
                    'Sei sicuro di voler eliminare questa lavorazione?'
                );
                
                if (confirmed) {
                    await window.dataManager.deleteLavorazione(taskId);
                    await loadTasks();
                    await updateStats();
                    showNotification('Lavorazione eliminata con successo!', 'success');
                }
            } catch (error) {
                console.error('Errore eliminazione task:', error);
                showNotification('Impossibile eliminare la lavorazione: ' + error.message, 'error');
            }
        }

        async function updateStats() {
            try {
                const tasks = await window.dataManager.getLavorazioni();
                document.getElementById('totalTasks').textContent = tasks.length;
                document.getElementById('inProgressTasks').textContent = tasks.filter(t => t.stato === 'in_corso').length;
                document.getElementById('completedTasks').textContent = tasks.filter(t => t.stato === 'completato').length;
                
                const overdue = tasks.filter(t => {
                    if (!t.scadenza || t.stato === 'completato') return false;
                    return new Date(t.scadenza) < new Date();
                }).length;
                document.getElementById('overdueTasks').textContent = overdue;
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
            }
        }

        async function updateColumnCounts() {
            try {
                const tasks = await window.dataManager.getLavorazioni();
                document.getElementById('todoCount').textContent = tasks.filter(t => t.stato === 'da_fare').length;
                document.getElementById('inProgressCount').textContent = tasks.filter(t => t.stato === 'in_corso').length;
                document.getElementById('reviewCount').textContent = tasks.filter(t => t.stato === 'revisione').length;
                document.getElementById('completedCount').textContent = tasks.filter(t => t.stato === 'completato').length;
            } catch (error) {
                console.error('Errore conteggio colonne:', error);
            }
        }

        // Form submission
        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const assignType = document.querySelector('input[name="assignType"]:checked').value;
                
                // Get client data
                const clientId = document.getElementById('taskClient').value;
                if (!clientId) {
                    showNotification('Seleziona un cliente', 'error');
                    return;
                }

                const taskData = {
                    titolo: document.getElementById('taskTitle').value,
                    descrizione: document.getElementById('taskDescription').value,
                    stato: currentEditingTask ? currentEditingTask.stato : 'da_fare',
                    priorita: document.getElementById('taskPriority').value,
                    scadenza: document.getElementById('taskDeadline').value,
                    client_id: clientId,
                    progresso: currentEditingTask ? currentEditingTask.progresso : 0,
                    note_progresso: currentEditingTask ? currentEditingTask.note_progresso : null,
                    created_by: null // Will be set by backend or current user
                };

                if (assignType === 'team') {
                    // Team assignment - create ONE task assigned to the team
                    const teamId = document.getElementById('taskTeam').value;
                    if (!teamId) {
                        showNotification('Seleziona una squadra', 'error');
                        return;
                    }
                    
                    // Get team data to verify it has members
                    const select = document.getElementById('taskTeam');
                    const selectedOption = select.options[select.selectedIndex];
                    const team = JSON.parse(selectedOption.dataset.teamData);
                    
                    if (!team.membri || team.membri.length === 0) {
                        showNotification('La squadra selezionata non ha membri', 'error');
                        return;
                    }
                    
                    taskData.assigned_team_id = teamId;
                    taskData.assigned_user_id = null; // NULL means it's a team task
                    
                    if (currentEditingTask) {
                        taskData.id = currentEditingTask.id;
                        taskData.created_at = currentEditingTask.created_at;
                        taskData.created_by = currentEditingTask.created_by;
                        taskData.data_inizio = currentEditingTask.data_inizio;
                        taskData.data_completamento = currentEditingTask.data_completamento;
                    }
                    
                    if (taskComponents.length > 0) {
                        taskData.componenti = taskComponents;
                    }

                    await window.dataManager.saveLavorazione(taskData);
                    
                    showNotification(`Lavorazione assegnata alla squadra ${team.nome} (${team.membri.length} membri)!`, 'success');
                } else if (assignType === 'multi') {
                    // Multi user assignment
                    if (selectedMultiUsers.length === 0) {
                        showNotification('Seleziona almeno un dipendente', 'error');
                        return;
                    }
                    
                    // Assegna al primo utente (required dal constraint)
                    taskData.assigned_user_id = selectedMultiUsers[0];
                    taskData.assigned_team_id = null;
                    
                    if (currentEditingTask) {
                        taskData.id = currentEditingTask.id;
                        taskData.created_at = currentEditingTask.created_at;
                        taskData.created_by = currentEditingTask.created_by;
                        taskData.data_inizio = currentEditingTask.data_inizio;
                        taskData.data_completamento = currentEditingTask.data_completamento;
                    }
                    
                    if (taskComponents.length > 0) {
                        taskData.componenti = taskComponents;
                    }

                    // Salva la task principale
                    const savedTask = await window.dataManager.saveLavorazione(taskData);
                    const taskId = savedTask.id || currentEditingTask?.id;
                    
                    // Salva le assegnazioni multiple usando multiUserAssignment
                    if (taskId && window.multiUserAssignment) {
                        const assignResult = await window.multiUserAssignment.salvaAssegnazioni(
                            taskId,
                            selectedMultiUsers
                        );
                        
                        if (!assignResult.success) {
                            console.error('Errore salvataggio assegnazioni multiple:', assignResult.error);
                            showNotification('Task creata ma errore nelle assegnazioni multiple', 'warning');
                        }
                    }
                    
                    showNotification(`Lavorazione assegnata a ${selectedMultiUsers.length} dipendenti!`, 'success');
                } else {
                    // Single assignment
                    const assigneeId = document.getElementById('taskAssignee').value;
                    if (!assigneeId) {
                        showNotification('Seleziona un dipendente', 'error');
                        return;
                    }
                    
                    taskData.assigned_user_id = assigneeId;
                    taskData.assigned_team_id = null;
                    
                    if (currentEditingTask) {
                        // Editing existing task - preserve all existing data
                        taskData.id = currentEditingTask.id;
                        taskData.created_at = currentEditingTask.created_at;
                        taskData.created_by = currentEditingTask.created_by;
                        taskData.data_inizio = currentEditingTask.data_inizio;
                        taskData.data_completamento = currentEditingTask.data_completamento;
                    }
                    
                    // Add components to task data
                    if (taskComponents.length > 0) {
                        taskData.componenti = taskComponents;
                    }

                    await window.dataManager.saveLavorazione(taskData);
                    
                    showNotification(currentEditingTask ? 'Lavorazione aggiornata!' : 'Lavorazione creata!', 'success');
                }
                
                closeTaskModal();
                await loadTasks();
            } catch (error) {
                console.error('Errore salvataggio task:', error);
                showNotification('Impossibile salvare la lavorazione: ' + error.message, 'error');
            }
        });

        // Event listeners for drag and drop
        document.addEventListener('dragover', function(e) {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                if (column !== e.target.closest('.kanban-column')) {
                    column.classList.remove('drag-over');
                }
            });
        });

        // Utility functions
        function getColumnId(status) {
            switch(status) {
                case 'da_fare': return 'todoColumn';
                case 'in_corso': return 'inProgressColumn';
                case 'revisione': return 'reviewColumn';
                case 'completato': return 'completedColumn';
                default: return null;
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'da_fare': return 'bg-gray-100 text-gray-800';
                case 'in_corso': return 'bg-blue-100 text-blue-800';
                case 'revisione': return 'bg-orange-100 text-orange-800';
                case 'completato': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'da_fare': return 'Da Fare';
                case 'in_corso': return 'In Corso';
                case 'revisione': return 'Revisione';
                case 'completato': return 'Completato';
                default: return status;
            }
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'alta': return 'priority-alta';
                case 'media': return 'priority-media';
                case 'bassa': return 'priority-bassa';
                default: return '';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'alta': return 'bg-red-100 text-red-800';
                case 'media': return 'bg-yellow-100 text-yellow-800';
                case 'bassa': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Make tasks data available globally for user panel integration
        // Data will be loaded from Supabase via dataManager
        window.sharedTasksData = [];

        // Component Management Functions
        // taskComponents is now declared at the top of the script

        async function openComponentSelector() {
            document.getElementById('componentModal').classList.remove('hidden');
            await loadComponents();
            lucide.createIcons();
        }

        function closeComponentModal() {
            document.getElementById('componentModal').classList.add('hidden');
        }

        async function loadComponents(category = '', searchTerm = '') {
            try {
                const allComponents = await window.dataManager.getComponenti();
                
                // Filter by category
                let components = category ? 
                    allComponents.filter(c => c.categoria === category) : 
                    allComponents;
                
                // Filter by search term
                if (searchTerm) {
                    components = components.filter(c => 
                        c.nome.toLowerCase().includes(searchTerm) ||
                        c.codice.toLowerCase().includes(searchTerm) ||
                        (c.descrizione && c.descrizione.toLowerCase().includes(searchTerm))
                    );
                }
                
                const container = document.getElementById('componentsList');
                container.innerHTML = '';
                
                if (components.length === 0) {
                    container.innerHTML = '<p class="col-span-2 text-center text-gray-500 py-8">Nessun componente trovato</p>';
                    return;
                }
                
                components.forEach(component => {
                    const isAdded = taskComponents.some(tc => tc.id === component.id);
                
                const card = document.createElement('div');
                card.className = `bg-gray-50 rounded-lg p-4 border ${isAdded ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${component.nome}</h4>
                            <p class="text-xs text-gray-500">${component.codice}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded ${getCategoryBadge(component.categoria)}">
                            ${component.categoria}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${component.descrizione}</p>
                    <div class="flex justify-between items-center text-sm mb-3">
                        <span class="text-gray-600">
                            <i class="fas fa-warehouse mr-1"></i>
                            Disponibili: <strong>${component.quantita_disponibile || 0} ${component.unita_misura || 'pz'}</strong>
                        </span>
                        <span class="text-gray-600">
                            €${(component.prezzo_unitario || 0).toFixed(2)}/${component.unita_misura || 'pz'}
                        </span>
                    </div>
                    ${isAdded ? `
                        <div class="flex gap-2">
                            <input type="number" id="qty-${component.id}" value="${getComponentQuantity(component.id)}" min="1" 
                                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                   onchange="updateComponentQuantity('${component.id}', this.value)">
                            <button onclick="removeComponentFromTask('${component.id}')" 
                                    class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    ` : `
                        <button onclick="addComponentToTask('${component.id}')" 
                                class="w-full px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                            <i class="fas fa-plus mr-1"></i>
                            Aggiungi
                        </button>
                    `}
                `;
                container.appendChild(card);
            });
            } catch (error) {
                console.error('Errore caricamento componenti:', error);
                document.getElementById('componentsList').innerHTML = '<p class="text-red-500 text-center py-4">Errore nel caricamento dei componenti</p>';
            }
        }

        function filterComponents() {
            const category = document.getElementById('componentCategoryFilter').value;
            const searchTerm = document.getElementById('componentSearch').value.toLowerCase();
            loadComponents(category, searchTerm);
        }

        async function filterComponentsByCategory() {
            filterComponents();
        }

        async function addComponentToTask(componentId) {
            try {
                const components = await window.dataManager.getComponenti();
                const component = components.find(c => c.id === componentId);
                if (!component) return;
                
                taskComponents.push({ id: componentId, quantita: 1 });
                await updateTaskComponentsList();
                filterComponents();
            } catch (error) {
                console.error('Errore aggiunta componente:', error);
            }
        }

        async function removeComponentFromTask(componentId) {
            const index = taskComponents.findIndex(c => c.id === componentId);
            if (index !== -1) {
                taskComponents.splice(index, 1);
                await updateTaskComponentsList();
                filterComponents();
            }
        }

        async function updateComponentQuantity(componentId, quantita) {
            const component = taskComponents.find(c => c.id === componentId);
            if (component) {
                component.quantita = parseInt(quantita) || 1;
                await updateTaskComponentsList();
            }
        }

        function getComponentQuantity(componentId) {
            const component = taskComponents.find(c => c.id === componentId);
            return component ? component.quantita : 1;
        }

        async function updateTaskComponentsList() {
            const container = document.getElementById('taskComponentsList');
            
            if (taskComponents.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 italic">Nessun componente selezionato</p>';
                return;
            }
            
            container.innerHTML = '';
            
            // Fetch all components
            const allComponents = await window.dataManager.getComponenti();
            
            taskComponents.forEach(tc => {
                const component = allComponents.find(c => c.id === tc.id);
                if (!component) return;
                
                const available = (component.quantita_disponibile || 0) >= tc.quantita;
                
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-3 bg-gray-50 rounded-lg border ${available ? 'border-gray-200' : 'border-red-300 bg-red-50'}`;
                item.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${component.nome}</p>
                        <p class="text-xs text-gray-500">${component.codice || 'N/A'}</p>
                        ${!available ? '<p class="text-xs text-red-600 mt-1"><i class="fas fa-exclamation-triangle mr-1"></i>Quantità non disponibile in magazzino</p>' : ''}
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-medium text-gray-700">
                            ${tc.quantita} ${component.unita_misura || 'pz'}
                        </span>
                        <button onclick="editComponentInList('${tc.id}')" 
                                class="text-blue-600 hover:text-blue-700" title="Modifica quantità">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeComponentFromList('${tc.id}')" 
                                class="text-red-600 hover:text-red-700" title="Rimuovi">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function editComponentInList(componentId) {
            openComponentSelector();
        }

        function removeComponentFromList(componentId) {
            if (confirm('Vuoi rimuovere questo componente dalla lavorazione?')) {
                removeComponentFromTask(componentId);
            }
        }

        function getCategoryBadge(category) {
            switch(category) {
                case 'Antifurto': return 'bg-red-100 text-red-700';
                case 'Videosorveglianza': return 'bg-blue-100 text-blue-700';
                case 'Rete': return 'bg-green-100 text-green-700';
                case 'Accessori': return 'bg-purple-100 text-purple-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        // ============================================
        // 🎯 SISTEMA SUGGERIMENTO AUTOMATICO
        // ============================================
        
        let suggestedUser = null;
        let suggestedUsers = []; // For multi-user suggestions

        async function suggerisciAutomatico() {
            const assignType = document.querySelector('input[name="assignType"]:checked').value;
            
            if (assignType === 'single') {
                await suggerisciDipendenteSingolo();
            } else if (assignType === 'multi') {
                await suggerisciDipendentiMulti();
            } else if (assignType === 'team') {
                await suggerisciSquadra();
            }
        }

        async function suggerisciDipendenteSingolo() {
            try {
                const result = await window.availabilityChecker.checkUrgenzaVeloce();
                
                if (result.success) {
                    const c = result.consigliato;
                    suggestedUser = c;
                    
                    document.getElementById('suggestionAlert').classList.remove('hidden');
                    document.getElementById('suggestionTitle').textContent = 'Suggerimento Singolo Dipendente';
                    document.getElementById('suggestionText').innerHTML = `
                        <strong>${c.nome}</strong> è il più disponibile con 
                        <strong>${c.oreDisponibili} ore libere</strong> e 
                        <strong>${c.taskAttivi} task attivi</strong>.
                    `;
                    
                    showNotification('Suggerimento automatico generato! ✨', 'success');
                } else {
                    showNotification('Nessun dipendente disponibile al momento', 'warning');
                }
            } catch (error) {
                console.error('Errore suggerimento:', error);
                showNotification('Errore nel calcolo suggerimento', 'error');
            }
        }

        async function suggerisciDipendentiMulti() {
            try {
                // Get all available users
                const { data: users, error } = await window.supabaseClient
                    .from('users')
                    .select('id, nome, cognome, ruolo')
                    .in('ruolo', ['Dipendente', 'Tecnico', 'Segreteria'])
                    .order('nome');

                if (error) throw error;

                if (!users || users.length === 0) {
                    showNotification('Nessun dipendente disponibile', 'warning');
                    return;
                }

                // Get task count for each user
                const availability = [];
                for (const user of users) {
                    try {
                        // Count active tasks for this user
                        const { data: tasks, error: taskError } = await window.supabaseClient
                            .from('tasks')
                            .select('id, ore_stimate')
                            .or(`assegnatario_id.eq.${user.id},utenti_assegnati.cs.{${user.id}}`)
                            .in('stato', ['in-attesa', 'in-corso']);

                        if (taskError) {
                            console.warn('Errore conteggio task per', user.nome, taskError);
                        }

                        const taskAttivi = tasks ? tasks.length : 0;
                        const oreTotali = tasks ? tasks.reduce((sum, t) => sum + (parseFloat(t.ore_stimate) || 0), 0) : 0;
                        // Assume 40 ore settimanali disponibili
                        const oreDisponibili = Math.max(0, 40 - oreTotali);

                        availability.push({
                            userId: user.id,
                            nome: `${user.nome} ${user.cognome}`,
                            oreDisponibili: oreDisponibili,
                            taskAttivi: taskAttivi
                        });
                    } catch (e) {
                        console.warn('Errore check disponibilità per', user.nome, e);
                        // Include user anyway with default values
                        availability.push({
                            userId: user.id,
                            nome: `${user.nome} ${user.cognome}`,
                            oreDisponibili: 40,
                            taskAttivi: 0
                        });
                    }
                }

                // Sort by availability (more available hours first, less active tasks)
                availability.sort((a, b) => {
                    if (b.oreDisponibili !== a.oreDisponibili) {
                        return b.oreDisponibili - a.oreDisponibili;
                    }
                    return a.taskAttivi - b.taskAttivi;
                });

                // Get top 3
                const top3 = availability.slice(0, 3);
                
                if (top3.length === 0) {
                    showNotification('Nessun dipendente disponibile', 'warning');
                    return;
                }

                suggestedUsers = top3; // Store for applying later

                document.getElementById('suggestionAlert').classList.remove('hidden');
                document.getElementById('suggestionTitle').textContent = 'Suggerimento Multi Dipendente';
                document.getElementById('suggestionText').innerHTML = `
                    <strong>Top ${top3.length} dipendenti più disponibili:</strong><br>
                    ${top3.map((u, i) => `
                        ${i + 1}. <strong>${u.nome}</strong> - ${u.oreDisponibili.toFixed(0)}h libere, ${u.taskAttivi} task attivi
                    `).join('<br>')}
                `;
                
                showNotification('Suggerimento multi-dipendente generato! ✨', 'success');
            } catch (error) {
                console.error('Errore suggerimento multi:', error);
                showNotification('Errore nel calcolo suggerimento: ' + error.message, 'error');
            }
        }

        async function suggerisciSquadra() {
            showNotification('Funzionalità in sviluppo', 'info');
        }

        // Keep old function name for compatibility
        async function suggerisciDipendenteAutomatico() {
            await suggerisciAutomatico();
        }

        function applicaSuggerimento() {
            const assignType = document.querySelector('input[name="assignType"]:checked').value;
            
            if (assignType === 'single') {
                if (!suggestedUser) {
                    showNotification('Nessun suggerimento disponibile', 'error');
                    return;
                }

                // Select the suggested user
                const select = document.getElementById('taskAssignee');
                select.value = suggestedUser.userId;

                showNotification(`✓ Assegnato a ${suggestedUser.nome}!`, 'success');
                
            } else if (assignType === 'multi') {
                if (!suggestedUsers || suggestedUsers.length === 0) {
                    showNotification('Nessun suggerimento disponibile', 'error');
                    return;
                }

                // Select all suggested users
                selectedMultiUsers = suggestedUsers.map(u => u.userId);
                
                // Update checkboxes
                const checkboxes = document.querySelectorAll('#multiUsersList input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    if (selectedMultiUsers.includes(cb.value)) {
                        cb.checked = true;
                    }
                });

                // Update preview
                updateSelectedUsersPreview();

                showNotification(`✓ Selezionati ${suggestedUsers.length} dipendenti!`, 'success');
            }

            // Hide suggestion
            document.getElementById('suggestionAlert').classList.add('hidden');
            lucide.createIcons();
        }
    </script>

    <!-- ================================================ -->
    <!-- MENU SELEZIONE TIPO CREAZIONE -->
    <!-- ================================================ -->
    <div id="creation-menu-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8 relative">
            <button onclick="document.getElementById('creation-menu-modal').classList.add('hidden')" 
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Come vuoi creare la lavorazione?</h2>
                <p class="text-gray-600">Scegli il metodo che preferisci</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Opzione 1: Wizard Guidato -->
                <button onclick="apriWizard()" 
                        class="group relative bg-gradient-to-br from-purple-500 to-blue-600 text-white p-8 rounded-2xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
                    <div class="absolute top-4 right-4">
                        <span class="bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full">NUOVO ✨</span>
                    </div>
                    
                    <div class="text-center">
                        <i data-lucide="wand-2" class="w-16 h-16 mx-auto mb-4"></i>
                        <h3 class="text-2xl font-bold mb-3">Wizard Guidato</h3>
                        <p class="text-white text-opacity-90 text-sm mb-4">
                            Creazione assistita passo-passo con 5 step:
                        </p>
                        <ul class="text-left text-sm space-y-2 text-white text-opacity-90">
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Dati base
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Assegnazione intelligente
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Componenti magazzino
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Verifica disponibilità AI
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Riepilogo e conferma
                            </li>
                        </ul>
                        <div class="mt-6 bg-white bg-opacity-20 rounded-lg p-3">
                            <p class="text-xs font-semibold">Consigliato per lavorazioni complesse</p>
                        </div>
                    </div>
                </button>

                <!-- Opzione 2: Form Classico -->
                <button onclick="apriFormClassico()" 
                        class="group relative bg-white border-2 border-gray-300 text-gray-800 p-8 rounded-2xl hover:shadow-2xl hover:border-blue-500 transition-all duration-300 transform hover:scale-105">
                    <div class="text-center">
                        <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 text-gray-600 group-hover:text-blue-600"></i>
                        <h3 class="text-2xl font-bold mb-3">Form Classico</h3>
                        <p class="text-gray-600 text-sm mb-4">
                            Inserimento rapido tradizionale con form unico
                        </p>
                        <ul class="text-left text-sm space-y-2 text-gray-700">
                            <li class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-blue-600"></i>
                                Creazione veloce
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-blue-600"></i>
                                Un solo passaggio
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-blue-600"></i>
                                Interfaccia familiare
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-blue-600"></i>
                                Tutti i campi visibili
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-blue-600"></i>
                                Nessuna validazione step
                            </li>
                        </ul>
                        <div class="mt-6 bg-gray-100 rounded-lg p-3">
                            <p class="text-xs font-semibold text-gray-700">Ideale per lavorazioni semplici</p>
                        </div>
                    </div>
                </button>
            </div>

            <div class="mt-8 text-center">
                <p class="text-sm text-gray-500">
                    💡 Suggerimento: Usa il wizard per lavorazioni con più dettagli, il form classico per aggiunte veloci
                </p>
            </div>
        </div>
    </div>

    <!-- ================================================ -->
    <!-- WIZARD MODAL COMPLETO -->
    <!-- ================================================ -->
    <div id="task-wizard-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Header con Progress Bar -->
            <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold">🪄 Wizard Creazione Lavorazione</h2>
                    <button onclick="window.taskWizard.closeWizard()" class="text-white hover:text-gray-200">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <!-- Progress Bar -->
                <div class="bg-white bg-opacity-20 rounded-full h-2 mb-2">
                    <div id="wizard-progress-bar" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
                </div>
                <p id="wizard-progress-text" class="text-sm text-white text-opacity-90">Step 1 di 4</p>
                
                <!-- Step Indicators -->
                <div class="flex justify-between mt-4">
                    <div id="step-indicator-1" class="flex flex-col items-center active">
                        <div class="w-10 h-10 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold mb-1">1</div>
                        <span class="text-xs">Dati Base</span>
                    </div>
                    <div id="step-indicator-2" class="flex flex-col items-center opacity-50">
                        <div class="w-10 h-10 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold mb-1">2</div>
                        <span class="text-xs">Assegnazione</span>
                    </div>
                    <div id="step-indicator-3" class="flex flex-col items-center opacity-50">
                        <div class="w-10 h-10 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold mb-1">3</div>
                        <span class="text-xs">Dettagli</span>
                    </div>
                    <div id="step-indicator-4" class="flex flex-col items-center opacity-50">
                        <div class="w-10 h-10 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold mb-1">4</div>
                        <span class="text-xs">Conferma</span>
                    </div>
                </div>
            </div>

            <!-- Contenuto Steps -->
            <div class="p-8">
                <!-- STEP 1: Dati Base -->
                <div id="wizard-step-1" class="space-y-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">📋 Informazioni Base</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Titolo Lavorazione *</label>
                        <input type="text" id="wizard-titolo" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Es: Riparazione impianto elettrico">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                        <select id="wizard-cliente-select" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleziona cliente...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                        <textarea id="wizard-descrizione" rows="4"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="Descrizione dettagliata della lavorazione..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priorità</label>
                            <select id="wizard-priorita" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="bassa">🟢 Bassa</option>
                                <option value="media" selected>🟡 Media</option>
                                <option value="alta">🔴 Alta</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Scadenza *</label>
                            <input type="date" id="wizard-scadenza" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <input type="text" id="wizard-categoria" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Es: Elettrico, Idraulico, Manutenzione...">
                    </div>
                </div>

                <!-- STEP 2: Assegnazione -->
                <div id="wizard-step-2" class="hidden space-y-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">👤 Assegnazione Lavorazione</h3>
                    
                    <div class="flex flex-wrap gap-4 mb-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="tipo-assegnazione" id="wizard-tipo-user" value="user" checked
                                   onchange="document.getElementById('wizard-dipendente-container').classList.remove('hidden'); document.getElementById('wizard-squadra-container').classList.add('hidden'); document.getElementById('wizard-multi-container').classList.add('hidden');"
                                   class="w-4 h-4 text-blue-600">
                            <span class="font-medium">Dipendente Singolo</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="tipo-assegnazione" id="wizard-tipo-multi" value="multi"
                                   onchange="document.getElementById('wizard-dipendente-container').classList.add('hidden'); document.getElementById('wizard-squadra-container').classList.add('hidden'); document.getElementById('wizard-multi-container').classList.remove('hidden');"
                                   class="w-4 h-4 text-blue-600">
                            <span class="font-medium">🆕 Più Utenti</span>
                            <span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full">NUOVO</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="tipo-assegnazione" id="wizard-tipo-team" value="team"
                                   onchange="document.getElementById('wizard-dipendente-container').classList.add('hidden'); document.getElementById('wizard-squadra-container').classList.remove('hidden'); document.getElementById('wizard-multi-container').classList.add('hidden');"
                                   class="w-4 h-4 text-blue-600">
                            <span class="font-medium">Squadra Esistente</span>
                        </label>
                    </div>

                    <div id="wizard-dipendente-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seleziona Dipendente *</label>
                        <select id="wizard-dipendente-select" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleziona dipendente...</option>
                        </select>
                    </div>

                    <div id="wizard-multi-container" class="hidden">
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <i data-lucide="users-2" class="w-8 h-8 text-purple-600"></i>
                                <div>
                                    <h4 class="font-bold text-lg">Assegnazione Multipla</h4>
                                    <p class="text-sm text-gray-600">Seleziona più utenti senza creare una squadra</p>
                                </div>
                            </div>

                            <button onclick="window.multiUserAssignment.mostraSuggerimentoMultiUtente()" 
                                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4 rounded-xl hover:shadow-xl transition-all flex items-center justify-center gap-2 font-semibold mb-4">
                                <i data-lucide="sparkles" class="w-5 h-5"></i>
                                Suggerisci Automatico
                                <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>

                            <div id="wizard-multi-users-container">
                                <div class="text-center text-gray-500 py-6">
                                    <i data-lucide="user-plus" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                    <p class="text-sm">Nessun utente selezionato</p>
                                    <p class="text-xs mt-1">Clicca "Suggerisci Automatico" per iniziare</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="wizard-squadra-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seleziona Squadra *</label>
                        <select id="wizard-squadra-select" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleziona squadra...</option>
                        </select>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                        <p class="text-sm text-blue-800">
                            💡 <strong>Suggerimento:</strong> Con "Più Utenti" puoi assegnare la lavorazione a membri indipendenti senza creare una squadra permanente!
                        </p>
                    </div>
                </div>

                <!-- STEP 3: Dettagli e Componenti -->
                <div id="wizard-step-3" class="hidden space-y-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">⚙️ Dettagli Tecnici e Componenti</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ore Stimate</label>
                            <input type="number" id="wizard-ore-stimate" min="0" step="0.5"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Es: 8">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Costo Stimato (€)</label>
                            <input type="number" id="wizard-costo-stimato" min="0" step="10"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Es: 500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo Lavoro</label>
                        <input type="text" id="wizard-indirizzo" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Via, Città, CAP">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Componenti/Materiali Necessari</label>
                        
                        <!-- Bottone Selezione Prodotti -->
                        <button type="button" 
                                onclick="window.productScanner.mostraSelezioneProdotti()"
                                class="w-full mb-4 px-6 py-4 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl hover:shadow-xl transition-all flex items-center justify-center gap-3 font-semibold">
                            <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                            <span>Seleziona Prodotti / Scansiona QR</span>
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>

                        <!-- Lista Prodotti Selezionati -->
                        <div id="wizard-componenti-selezionati">
                            <div class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-300 rounded-lg">
                                <i data-lucide="package-open" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm">Nessun prodotto selezionato</p>
                                <p class="text-xs mt-1">Clicca il bottone sopra per aggiungere materiali</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 4: Riepilogo e Conferma -->
                <div id="wizard-step-4" class="hidden space-y-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">✅ Riepilogo Finale</h3>
                    
                    <div id="wizard-riepilogo-container">
                        <p class="text-center text-gray-500 py-8">Generazione riepilogo...</p>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-6">
                        <div class="flex items-center gap-2">
                            <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                            <p class="text-sm text-green-800 font-medium">
                                Tutto pronto! Clicca "Crea Lavorazione" per salvare.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer con Pulsanti Navigazione -->
            <div class="sticky bottom-0 bg-gray-50 px-8 py-4 rounded-b-2xl border-t flex justify-between items-center">
                <button id="wizard-prev-btn" 
                        onclick="window.taskWizard.saveCurrentStepData(); window.taskWizard.prevStep();" 
                        class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    ← Indietro
                </button>

                <div class="flex gap-3">
                    <button onclick="window.taskWizard.closeWizard()" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        Annulla
                    </button>
                    <button id="wizard-next-btn" 
                            onclick="window.taskWizard.saveCurrentStepData(); window.taskWizard.nextStep();" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Avanti →
                    </button>
                    <button id="wizard-submit-btn" 
                            onclick="window.taskWizard.submitWizard();" 
                            class="hidden px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        🎉 Crea Lavorazione
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        #step-indicator-1.active, #step-indicator-2.active, 
        #step-indicator-3.active, #step-indicator-4.active {
            opacity: 1;
        }
        #step-indicator-1.completed div, #step-indicator-2.completed div,
        #step-indicator-3.completed div, #step-indicator-4.completed div {
            background-color: #10b981;
            color: white;
        }
    </style>

    <script>
        // ===================================
        // MENU SELEZIONE TIPO CREAZIONE
        // ===================================
        
        function mostraMenuCreazione() {
            const menu = document.getElementById('creation-menu-modal');
            if (menu) {
                menu.classList.remove('hidden');
                lucide.createIcons();
            }
        }

        function apriWizard() {
            // Chiudi menu
            document.getElementById('creation-menu-modal').classList.add('hidden');
            // Apri wizard
            window.taskWizard.iniziaWizard();
        }

        function apriFormClassico() {
            // Chiudi menu
            document.getElementById('creation-menu-modal').classList.add('hidden');
            // Apri form classico (funzione originale)
            openTaskModal();
        }

        // ===================================
        // WIZARD SETUP
        // ===================================
        
        // Override renderWizard per mostrare il modal
        window.taskWizard.renderWizard = async function() {
            const modal = document.getElementById('task-wizard-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
            lucide.createIcons();
        };

        // Auto-init quando la pagina carica
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>