<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Richieste - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="Admin/auth-helper.js"></script>
    <script src="data-migration.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .status-pending { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .status-approved { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .status-rejected { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out z-50" id="sidebar">
        <div class="flex items-center justify-center h-16 gradient-bg">
            <h1 class="text-white text-xl font-bold">Admin Panel</h1>
        </div>
        <nav class="mt-8">
            <a href="admin-functional.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="gestione-utenti.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                Gestione Utenti
            </a>
            <a href="gestione-lavorazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                Gestione Lavorazioni
            </a>
            <a href="gestione-richieste.html" class="flex items-center px-6 py-3 bg-blue-50 text-blue-600 border-r-4 border-blue-600">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                Gestione Richieste
            </a>
            <a href="comunicazioni.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                Comunicazioni
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Gestione Richieste</h2>
            <p class="text-gray-600">Approva o rifiuta le richieste dei dipendenti</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Richieste Totali</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalRequests">24</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="file-text" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">In Attesa</p>
                        <p class="text-2xl font-bold text-orange-600" id="pendingRequests">8</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Approvate</p>
                        <p class="text-2xl font-bold text-green-600" id="approvedRequests">12</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Rifiutate</p>
                        <p class="text-2xl font-bold text-red-600" id="rejectedRequests">4</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 fade-in">
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-64">
                    <input type="text" id="searchRequests" placeholder="Cerca richieste..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <select id="typeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutti i tipi</option>
                    <option value="ferie">Ferie</option>
                    <option value="permessi">Permessi</option>
                    <option value="materiali">Materiali</option>
                    <option value="veicoli">Veicoli</option>
                    <option value="straordinari">Straordinari</option>
                </select>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutti gli stati</option>
                    <option value="in_attesa">In Attesa</option>
                    <option value="approvata">Approvata</option>
                    <option value="rifiutata">Rifiutata</option>
                </select>
                <select id="priorityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tutte le priorit√†</option>
                    <option value="alta">Alta</option>
                    <option value="media">Media</option>
                    <option value="bassa">Bassa</option>
                </select>
            </div>
        </div>

        <!-- Requests List -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden fade-in">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Elenco Richieste</h3>
            </div>
            <div class="overflow-x-auto">
                <div id="requestsList" class="divide-y divide-gray-200">
                    <!-- Requests will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div id="requestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Dettagli Richiesta</h3>
                    <button onclick="closeRequestModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="requestModalContent" class="p-6">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Approval/Rejection Modal -->
    <div id="actionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h3 id="actionModalTitle" class="text-lg font-medium text-gray-900">Conferma Azione</h3>
                    <button onclick="closeActionModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="p-6">
                    <p id="actionModalText" class="text-gray-600 mb-4"></p>
                    <div class="mb-4">
                        <label for="actionNote" class="block text-sm font-medium text-gray-700 mb-2">Note (opzionale)</label>
                        <textarea id="actionNote" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="closeActionModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Annulla
                        </button>
                        <button id="confirmActionBtn" onclick="confirmAction()" class="flex-1 px-4 py-2 rounded-lg text-white">
                            Conferma
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAction = null;
        let currentRequestId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            await loadRequests();
            await updateStats();
            setupFilters();
        });

        async function loadRequests() {
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '';

            const filteredRequests = await getFilteredRequests();

            filteredRequests.forEach(request => {
                const requestElement = createRequestElement(request);
                requestsList.appendChild(requestElement);
            });
        }

        function createRequestElement(request) {
            const requestDiv = document.createElement('div');
            requestDiv.className = `p-6 hover:bg-gray-50 transition-colors ${getPriorityClass(request.priorita)}`;
            
            const statusClass = getStatusClass(request.stato);
            const typeIcon = getTypeIcon(request.tipo);
            const urgentBadge = request.urgente ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-2">Urgente</span>' : '';
            
            requestDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="${typeIcon}" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center">
                                <h4 class="text-lg font-medium text-gray-900">${request.titolo}</h4>
                                ${urgentBadge}
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${request.descrizione}</p>
                            <div class="flex items-center mt-2 space-x-4">
                                <div class="flex items-center space-x-2">
                                    <img src="${request.dipendente.avatar}" alt="${request.dipendente.nome}" class="w-6 h-6 rounded-full">
                                    <span class="text-sm text-gray-600">${request.dipendente.nome}</span>
                                </div>
                                <span class="text-sm text-gray-500">${formatDate(request.dataRichiesta)}</span>
                                <span class="text-sm font-medium text-gray-600 capitalize">${request.tipo.replace('_', ' ')}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="${statusClass} px-3 py-1 rounded-full text-sm font-medium">${getStatusText(request.stato)}</span>
                            <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityBadgeClass(request.priorita)}">${request.priorita.charAt(0).toUpperCase() + request.priorita.slice(1)}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button onclick="viewRequest(${request.id})" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                        ${request.stato === 'in_attesa' ? `
                            <button onclick="approveRequest(${request.id})" class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="rejectRequest(${request.id})" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            return requestDiv;
        }

        async function getFilteredRequests() {
            try {
                const requests = await window.dataManager.getRichieste();
                const searchTerm = document.getElementById('searchRequests').value.toLowerCase();
                const typeFilter = document.getElementById('typeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;

                return requests.filter(request => {
                    const matchesSearch = (request.title || request.titolo || '').toLowerCase().includes(searchTerm) || 
                                        (request.description || request.descrizione || '').toLowerCase().includes(searchTerm) ||
                                        (request.user_name || '').toLowerCase().includes(searchTerm);
                    const matchesType = !typeFilter || request.type === typeFilter || request.tipo === typeFilter;
                    const matchesStatus = !statusFilter || request.status === statusFilter || request.stato === statusFilter;
                    const matchesPriority = !priorityFilter || request.priority === priorityFilter || request.priorita === priorityFilter;

                    return matchesSearch && matchesType && matchesStatus && matchesPriority;
                });
            } catch (error) {
                console.error('Errore caricamento richieste:', error);
                return [];
            }
        }

        function setupFilters() {
            const searchInput = document.getElementById('searchRequests');
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const priorityFilter = document.getElementById('priorityFilter');

            [searchInput, typeFilter, statusFilter, priorityFilter].forEach(element => {
                element.addEventListener('input', loadRequests);
                element.addEventListener('change', loadRequests);
            });
        }

        async function viewRequest(requestId) {
            try {
                const requests = await window.dataManager.getRichieste();
                const request = requests.find(r => r.id === requestId);
                if (!request) return;

                const modalContent = document.getElementById('requestModalContent');
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <h4 class="text-xl font-bold text-gray-900">${request.title || request.titolo || 'Richiesta'}</h4>
                            <span class="${getStatusClass(request.status || request.stato)} px-3 py-1 rounded-full text-sm font-medium">${getStatusText(request.status || request.stato)}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Utente</label>
                                <p class="font-medium">${request.user_name || 'N/A'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Richiesta</label>
                                <p class="capitalize">${(request.type || request.tipo || '').replace('_', ' ')}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Data Richiesta</label>
                                <p>${formatDate(request.created_at || request.dataRichiesta)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Priorit√†</label>
                                <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityBadgeClass(request.priority || request.priorita || 'bassa')}">${(request.priority || request.priorita || 'bassa').charAt(0).toUpperCase() + (request.priority || request.priorita || 'bassa').slice(1)}</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                            <p class="text-gray-600">${request.description || request.descrizione || 'Nessuna descrizione'}</p>
                        </div>
                        
                        ${(request.status || request.stato) === 'pending' || (request.status || request.stato) === 'in_attesa' ? `
                            <div class="flex space-x-3 pt-4 border-t">
                                <button onclick="approveRequest(${request.id})" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    <i data-lucide="check" class="w-4 h-4 inline mr-2"></i>
                                Approva
                            </button>
                            <button onclick="rejectRequest(${request.id})" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                                Rifiuta
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('requestModal').classList.remove('hidden');
            lucide.createIcons();
            } catch (error) {
                console.error('Errore visualizzazione richiesta:', error);
            }
        }

        function closeRequestModal() {
            document.getElementById('requestModal').classList.add('hidden');
        }

        async function approveRequest(requestId) {
            currentAction = 'approve';
            currentRequestId = requestId;
            try {
                const requests = await window.dataManager.getRichieste();
                const request = requests.find(r => r.id === requestId);
                
                document.getElementById('actionModalTitle').textContent = 'Approva Richiesta';
                document.getElementById('actionModalText').textContent = `Sei sicuro di voler approvare la richiesta "${request.title || request.titolo || 'questa richiesta'}"?`;
                document.getElementById('confirmActionBtn').className = 'flex-1 px-4 py-2 rounded-lg text-white bg-green-600 hover:bg-green-700';
                document.getElementById('confirmActionBtn').innerHTML = '<i data-lucide="check" class="w-4 h-4 inline mr-2"></i>Approva';
                
                document.getElementById('actionModal').classList.remove('hidden');
                lucide.createIcons();
            } catch (error) {
                console.error('Errore:', error);
            }
        }

        async function rejectRequest(requestId) {
            currentAction = 'reject';
            currentRequestId = requestId;
            try {
                const requests = await window.dataManager.getRichieste();
                const request = requests.find(r => r.id === requestId);
                
                document.getElementById('actionModalTitle').textContent = 'Rifiuta Richiesta';
                document.getElementById('actionModalText').textContent = `Sei sicuro di voler rifiutare la richiesta "${request.title || request.titolo || 'questa richiesta'}"?`;
                document.getElementById('confirmActionBtn').className = 'flex-1 px-4 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700';
                document.getElementById('confirmActionBtn').innerHTML = '<i data-lucide="x" class="w-4 h-4 inline mr-2"></i>Rifiuta';
                
                document.getElementById('actionModal').classList.remove('hidden');
                lucide.createIcons();
            } catch (error) {
                console.error('Errore:', error);
            }
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.add('hidden');
            document.getElementById('actionNote').value = '';
            currentAction = null;
            currentRequestId = null;
        }

        async function confirmAction() {
            if (!currentAction || !currentRequestId) return;

            try {
                const note = document.getElementById('actionNote').value;
                const newStatus = currentAction === 'approve' ? 'approved' : 'rejected';
                
                await window.RequestsAPI.update(currentRequestId, { 
                    status: newStatus,
                    notes: note
                });

                closeActionModal();
                closeRequestModal();
                await loadRequests();
                await updateStats();

                // Show success message
                showNotification(`Richiesta ${currentAction === 'approve' ? 'approvata' : 'rifiutata'} con successo!`, 'success');
            } catch (error) {
                console.error('Errore conferma azione:', error);
                showNotification('Errore durante l\'operazione', 'error');
            }
        }

        async function updateStats() {
            try {
                const requests = await window.dataManager.getRichieste();
                const total = requests.length;
                const pending = requests.filter(r => (r.status || r.stato) === 'pending' || (r.status || r.stato) === 'in_attesa').length;
                const approved = requests.filter(r => (r.status || r.stato) === 'approved' || (r.status || r.stato) === 'approvata').length;
                const rejected = requests.filter(r => (r.status || r.stato) === 'rejected' || (r.status || r.stato) === 'rifiutata').length;

                document.getElementById('totalRequests').textContent = total;
                document.getElementById('pendingRequests').textContent = pending;
                document.getElementById('approvedRequests').textContent = approved;
                document.getElementById('rejectedRequests').textContent = rejected;
            } catch (error) {
                console.error('Errore aggiornamento stats:', error);
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'in_attesa': return 'bg-orange-100 text-orange-800';
                case 'approvata': return 'bg-green-100 text-green-800';
                case 'rifiutata': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'in_attesa': return 'In Attesa';
                case 'approvata': return 'Approvata';
                case 'rifiutata': return 'Rifiutata';
                default: return status;
            }
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'alta': return 'priority-high';
                case 'media': return 'priority-medium';
                case 'bassa': return 'priority-low';
                default: return '';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'alta': return 'bg-red-100 text-red-800';
                case 'media': return 'bg-yellow-100 text-yellow-800';
                case 'bassa': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getTypeIcon(type) {
            switch(type) {
                case 'ferie': return 'calendar';
                case 'permessi': return 'clock';
                case 'materiali': return 'package';
                case 'veicoli': return 'car';
                case 'straordinari': return 'zap';
                default: return 'file-text';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-blue-500'} text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>